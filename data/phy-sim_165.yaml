- en: Constraint Solver
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 约束求解器
- en: 原文：[https://phys-sim-book.github.io/lec31.4-solver.html](https://phys-sim-book.github.io/lec31.4-solver.html)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://phys-sim-book.github.io/lec31.4-solver.html](https://phys-sim-book.github.io/lec31.4-solver.html)
- en: <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
- en: The heart of the PBD algorithm is the constraint solver, which iteratively projects
    the predicted particle positions to satisfy the defined constraints. Since this
    projection must be done in a physically plausible manner, ideally conserving the
    system's total linear and angular momentum for internal constraints, we employ
    a nonlinear Gauss-Seidel Solver.
  id: totrans-3
  prefs: []
  type: TYPE_NORMAL
  zh: PBD算法的核心是约束求解器，它通过迭代地将预测的粒子位置投影以满足定义的约束。由于这种投影必须在物理上合理进行，理想情况下应保持系统的总线动量和角动量以适应内部约束，我们采用非线性Gauss-Seidel求解器。
- en: '[Constraint Projection: Momentum Conservation](#constraint-projection-momentum-conservation)'
  id: totrans-4
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[约束投影：动量守恒](#constraint-projection-momentum-conservation)'
- en: 'To keep things as physically plausible as possible we make sure that for any
    internal constraint, the correction step should not introduce fictitious external
    forces, often referred to as "ghost forces." This is achieved by ensuring that
    the net change in linear and angular momentum is zero. Let Δpi​ be the position
    correction for particle i. Linear momentum is conserved if the center of mass
    remains unchanged by the correction:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 为了尽可能保持物理上的合理性，我们确保对于任何内部约束，修正步骤不应引入虚假的外部力，通常称为“幽灵力”。这是通过确保线动量和角动量的净变化为零来实现的。设Δpi为粒子i的位置修正。如果修正不改变质心，则线动量是守恒的：
- en: i∑​mi​Δpi​=0
  id: totrans-6
  prefs: []
  type: TYPE_NORMAL
  zh: i∑miΔpi=0
- en: 'Angular momentum is conserved if the net torque produced by the corrections
    is zero with respect to a common center of rotation c:'
  id: totrans-7
  prefs: []
  type: TYPE_NORMAL
  zh: 如果修正产生的净扭矩相对于一个共同的旋转中心c为零，则角动量是守恒的：
- en: i∑​(pi​−c)×(mi​Δpi​)=0
  id: totrans-8
  prefs: []
  type: TYPE_NORMAL
  zh: i∑(pi−c)×(miΔpi)=0
- en: '***Remark 32.4.1 (Constraint Gradient).*** A key insight is that if the correction
    vector for the concatenated particle positions, Δp=[Δp1T​,…,ΔpnT​]T, is chosen
    to be parallel to the constraint gradient ∇p​C, that is: Δp⊤∇p​C=0 then for many
    common internal constraints (which are independent of rigid body transformations),
    both momenta are automatically conserved when particle masses are equal.'
  id: totrans-9
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '***备注32.4.1（约束梯度）*** 一个关键的洞察是，如果连接粒子位置的修正向量Δp=[Δp1T,…,ΔpnT]T被选为与约束梯度∇pC平行，即：Δp⊤∇pC=0，那么对于许多常见的内部约束（这些约束与刚体变换无关），当粒子质量相等时，动量会自动守恒。'
- en: As such the correction for each particle will be assumed to be parallel to the
    constraint gradient. This choice is supported by the fact that since the gradient
    points in the direction of the steepest ascent of the constraint function, and
    thus moving in the opposite direction is the most direct way to reduce the constraint
    error.
  id: totrans-10
  prefs: []
  type: TYPE_NORMAL
  zh: 因此，每个粒子的修正将被假设为与约束梯度平行。这一选择得到了支持，因为梯度指向约束函数最陡上升的方向，因此朝相反方向移动是减少约束误差的最直接方式。
- en: '[Position Correction (General Constraints)](#position-correction-general-constraints)'
  id: totrans-11
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[位置修正（一般约束）](#position-correction-general-constraints)'
- en: 'Consider a single constraint C(p1​,…,pn​)=0 involving n particles. Given a
    set of predicted positions p that violate this constraint (i.e., C(p)=0), we
    seek a correction Δp such that C(p+Δp)=0. To make this tractable, we linearize
    the constraint function using a first-order Taylor expansion around the current
    positions p: C(p+Δp)C(p+Δp)​=C(p)+∇p​C(p)⊤Δp+O(∥Δp∥2)≻0,≈C(p)+∇p​C(p)⊤Δp≻0.​(32.4.1)​'
  id: totrans-12
  prefs: []
  type: TYPE_NORMAL
  zh: 考虑一个涉及n个粒子的单个约束C(p1,…,pn)=0。给定一组违反此约束的预测位置p（即，C(p)≠0），我们寻求一个修正Δp，使得C(p+Δp)=0。为了使问题可处理，我们使用当前位置p周围的一阶泰勒展开线性化约束函数：C(p+Δp)≈C(p)+∇pC(p)⊤Δp+O(∥Δp∥2)≻0。(32.4.1)
- en: 'As established above, we restrict the correction to be in the direction of
    the constraint gradient. This allows us to define the correction for a single
    particle i in terms of a single unknown scalar λ, which acts as a Lagrange multiplier:
    Δpi​=−λwi​∇pi​​C(p)(32.4.2) where wi​=1/mi​ is the inverse mass, ensuring that
    lighter particles are displaced more. The negative sign is a convention to align
    λ with the concept of a repulsive force for a positive constraint violation. In
    vector form for all involved particles, this is Δp=−λM−1∇p​C, where M is the diagonal
    mass matrix.'
  id: totrans-13
  prefs: []
  type: TYPE_NORMAL
  zh: 如上所述，我们将校正限制在约束梯度的方向上。这使我们能够用单个未知标量λ来定义单个粒子i的校正，该标量λ充当拉格朗日乘子：Δpi=−λwi∇piC(p)(32.4.2)，其中wi=1/mi是质量倒数，确保较轻的粒子位移更大。负号是一个约定，用于将λ与正约束违反的排斥力概念对齐。对于所有涉及的粒子，这可以表示为向量形式：Δp=−λM−1∇pC，其中M是对角质量矩阵。
- en: 'To find the value of λ, we substitute the correction from Equation [(32.4.2)](#eq:solver:correction_form)
    back into the linearized constraint, Equation [(32.4.1)](#eq:pbd:linearized_constraint).
    For an equality constraint, this becomes: C(p)+∇p​C(p)⊤(−λM−1∇p​C(p))=0 Solving
    for the Lagrange multiplier λ yields: λ=∑j=1n​wj​∥∇pj​​C(p)∥2C(p)​(32.4.3) With
    λ determined, the position correction Δpi​ for each particle is fully defined.
    We can also write the full correction in a single expression by substituting Equation
    [(32.4.3)](#eq:solver:lambda) into Equation [(32.4.2)](#eq:solver:correction_form):
    Δpi​=−∑j=1n​wj​∥∇pj​​C∥2C(p1​,…,pn​)​wi​∇pi​​C(p)(32.4.4) This equation is the
    cornerstone of the PBD solver. It provides a direct, computationally efficient
    method to calculate the position corrections required to satisfy a single linearized
    constraint while respecting particle masses. This projection is solved multiple
    times for each constraint within a single time step. It is important to note that
    for constraints that are linear along their gradient, such as a simple distance
    constraint, this linearization is exact, and the constraint can be satisfied in
    a single step.'
  id: totrans-14
  prefs: []
  type: TYPE_NORMAL
  zh: 为了找到λ的值，我们将方程[(32.4.2)](#eq:solver:correction_form)中的校正代入线性化约束方程[(32.4.1)](#eq:pbd:linearized_constraint)。对于等式约束，这变为：C(p)+∇pC(p)⊤(−λM−1∇pC(p))=0
    通过求解拉格朗日乘子λ得到：λ=∑j=1n​wj∥∇pjC(p)∥2C(p)(32.4.3)。一旦确定了λ，每个粒子的位置校正Δpi就完全定义了。我们还可以通过将方程[(32.4.3)](#eq:solver:lambda)代入方程[(32.4.2)](#eq:solver:correction_form)来写出完整的校正表达式：Δpi=−∑j=1n​wj∥∇pjC∥2C(p1,…,pn)wi∇piC(p)(32.4.4)。这个方程是PBD求解器的基石。它提供了一种直接且计算效率高的方法来计算满足单个线性化约束并尊重粒子质量所需的位置校正。这个投影在每个时间步内对每个约束求解多次。需要注意的是，对于沿着梯度线性的约束，例如简单的距离约束，这种线性化是精确的，约束可以在单步中满足。
- en: '****Example 32.4.1 (Distance Constraint).**** Let us consider one of the most
    fundamental constraints: the distance constraint, which enforces a fixed separation
    d between two particles, p1​ and p2​. This is a common building block used to
    model stretching resistance in springs, the edges of a cloth mesh, or rigid links
    between objects.'
  id: totrans-15
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: '****示例 32.4.1（距离约束）**** 让我们考虑最基本的约束之一：距离约束，它强制两个粒子p1和p2之间保持固定的分离距离d。这是建模弹簧的拉伸阻力、布网边缘或物体之间的刚性连接的常用构建块。'
- en: ''
  id: totrans-16
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'The constraint function is defined as the difference between the current distance
    and the desired rest distance d: C(p1​,p2​)=∥p1​−p2​∥−d This function directly
    measures the error that needs to be corrected. While the general projection method
    from Equation [(32.4.4)](#eq:pbd:final_correction) can be applied, for this specific
    and common case, the result simplifies to a very intuitive form. The final position
    corrections for each particle are given directly by: Δp1​Δp2​​=−w1​+w2​w1​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​=+w1​+w2​w2​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​​​​
    The term (∥p1​−p2​∥−d) represents the total correction magnitude needed along
    the vector connecting the particles. This total correction is then distributed
    between the two particles based on their inverse mass ratio, wi​/(w1​+w2​). The
    correction is applied along the unit vector (p1​−p2​)/∥p1​−p2​∥, moving the particles
    towards each other if they are too far apart (C>0) and away from each other if
    they are too close (C<0). This formulation directly satisfies the conservation
    of linear momentum!'
  id: totrans-17
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 约束函数定义为当前距离与期望的静止距离 d 之间的差：C(p1​,p2​)=∥p1​−p2​∥−d 这个函数直接测量需要纠正的错误。虽然可以从方程 [(32.4.4)](#eq:pbd:final_correction)
    中的通用投影方法应用，但对于这个特定且常见的情况，结果简化为一个非常直观的形式。每个粒子的最终位置修正直接给出如下：Δp1​Δp2​​=−w1​+w2​w1​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​=+w1​+w2​w2​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​
    The term (∥p1​−p2​∥−d) 表示沿着连接粒子的向量上所需的总修正量。然后，根据它们的逆质量比 wi​/(w1​+w2​) 在两个粒子之间分配这个总修正。修正沿着单位向量
    (p1​−p2​)/∥p1​−p2​∥ 应用，如果粒子之间距离太远（C>0），则将粒子推向彼此；如果粒子之间太近（C<0），则将粒子推开。这种公式直接满足线性动量守恒！
- en: '[Hierarchical Solver](#hierarchical-solver)'
  id: totrans-18
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
  zh: '[分层求解器](#hierarchical-solver)'
- en: The standard Gauss-Seidel solver in PBD exhibits slow convergence for low-frequency,
    large-scale deformations because corrections propagate only locally. To accelerate
    this, Hierarchical Position Based Dynamics (HPBD) [[Müller 2008]](bibliography.html#muller2008hierarchical)
    introduces a multi-resolution approach. The system is represented as a hierarchy
    of meshes, from coarse to fine. The solver operates first on the coarsest levels,
    allowing corrections for large-scale errors to propagate rapidly across the entire
    object. These corrections are then transferred and refined on successively finer
    levels in a single coarse-to-fine pass via interpolation (prolongation). This
    multigrid-inspired technique significantly improves convergence speed. For this
    to work correctly, constraints on the coarse levels must be unilateral (inequality
    constraints), resisting only stretching, to avoid artificially restricting large-scale
    bending and folding of the object.
  id: totrans-19
  prefs: []
  type: TYPE_NORMAL
  zh: PBD 中的标准 Gauss-Seidel 求解器对于低频、大规模形变表现出收敛速度慢，因为修正只局部传播。为了加速这个过程，分层位置基于动力学 (HPBD)
    [[Müller 2008]](bibliography.html#muller2008hierarchical) 引入了一种多分辨率方法。系统被表示为一个从粗到细的网格层次结构。求解器首先在最低级别上操作，允许大规模错误的修正快速在整个对象上传播。然后，通过插值（延长）将这些修正传递并逐级细化，在单次粗到细的遍历中完成。这种受多网格启发的技术显著提高了收敛速度。为了正确工作，粗级别上的约束必须是单边的（不等式约束），仅抵抗拉伸，以避免人为地限制对象的大规模弯曲和折叠。
