<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>3 Make a plot</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>3 Make a plot</h1>
<blockquote>原文：<a href="https://socviz.co/makeplot.html">https://socviz.co/makeplot.html</a></blockquote>

<p>This Chapter will teach you how to use ggplot’s core functions to
produce a series of scatterplots. From one point of view, we will
proceed slowly and carefully, taking our time to understand the logic
behind the commands that you type. The reason for this is that the
central activity of visualizing data with ggplot more or less <em>always</em>
involves the same sequence of steps. So it is worth learning what they
are.</p>
<p>From another point of view, though, we will move fast. Once you have
the basic sequence down, and understand how it is that ggplot
assembles the pieces of a plot in to a final image, then you will find
that analytically and aesthetically sophisticated plots come within
your reach very quickly. By the end of this Chapter, for example, we
will have learned how to produce a small-multiple plot of time series
data for a large number of countries, with a smoothed regression line
in each panel. So in another sense we will have moved quite fast.</p>
<div id="how-ggplot-works" class="section level2">
<h2><span class="header-section-number">3.1</span> How ggplot works</h2>
<p>As we saw in Chapter <a href="lookatdata.html#lookatdata">1</a>, visualization involves representing your data
data using lines or shapes or colors and so on. There is some
structured relationship, some <em>mapping</em>, between the variables in your
data and their representation in the plot displayed on your screen or
on the page. We also saw that not all mappings make sense for all
types of variables, and (independently of this), some representations
are harder to interpret than others. Ggplot provides you with a set of
tools to map data to visual elements on your plot, to specify the kind
of plot you want, and then subsquently to control the fine details of
how it will be displayed. Figure <a href="makeplot.html#fig:ggplot-flow">3.1</a> shows a
schematic outline of the process starting from data, at the top, down
to a finished plot at the bottom. Don’t worry about the details for
now. We will be doing into them one piece at a time over the next few
chapters.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ggplot-flow"/>
<img src="../Images/c1ff2f5d98f9f5a0f2ee592c6c4b484c.png" alt="The main elements of ggplot's grammar of graphics. This chapter goes through these steps in detail." width="100%" data-original-src="https://socviz.co/assets/ch-03-ggplot-flow-vertical.png"/>
<!--
<p class="caption marginnote">-->Figure 3.1: The main elements of ggplot’s grammar of graphics. This chapter goes through these steps in detail.<!--</p>-->
<!--</div>--></span>
</p>
<p>The most important thing to get used to with ggplot is the way you use
it to think about the logical structure of your plot. The code you
write specifies the connections between the variables in your data,
and the colors, points, and shapes you see on the screen. In ggplot,
these logical connections between your data and the plot elements are
called <em>aesthetic mappings</em> or just <em>aesthetics</em>. You begin every plot
by telling the <code>ggplot()</code> function what your data is, and then how the
variables in this data logically map onto the plot’s aesthetics. Then
you take the result and say what general sort of plot you want, such
as a scatterplot, a boxplot, or a bar chart. In ggplot, the overall
type of plot is called a <em>geom</em>. Each geom has a function that creates
it. For example, <code>geom_point()</code> makes scatterplots, <code>geom_bar()</code> makes
barplots, <code>geom_boxplot()</code> makes boxplots, and so on. You combine
these two pieces, the <code>ggplot()</code> object and the <code>geom</code>, by literally
adding them together in an expression, using the “<code>+</code>” symbol.</p>
<p>At this point, ggplot will have enough information to be able to draw
a plot for you. The rest is just details about exactly what you want
to see. If you don’t specify anything further, ggplot will use a set
of defaults that try to be sensible about what gets drawn. But more
often, you will want to specify exactly what you want, including
information about the scales, the labels of legends and axes, and
other guides that help people to read the plot. These additional
pieces are added to the plot in the same way as the <code>geom_</code> function
was. Each component has it own function, you provide arguments to it
specifying what to do, and you literally add it to the sequence of
instructions. In this way you systematically build your plot piece by
piece.</p>
<p>In this chapter we will go through the main steps of this process. We
will proceed by example, repeatedly building a series of plots. As
noted earlier, I <em>strongly</em> encourage you go through this exercise
manually, typing (rather than copying-and-pasting) the code yourself.
This may seem a bit tedious, but it is <em>by far</em> the most effective way
to get used to what is happening, and to get a feel for R’s syntax.
While you’ll inevitably make some errors, you will also quickly find
yourself becoming able to diagnose your own errors, as well as having
a better grasp of the higher-level structure of plots. You should open
the RMarkdown file for your notes, remember to load the tidyverse
library<label for="tufte-mn-32" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-32" class="margin-toggle"/><span class="marginnote shownote"><code>library(tidyverse)</code></span> and write the code
out in chunks, interspersing your own notes and comments as you go.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:gaptab1">Table 3.1: </span>Life Expectancy data in wide format.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">1952</th>
<th align="right">1957</th>
<th align="right">1962</th>
<th align="right">1967</th>
<th align="right">1972</th>
<th align="right">1977</th>
<th align="right">1982</th>
<th align="right">1987</th>
<th align="right">1992</th>
<th align="right">1997</th>
<th align="right">2002</th>
<th align="right">2007</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">29</td>
<td align="right">30</td>
<td align="right">32</td>
<td align="right">34</td>
<td align="right">36</td>
<td align="right">38</td>
<td align="right">40</td>
<td align="right">41</td>
<td align="right">42</td>
<td align="right">42</td>
<td align="right">42</td>
<td align="right">44</td>
</tr>
<tr class="even">
<td align="left">Albania</td>
<td align="right">55</td>
<td align="right">59</td>
<td align="right">65</td>
<td align="right">66</td>
<td align="right">68</td>
<td align="right">69</td>
<td align="right">70</td>
<td align="right">72</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">76</td>
<td align="right">76</td>
</tr>
<tr class="odd">
<td align="left">Algeria</td>
<td align="right">43</td>
<td align="right">46</td>
<td align="right">48</td>
<td align="right">51</td>
<td align="right">55</td>
<td align="right">58</td>
<td align="right">61</td>
<td align="right">66</td>
<td align="right">68</td>
<td align="right">69</td>
<td align="right">71</td>
<td align="right">72</td>
</tr>
<tr class="even">
<td align="left">Angola</td>
<td align="right">30</td>
<td align="right">32</td>
<td align="right">34</td>
<td align="right">36</td>
<td align="right">38</td>
<td align="right">39</td>
<td align="right">40</td>
<td align="right">40</td>
<td align="right">41</td>
<td align="right">41</td>
<td align="right">41</td>
<td align="right">43</td>
</tr>
<tr class="odd">
<td align="left">Argentina</td>
<td align="right">62</td>
<td align="right">64</td>
<td align="right">65</td>
<td align="right">66</td>
<td align="right">67</td>
<td align="right">68</td>
<td align="right">70</td>
<td align="right">71</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">74</td>
<td align="right">75</td>
</tr>
<tr class="even">
<td align="left">Australia</td>
<td align="right">69</td>
<td align="right">70</td>
<td align="right">71</td>
<td align="right">71</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">75</td>
<td align="right">76</td>
<td align="right">78</td>
<td align="right">79</td>
<td align="right">80</td>
<td align="right">81</td>
</tr>
</tbody>
</table>

</div>
<div id="tidy-data" class="section level2">
<h2><span class="header-section-number">3.2</span> Tidy data</h2>
<p>The tidyverse tools we will be using want to see your data in a
particular sort of shape, generally referred to as “tidy data”
<span class="citation">(Wickham, 2014)</span>. Social scientists will likely be familiar with the
distinction between <em>wide format</em> and <em>long format</em> data. In a long
format table, every variable is a column, and every observation is a
row. In a wide format table, some variables are spread out across
columns. For example, Table <a href="makeplot.html#tab:gaptab1">3.1</a> shows part of a table
of life expectancy over time for a series of countries. This is in
wide format, because one of the variables, year, is spread across
the columns of the table.</p>
<p>By contrast, Table <a href="makeplot.html#tab:gaptab2">3.2</a> shows the beginning of the same
data in long format. The tidy data that ggplot wants is in this long
form. In a related bit of terminology, in this table the <code>year</code>
variable is sometimes called a <em>key</em> and the <code>lifeExp</code> variable is the
<em>value</em> taken by that key for any particular row. These terms are
useful when converting tables from wide to long format. I am speaking
fairly loosely here. Underneath these terms there is a worked-out
theory of the forms that tabular data can be stored in, but right now
we don’t need to know those additional details. For more on the ideas
behind tidy data, see the discussion in the Appendix. You will also
find an example showing the R code you need to get from an untidy to a
tidy shape for the common “wide” case where some variables are spread
out across the columns of your table.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:gaptab2">Table 3.2: </span>Life Expectancy data in long format.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">year</th>
<th align="right">lifeExp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1952</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1957</td>
<td align="right">30</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1962</td>
<td align="right">32</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1967</td>
<td align="right">34</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1972</td>
<td align="right">36</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1977</td>
<td align="right">38</td>
</tr>
</tbody>
</table>

<p>If you compare Tables <a href="makeplot.html#tab:gaptab1">3.1</a> and <a href="makeplot.html#tab:gaptab2">3.2</a>, it is
clear that a tidy table does not present data in its most compact
form. In fact, it is usually not how you would choose to present your
data if you wanted to just show people the numbers. Neither is untidy
data “messy” or the “wrong” way to lay out data in some generic sense.
It’s just that, even if its long-form shape makes tables larger, tidy
data is much more straightforward to work with when it comes to
specifying the mappings that you need to coherently describe plots.</p>
</div>
<div id="mappings-link-data-to-things-you-see" class="section level2">
<h2><span class="header-section-number">3.3</span> Mappings link data to things you see</h2>
<p>It’s useful to think of a recipe or template that we start from each
time we want to make a plot. This is shown in Figure
<a href="makeplot.html#fig:ch-03-ggplot-formula-schematic">3.2</a>. We start with just one object of
our own, our data, which should be in a shape that ggplot understands.
Usually this will be a <em>data frame</em> or some augmented version of it,
like a <em>tibble</em>. We tell the core <code>ggplot</code> function what our data is.
In this book, we will do this by creating an object named <code>p</code> which
will contain the core information for our plot. (The name <code>p</code> is just
a convenience.) Then we choose a plot type, or <em>geom</em> and add it to
<code>p</code>. From there, we add more features to the plot as needed, such as
additional elements, adjusted scales, a title, or other
labels as needed.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-ggplot-formula-schematic"/>
<img src="../Images/56281a77d6137fdd488cb29f21b9c816.png" alt="A schematic for making a plot." width="254" data-original-src="https://socviz.co/assets/ch-03-ggplot-formula-schematic.png"/>
<!--
<p class="caption marginnote">-->Figure 3.2: A schematic for making a plot.<!--</p>-->
<!--</div>--></span>
</p>
<p>We’ll use the gapminder data to make our first plots. Make sure the
library containing the data is loaded. If you are following through from the previous Chapter in the same RStudio session or RMarkdown document, you won’t have to load it again. Otherwise, use <code>library()</code> to make it available.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1"><span class="kw">library</span>(gapminder)</a></code></pre>
<p>We can remind ourselves again what it looks like by typing the name of the object at the console:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1">gapminder</a></code></pre>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333       779
##  2 Afghanistan Asia       1957    30.3  9240934       821
##  3 Afghanistan Asia       1962    32.0 10267083       853
##  4 Afghanistan Asia       1967    34.0 11537966       836
##  5 Afghanistan Asia       1972    36.1 13079460       740
##  6 Afghanistan Asia       1977    38.4 14880372       786
##  7 Afghanistan Asia       1982    39.9 12881816       978
##  8 Afghanistan Asia       1987    40.8 13867957       852
##  9 Afghanistan Asia       1992    41.7 16317921       649
## 10 Afghanistan Asia       1997    41.8 22227415       635
## # ... with 1,694 more rows</code></pre>
<p>Let’s say we want to plot Life Expectancy against per capita GDP
for all country-years in the data. We’ll do this by creating an object
that has some of the necessary information in it, and build it up from
there. First, we must tell the <code>ggplot()</code> function what data we are
using.<label for="tufte-mn-33" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-33" class="margin-toggle"/><span class="marginnote shownote">Remember, use <code>Option+minus</code> on MacOS or <code>Alt+minus</code> on Windows to type the assignment operator.</span></p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder)</a></code></pre>
<p>At this point ggplot knows our data, but not what the
<em>mapping</em>. That is,<label for="tufte-mn-34" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-34" class="margin-toggle"/><span class="marginnote shownote">You do not need to explicitly name the arguments you pass to functions, as long as you provide them in the expected order, viz, the order listed on the help page for the function. This code would still work if we omitted <code>data = </code> and <code>mapping = </code>. In this book, I name all the arguments for clarity.</span> we need to tell it which variables in the data should be represented by which visual elements in the plot. It also doesn’t know what sort of plot we want. In ggplot, mappings are specified using the <code>aes()</code>
function. Like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb71-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb71-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a></code></pre>
<p>Here we’ve given the <code>ggplot()</code> function two arguments instead of one: <code>data</code> and <code>mapping</code>. The <code>data</code> argument tells ggplot where to find the variables it is about to use. This saves us from having to tediously dig out the name of each variable in full. Instead, any mentions of variables will be looked for here first.</p>
<p>Next, the mapping. The <code>mapping</code> argument is not a data object, nor is
it a character string. Instead, it’s a function. (Remember, functions
can be nested inside other functions.) The arguments we give to the
<code>aes</code> function are a sequence of definitions that <code>ggplot</code> will use
later. Here they say, “The variable on the x-axis is going to be
<code>gdpPercap</code>, and the variable on the y-axis is going to be <code>lifeExp</code>.”
The <code>aes()</code> function does not say where variables with those names are
to be found. That’s because <code>ggplot()</code> is going to assume things with
that name are in the object given to the <code>data</code> argument.</p>
<p>The <code>mapping = aes(...)</code> argument <em>links variables</em> to <em>things you
will see</em> on the plot. The <code>x</code> and <code>y</code> values are the most obvious
ones. Other aesthetic mappings can include, for example, color, shape,
size, and line type (whether a line is solid or dashed, or some other
pattern). We’ll see examples in a minute. A mapping does not directly
say what particular, e.g., colors or shapes will be on the plot.
Rather they say which <em>variables</em> in the data will be <em>represented</em> by
visual elements like a color, a shape, or a point on the plot area.</p>
<p>What happens if we just type <code>p</code> at the console at this point and hit
return?</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:unnamed-chunk-25"/>
<img src="../Images/47dad5f7b71ab7ea157c35ee278b93cf.png" alt="This empty plot has no geoms." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/unnamed-chunk-25-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.3: This empty plot has no geoms.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">p</a></code></pre>
<p>The <code>p</code> object has been created by the <code>ggplot()</code> function, and already has information in it about the mappings we want, together with a lot of other information added by default. (If you want to see just how much information is in the <code>p</code> object already, try asking for <code>str(p)</code>.) However, we haven’t given it any instructions get about what sort of plot to draw. We need to add a <em>layer</em> to the plot. This means picking a <code>geom_</code> function. We will use <code>geom_point()</code>. It knows how to take <code>x</code> and <code>y</code> values and plot them in a scatterplot.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() </a></code></pre>
<div class="figure"><span id="fig:ch-03-fig-lexp-gdp-01"/>
<p class="caption marginnote shownote">
Figure 3.4: A scatterplot of Life Expectancy vs GDP
</p>
<img src="../Images/3499497ffdaedc0433bcaf755af3df94.png" alt="A scatterplot of Life Expectancy vs GDP" width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-01-1.png"/>
</div>
<p>Success!</p>
</div>
<div id="build-your-plots-layer-by-layer" class="section level2">
<h2><span class="header-section-number">3.4</span> Build your plots layer by layer</h2>
<p>Although we got a brief taste of ggplot at the end of Chapter
<a href="gettingstarted.html#gettingstarted">2</a>, we spent more time in that Chaper preparing the
ground to make this first proper graph. We set up our software IDE and
made sure we could reproduce our work. We then learned the basics of
how R works, and the sort of tidy data that ggplot expects. Just now
we went through the logic of ggplot’s main idea, of building up plots
a piece at a time in a systematic and predictable fashion, beginning
with a mapping between a variable and an aesthetic element. We have
done a lot of work and produced one plot.</p>
<p>The good news is that, from now on, not much will change conceptually
about what we are doing. It will be more a question of learning in
greater detail about how to tell ggplot what to do. We will learn more
about the different geoms (or types of plot) available, and find out
about the functions that control the coordinate system, scales,
guiding elements (like labels and tick marks), and thematic features
of plots. This will allow us to make much more sophisticated plots
surprisingly fast. Conceptually, however, we will always be doing the
same thing. We will start with a table of data that has been tidied,
and then we will:</p>
<ol style="list-style-type: decimal">
<li>Tell the <code>ggplot()</code> function what our data is.<label for="tufte-mn-35" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-35" class="margin-toggle"/><span class="marginnote shownote">The <code>data = …</code> step.</span></li>
<li>Tell <code>ggplot()</code> <em>what</em> relationships we want to see.<label for="tufte-mn-36" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-36" class="margin-toggle"/><span class="marginnote shownote">The <code>mapping = aes(…)</code> step.</span> For convenience we will put the results of the first two steps in an object called <code>p</code>.</li>
<li>Tell <code>ggplot</code> <em>how</em> we want to see the relationships in our data.<label for="tufte-mn-37" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-37" class="margin-toggle"/><span class="marginnote shownote">Choose a geom.</span></li>
<li>Layer on geoms as needed, by adding them to the <code>p</code> object one at a time.</li>
<li>Use<label for="tufte-mn-38" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-38" class="margin-toggle"/><span class="marginnote shownote">The <code>scale_,</code> family, <code>labs()</code> and <code>guides()</code> functions.</span> some additional functions to adjust scales, labels, tick marks, titles. We’ll learn more about some of these functions shortly.</li>
</ol>
<p>To begin with we will let ggplot use its defaults for many of these
elements. The coordinate system used in plots is most often cartesian,
for example. It is a plane defined by an x axis and a y axis. This is
what ggplot assumes, unless you tell it otherwise. But we will quickly start making some adjustments.
Bear in mind once again that the process of adding layers to the plot really is <em>additive</em>.<label for="tufte-mn-39" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-39" class="margin-toggle"/><span class="marginnote shownote">In effect we create one big object that is a nested list of instructions for how to draw each piece of the plot.</span> Usually in R, functions cannot simply be added to objects. Rather, they take objects as inputs and produce objects as outputs.
But the objects created by ggplot() are special. This makes it easier to assemble plots one piece at a time, and to inspect how they look at every step. For example, let’s try a different <code>geom_</code> function with our plot.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-02"/>
<img src="../Images/0469c2175ab50a6df7a006a61a34e03b.png" alt="Life Expectancy vs GDP, using a smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.5: Life Expectancy vs GDP, using a smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb74-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb74-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb74-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>()</a></code></pre>
<p>You can see right away that some of these geoms do a lot more than simply put points on a grid. Here <code>geom_smooth()</code> has calculated a smoothed line for us and shaded in a ribbon showing the standard error for the line. If we want to see the data points and the line together, we simply add <code>geom_point()</code> back in:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-03"/>
<img src="../Images/20c96ac9f9ee066dad98ea66fbc317a1.png" alt="Life Expectancy vs GDP, showing both points and a GAM smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-03-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.6: Life Expectancy vs GDP, showing both points and a GAM smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb75-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>() </a></code></pre>
<pre><code>## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</code></pre>
<p>The console message R tells you the <code>geom_smooth()</code> function is using a <code>method</code> called <code>gam</code>, which in this case means it has fit a generalized additive model. This suggests that maybe there are other methods that <code>geom_smooth()</code> understands, and which we might tell it to use instead. Instructions are given to functions via their arguments, so we can try adding <code>method = "lm"</code> (for “linear model”) as an argument to <code>geom_smooth()</code>:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-04"/>
<img src="../Images/b464fa693cd69f46ffe0f320331102a8.png" alt="Life Expectancy vs GDP, points and an ill-advised linear fit." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.7: Life Expectancy vs GDP, points and an ill-advised linear fit.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb77-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb77-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb77-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>) </a></code></pre>
<p>We did not have to tell <code>geom_point()</code> or <code>geom_smooth()</code>
where their data was coming from, or what mappings they should use.
They <em>inherit</em> this information from the original <code>p</code> object. As we’ll
see later, it’s possible to give geoms separate instructions that they
will follow instead. But in the absence of any other information, the
geoms will look for the instructions it needs in the <code>ggplot()</code>
function, or the object created by it.</p>
<p>In our plot, the data is quite bunched up against the left side. Gross Domestic Product per capita is not normally distributed across our country years. The x-axis scale would probably look better if it were transformed from a linear scale to a log scale. For this we can use a function called <code>scale_x_log10()</code>. As you might expect this function scales the x-axis of a plot to a log 10 basis. To use it we just add it to the plot:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-05"/>
<img src="../Images/89cc54d50b54a4a8385915808ec2c87c.png" alt="Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-05-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.8: Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb78-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb78-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb78-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The x-axis transformation repositions the points, and also changes the shape the smoothed line. (We switched back to <code>gam</code> from <code>lm</code>.) While <code>ggplot()</code> and its associated functions have not made any changes to our underlying data frame, the scale transformation is applied to the data before the smoother is layered on to the plot. There are a variety of scale transformations that you can use in just this way. Each is named for the transformation you want to apply, and the axis you want to applying it to. In this case we use <code>scale_x_log10()</code>.</p>
<p>At this point, if our goal was just to show a plot of Life Expectancy vs GDP using sensible scales and adding a smoother, we would be thinking about polishing up the plot with nicer axis labels and a title. Perhaps we might also want to replace the scientific notation on the x-axis with the dollar value it actually represents. We can do both of these things quite easily. Let’s take care of the scale first. The labels on the tick-marks can be controlled through the <code>scale_</code> functions. While it’s possible to roll your own function to label axes (or just supply your labels manually, as we will see later), there’s also a handy <code>scales</code> library that contains some useful pre-made formatting functions. We can either load the whole library with <code>library(scales)</code> or, more conveniently, just grab the specific formatter we want from that library. Here it’s the <code>dollar()</code> function. To grab a function directly from a library we have not loaded, we use the syntax <code>thelibrary::thefunction</code>. So, we can do this:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-06"/>
<img src="../Images/52f0a9f105ac6e60c79d2503c117395d.png" alt="Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis, with better labels on the tick marks." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-06-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.9: Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis, with better labels on the tick marks.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb79-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar)</a></code></pre>
<p>We will learn more about scale transformations later. For now,
just remember two things about them. First, you can directly transform
your x or y axis by adding something like <code>scale_x_log10()</code> or
<code>scale_y_log10()</code> to your plot. When you do so, the x or y axis will
be transformed and, by default, the tick marks on the axis will be
labeled using scientific notation. Second, you can give these <code>scale_</code>
functions a <code>labels</code> argument that reformats the text printed
underneath the tick marks on the axes. Inside the <code>scale_x_log10()</code>
function try <code>labels=scales::comma</code>, for example.</p>
</div>
<div id="mapping-aesthetics-vs-setting-them" class="section level2">
<h2><span class="header-section-number">3.5</span> Mapping aesthetics vs setting them</h2>
<p>An <em>aesthetic mapping</em> specifies that a variable will be expressed by one of the available visual elements, such as size, or color, or shape, and so on. As we’ve seen, we map variables to aesthetics like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1">p &lt;-<span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb80-2" data-line-number="2">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">                            <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb80-4" data-line-number="4">                            <span class="dt">color =</span> continent))</a></code></pre>
<p>This code does <em>not</em> give a direct instruction like “color the points purple”. Instead it says, “the property ‘color’ will represent the variable <code>continent</code>”, or “color will map <code>continent</code>”. If we want to turn all the points in the figure purple, we do <em>not</em> do it through the mapping function. Look at what happens when we try:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb81-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb81-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb81-4" data-line-number="4">                          <span class="dt">color =</span> <span class="st">"purple"</span>))</a>
<a class="sourceLine" id="cb81-5" data-line-number="5">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb81-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<div class="figure"><span id="fig:ch-03-fig-lexp-gdp-07"/>
<p class="caption marginnote shownote">
Figure 3.10: What has gone wrong here?
</p>
<img src="../Images/5cf321e8ee5046c7708138606531ccb1.png" alt="What has gone wrong here?" width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-07-1.png"/>
</div>
<p>What has happened here? Why is there a legend saying “purple”? And why have the points all turned pinkish-red instead of purple? Remember, an aesthetic is a mapping of variables in your data to properties you can see on the graph. The <code>aes()</code> function is where that mapping is specified, and the function is trying to do its job. It wants to map a variable to the color aesthetic, so it assumes you are giving it a variable.<label for="tufte-mn-40" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-40" class="margin-toggle"/><span class="marginnote shownote">Just as in Chapter 1, when we were able to write ‘<code>my_numbers + 1</code>’ to add one to each element of the vector.</span> We have only given it one word, though—“purple”. Still, <code>aes()</code> will do its best to treat that word as though it were a variable. A variable should have as many observations as there are rows in the data, so <code>aes()</code> falls back on R’s recycling rules for making vectors of different lengths match up.</p>
<p>In effect, this creates a new categorical variable for your data. The string “purple” is recycled for every row of your data. Now you have a new column. Every element in it has the same value, “purple”. Then ggplot plots the results on the graph as you’ve asked it to, by mapping it to the <code>color</code> aesthetic. It dutifully makes a legend for this new variable. By default, ggplot displays the points falling into the category “purple” (which is all of them) using its default first-category hue … which is red.</p>
<p>The <code>aes()</code> function is for mappings only. Do not use it to change properties to a particular value. If we want to <em>set</em> a property, we do it in the <code>geom_</code> we are using, and <em>outside</em> the <code>mapping = aes(...)</code> step. Try this:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-08"/>
<img src="../Images/4a637ca648cb8a2b5edf8ddbb6e5988a.png" alt="Setting the color attribute of the points directly." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-08-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.11: Setting the color attribute of the points directly.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb82-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb82-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb82-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">"purple"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb82-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb82-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The <code>geom_point()</code> function can take a <code>color</code> argument directly, and R knows what color “purple” is. This is not part of the aesthetic mapping that defines the basic structure of the graphic. From the point of view of the grammar or logic of the graph, the fact that the points are colored purple has no significance. The color purple is not representing or mapping a variable or feature of the data in the relevant way.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-09"/>
<img src="../Images/db844341dc1449fb34c26dfe215020f0.png" alt="Setting some other arguments." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-09-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.12: Setting some other arguments.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb83-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp)) </a>
<a class="sourceLine" id="cb83-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"orange"</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">size =</span> <span class="dv">8</span>, <span class="dt">method =</span> <span class="st">"lm"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb83-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The various <code>geom_</code> functions can take many other arguments that will affect how the plot looks, but that do not involve mapping variables to aesthetic elements. Thus, those arguments will never go inside the <code>aes()</code> function. Some of the things we will want to set, like color or size, have the same name as mappable elements. Others, like the <code>method</code> or <code>se</code> arguments in <code>geom_smooth()</code> affect other aspects of the plot. In the code for Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-09">3.12</a>, the <code>geom_smooth()</code> call sets the line color to orange and sets its size (i.e., thickness) to 8, an unreasonably large value. We also turn off the <code>se</code> option by switching it from its default value of <code>TRUE</code> to <code>FALSE</code>. The result is that the standard error ribbon is not shown.</p>
<p>Meanwhile<label for="tufte-mn-41" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-41" class="margin-toggle"/><span class="marginnote shownote">It’s also possible to map a continuous variable directly to the alpha property, much like one might map a continuous variable to a single-color gradient. However, this is generally not an effective way of precisely conveying variation in quantity.</span> in the <code>geom_smooth()</code> call we set the <code>alpha</code> argument to 0.3. Like color, size, and shape, “alpha” is an aesthetic property that points (and some other plot elements) have, and to which variables can be mapped. It controls how transparent the object will appear when drawn. It’s measured on a scale of zero to one. An object with an alpha of zero will be completely transparent. Setting it to zero will make any other mappings the object might have, such as color or size, invisible as well. An object with an alpha of one will be completely opaque. Choosing an intermediate value can be useful when there is a lot of overlapping data to plot, as it makes it easier to see where the bulk of the observations are located.</p>
<div class="figure fullwidth"><span id="fig:ch-03-fig-lexp-gdp-10"/>
<img src="../Images/528814bf005572e3aa69ff08fea67934.png" alt="A more polished plot of Life Expectancy vs GDP." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-10-1.png"/>
<p class="caption marginnote shownote">
Figure 3.13: A more polished plot of Life Expectancy vs GDP.
</p>
</div>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb84-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"GDP Per Capita"</span>, <span class="dt">y =</span> <span class="st">"Life Expectancy in Years"</span>,</a>
<a class="sourceLine" id="cb84-6" data-line-number="6">         <span class="dt">title =</span> <span class="st">"Economic Growth and Life Expectancy"</span>,</a>
<a class="sourceLine" id="cb84-7" data-line-number="7">         <span class="dt">subtitle =</span> <span class="st">"Data points are country-years"</span>,</a>
<a class="sourceLine" id="cb84-8" data-line-number="8">         <span class="dt">caption =</span> <span class="st">"Source: Gapminder."</span>)</a></code></pre>
<p>We can now make a reasonably polished plot. We set the <code>alpha</code> of the points to a low value, make nicer x- and y-axis labels, and add a title, subtitle, and caption. As you can see in the code above, in addition to <code>x</code>, <code>y</code>, and any other aesthetic mappings in your plot (such as <code>size</code>, <code>fill</code>, or <code>color</code>), the <code>labs()</code> function can also set the text for <code>title</code>, <code>subtitle</code>, and <code>caption</code>. It controls the <em>main labels</em> of scales. The appearance of things like axis tick marks are the responsibility of various <code>scale_</code> functions, such as the <code>scale_x_log10()</code> function used here. We will learn more about what can be done with <code>scale_</code> functions soon.</p>
<p>Are there any variables in our data that can sensibly be mapped to the <code>color</code> aesthetic? Consider <code>continent</code>. In Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-11">3.14</a> the individual data points have been colored by <code>continent</code>, and a legend with a key to the colors has automatically been added to the plot. In addition, instead of one smoothing line we now have five. There is one for each unique value of the <code>continent</code> variable. This is a consequence of the way aesthetic mappings are inherited. Along with <code>x</code> and <code>y</code>, the <code>color</code> aesthetic mapping is set in the call to <code>ggplot()</code> that we used to creat the <code>p</code> object. Unless told otherwise, all geoms layered on top of the original plot object will inherit that object’s mappings. In this case we get both our points and smoothers colored by continent.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb85-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb85-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb85-4" data-line-number="4">                          <span class="dt">color =</span> continent))</a>
<a class="sourceLine" id="cb85-5" data-line-number="5">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb85-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb85-7" data-line-number="7"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-11"/>
<img src="../Images/a0fd0b66ad62e23457edd70756fa6d2a.png" alt="Mapping the continent variable to the color aesthetic." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-11-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.14: Mapping the continent variable to the color aesthetic.<!--</p>-->
<!--</div>--></span>
</p>
<p>If it is what we want, then we might also consider shading the standard error ribbon of each line to match its dominant color. The color of the standard error ribbon is controlled by the <code>fill</code> aesthetic. Whereas the <code>color</code> aesthetic affects the appearance of lines and points, <code>fill</code> is for the filled areas of bars, polygons and, in this case, the interior of the smoother’s standard error ribbon.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb86-4" data-line-number="4">                          <span class="dt">color =</span> continent,</a>
<a class="sourceLine" id="cb86-5" data-line-number="5">                          <span class="dt">fill =</span> continent))</a>
<a class="sourceLine" id="cb86-6" data-line-number="6">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb86-8" data-line-number="8"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-12"/>
<img src="../Images/d0fac1d82d45ee7eaabdec2d69bb1a77.png" alt="Mapping the continent variable to the color aesthetic, and correcting the error bars using the fill aesthetic." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-12-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.15: Mapping the continent variable to the color aesthetic, and correcting the error bars using the fill aesthetic.<!--</p>-->
<!--</div>--></span>
</p>
<p>Making sure that color and fill aesthetics match up consistently in
this way improves the overall look of the plot. In order to make it
happen we just need to specify that the mappings are to the same
variable in each case.</p>
</div>
<div id="aesthetics-can-be-mapped-per-geom" class="section level2">
<h2><span class="header-section-number">3.6</span> Aesthetics can be mapped per geom</h2>
<p>Perhaps five separate smoothers is too many, and we just want one line. But we still would like to have the points color-coded by continent. By default, geoms inherit their mappings from the <code>ggplot()</code> function. We can change this by mapping the aesthetics we want only the <code>geom_</code> functions that we want them to apply to. We use the same <code>mapping = aes(...)</code> expression as in the initial call to <code>ggplot()</code>, but now use it in the <code>geom_</code> functions as well, specifying only the mappings we want to apply to each one. Mappings specified only in the initial <code>ggplot()</code> function—here, <code>x</code> and <code>y</code>—will carry through to all subsequent geoms.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-13"/>
<img src="../Images/84973e15698acc2a6756470dedb62db6.png" alt="Mapping aesthetics on a per-geom basis. Here color is mapped to continent for the points but not the smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-13-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.16: Mapping aesthetics on a per-geom basis. Here color is mapped to continent for the points but not the smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb87-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> continent)) <span class="op">+</span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb87-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>It’s possible to map continuous variables to the <code>color</code> aesthetic, too. For example, we can map the log of each country-year’s population (<code>pop</code>) to <code>color</code>. (We can take the log of population right in the <code>aes()</code> statement, using the <code>log()</code> function. R will evaluate this for us quite happily.) When we do this, ggplot produces a gradient scale. It is continuous, but marked at intervals in the legend. Depending on the circumstances, mapping quantities like population to a continuous color gradient may be more or less effective than cutting the variable into categorical bins running, e.g., from low to high. In general it is always worth looking at the data in its continuous form first rather than cutting or binning it into categories.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-14"/>
<img src="../Images/b6fa2af5be9bb0293878a97e7fc2b565.png" alt="Mapping a continuous variable to color." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-14-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.17: Mapping a continuous variable to color.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb88-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb88-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb88-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">log</span>(pop))) <span class="op">+</span></a>
<a class="sourceLine" id="cb88-5" data-line-number="5"><span class="st">    </span><span class="kw">scale_x_log10</span>()    </a></code></pre>
<p>Finally, it is worth paying a little more attention to the way that ggplot draws its scales. Because every mapped variable has a scale, we can learn a lot about how a plot has been constructed, and what mappings it contains, by seeing what the legends look like. For example, take a closer look at the legends produced in Figures <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-12">3.15</a> and <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-13">3.16</a>.</p>
<div class="figure"><span id="fig:ch-03-fig-legends-combined"/>
<p class="caption marginnote shownote">
Figure 3.18: Guides and legends faithfully reflect the mappings they represent.
</p>
<img src="../Images/6e57e4eaeef8b9c1c8396189614f7471.png" alt="Guides and legends faithfully reflect the mappings they represent." width="80%" data-original-src="https://socviz.co/assets/ch-03-legends-combined.png"/>
</div>
<p>In the legend for the first figure, shown here on the left, we see several visual elements. The key for each continent shows a dot, a line, and a shaded background. The key for the second figure, shown on the right, has only a dot for each continent, with no shaded background or line. If you look again at the code for Figures <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-12">3.15</a> and <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-13">3.16</a>, you will see that in the first case we mapped the <code>continent</code> variable to both <code>color</code> and <code>fill</code>. We then drew the figure with <code>geom_point()</code> and fitted a line for each continent with <code>geom_smooth()</code>. Points have <code>color</code> but the smoother understands both <code>color</code> (for the line itself) and <code>fill</code> (for the shaded standard error ribbon). Each of these elements is represented in the legend: the point color, the line color, and the ribbon fill. In the second figure, we decided to simplify things by having only the points be colored by <code>continent</code>. Then we drew just a single smoother for the whole graph. Thus, in the legend for that figure, the colored line and the shaded box are both absent. We only see a legend for the mapping of <code>color</code> to <code>continent</code> in <code>geom_point()</code>. Meanwhile on the graph itself the line drawn by <code>geom_smooth()</code> is set by default to a bright blue, different from anything on the scale, and its shaded error ribbon is set by default to gray. Small details like this are not accidents. They are a direct consequence of ggplot’s grammatical way of thinking about the relationship between the data behind the plot and the visual elements that represent it.</p>
</div>
<div id="save-your-work" class="section level2">
<h2><span class="header-section-number">3.7</span> Save your work</h2>
<p>Now that you have started to make your own plots, you may be wondering how to save them, and perhaps also how to control their size and format. If you are working in an RMarkdown document then the plots you make will be embedded in it, as we have already seen. You can set the default size of plots within your <code>.Rmd</code> document by setting an option in your first code chunk. This one tells R to make 8x5 figures:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">fig.width=</span><span class="dv">8</span>, <span class="dt">fig.height=</span><span class="dv">5</span>) </a></code></pre>
<p>Because you will be making plots of different sizes and shapes, sometimes you will want to control the size of particular plots, without changing the default. To do this, you can add the same options to any particular chunk inside the curly braces at the beginning. Remember, each chunk opens with three backticks and then a pair of braces containing the language name (for us always <code>r</code>) and an optional label:</p>
<p class="sourceCode"/><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb90-1" data-line-number="1">```{r example}</a>
<a class="sourceLine" id="cb90-2" data-line-number="2">p + geom_point()</a>
<a class="sourceLine" id="cb90-3" data-line-number="3">```</a></code></pre>
<p>You can follow the label with a comma and provide a series of options if needed. They will apply only to that chunk. To make a figure twelve inches wide and nine inches high we say e.g. <code>{r example, fig.width = 12, fig.height = 9}</code> in the braces section.</p>
<p>You will often need to save your figures individually, as they will
end up being dropped into slides or published in papers that are not
produced using RMarkdown. Saving a figure to a file can be done in
several different ways. When working with <code>ggplot</code>, the easiest way is
to use the <code>ggsave()</code> function. To save the most recently displayed
figure, we provide the name we want to save it under:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="dt">filename =</span> <span class="st">"my_figure.png"</span>)</a></code></pre>
<p>This<label for="tufte-mn-42" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-42" class="margin-toggle"/><span class="marginnote shownote">Several other file formats are available as well. See the function’s help page for details.</span> will save the figure as a PNG file, a format suitable for displaying on web pages. If you want a PDF instead, change the extension of the file:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="dt">filename =</span> <span class="st">"my_figure.pdf"</span>)</a></code></pre>
<p>Remember that, for convenience, you do not need to write <code>filename =</code> as long as the name of the file is the first argument you give <code>ggsave()</code>. You can also pass plot objects to <code>ggsave()</code>. For example, we can put our recent plot into an object called <code>p_out</code> and then tell <code>ggave()</code> that we want to save that object.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1">p_out &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a>
<a class="sourceLine" id="cb93-4" data-line-number="4"/>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="kw">ggsave</span>(<span class="st">"my_figure.pdf"</span>, <span class="dt">plot =</span> p_out)</a></code></pre>
<p>When saving your work, it is sensible to have a subfolder (or more
than one, depending on the project) where you save only figures. You
should also take care to name your saved figures in a sensible way.
<code>fig_1.pdf</code> or <code>my_figure.pdf</code> are not good names. Figure names should
be compact but descriptive, and consistent between figures within a
project. In addition, although it really shouldn’t be the case in this
day and age, it is also wise to play it safe and avoid file names
containing characters likely to make your code choke in future. These
include apostrophes, backticks, spaces, forward and back slashes, and
quotes.</p>
<p>The Appendix contains a short discussion of how to organize your files within your project folder. Treat the project folder as the home base of your work for the paper or work you are doing, and put your data and figures in subfolders within the project folder. To begin with, using your file manager, create a folder named “figures” inside your project folder. When saving figures, you can use Kirill Müller’s handy <code>here</code> library to make it easier to work with files and subfolders while not having to type in full file paths. Load the library in the setup chunk of your RMarkdown document. When you do, it tells you where “here” is for the current project. You will see a message saying something like this, with your file path and user name instead of mine:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="co"># here() starts at /Users/kjhealy/projects/socviz</span></a></code></pre>
<p>You can then use the <code>here()</code> function to make loading and saving your
work more straightforward and safer. Assuming a folder named “figures” exists in your project folder, you can do this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="kw">here</span>(<span class="st">"figures"</span>, <span class="st">"lifexp_vs_gdp_gradient.pdf"</span>), <span class="dt">plot =</span> p_out)</a></code></pre>
<p>This saves <code>p_out</code> as a file called <code>lifeexp_vs_gdp_gradient.pdf</code> in the <code>figures</code> directory <em>here</em>, i.e. in your current project folder.</p>
<p>You can save your figure in a variety of different formats, depending
on your needs (and also, to a lesser extent, on your particular
computer system). The most important distinction to bear in mind is
between <em>vector</em> formats and <em>raster</em> formats. A file with a <em>vector</em>
format, like PDF or SVG, is stored as a set of instructions about
lines, shapes, colors, and their relationships. The viewing software
(such as Adobe Acrobat or Apple’s Preview application for PDFs) then
interprets those instructions and displays the figure. Representing
the figure this way allows it to be easily resized without becoming
distorted. The underlying language of the PDF format is Postscript,
which is also the language of modern typesetting and printing. This
makes a vector-based format like PDF the best choice for submission to
journals.</p>
<p>A <em>raster</em> based format, on the other hand, stores images essentially
as a grid of pixels of a pre-defined size with information about the
location, color, brightness, and so on of each pixel in the grid. This
makes for more efficient storage, especially when used in conjunction
with compression methods that take advantage of redundancy in images
in order to save space. Formats like JPG are compressed raster
formats. A PNG file is a raster image format that supports lossless
compression. For graphs containing an awful lot of data, PNG files
will tend to be much smaller than the corresponding PDF. However,
raster formats cannot be easily resized. In particular they cannot be
expanded in size without becoming pixelated or grainy. Formats like
JPG and PNG are the standard way that images are displayed on the web.
The more recent SVG format is vector-based format but also
nevertheless supported by many web browsers.</p>
<p>In general you should save your work in several different formats.
When you save in different formats and in different sizes you may need
to experiment with the scaling of the plot and the size of the fonts
in order to get a good result. The <code>scale</code> argument to <code>ggsave()</code> can
help you here (you can try out different values, like <code>scale=1.3</code>,
<code>scale=5</code>, and so on). You can also use <code>ggave()</code> to explicitly set
the height and width of your plot in the units that you choose.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="kw">here</span>(<span class="st">"figures"</span>, <span class="st">"lifexp_vs_gdp_gradient.pdf"</span>),</a>
<a class="sourceLine" id="cb96-2" data-line-number="2">       <span class="dt">plot =</span> p_out, <span class="dt">height =</span> <span class="dv">8</span>, <span class="dt">width =</span> <span class="dv">10</span>, <span class="dt">units =</span> <span class="st">"in"</span>)</a></code></pre>
<p>Now that you know how to do that, let’s get back to making more graphs.</p>
</div>
<div id="where-to-go-next-2" class="section level2">
<h2><span class="header-section-number">3.8</span> Where to go next</h2>
<p>Start by playing around with the <code>gapminder</code> data a little more. You can try each of these explorations with <code>geom_point()</code> and then with <code>geom_smooth()</code>, or both together.</p>
<ul>
<li>What happens when you put the <code>geom_smooth()</code> function before <code>geom_point()</code> instead of after it? What does this tell you about how the plot is drawn? Think about how this might be useful when drawing plots.</li>
<li>Change the mappings in the <code>aes()</code> function so that you plot Life Expectancy against population (<code>pop</code>) rather than per capita GDP. What does that look like? What does it tell you about the unit of observation in the dataset?</li>
<li>Try some alternative scale mappings. Besides <code>scale_x_log10()</code> you can try <code>scale_x_sqrt()</code> and <code>scale_x_reverse()</code>. There are corresponding functions for y-axis transformations. Just write <code>y</code> instead of <code>x</code>. Experiment with them to see what sort of effect they have on the plot, and whether they make any sense to use.</li>
<li>What happens if you map <code>color</code> to <code>year</code> instead of <code>continent</code>? Is the result what you expected? Think about what class of object <code>year</code> is. Remember you can get a quick look at the top of the data, which includes some shorthand information on the class of each variable, by typing <code>gapminder</code>.</li>
<li>Instead of mapping <code>color = year</code>, what happens if you try <code>color = factor(year)</code>?</li>
<li>As you look at these different scatterplots, think about Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-10">3.13</a> a little more critically. We worked it up to the point where it was reasonably polished, but is it really the best way to display this country-year data? What are we gaining and losing by ignoring the temporal and country-level structure of the data? How could we do better? Sketch out what an alternative visualization might look like.</li>
</ul>
<p>As you begin to experiment, remember two things. First, it’s always worth trying something, even if you’re not sure what’s going to happen. Don’t be afraid of the console.<label for="tufte-mn-43" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-43" class="margin-toggle"/><span class="marginnote shownote">This license does not extend to, for example, overwriting or deleting your data by mistake. You should still manage your project responsibly, at a minimum keeping good backups. But within R and at the level of experimenting with graphs at the console, you have a lot of freedom.</span> The nice thing about making your graphics through code is that you won’t break anything you can’t reproduce. If something doesn’t work, you can figure out what happened, fix things, and re-run the code to make the graph again.</p>
<p>Second, remember that the main flow of action in ggplot is always the same. You start with a table of data, you map the variables you want to display to aesthetics like position, color, or shape, and you choose one or more geoms to draw the graph. In your code this gets accomplished by making an object with the basic information about data and mappings, and then adding or layering additional information as needed. Once you get used to this way of thinking about your plots, especially the aesthetic mapping part, then drawing them becomes easier. Instead of having to think about how to draw particular shapes or colors on the screen, the many <code>geom_</code> functions take care of that for you. In the same way, learning new geoms is easier once you think of them as ways to display aesthetic mappings that you specify. Most of the learning curve with ggplot involves getting used to this way of thinking about your data and its representation in a plot. In the next chapter, we will flesh out these ideas a little more, cover some common ways plots go “wrong” (i.e., when they end up looking strange), and learn how to recognize and avoid those problems.</p>

</div>
&#13;

<h2><span class="header-section-number">3.1</span> How ggplot works</h2>
<p>As we saw in Chapter <a href="lookatdata.html#lookatdata">1</a>, visualization involves representing your data
data using lines or shapes or colors and so on. There is some
structured relationship, some <em>mapping</em>, between the variables in your
data and their representation in the plot displayed on your screen or
on the page. We also saw that not all mappings make sense for all
types of variables, and (independently of this), some representations
are harder to interpret than others. Ggplot provides you with a set of
tools to map data to visual elements on your plot, to specify the kind
of plot you want, and then subsquently to control the fine details of
how it will be displayed. Figure <a href="makeplot.html#fig:ggplot-flow">3.1</a> shows a
schematic outline of the process starting from data, at the top, down
to a finished plot at the bottom. Don’t worry about the details for
now. We will be doing into them one piece at a time over the next few
chapters.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ggplot-flow"/>
<img src="../Images/c1ff2f5d98f9f5a0f2ee592c6c4b484c.png" alt="The main elements of ggplot's grammar of graphics. This chapter goes through these steps in detail." width="100%" data-original-src="https://socviz.co/assets/ch-03-ggplot-flow-vertical.png"/>
<!--
<p class="caption marginnote">-->Figure 3.1: The main elements of ggplot’s grammar of graphics. This chapter goes through these steps in detail.<!--</p>-->
<!--</div>--></span>
</p>
<p>The most important thing to get used to with ggplot is the way you use
it to think about the logical structure of your plot. The code you
write specifies the connections between the variables in your data,
and the colors, points, and shapes you see on the screen. In ggplot,
these logical connections between your data and the plot elements are
called <em>aesthetic mappings</em> or just <em>aesthetics</em>. You begin every plot
by telling the <code>ggplot()</code> function what your data is, and then how the
variables in this data logically map onto the plot’s aesthetics. Then
you take the result and say what general sort of plot you want, such
as a scatterplot, a boxplot, or a bar chart. In ggplot, the overall
type of plot is called a <em>geom</em>. Each geom has a function that creates
it. For example, <code>geom_point()</code> makes scatterplots, <code>geom_bar()</code> makes
barplots, <code>geom_boxplot()</code> makes boxplots, and so on. You combine
these two pieces, the <code>ggplot()</code> object and the <code>geom</code>, by literally
adding them together in an expression, using the “<code>+</code>” symbol.</p>
<p>At this point, ggplot will have enough information to be able to draw
a plot for you. The rest is just details about exactly what you want
to see. If you don’t specify anything further, ggplot will use a set
of defaults that try to be sensible about what gets drawn. But more
often, you will want to specify exactly what you want, including
information about the scales, the labels of legends and axes, and
other guides that help people to read the plot. These additional
pieces are added to the plot in the same way as the <code>geom_</code> function
was. Each component has it own function, you provide arguments to it
specifying what to do, and you literally add it to the sequence of
instructions. In this way you systematically build your plot piece by
piece.</p>
<p>In this chapter we will go through the main steps of this process. We
will proceed by example, repeatedly building a series of plots. As
noted earlier, I <em>strongly</em> encourage you go through this exercise
manually, typing (rather than copying-and-pasting) the code yourself.
This may seem a bit tedious, but it is <em>by far</em> the most effective way
to get used to what is happening, and to get a feel for R’s syntax.
While you’ll inevitably make some errors, you will also quickly find
yourself becoming able to diagnose your own errors, as well as having
a better grasp of the higher-level structure of plots. You should open
the RMarkdown file for your notes, remember to load the tidyverse
library<label for="tufte-mn-32" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-32" class="margin-toggle"/><span class="marginnote shownote"><code>library(tidyverse)</code></span> and write the code
out in chunks, interspersing your own notes and comments as you go.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:gaptab1">Table 3.1: </span>Life Expectancy data in wide format.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">1952</th>
<th align="right">1957</th>
<th align="right">1962</th>
<th align="right">1967</th>
<th align="right">1972</th>
<th align="right">1977</th>
<th align="right">1982</th>
<th align="right">1987</th>
<th align="right">1992</th>
<th align="right">1997</th>
<th align="right">2002</th>
<th align="right">2007</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">29</td>
<td align="right">30</td>
<td align="right">32</td>
<td align="right">34</td>
<td align="right">36</td>
<td align="right">38</td>
<td align="right">40</td>
<td align="right">41</td>
<td align="right">42</td>
<td align="right">42</td>
<td align="right">42</td>
<td align="right">44</td>
</tr>
<tr class="even">
<td align="left">Albania</td>
<td align="right">55</td>
<td align="right">59</td>
<td align="right">65</td>
<td align="right">66</td>
<td align="right">68</td>
<td align="right">69</td>
<td align="right">70</td>
<td align="right">72</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">76</td>
<td align="right">76</td>
</tr>
<tr class="odd">
<td align="left">Algeria</td>
<td align="right">43</td>
<td align="right">46</td>
<td align="right">48</td>
<td align="right">51</td>
<td align="right">55</td>
<td align="right">58</td>
<td align="right">61</td>
<td align="right">66</td>
<td align="right">68</td>
<td align="right">69</td>
<td align="right">71</td>
<td align="right">72</td>
</tr>
<tr class="even">
<td align="left">Angola</td>
<td align="right">30</td>
<td align="right">32</td>
<td align="right">34</td>
<td align="right">36</td>
<td align="right">38</td>
<td align="right">39</td>
<td align="right">40</td>
<td align="right">40</td>
<td align="right">41</td>
<td align="right">41</td>
<td align="right">41</td>
<td align="right">43</td>
</tr>
<tr class="odd">
<td align="left">Argentina</td>
<td align="right">62</td>
<td align="right">64</td>
<td align="right">65</td>
<td align="right">66</td>
<td align="right">67</td>
<td align="right">68</td>
<td align="right">70</td>
<td align="right">71</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">74</td>
<td align="right">75</td>
</tr>
<tr class="even">
<td align="left">Australia</td>
<td align="right">69</td>
<td align="right">70</td>
<td align="right">71</td>
<td align="right">71</td>
<td align="right">72</td>
<td align="right">73</td>
<td align="right">75</td>
<td align="right">76</td>
<td align="right">78</td>
<td align="right">79</td>
<td align="right">80</td>
<td align="right">81</td>
</tr>
</tbody>
</table>

&#13;

<h2><span class="header-section-number">3.2</span> Tidy data</h2>
<p>The tidyverse tools we will be using want to see your data in a
particular sort of shape, generally referred to as “tidy data”
<span class="citation">(Wickham, 2014)</span>. Social scientists will likely be familiar with the
distinction between <em>wide format</em> and <em>long format</em> data. In a long
format table, every variable is a column, and every observation is a
row. In a wide format table, some variables are spread out across
columns. For example, Table <a href="makeplot.html#tab:gaptab1">3.1</a> shows part of a table
of life expectancy over time for a series of countries. This is in
wide format, because one of the variables, year, is spread across
the columns of the table.</p>
<p>By contrast, Table <a href="makeplot.html#tab:gaptab2">3.2</a> shows the beginning of the same
data in long format. The tidy data that ggplot wants is in this long
form. In a related bit of terminology, in this table the <code>year</code>
variable is sometimes called a <em>key</em> and the <code>lifeExp</code> variable is the
<em>value</em> taken by that key for any particular row. These terms are
useful when converting tables from wide to long format. I am speaking
fairly loosely here. Underneath these terms there is a worked-out
theory of the forms that tabular data can be stored in, but right now
we don’t need to know those additional details. For more on the ideas
behind tidy data, see the discussion in the Appendix. You will also
find an example showing the R code you need to get from an untidy to a
tidy shape for the common “wide” case where some variables are spread
out across the columns of your table.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:gaptab2">Table 3.2: </span>Life Expectancy data in long format.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">country</th>
<th align="right">year</th>
<th align="right">lifeExp</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1952</td>
<td align="right">29</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1957</td>
<td align="right">30</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1962</td>
<td align="right">32</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1967</td>
<td align="right">34</td>
</tr>
<tr class="odd">
<td align="left">Afghanistan</td>
<td align="right">1972</td>
<td align="right">36</td>
</tr>
<tr class="even">
<td align="left">Afghanistan</td>
<td align="right">1977</td>
<td align="right">38</td>
</tr>
</tbody>
</table>

<p>If you compare Tables <a href="makeplot.html#tab:gaptab1">3.1</a> and <a href="makeplot.html#tab:gaptab2">3.2</a>, it is
clear that a tidy table does not present data in its most compact
form. In fact, it is usually not how you would choose to present your
data if you wanted to just show people the numbers. Neither is untidy
data “messy” or the “wrong” way to lay out data in some generic sense.
It’s just that, even if its long-form shape makes tables larger, tidy
data is much more straightforward to work with when it comes to
specifying the mappings that you need to coherently describe plots.</p>
&#13;

<h2><span class="header-section-number">3.3</span> Mappings link data to things you see</h2>
<p>It’s useful to think of a recipe or template that we start from each
time we want to make a plot. This is shown in Figure
<a href="makeplot.html#fig:ch-03-ggplot-formula-schematic">3.2</a>. We start with just one object of
our own, our data, which should be in a shape that ggplot understands.
Usually this will be a <em>data frame</em> or some augmented version of it,
like a <em>tibble</em>. We tell the core <code>ggplot</code> function what our data is.
In this book, we will do this by creating an object named <code>p</code> which
will contain the core information for our plot. (The name <code>p</code> is just
a convenience.) Then we choose a plot type, or <em>geom</em> and add it to
<code>p</code>. From there, we add more features to the plot as needed, such as
additional elements, adjusted scales, a title, or other
labels as needed.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-ggplot-formula-schematic"/>
<img src="../Images/56281a77d6137fdd488cb29f21b9c816.png" alt="A schematic for making a plot." width="254" data-original-src="https://socviz.co/assets/ch-03-ggplot-formula-schematic.png"/>
<!--
<p class="caption marginnote">-->Figure 3.2: A schematic for making a plot.<!--</p>-->
<!--</div>--></span>
</p>
<p>We’ll use the gapminder data to make our first plots. Make sure the
library containing the data is loaded. If you are following through from the previous Chapter in the same RStudio session or RMarkdown document, you won’t have to load it again. Otherwise, use <code>library()</code> to make it available.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb67-1" data-line-number="1"><span class="kw">library</span>(gapminder)</a></code></pre>
<p>We can remind ourselves again what it looks like by typing the name of the object at the console:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb68-1" data-line-number="1">gapminder</a></code></pre>
<pre><code>## # A tibble: 1,704 x 6
##    country     continent  year lifeExp      pop gdpPercap
##    &lt;fct&gt;       &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1 Afghanistan Asia       1952    28.8  8425333       779
##  2 Afghanistan Asia       1957    30.3  9240934       821
##  3 Afghanistan Asia       1962    32.0 10267083       853
##  4 Afghanistan Asia       1967    34.0 11537966       836
##  5 Afghanistan Asia       1972    36.1 13079460       740
##  6 Afghanistan Asia       1977    38.4 14880372       786
##  7 Afghanistan Asia       1982    39.9 12881816       978
##  8 Afghanistan Asia       1987    40.8 13867957       852
##  9 Afghanistan Asia       1992    41.7 16317921       649
## 10 Afghanistan Asia       1997    41.8 22227415       635
## # ... with 1,694 more rows</code></pre>
<p>Let’s say we want to plot Life Expectancy against per capita GDP
for all country-years in the data. We’ll do this by creating an object
that has some of the necessary information in it, and build it up from
there. First, we must tell the <code>ggplot()</code> function what data we are
using.<label for="tufte-mn-33" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-33" class="margin-toggle"/><span class="marginnote shownote">Remember, use <code>Option+minus</code> on MacOS or <code>Alt+minus</code> on Windows to type the assignment operator.</span></p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb70-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder)</a></code></pre>
<p>At this point ggplot knows our data, but not what the
<em>mapping</em>. That is,<label for="tufte-mn-34" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-34" class="margin-toggle"/><span class="marginnote shownote">You do not need to explicitly name the arguments you pass to functions, as long as you provide them in the expected order, viz, the order listed on the help page for the function. This code would still work if we omitted <code>data = </code> and <code>mapping = </code>. In this book, I name all the arguments for clarity.</span> we need to tell it which variables in the data should be represented by which visual elements in the plot. It also doesn’t know what sort of plot we want. In ggplot, mappings are specified using the <code>aes()</code>
function. Like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb71-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb71-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb71-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a></code></pre>
<p>Here we’ve given the <code>ggplot()</code> function two arguments instead of one: <code>data</code> and <code>mapping</code>. The <code>data</code> argument tells ggplot where to find the variables it is about to use. This saves us from having to tediously dig out the name of each variable in full. Instead, any mentions of variables will be looked for here first.</p>
<p>Next, the mapping. The <code>mapping</code> argument is not a data object, nor is
it a character string. Instead, it’s a function. (Remember, functions
can be nested inside other functions.) The arguments we give to the
<code>aes</code> function are a sequence of definitions that <code>ggplot</code> will use
later. Here they say, “The variable on the x-axis is going to be
<code>gdpPercap</code>, and the variable on the y-axis is going to be <code>lifeExp</code>.”
The <code>aes()</code> function does not say where variables with those names are
to be found. That’s because <code>ggplot()</code> is going to assume things with
that name are in the object given to the <code>data</code> argument.</p>
<p>The <code>mapping = aes(...)</code> argument <em>links variables</em> to <em>things you
will see</em> on the plot. The <code>x</code> and <code>y</code> values are the most obvious
ones. Other aesthetic mappings can include, for example, color, shape,
size, and line type (whether a line is solid or dashed, or some other
pattern). We’ll see examples in a minute. A mapping does not directly
say what particular, e.g., colors or shapes will be on the plot.
Rather they say which <em>variables</em> in the data will be <em>represented</em> by
visual elements like a color, a shape, or a point on the plot area.</p>
<p>What happens if we just type <code>p</code> at the console at this point and hit
return?</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:unnamed-chunk-25"/>
<img src="../Images/47dad5f7b71ab7ea157c35ee278b93cf.png" alt="This empty plot has no geoms." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/unnamed-chunk-25-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.3: This empty plot has no geoms.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb72-1" data-line-number="1">p</a></code></pre>
<p>The <code>p</code> object has been created by the <code>ggplot()</code> function, and already has information in it about the mappings we want, together with a lot of other information added by default. (If you want to see just how much information is in the <code>p</code> object already, try asking for <code>str(p)</code>.) However, we haven’t given it any instructions get about what sort of plot to draw. We need to add a <em>layer</em> to the plot. This means picking a <code>geom_</code> function. We will use <code>geom_point()</code>. It knows how to take <code>x</code> and <code>y</code> values and plot them in a scatterplot.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb73-1" data-line-number="1">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() </a></code></pre>
<div class="figure"><span id="fig:ch-03-fig-lexp-gdp-01"/>
<p class="caption marginnote shownote">
Figure 3.4: A scatterplot of Life Expectancy vs GDP
</p>
<img src="../Images/3499497ffdaedc0433bcaf755af3df94.png" alt="A scatterplot of Life Expectancy vs GDP" width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-01-1.png"/>
</div>
<p>Success!</p>
&#13;

<h2><span class="header-section-number">3.4</span> Build your plots layer by layer</h2>
<p>Although we got a brief taste of ggplot at the end of Chapter
<a href="gettingstarted.html#gettingstarted">2</a>, we spent more time in that Chaper preparing the
ground to make this first proper graph. We set up our software IDE and
made sure we could reproduce our work. We then learned the basics of
how R works, and the sort of tidy data that ggplot expects. Just now
we went through the logic of ggplot’s main idea, of building up plots
a piece at a time in a systematic and predictable fashion, beginning
with a mapping between a variable and an aesthetic element. We have
done a lot of work and produced one plot.</p>
<p>The good news is that, from now on, not much will change conceptually
about what we are doing. It will be more a question of learning in
greater detail about how to tell ggplot what to do. We will learn more
about the different geoms (or types of plot) available, and find out
about the functions that control the coordinate system, scales,
guiding elements (like labels and tick marks), and thematic features
of plots. This will allow us to make much more sophisticated plots
surprisingly fast. Conceptually, however, we will always be doing the
same thing. We will start with a table of data that has been tidied,
and then we will:</p>
<ol style="list-style-type: decimal">
<li>Tell the <code>ggplot()</code> function what our data is.<label for="tufte-mn-35" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-35" class="margin-toggle"/><span class="marginnote shownote">The <code>data = …</code> step.</span></li>
<li>Tell <code>ggplot()</code> <em>what</em> relationships we want to see.<label for="tufte-mn-36" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-36" class="margin-toggle"/><span class="marginnote shownote">The <code>mapping = aes(…)</code> step.</span> For convenience we will put the results of the first two steps in an object called <code>p</code>.</li>
<li>Tell <code>ggplot</code> <em>how</em> we want to see the relationships in our data.<label for="tufte-mn-37" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-37" class="margin-toggle"/><span class="marginnote shownote">Choose a geom.</span></li>
<li>Layer on geoms as needed, by adding them to the <code>p</code> object one at a time.</li>
<li>Use<label for="tufte-mn-38" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-38" class="margin-toggle"/><span class="marginnote shownote">The <code>scale_,</code> family, <code>labs()</code> and <code>guides()</code> functions.</span> some additional functions to adjust scales, labels, tick marks, titles. We’ll learn more about some of these functions shortly.</li>
</ol>
<p>To begin with we will let ggplot use its defaults for many of these
elements. The coordinate system used in plots is most often cartesian,
for example. It is a plane defined by an x axis and a y axis. This is
what ggplot assumes, unless you tell it otherwise. But we will quickly start making some adjustments.
Bear in mind once again that the process of adding layers to the plot really is <em>additive</em>.<label for="tufte-mn-39" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-39" class="margin-toggle"/><span class="marginnote shownote">In effect we create one big object that is a nested list of instructions for how to draw each piece of the plot.</span> Usually in R, functions cannot simply be added to objects. Rather, they take objects as inputs and produce objects as outputs.
But the objects created by ggplot() are special. This makes it easier to assemble plots one piece at a time, and to inspect how they look at every step. For example, let’s try a different <code>geom_</code> function with our plot.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-02"/>
<img src="../Images/0469c2175ab50a6df7a006a61a34e03b.png" alt="Life Expectancy vs GDP, using a smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.5: Life Expectancy vs GDP, using a smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb74-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb74-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb74-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb74-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>()</a></code></pre>
<p>You can see right away that some of these geoms do a lot more than simply put points on a grid. Here <code>geom_smooth()</code> has calculated a smoothed line for us and shaded in a ribbon showing the standard error for the line. If we want to see the data points and the line together, we simply add <code>geom_point()</code> back in:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-03"/>
<img src="../Images/20c96ac9f9ee066dad98ea66fbc317a1.png" alt="Life Expectancy vs GDP, showing both points and a GAM smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-03-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.6: Life Expectancy vs GDP, showing both points and a GAM smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb75-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb75-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb75-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb75-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>() </a></code></pre>
<pre><code>## `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</code></pre>
<p>The console message R tells you the <code>geom_smooth()</code> function is using a <code>method</code> called <code>gam</code>, which in this case means it has fit a generalized additive model. This suggests that maybe there are other methods that <code>geom_smooth()</code> understands, and which we might tell it to use instead. Instructions are given to functions via their arguments, so we can try adding <code>method = "lm"</code> (for “linear model”) as an argument to <code>geom_smooth()</code>:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-04"/>
<img src="../Images/b464fa693cd69f46ffe0f320331102a8.png" alt="Life Expectancy vs GDP, points and an ill-advised linear fit." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.7: Life Expectancy vs GDP, points and an ill-advised linear fit.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb77-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb77-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb77-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb77-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>) </a></code></pre>
<p>We did not have to tell <code>geom_point()</code> or <code>geom_smooth()</code>
where their data was coming from, or what mappings they should use.
They <em>inherit</em> this information from the original <code>p</code> object. As we’ll
see later, it’s possible to give geoms separate instructions that they
will follow instead. But in the absence of any other information, the
geoms will look for the instructions it needs in the <code>ggplot()</code>
function, or the object created by it.</p>
<p>In our plot, the data is quite bunched up against the left side. Gross Domestic Product per capita is not normally distributed across our country years. The x-axis scale would probably look better if it were transformed from a linear scale to a log scale. For this we can use a function called <code>scale_x_log10()</code>. As you might expect this function scales the x-axis of a plot to a log 10 basis. To use it we just add it to the plot:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-05"/>
<img src="../Images/89cc54d50b54a4a8385915808ec2c87c.png" alt="Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-05-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.8: Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb78-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb78-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb78-3" data-line-number="3">                          <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb78-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb78-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb78-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The x-axis transformation repositions the points, and also changes the shape the smoothed line. (We switched back to <code>gam</code> from <code>lm</code>.) While <code>ggplot()</code> and its associated functions have not made any changes to our underlying data frame, the scale transformation is applied to the data before the smoother is layered on to the plot. There are a variety of scale transformations that you can use in just this way. Each is named for the transformation you want to apply, and the axis you want to applying it to. In this case we use <code>scale_x_log10()</code>.</p>
<p>At this point, if our goal was just to show a plot of Life Expectancy vs GDP using sensible scales and adding a smoother, we would be thinking about polishing up the plot with nicer axis labels and a title. Perhaps we might also want to replace the scientific notation on the x-axis with the dollar value it actually represents. We can do both of these things quite easily. Let’s take care of the scale first. The labels on the tick-marks can be controlled through the <code>scale_</code> functions. While it’s possible to roll your own function to label axes (or just supply your labels manually, as we will see later), there’s also a handy <code>scales</code> library that contains some useful pre-made formatting functions. We can either load the whole library with <code>library(scales)</code> or, more conveniently, just grab the specific formatter we want from that library. Here it’s the <code>dollar()</code> function. To grab a function directly from a library we have not loaded, we use the syntax <code>thelibrary::thefunction</code>. So, we can do this:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-06"/>
<img src="../Images/52f0a9f105ac6e60c79d2503c117395d.png" alt="Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis, with better labels on the tick marks." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-06-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.9: Life Expectancy vs GDP scatterplot, with a GAM smoother and a log scale on the x-axis, with better labels on the tick marks.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb79-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb79-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb79-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb79-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar)</a></code></pre>
<p>We will learn more about scale transformations later. For now,
just remember two things about them. First, you can directly transform
your x or y axis by adding something like <code>scale_x_log10()</code> or
<code>scale_y_log10()</code> to your plot. When you do so, the x or y axis will
be transformed and, by default, the tick marks on the axis will be
labeled using scientific notation. Second, you can give these <code>scale_</code>
functions a <code>labels</code> argument that reformats the text printed
underneath the tick marks on the axes. Inside the <code>scale_x_log10()</code>
function try <code>labels=scales::comma</code>, for example.</p>
&#13;

<h2><span class="header-section-number">3.5</span> Mapping aesthetics vs setting them</h2>
<p>An <em>aesthetic mapping</em> specifies that a variable will be expressed by one of the available visual elements, such as size, or color, or shape, and so on. As we’ve seen, we map variables to aesthetics like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb80-1" data-line-number="1">p &lt;-<span class="st">  </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb80-2" data-line-number="2">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb80-3" data-line-number="3">                            <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb80-4" data-line-number="4">                            <span class="dt">color =</span> continent))</a></code></pre>
<p>This code does <em>not</em> give a direct instruction like “color the points purple”. Instead it says, “the property ‘color’ will represent the variable <code>continent</code>”, or “color will map <code>continent</code>”. If we want to turn all the points in the figure purple, we do <em>not</em> do it through the mapping function. Look at what happens when we try:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb81-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb81-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb81-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb81-4" data-line-number="4">                          <span class="dt">color =</span> <span class="st">"purple"</span>))</a>
<a class="sourceLine" id="cb81-5" data-line-number="5">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb81-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb81-7" data-line-number="7"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<div class="figure"><span id="fig:ch-03-fig-lexp-gdp-07"/>
<p class="caption marginnote shownote">
Figure 3.10: What has gone wrong here?
</p>
<img src="../Images/5cf321e8ee5046c7708138606531ccb1.png" alt="What has gone wrong here?" width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-07-1.png"/>
</div>
<p>What has happened here? Why is there a legend saying “purple”? And why have the points all turned pinkish-red instead of purple? Remember, an aesthetic is a mapping of variables in your data to properties you can see on the graph. The <code>aes()</code> function is where that mapping is specified, and the function is trying to do its job. It wants to map a variable to the color aesthetic, so it assumes you are giving it a variable.<label for="tufte-mn-40" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-40" class="margin-toggle"/><span class="marginnote shownote">Just as in Chapter 1, when we were able to write ‘<code>my_numbers + 1</code>’ to add one to each element of the vector.</span> We have only given it one word, though—“purple”. Still, <code>aes()</code> will do its best to treat that word as though it were a variable. A variable should have as many observations as there are rows in the data, so <code>aes()</code> falls back on R’s recycling rules for making vectors of different lengths match up.</p>
<p>In effect, this creates a new categorical variable for your data. The string “purple” is recycled for every row of your data. Now you have a new column. Every element in it has the same value, “purple”. Then ggplot plots the results on the graph as you’ve asked it to, by mapping it to the <code>color</code> aesthetic. It dutifully makes a legend for this new variable. By default, ggplot displays the points falling into the category “purple” (which is all of them) using its default first-category hue … which is red.</p>
<p>The <code>aes()</code> function is for mappings only. Do not use it to change properties to a particular value. If we want to <em>set</em> a property, we do it in the <code>geom_</code> we are using, and <em>outside</em> the <code>mapping = aes(...)</code> step. Try this:</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-08"/>
<img src="../Images/4a637ca648cb8a2b5edf8ddbb6e5988a.png" alt="Setting the color attribute of the points directly." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-08-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.11: Setting the color attribute of the points directly.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb82-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb82-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb82-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb82-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">color =</span> <span class="st">"purple"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb82-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb82-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The <code>geom_point()</code> function can take a <code>color</code> argument directly, and R knows what color “purple” is. This is not part of the aesthetic mapping that defines the basic structure of the graphic. From the point of view of the grammar or logic of the graph, the fact that the points are colored purple has no significance. The color purple is not representing or mapping a variable or feature of the data in the relevant way.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-09"/>
<img src="../Images/db844341dc1449fb34c26dfe215020f0.png" alt="Setting some other arguments." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-09-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.12: Setting some other arguments.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb83-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb83-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb83-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp)) </a>
<a class="sourceLine" id="cb83-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb83-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"orange"</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">size =</span> <span class="dv">8</span>, <span class="dt">method =</span> <span class="st">"lm"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb83-6" data-line-number="6"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>The various <code>geom_</code> functions can take many other arguments that will affect how the plot looks, but that do not involve mapping variables to aesthetic elements. Thus, those arguments will never go inside the <code>aes()</code> function. Some of the things we will want to set, like color or size, have the same name as mappable elements. Others, like the <code>method</code> or <code>se</code> arguments in <code>geom_smooth()</code> affect other aspects of the plot. In the code for Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-09">3.12</a>, the <code>geom_smooth()</code> call sets the line color to orange and sets its size (i.e., thickness) to 8, an unreasonably large value. We also turn off the <code>se</code> option by switching it from its default value of <code>TRUE</code> to <code>FALSE</code>. The result is that the standard error ribbon is not shown.</p>
<p>Meanwhile<label for="tufte-mn-41" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-41" class="margin-toggle"/><span class="marginnote shownote">It’s also possible to map a continuous variable directly to the alpha property, much like one might map a continuous variable to a single-color gradient. However, this is generally not an effective way of precisely conveying variation in quantity.</span> in the <code>geom_smooth()</code> call we set the <code>alpha</code> argument to 0.3. Like color, size, and shape, “alpha” is an aesthetic property that points (and some other plot elements) have, and to which variables can be mapped. It controls how transparent the object will appear when drawn. It’s measured on a scale of zero to one. An object with an alpha of zero will be completely transparent. Setting it to zero will make any other mappings the object might have, such as color or size, invisible as well. An object with an alpha of one will be completely opaque. Choosing an intermediate value can be useful when there is a lot of overlapping data to plot, as it makes it easier to see where the bulk of the observations are located.</p>
<div class="figure fullwidth"><span id="fig:ch-03-fig-lexp-gdp-10"/>
<img src="../Images/528814bf005572e3aa69ff08fea67934.png" alt="A more polished plot of Life Expectancy vs GDP." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-10-1.png"/>
<p class="caption marginnote shownote">
Figure 3.13: A more polished plot of Life Expectancy vs GDP.
</p>
</div>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb84-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y=</span>lifeExp))</a>
<a class="sourceLine" id="cb84-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.3</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"gam"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb84-5" data-line-number="5"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"GDP Per Capita"</span>, <span class="dt">y =</span> <span class="st">"Life Expectancy in Years"</span>,</a>
<a class="sourceLine" id="cb84-6" data-line-number="6">         <span class="dt">title =</span> <span class="st">"Economic Growth and Life Expectancy"</span>,</a>
<a class="sourceLine" id="cb84-7" data-line-number="7">         <span class="dt">subtitle =</span> <span class="st">"Data points are country-years"</span>,</a>
<a class="sourceLine" id="cb84-8" data-line-number="8">         <span class="dt">caption =</span> <span class="st">"Source: Gapminder."</span>)</a></code></pre>
<p>We can now make a reasonably polished plot. We set the <code>alpha</code> of the points to a low value, make nicer x- and y-axis labels, and add a title, subtitle, and caption. As you can see in the code above, in addition to <code>x</code>, <code>y</code>, and any other aesthetic mappings in your plot (such as <code>size</code>, <code>fill</code>, or <code>color</code>), the <code>labs()</code> function can also set the text for <code>title</code>, <code>subtitle</code>, and <code>caption</code>. It controls the <em>main labels</em> of scales. The appearance of things like axis tick marks are the responsibility of various <code>scale_</code> functions, such as the <code>scale_x_log10()</code> function used here. We will learn more about what can be done with <code>scale_</code> functions soon.</p>
<p>Are there any variables in our data that can sensibly be mapped to the <code>color</code> aesthetic? Consider <code>continent</code>. In Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-11">3.14</a> the individual data points have been colored by <code>continent</code>, and a legend with a key to the colors has automatically been added to the plot. In addition, instead of one smoothing line we now have five. There is one for each unique value of the <code>continent</code> variable. This is a consequence of the way aesthetic mappings are inherited. Along with <code>x</code> and <code>y</code>, the <code>color</code> aesthetic mapping is set in the call to <code>ggplot()</code> that we used to creat the <code>p</code> object. Unless told otherwise, all geoms layered on top of the original plot object will inherit that object’s mappings. In this case we get both our points and smoothers colored by continent.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb85-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb85-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb85-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb85-4" data-line-number="4">                          <span class="dt">color =</span> continent))</a>
<a class="sourceLine" id="cb85-5" data-line-number="5">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb85-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb85-7" data-line-number="7"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-11"/>
<img src="../Images/a0fd0b66ad62e23457edd70756fa6d2a.png" alt="Mapping the continent variable to the color aesthetic." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-11-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.14: Mapping the continent variable to the color aesthetic.<!--</p>-->
<!--</div>--></span>
</p>
<p>If it is what we want, then we might also consider shading the standard error ribbon of each line to match its dominant color. The color of the standard error ribbon is controlled by the <code>fill</code> aesthetic. Whereas the <code>color</code> aesthetic affects the appearance of lines and points, <code>fill</code> is for the filled areas of bars, polygons and, in this case, the interior of the smoother’s standard error ribbon.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb86-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb86-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb86-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp,</a>
<a class="sourceLine" id="cb86-4" data-line-number="4">                          <span class="dt">color =</span> continent,</a>
<a class="sourceLine" id="cb86-5" data-line-number="5">                          <span class="dt">fill =</span> continent))</a>
<a class="sourceLine" id="cb86-6" data-line-number="6">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb86-7" data-line-number="7"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb86-8" data-line-number="8"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-12"/>
<img src="../Images/d0fac1d82d45ee7eaabdec2d69bb1a77.png" alt="Mapping the continent variable to the color aesthetic, and correcting the error bars using the fill aesthetic." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-12-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.15: Mapping the continent variable to the color aesthetic, and correcting the error bars using the fill aesthetic.<!--</p>-->
<!--</div>--></span>
</p>
<p>Making sure that color and fill aesthetics match up consistently in
this way improves the overall look of the plot. In order to make it
happen we just need to specify that the mappings are to the same
variable in each case.</p>
&#13;

<h2><span class="header-section-number">3.6</span> Aesthetics can be mapped per geom</h2>
<p>Perhaps five separate smoothers is too many, and we just want one line. But we still would like to have the points color-coded by continent. By default, geoms inherit their mappings from the <code>ggplot()</code> function. We can change this by mapping the aesthetics we want only the <code>geom_</code> functions that we want them to apply to. We use the same <code>mapping = aes(...)</code> expression as in the initial call to <code>ggplot()</code>, but now use it in the <code>geom_</code> functions as well, specifying only the mappings we want to apply to each one. Mappings specified only in the initial <code>ggplot()</code> function—here, <code>x</code> and <code>y</code>—will carry through to all subsequent geoms.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-13"/>
<img src="../Images/84973e15698acc2a6756470dedb62db6.png" alt="Mapping aesthetics on a per-geom basis. Here color is mapped to continent for the points but not the smoother." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-13-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.16: Mapping aesthetics on a per-geom basis. Here color is mapped to continent for the points but not the smoother.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb87-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap, <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb87-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> continent)) <span class="op">+</span></a>
<a class="sourceLine" id="cb87-3" data-line-number="3"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb87-4" data-line-number="4"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a></code></pre>
<p>It’s possible to map continuous variables to the <code>color</code> aesthetic, too. For example, we can map the log of each country-year’s population (<code>pop</code>) to <code>color</code>. (We can take the log of population right in the <code>aes()</code> statement, using the <code>log()</code> function. R will evaluate this for us quite happily.) When we do this, ggplot produces a gradient scale. It is continuous, but marked at intervals in the legend. Depending on the circumstances, mapping quantities like population to a continuous color gradient may be more or less effective than cutting the variable into categorical bins running, e.g., from low to high. In general it is always worth looking at the data in its continuous form first rather than cutting or binning it into categories.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-03-fig-lexp-gdp-14"/>
<img src="../Images/b6fa2af5be9bb0293878a97e7fc2b565.png" alt="Mapping a continuous variable to color." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-03-fig-lexp-gdp-14-1.png"/>
<!--
<p class="caption marginnote">-->Figure 3.17: Mapping a continuous variable to color.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb88-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gapminder,</a>
<a class="sourceLine" id="cb88-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> gdpPercap,</a>
<a class="sourceLine" id="cb88-3" data-line-number="3">                          <span class="dt">y =</span> lifeExp))</a>
<a class="sourceLine" id="cb88-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> <span class="kw">log</span>(pop))) <span class="op">+</span></a>
<a class="sourceLine" id="cb88-5" data-line-number="5"><span class="st">    </span><span class="kw">scale_x_log10</span>()    </a></code></pre>
<p>Finally, it is worth paying a little more attention to the way that ggplot draws its scales. Because every mapped variable has a scale, we can learn a lot about how a plot has been constructed, and what mappings it contains, by seeing what the legends look like. For example, take a closer look at the legends produced in Figures <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-12">3.15</a> and <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-13">3.16</a>.</p>
<div class="figure"><span id="fig:ch-03-fig-legends-combined"/>
<p class="caption marginnote shownote">
Figure 3.18: Guides and legends faithfully reflect the mappings they represent.
</p>
<img src="../Images/6e57e4eaeef8b9c1c8396189614f7471.png" alt="Guides and legends faithfully reflect the mappings they represent." width="80%" data-original-src="https://socviz.co/assets/ch-03-legends-combined.png"/>
</div>
<p>In the legend for the first figure, shown here on the left, we see several visual elements. The key for each continent shows a dot, a line, and a shaded background. The key for the second figure, shown on the right, has only a dot for each continent, with no shaded background or line. If you look again at the code for Figures <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-12">3.15</a> and <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-13">3.16</a>, you will see that in the first case we mapped the <code>continent</code> variable to both <code>color</code> and <code>fill</code>. We then drew the figure with <code>geom_point()</code> and fitted a line for each continent with <code>geom_smooth()</code>. Points have <code>color</code> but the smoother understands both <code>color</code> (for the line itself) and <code>fill</code> (for the shaded standard error ribbon). Each of these elements is represented in the legend: the point color, the line color, and the ribbon fill. In the second figure, we decided to simplify things by having only the points be colored by <code>continent</code>. Then we drew just a single smoother for the whole graph. Thus, in the legend for that figure, the colored line and the shaded box are both absent. We only see a legend for the mapping of <code>color</code> to <code>continent</code> in <code>geom_point()</code>. Meanwhile on the graph itself the line drawn by <code>geom_smooth()</code> is set by default to a bright blue, different from anything on the scale, and its shaded error ribbon is set by default to gray. Small details like this are not accidents. They are a direct consequence of ggplot’s grammatical way of thinking about the relationship between the data behind the plot and the visual elements that represent it.</p>
&#13;

<h2><span class="header-section-number">3.7</span> Save your work</h2>
<p>Now that you have started to make your own plots, you may be wondering how to save them, and perhaps also how to control their size and format. If you are working in an RMarkdown document then the plots you make will be embedded in it, as we have already seen. You can set the default size of plots within your <code>.Rmd</code> document by setting an option in your first code chunk. This one tells R to make 8x5 figures:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb89-1" data-line-number="1">knitr<span class="op">::</span>opts_chunk<span class="op">$</span><span class="kw">set</span>(<span class="dt">fig.width=</span><span class="dv">8</span>, <span class="dt">fig.height=</span><span class="dv">5</span>) </a></code></pre>
<p>Because you will be making plots of different sizes and shapes, sometimes you will want to control the size of particular plots, without changing the default. To do this, you can add the same options to any particular chunk inside the curly braces at the beginning. Remember, each chunk opens with three backticks and then a pair of braces containing the language name (for us always <code>r</code>) and an optional label:</p>
<p class="sourceCode"/><pre class="sourceCode markdown"><code class="sourceCode markdown"><a class="sourceLine" id="cb90-1" data-line-number="1">```{r example}</a>
<a class="sourceLine" id="cb90-2" data-line-number="2">p + geom_point()</a>
<a class="sourceLine" id="cb90-3" data-line-number="3">```</a></code></pre>
<p>You can follow the label with a comma and provide a series of options if needed. They will apply only to that chunk. To make a figure twelve inches wide and nine inches high we say e.g. <code>{r example, fig.width = 12, fig.height = 9}</code> in the braces section.</p>
<p>You will often need to save your figures individually, as they will
end up being dropped into slides or published in papers that are not
produced using RMarkdown. Saving a figure to a file can be done in
several different ways. When working with <code>ggplot</code>, the easiest way is
to use the <code>ggsave()</code> function. To save the most recently displayed
figure, we provide the name we want to save it under:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="dt">filename =</span> <span class="st">"my_figure.png"</span>)</a></code></pre>
<p>This<label for="tufte-mn-42" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-42" class="margin-toggle"/><span class="marginnote shownote">Several other file formats are available as well. See the function’s help page for details.</span> will save the figure as a PNG file, a format suitable for displaying on web pages. If you want a PDF instead, change the extension of the file:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="dt">filename =</span> <span class="st">"my_figure.pdf"</span>)</a></code></pre>
<p>Remember that, for convenience, you do not need to write <code>filename =</code> as long as the name of the file is the first argument you give <code>ggsave()</code>. You can also pass plot objects to <code>ggsave()</code>. For example, we can put our recent plot into an object called <code>p_out</code> and then tell <code>ggave()</code> that we want to save that object.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1">p_out &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb93-2" data-line-number="2"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"loess"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb93-3" data-line-number="3"><span class="st">    </span><span class="kw">scale_x_log10</span>()</a>
<a class="sourceLine" id="cb93-4" data-line-number="4"/>
<a class="sourceLine" id="cb93-5" data-line-number="5"><span class="kw">ggsave</span>(<span class="st">"my_figure.pdf"</span>, <span class="dt">plot =</span> p_out)</a></code></pre>
<p>When saving your work, it is sensible to have a subfolder (or more
than one, depending on the project) where you save only figures. You
should also take care to name your saved figures in a sensible way.
<code>fig_1.pdf</code> or <code>my_figure.pdf</code> are not good names. Figure names should
be compact but descriptive, and consistent between figures within a
project. In addition, although it really shouldn’t be the case in this
day and age, it is also wise to play it safe and avoid file names
containing characters likely to make your code choke in future. These
include apostrophes, backticks, spaces, forward and back slashes, and
quotes.</p>
<p>The Appendix contains a short discussion of how to organize your files within your project folder. Treat the project folder as the home base of your work for the paper or work you are doing, and put your data and figures in subfolders within the project folder. To begin with, using your file manager, create a folder named “figures” inside your project folder. When saving figures, you can use Kirill Müller’s handy <code>here</code> library to make it easier to work with files and subfolders while not having to type in full file paths. Load the library in the setup chunk of your RMarkdown document. When you do, it tells you where “here” is for the current project. You will see a message saying something like this, with your file path and user name instead of mine:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="co"># here() starts at /Users/kjhealy/projects/socviz</span></a></code></pre>
<p>You can then use the <code>here()</code> function to make loading and saving your
work more straightforward and safer. Assuming a folder named “figures” exists in your project folder, you can do this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="kw">here</span>(<span class="st">"figures"</span>, <span class="st">"lifexp_vs_gdp_gradient.pdf"</span>), <span class="dt">plot =</span> p_out)</a></code></pre>
<p>This saves <code>p_out</code> as a file called <code>lifeexp_vs_gdp_gradient.pdf</code> in the <code>figures</code> directory <em>here</em>, i.e. in your current project folder.</p>
<p>You can save your figure in a variety of different formats, depending
on your needs (and also, to a lesser extent, on your particular
computer system). The most important distinction to bear in mind is
between <em>vector</em> formats and <em>raster</em> formats. A file with a <em>vector</em>
format, like PDF or SVG, is stored as a set of instructions about
lines, shapes, colors, and their relationships. The viewing software
(such as Adobe Acrobat or Apple’s Preview application for PDFs) then
interprets those instructions and displays the figure. Representing
the figure this way allows it to be easily resized without becoming
distorted. The underlying language of the PDF format is Postscript,
which is also the language of modern typesetting and printing. This
makes a vector-based format like PDF the best choice for submission to
journals.</p>
<p>A <em>raster</em> based format, on the other hand, stores images essentially
as a grid of pixels of a pre-defined size with information about the
location, color, brightness, and so on of each pixel in the grid. This
makes for more efficient storage, especially when used in conjunction
with compression methods that take advantage of redundancy in images
in order to save space. Formats like JPG are compressed raster
formats. A PNG file is a raster image format that supports lossless
compression. For graphs containing an awful lot of data, PNG files
will tend to be much smaller than the corresponding PDF. However,
raster formats cannot be easily resized. In particular they cannot be
expanded in size without becoming pixelated or grainy. Formats like
JPG and PNG are the standard way that images are displayed on the web.
The more recent SVG format is vector-based format but also
nevertheless supported by many web browsers.</p>
<p>In general you should save your work in several different formats.
When you save in different formats and in different sizes you may need
to experiment with the scaling of the plot and the size of the fonts
in order to get a good result. The <code>scale</code> argument to <code>ggsave()</code> can
help you here (you can try out different values, like <code>scale=1.3</code>,
<code>scale=5</code>, and so on). You can also use <code>ggave()</code> to explicitly set
the height and width of your plot in the units that you choose.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="kw">ggsave</span>(<span class="kw">here</span>(<span class="st">"figures"</span>, <span class="st">"lifexp_vs_gdp_gradient.pdf"</span>),</a>
<a class="sourceLine" id="cb96-2" data-line-number="2">       <span class="dt">plot =</span> p_out, <span class="dt">height =</span> <span class="dv">8</span>, <span class="dt">width =</span> <span class="dv">10</span>, <span class="dt">units =</span> <span class="st">"in"</span>)</a></code></pre>
<p>Now that you know how to do that, let’s get back to making more graphs.</p>
&#13;

<h2><span class="header-section-number">3.8</span> Where to go next</h2>
<p>Start by playing around with the <code>gapminder</code> data a little more. You can try each of these explorations with <code>geom_point()</code> and then with <code>geom_smooth()</code>, or both together.</p>
<ul>
<li>What happens when you put the <code>geom_smooth()</code> function before <code>geom_point()</code> instead of after it? What does this tell you about how the plot is drawn? Think about how this might be useful when drawing plots.</li>
<li>Change the mappings in the <code>aes()</code> function so that you plot Life Expectancy against population (<code>pop</code>) rather than per capita GDP. What does that look like? What does it tell you about the unit of observation in the dataset?</li>
<li>Try some alternative scale mappings. Besides <code>scale_x_log10()</code> you can try <code>scale_x_sqrt()</code> and <code>scale_x_reverse()</code>. There are corresponding functions for y-axis transformations. Just write <code>y</code> instead of <code>x</code>. Experiment with them to see what sort of effect they have on the plot, and whether they make any sense to use.</li>
<li>What happens if you map <code>color</code> to <code>year</code> instead of <code>continent</code>? Is the result what you expected? Think about what class of object <code>year</code> is. Remember you can get a quick look at the top of the data, which includes some shorthand information on the class of each variable, by typing <code>gapminder</code>.</li>
<li>Instead of mapping <code>color = year</code>, what happens if you try <code>color = factor(year)</code>?</li>
<li>As you look at these different scatterplots, think about Figure <a href="makeplot.html#fig:ch-03-fig-lexp-gdp-10">3.13</a> a little more critically. We worked it up to the point where it was reasonably polished, but is it really the best way to display this country-year data? What are we gaining and losing by ignoring the temporal and country-level structure of the data? How could we do better? Sketch out what an alternative visualization might look like.</li>
</ul>
<p>As you begin to experiment, remember two things. First, it’s always worth trying something, even if you’re not sure what’s going to happen. Don’t be afraid of the console.<label for="tufte-mn-43" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-43" class="margin-toggle"/><span class="marginnote shownote">This license does not extend to, for example, overwriting or deleting your data by mistake. You should still manage your project responsibly, at a minimum keeping good backups. But within R and at the level of experimenting with graphs at the console, you have a lot of freedom.</span> The nice thing about making your graphics through code is that you won’t break anything you can’t reproduce. If something doesn’t work, you can figure out what happened, fix things, and re-run the code to make the graph again.</p>
<p>Second, remember that the main flow of action in ggplot is always the same. You start with a table of data, you map the variables you want to display to aesthetics like position, color, or shape, and you choose one or more geoms to draw the graph. In your code this gets accomplished by making an object with the basic information about data and mappings, and then adding or layering additional information as needed. Once you get used to this way of thinking about your plots, especially the aesthetic mapping part, then drawing them becomes easier. Instead of having to think about how to draw particular shapes or colors on the screen, the many <code>geom_</code> functions take care of that for you. In the same way, learning new geoms is easier once you think of them as ways to display aesthetic mappings that you specify. Most of the learning curve with ggplot involves getting used to this way of thinking about your data and its representation in a plot. In the next chapter, we will flesh out these ideas a little more, cover some common ways plots go “wrong” (i.e., when they end up looking strange), and learn how to recognize and avoid those problems.</p>

    
</body>
</html>