- en: Filter Line Search for Non-Inversion
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://phys-sim-book.github.io/lec15.3-filter_line_search.html](https://phys-sim-book.github.io/lec15.3-filter_line_search.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
  prefs: []
  type: TYPE_NORMAL
- en: 'To guarantee non-inversion just like non-interpenetration (see [Filter Line
    Search](lec8-filter_line_search.html)) during the simulation, we can similarly
    filter the line search initial step size with a critical step size αI that first
    brings the volume of any triangles to 0. This can be obtained by solving a 1D
    equation per triangle: V(xi​+αIpi​)=0,(15.3.1) and taking the minimum of the solved
    step sizes. Here pi​ is the search direction of node i, and in 2D, Equation [(15.3.1)](#eq:lec15:V_eq_0)
    is equivalent to: det([x21α​,x31α​])≡x21,1α​x31,2α​−x21,2α​x31,1α​=0(15.3.2) with
    xijα​=xij​+αIpij​ and xij​=xi​−xj​, pij​=pi​−pj​. Expanding Equation [(15.3.2)](#eq:lec15:det_tri_equals_0)
    we obtain: (x21,1​+αIp21,1​)(x31,2​+αIp31,2​)−(x21,2​+αIp21,2​)(x31,1​+αIp31,1​)=0,
    which can be reorganized as a quadratic equation of αI: det([p21​,p31​])(αI)2+(det([x21​,p31​])+det([p21​,x31​]))αI+det([x21​,x31​])=0.
    Here, note that det([p21​,p31​]) can be very tiny when the nodes do not move much
    or when their movement barely changes to triangle area in the current timestep,
    thus the equation can be degenerated into a linear one. To robustly detect this
    degenerate case, we cannot directly check whether det([p21​,p31​]) is 0 due to
    numerical errors. In fact, checking whether det([p21​,p31​]) is below an epsilon
    is still tricky, because the scale of det([p21​,p31​]) heavily depends on the
    scene dimension and nodal velocity during the simulation. Therefore, we use det([x21​,x31​])
    as a scaling and obtain a scaled but equivalent equation: det([x21​,x31​])det([p21​,p31​])​(αI)2+det([x21​,x31​])det([x21​,p31​])+det([p21​,x31​])​αI+1=0,(15.3.3)
    where magnitude checks can be safely performed on any coefficients with unitless
    thresholds.'
  prefs: []
  type: TYPE_NORMAL
- en: 'In practice, we also need to allow some slackness so that the step size to
    be taken will not lead to an exactly 0 volume. Thus, we solve αI such that it
    first decreases the volume of any triangles by 90%, which can be realized by modifying
    the constant term coefficient in Equation [(15.3.3)](#eq:lec15:scaled_quad_eq_of_alphaI)
    from 1 to 0.9:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Implementation 15.3.1 (Filter line search, NeoHookeanEnergy.py).**'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE0]'
  prefs: []
  type: TYPE_PRE
- en: Here, if the equation does not have a positive real root, that means for this
    specific triangle, the step size can be taken arbitrarily large and it will not
    trigger inversion.
  prefs: []
  type: TYPE_NORMAL
- en: The quadratic equation can be solved as
  prefs: []
  type: TYPE_NORMAL
- en: '**Implementation 15.3.2 (Solve quadratic equation, utils.py).**'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE1]'
  prefs: []
  type: TYPE_PRE
- en: With scaled coefficients, we simply use a unitless threshold, e.g. `1e-6`, to
    check for degeneracies. If no positive real roots are found, the function simply
    returns `-1`.
  prefs: []
  type: TYPE_NORMAL
- en: 'Now as we filter the initial step size in addition to non-interpenetration:'
  prefs: []
  type: TYPE_NORMAL
- en: '**Implementation 15.3.3 (Apply filter, time_integrator.py).**'
  prefs: []
  type: TYPE_NORMAL
- en: '[PRE2]'
  prefs: []
  type: TYPE_PRE
- en: and make sure all added data structures and modified functions are reflected
    in the time integrator, we can finally simulate the compressing square example
    from [Moving Boundary Condition](lec11-mov_DBC.html) with guaranteed non-inversion
    (see [Figure 15.3.1](#fig:lec15:compress_square_inv_free)).
  prefs: []
  type: TYPE_NORMAL
- en: '![](../Images/bf913ac9f152f77cf2c8e2b64e8064b5.png)'
  prefs: []
  type: TYPE_IMG
- en: '**Figure 15.3.1.** A square is dropped onto the ground and compressed severely
    by a ceiling while maintaining inversion-free throughout the simulation. The ground
    has friction coefficient 0.11 so that the bottom of the square slides less than
    the top, where the ceiling has no friction.'
  prefs: []
  type: TYPE_NORMAL
