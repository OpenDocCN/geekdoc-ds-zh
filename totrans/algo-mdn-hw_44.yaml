- en: Memory Hierarchy
  id: totrans-0
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
  zh: 存储层次结构
- en: 原文：[https://en.algorithmica.org/hpc/external-memory/hierarchy/](https://en.algorithmica.org/hpc/external-memory/hierarchy/)
  id: totrans-1
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
  zh: 原文：[https://en.algorithmica.org/hpc/external-memory/hierarchy/](https://en.algorithmica.org/hpc/external-memory/hierarchy/)
- en: 'Modern computer memory is highly hierarchical. It consists of multiple *cache
    layers* of varying speed and size, where *higher* levels typically store most
    frequently accessed data from *lower* levels to reduce latency: each next level
    is usually an order of magnitude faster, but also smaller and/or more expensive.'
  id: totrans-2
  prefs: []
  type: TYPE_NORMAL
  zh: 现代计算机内存高度分层。它由多个速度和大小不同的缓存层组成，其中*较高*的层次通常存储从*较低*层次频繁访问的数据以减少延迟：每个下一级通常快一个数量级，但也更小和/或更贵。
- en: '![](../Images/d1ef76dfa02b39c27d74f4b645a637da.png)'
  id: totrans-3
  prefs: []
  type: TYPE_IMG
  zh: '![](../Images/d1ef76dfa02b39c27d74f4b645a637da.png)'
- en: Abstractly, various memory devices can be described as modules that have a certain
    storage capacity $M$ and can read or write data in blocks of $B$ (not individual
    bytes!), taking a fixed time to complete.
  id: totrans-4
  prefs: []
  type: TYPE_NORMAL
  zh: 抽象地说，各种内存设备可以被描述为具有一定存储容量 $M$ 的模块，可以以块 $B$（而不是单个字节！）的形式读取或写入数据，并花费固定的时间完成。
- en: 'From this perspective, each type of memory has a few important characteristics:'
  id: totrans-5
  prefs: []
  type: TYPE_NORMAL
  zh: 从这个角度来看，每种类型的内存都有几个重要的特性：
- en: '*total size* $M$;'
  id: totrans-6
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*总大小* $M$；'
- en: '*block size* $B$;'
  id: totrans-7
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*块大小* $B$；'
- en: '*latency*, that is, how much time it takes to fetch one byte;'
  id: totrans-8
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*延迟*，即获取一个字节所需的时间；'
- en: '*bandwidth*, which may be higher than just the block size times latency, meaning
    that I/O operations can “overlap”;'
  id: totrans-9
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*带宽*，可能高于仅仅是块大小乘以延迟，这意味着I/O操作可以“重叠”；'
- en: '*cost* in the amortized sense, including the price for the chip, its energy
    requirements, maintenance, and so on.'
  id: totrans-10
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '*成本*在摊销意义上的，包括芯片价格、能源需求、维护等。'
- en: 'Here is an approximate comparison table for commodity hardware in 2021:'
  id: totrans-11
  prefs: []
  type: TYPE_NORMAL
  zh: 下面是2021年商品硬件的大致比较表：
- en: '| Type | $M$ | $B$ | Latency | Bandwidth | $/GB/mo^([1](#fn:1)) |'
  id: totrans-12
  prefs: []
  type: TYPE_TB
  zh: '| 类型 | $M$ | $B$ | 延迟 | 带宽 | $/GB/mo^([1](#fn:1))$ |'
- en: '| --- | --- | --- | --- | --- | --- |'
  id: totrans-13
  prefs: []
  type: TYPE_TB
  zh: '| --- | --- | --- | --- | --- | --- |'
- en: '| L1 | 10K | 64B | 2ns | 80G/s | - |'
  id: totrans-14
  prefs: []
  type: TYPE_TB
  zh: '| L1 | 10K | 64B | 2ns | 80G/s | - |'
- en: '| L2 | 100K | 64B | 5ns | 40G/s | - |'
  id: totrans-15
  prefs: []
  type: TYPE_TB
  zh: '| L2 | 100K | 64B | 5ns | 40G/s | - |'
- en: '| L3 | 1M/core | 64B | 20ns | 20G/s | - |'
  id: totrans-16
  prefs: []
  type: TYPE_TB
  zh: '| L3 | 1M/core | 64B | 20ns | 20G/s | - |'
- en: '| RAM | GBs | 64B | 100ns | 10G/s | 1.5 |'
  id: totrans-17
  prefs: []
  type: TYPE_TB
  zh: '| RAM | GBs | 64B | 100ns | 10G/s | 1.5 |'
- en: '| SSD | TBs | 4K | 0.1ms | 5G/s | 0.17 |'
  id: totrans-18
  prefs: []
  type: TYPE_TB
  zh: '| SSD | TBs | 4K | 0.1ms | 5G/s | 0.17 |'
- en: '| HDD | TBs | - | 10ms | 1G/s | 0.04 |'
  id: totrans-19
  prefs: []
  type: TYPE_TB
  zh: '| HDD | TBs | - | 10ms | 1G/s | 0.04 |'
- en: '| S3 | $\infty$ | - | 150ms | $\infty$ | 0.02^([2](#fn:2)) |'
  id: totrans-20
  prefs: []
  type: TYPE_TB
  zh: '| S3 | $\infty$ | - | 150ms | $\infty$ | 0.02^([2](#fn:2))$ |'
- en: In reality, there are many specifics about each type of memory, which we will
    now go through.
  id: totrans-21
  prefs: []
  type: TYPE_NORMAL
  zh: 在现实中，每种类型的存储器都有许多具体细节，我们现在将逐一介绍。
- en: '### [#](https://en.algorithmica.org/hpc/external-memory/hierarchy/#volatile-memory)Volatile
    Memory'
  id: totrans-22
  prefs: []
  type: TYPE_NORMAL
  zh: '### [#](https://en.algorithmica.org/hpc/external-memory/hierarchy/#volatile-memory)易失性存储器'
- en: Everything up to the RAM level is called *volatile memory* because it does not
    persist data in case of a power shortage and other disasters. It is fast, which
    is why it is used to store temporary data while the computer is powered.
  id: totrans-23
  prefs: []
  type: TYPE_NORMAL
  zh: 到RAM级别的一切都称为*易失性存储器*，因为它在电源短缺和其他灾难情况下不会持久化数据。它速度快，这就是为什么它在计算机供电时用于存储临时数据。
- en: 'From fastest to slowest:'
  id: totrans-24
  prefs: []
  type: TYPE_NORMAL
  zh: 从快到慢：
- en: '**CPU registers**, which are the zero-time access data cells CPU uses to store
    all its intermediate values, can also be thought of as a memory type. There is
    only a limited number of them (e.g., just 16 “general purpose” ones), and in some
    cases, you may want to use all of them for performance reasons.'
  id: totrans-25
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**CPU寄存器**，CPU使用这些零时间访问的数据单元来存储所有中间值，也可以被视为一种内存类型。它们的数量有限（例如，只有16个“通用”寄存器），在某些情况下，你可能出于性能原因想要使用它们全部。'
- en: '**CPU caches.** Modern CPUs have multiple layers of cache (L1, L2, often L3,
    and rarely even L4). The lowest layer is shared between cores and is usually scaled
    with their number (e.g., a 10-core CPU should have around 10M of L3 cache).'
  id: totrans-26
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**CPU缓存**。现代CPU有多个缓存层（L1、L2，通常是L3，很少是L4）。最底层是核心间共享的，通常与核心数量成比例（例如，一个10核心的CPU应该有大约10M的L3缓存）。'
- en: '**Random access memory,** which is the first scalable type of memory: nowadays
    you can rent machines with half a terabyte of RAM on the public clouds. This is
    the one where most of your working data is supposed to be stored.'
  id: totrans-27
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**随机存取存储器**，这是第一种可扩展的存储类型：如今你可以在公共云上租用拥有半太字节RAM的机器。这是你大部分工作数据应该存储的地方。'
- en: The CPU cache system has an important concept of a *cache line*, which is the
    basic unit of data transfer between the CPU and the RAM. The size of a cache line
    is 64 bytes on most architectures, meaning that all main memory is divided into
    blocks of 64 bytes, and whenever you request (read or write) a single byte, you
    are also fetching all its 63 cache line neighbors whether your want them or not.
  id: totrans-28
  prefs: []
  type: TYPE_NORMAL
  zh: CPU 缓存系统有一个重要的概念，即 *缓存行*，它是 CPU 和 RAM 之间数据传输的基本单位。在大多数架构中，缓存行的大小为 64 字节，这意味着所有主内存都被划分为
    64 字节的块，无论你是否需要，每次请求（读取或写入）单个字节时，你都会获取其所有 63 个缓存行邻居。
- en: Caching on the CPU level happens automatically based on the last access times
    of cache lines. When accessed, the contents of a cache line are emplaced onto
    the lowest cache layer and then gradually evicted to higher levels unless accessed
    again in time. The programmer can’t control this process explicitly, but it is
    worthwhile to study how it works in detail, which we will do [in the next chapter](/hpc/cpu-cache).
  id: totrans-29
  prefs: []
  type: TYPE_NORMAL
  zh: CPU 级别的缓存是基于缓存行的最后访问时间自动发生的。当访问时，缓存行的内容会被放置到最低的缓存层，然后逐渐被移除到更高层，除非在规定时间内再次访问。程序员无法显式控制这个过程，但研究其工作原理是值得的，我们将在下一章中介绍[CPU
    缓存](/hpc/cpu-cache)。
- en: '### [#](https://en.algorithmica.org/hpc/external-memory/hierarchy/#non-volatile-memory)Non-Volatile
    Memory'
  id: totrans-30
  prefs: []
  type: TYPE_NORMAL
  zh: '### [非易失性存储器](https://en.algorithmica.org/hpc/external-memory/hierarchy/#non-volatile-memory)'
- en: While the data cells in CPU caches and the RAM only gently store just a few
    electrons (that periodically leak and need to be periodically refreshed), the
    data cells in *non-volatile memory* types store hundreds of them. This lets the
    data persist for prolonged periods of time without power but comes at the cost
    of performance and durability — because when you have more electrons, you also
    have more opportunities for them to collide with silicon atoms.
  id: totrans-31
  prefs: []
  type: TYPE_NORMAL
  zh: 虽然 CPU 缓存和 RAM 中的数据单元只存储少量电子（这些电子会周期性地泄漏并需要定期刷新），但 *非易失性存储器* 类型的数据单元存储了数百个电子。这使得数据在没有电源的情况下可以持续较长时间，但这也带来了性能和耐用性的代价——因为电子越多，它们与硅原子碰撞的机会也越多。
- en: 'There are many ways to store data in a persistent way, but these are the main
    ones from a programmer’s perspective:'
  id: totrans-32
  prefs: []
  type: TYPE_NORMAL
  zh: 存储数据的方式有很多种，但从程序员的角度来看，这些是主要的几种：
- en: '**Solid state drives.** These have relatively low latency on the order of 0.1ms
    ($10^5$ ns), but they also have a high cost, amplified by the fact that they have
    limited lifespans as each cell can only be written to a limited number of times.
    This is what mobile devices and most laptops use because they are compact and
    have no moving parts.'
  id: totrans-33
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**固态硬盘**。这些硬盘的延迟相对较低，大约为 0.1ms（$10^5$ ns），但它们的价格也相对较高，因为每个单元只能写入有限次数，这限制了它们的寿命。这就是为什么移动设备和大多数笔记本电脑使用它们的原因，因为它们体积小，没有移动部件。'
- en: '**Hard disk drives** are unusual because they are actually [rotating physical
    disks](https://www.youtube.com/watch?v=3owqvmMf6No&feature=emb_title) with a read/write
    head attached to them. To read a memory location, you need to wait until the disk
    rotates to the right position and then very precisely move the head to it. This
    results in some very weird access patterns where reading one byte randomly may
    take the same time as reading the next 1MB of data — which is usually on the order
    of milliseconds. Since this is the only part of a computer, except for the cooling
    system, that has mechanically moving parts, hard disks break quite often (with
    the average lifespan of ~3 years for a data center HDD).'
  id: totrans-34
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**硬盘驱动器**是非同寻常的，因为它们实际上是带有读写头的旋转物理磁盘[旋转物理磁盘](https://www.youtube.com/watch?v=3owqvmMf6No&feature=emb_title)。要读取内存位置，你需要等待磁盘旋转到正确的位置，然后非常精确地将头移动到那里。这导致了一些非常奇怪的访问模式，随机读取一个字节可能需要的时间与读取下一个
    1MB 的数据所需的时间相同——这通常在毫秒级别。由于这是计算机中唯一具有机械移动部件的部分（除了冷却系统），硬盘经常损坏（数据中心 HDD 的平均寿命约为
    3 年）。'
- en: '**Network-attached storage**, which is the practice of using other networked
    devices to store data on them. There are two distinctive types. The first one
    is the Network File System (NFS), which is a protocol for mounting the file system
    of another computer over the network. The other is API-based distributed storage
    systems, most famously [Amazon S3](https://aws.amazon.com/s3/), that are backed
    by a fleet of storage-optimized machines of a public cloud, typically using cheap
    HDDs or some [more exotic](https://aws.amazon.com/storagegateway/vtl/) storage
    types internally. While NFS can sometimes work even faster than HDD if it is located
    in the same data center, object storage in the public cloud usually has latencies
    of 50-100ms. They are typically highly distributed and replicated for better availability.'
  id: totrans-35
  prefs:
  - PREF_UL
  type: TYPE_NORMAL
  zh: '**网络附加存储**，即使用其他网络设备来存储数据的做法。它有两种独特的类型。第一种是网络文件系统（NFS），它是一种通过网络挂载另一台计算机文件系统的协议。另一种是基于API的分布式存储系统，最著名的是[Amazon
    S3](https://aws.amazon.com/s3/)，它由公共云中一队经过优化的存储机器支持，通常使用廉价的HDD或一些[更复杂的](https://aws.amazon.com/storagegateway/vtl/)存储类型。虽然如果NFS位于同一数据中心，它有时甚至可以比HDD运行得更快，但公共云中的对象存储通常有50-100毫秒的延迟。它们通常是高度分布和复制的，以提高可用性。'
- en: Since SDD/HDD are noticeably slower than RAM, everything on or below this level
    is usually called *external memory*.
  id: totrans-36
  prefs: []
  type: TYPE_NORMAL
  zh: 由于SDD/HDD的读写速度明显慢于RAM，因此在这个级别或以下的所有内容通常被称为*外部存储*。
- en: Unlike the CPU caches, external memory can be explicitly controlled. This is
    useful in many cases, but most programmers just want to abstract away from it
    and use it as an extension of the main memory, and operating systems have the
    capability to do so by the means of [virtual memory](../virtual).
  id: totrans-37
  prefs: []
  type: TYPE_NORMAL
  zh: 与CPU缓存不同，外部存储可以明确控制。这在许多情况下很有用，但大多数程序员只想将其抽象化，并将其用作主内存的扩展，操作系统通过[虚拟内存](../virtual)的方式具有这样做的能力。
- en: '* * *'
  id: totrans-38
  prefs: []
  type: TYPE_NORMAL
  zh: '* * *'
- en: Pricing information is taken from the [Google Cloud Platform](https://cloud.google.com/products/calculator?skip_cache=true). [↩︎](#fnref:1)
  id: totrans-39
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 定价信息来自[Google Cloud Platform](https://cloud.google.com/products/calculator?skip_cache=true)。[↩︎](#fnref:1)
- en: Cloud storage typically has [multiple tiers](https://aws.amazon.com/s3/storage-classes/),
    becoming progressively cheaper if you access the data less frequently. [↩︎](#fnref:2)
    [← ../External Memory](https://en.algorithmica.org/hpc/external-memory/)[Virtual
    Memory →](https://en.algorithmica.org/hpc/external-memory/virtual/)
  id: totrans-40
  prefs:
  - PREF_OL
  type: TYPE_NORMAL
  zh: 云存储通常有[多个层级](https://aws.amazon.com/s3/storage-classes/)，如果你访问数据的频率较低，成本会逐渐降低。[↩︎](#fnref:2)
    [← ../外部存储](https://en.algorithmica.org/hpc/external-memory/)[虚拟内存 →](https://en.algorithmica.org/hpc/external-memory/virtual/)
