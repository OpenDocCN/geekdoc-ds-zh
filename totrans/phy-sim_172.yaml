- en: 'Position-Based Fluids: Density and Surface Constraints'
  prefs:
  - PREF_H1
  type: TYPE_NORMAL
- en: 原文：[https://phys-sim-book.github.io/lec32.4-position_based_fluids.html](https://phys-sim-book.github.io/lec32.4-position_based_fluids.html)
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">
  prefs: []
  type: TYPE_NORMAL
- en: The Position-Based Dynamics framework can be elegantly extended from solids
    to simulate incompressible fluids. The resulting method, known as Position-Based
    Fluids (PBF) [[Macklin & Muller 2013]](bibliography.html#macklin2013position),
    replaces the complex pressure solves of traditional Smoothed Particle Hydrodynamics
    (SPH) [[Koschier et al. 2020]](bibliography.html#koschier2020smoothed) with a
    set of geometric constraints. This approach inherits the stability and efficiency
    of PBD, allowing for large time steps suitable for real-time applications, while
    effectively enforcing the constant-density condition that characterizes incompressible
    flow.
  prefs: []
  type: TYPE_NORMAL
- en: '[The Per-Particle Density Constraint](#the-per-particle-density-constraint)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: The fundamental principle of PBF is to ensure that the density around each fluid
    particle remains constant. The density at a given particle's location is estimated
    using a kernel-based summation over its neighbors.
  prefs: []
  type: TYPE_NORMAL
- en: 'The density ρi​ for a particle i at position pi​ is estimated as: ρi​=j∑​mj​W(pi​−pj​,h)(33.4.1)
    where the sum is over all neighboring particles j, mj​ is the mass of particle
    j, h is the smoothing kernel radius, and W is a radially symmetric smoothing kernel
    function. For simplicity, we can assume all particles have equal mass and absorb
    it into the density calculation.'
  prefs: []
  type: TYPE_NORMAL
- en: The goal is to enforce that this estimated density ρi​ matches a user-defined
    rest density ρ0​. This is formulated as a per-particle constraint function Ci​.
  prefs: []
  type: TYPE_NORMAL
- en: '****Definition 33.4.1 (PBF Density Constraint).**** For each particle i, the
    density constraint Ci​ is defined as the scaled deviation from the rest density
    ρ0​: Ci​(p1​,...,pN​)=ρ0​ρi​​−1(33.4.2) The constraint is satisfied when Ci​=0.'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: 'To solve this system of constraints, PBF computes a position correction Δpi​
    for each particle. Following the PBD methodology, we first compute the gradient
    of Ci​ with respect to the position of a particle k: ∇pk​​Ci​=ρ0​1​j∑​mj​∇pk​​W(pi​−pj​,h)={ρ0​1​∑j​mj​∇W(pi​−pj​,h)−ρ0​mk​​∇W(pi​−pk​,h)​if k=iif k=i​(33.4.3)
    The standard PBD solver computes a single Lagrange multiplier λi​ for each constraint
    Ci​ using the formula λi​=−Ci​/(∑k​∥∇pk​​Ci​∥2). The position correction for a
    particle Δpi​ is then derived from the influence of its own constraint and the
    constraints of its neighbors. Due to the symmetry of the kernel gradient (∇pi​​W(pi​−pj​,h)=−∇pj​​W(pi​−pj​,h)),
    this results in a simple and efficient final update rule for the position correction
    of particle i: Δpi​=ρ0​1​j∑​(λi​+λj​)∇W(pi​−pj​,h)(33.4.4) Here, a different kernel,
    the Spiky kernel, is typically used for its non-vanishing gradient, which prevents
    particle clustering.'
  prefs: []
  type: TYPE_NORMAL
- en: '***Remark 33.4.1 (Robustness and Constraint Softening).*** A practical issue
    arises when a particle has few neighbors, as the denominator ∑k​∥∇pk​​Ci​∥2 can
    approach zero, leading to large, unstable position corrections. To prevent this,
    a small relaxation parameter ε is added to the denominator, softening the constraint.
    This is known as Constraint Force Mixing (CFM) [[Smith & others 2005]](bibliography.html#smith2005open).
    Then: λi​=−∑k​∥∇pk​​Ci​∥2+εCi​(p1​,...,pN​)​(33.4.5)'
  prefs:
  - PREF_BQ
  type: TYPE_NORMAL
- en: '[Correcting for Tensile Instability](#correcting-for-tensile-instability)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: A well-known artifact in SPH-based fluid simulations is the "tensile instability,"
    where particles near a free surface clump together due to an inability to satisfy
    the rest density. PBF offers a direct solution by incorporating an artificial
    pressure term.
  prefs: []
  type: TYPE_NORMAL
- en: 'Specifically, an artificial pressure term, scorr​, is introduced to create
    a short-range repulsive force between nearby particles. This term is a function
    of W: scorr​=−k(W(Δq,h)W(pi​−pj​,h)​)n(33.4.6) where k and n are small positive
    constants (e.g., k=0.1,n=4), and Δq is a vector representing a small distance
    within the kernel radius (e.g., ∥Δq∥=0.3h). This term is only applied to push
    particles apart and is incorporated directly into the position correction calculation
    from Equation [(33.4.4)](#eq:pbf:position_correction): Δpi​=ρ0​1​j∑​(λi​+λj​+scorr​)∇W(pi​−pj​,h)(33.4.7)
    This prevents clumping, and implicitly creates a surface tension-like effect at
    the fluid''s boundary.'
  prefs: []
  type: TYPE_NORMAL
- en: '[Velocity-Level Corrections: Viscosity and Vorticity](#velocity-level-corrections-viscosity-and-vorticity)'
  prefs:
  - PREF_H3
  type: TYPE_NORMAL
- en: While the primary constraints in PBF operate on positions, velocity-level updates
    are still necessary to model phenomena like viscosity and to reintroduce lost
    energy. These are applied as a post-process after the main PBD solver loop has
    updated positions and velocities.
  prefs: []
  type: TYPE_NORMAL
- en: '**XSPH Viscosity:** To impart a more coherent, liquid-like motion and reduce
    particle intermixing, XSPH viscosity is applied. It adjusts each particle''s velocity
    to be closer to the average velocity of its neighbors: vinew​=vi​+cj∑​(vj​−vi​)W(pi​−pj​,h)(33.4.8)
    where c is a positive viscosity coefficient, typically a small value like 0.01.'
  prefs: []
  type: TYPE_NORMAL
- en: '**Vorticity Confinement:** The iterative nature of PBD can introduce numerical
    damping, causing the fluid to lose rotational energy and appear overly viscous.
    Vorticity confinement can be used to counteract this by calculating the vorticity
    (curl of the velocity field) ωi​=∇×vi​ at each particle and applying a corrective
    force fvorticity​=ε(N×ωi​) to reintroduce small-scale rotational details. This
    force is then integrated to update particle velocities.'
  prefs: []
  type: TYPE_NORMAL
