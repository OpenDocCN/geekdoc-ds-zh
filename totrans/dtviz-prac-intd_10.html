<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>A Appendix</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>A Appendix</h1>
<blockquote>原文：<a href="https://socviz.co/appendix.html">https://socviz.co/appendix.html</a></blockquote>


<p>This Appendix contains supplemental information about various aspects
of R and ggplot that you are likely to run into as you use it. You are
at the beginning of a process of discovering practical problems that
are an inevitable part of using software. This is often frustrating.
But feeling stumped is a standard experience for everyone who writes
code. Each time you figure out the solution to your problem, you
acquire more and more knowledge about how and why things go wrong, and
more confidence about how to tackle the next glitch that comes along.</p>
<div id="a-little-more-about-r" class="section level2">
<h2><span class="header-section-number">A.1</span> A little more about R</h2>
<div id="how-to-read-an-r-help-page" class="section level3">
<h3><span class="header-section-number">A.1.1</span> How to read an R help page</h3>
<p>Functions, datasets, and other built-in objects in R are documented in its help system. You can search or browse this documentation via the “Help” tab in RStudio’s lower right-hand window. The quality of R’s help pages varies somewhat. They tend to be on the terse side. However, they all have essentially the same structure and it is useful to know how to read them. Figure <a href="appendix.html#fig:ch-09-help">A.1</a> provides an overview of what to look for. Remember, functions take inputs, perform actions, and return outputs. Something goes in, it gets worked on, and then something comes out. That means you want to know what the function <em>requires</em>, what it <em>does</em>, and what it <em>returns</em>. What it requires is shown in the <em>Usage</em> and <em>Arguments</em> sections of the help page. The names of all the required and optional arguments are given by name and in the order the function expects them. Some arguments have default values. In the case of the <code>mean()</code> function the argument <code>na.rm</code> is set to <code>FALSE</code> by default. These will be shown in the <em>Usage</em> section. If a named argument has no default, you will have to give it a value. Depending on what the argument is, this might be a logical value, a number, a dataset, or any other object.</p>
<div class="figure fullwidth"><span id="fig:ch-09-help"/>
<img src="../Images/6ce9b70c44f6aef3373d3f1779e4bb78.png" alt="The structure of an R help page." width="100%" data-original-src="https://socviz.co/assets/ch-09-read-a-help-page.png"/>
<p class="caption marginnote shownote">
Figure A.1: The structure of an R help page.
</p>
</div>
<p>The other part to look at closely is the <em>Value</em> section, which tells you what the function returns once it has done its calculation. Again, depending on what the function is, this might simply be a single number or other short bit of output. But it could also be something as complex as a ggplot figure or a model object consisting of many separate parts organized as a list.</p>
<p>Well-documented packages will often have <em>Demos</em> and <em>Vignettes</em> attached to them. These are meant to describe the package as a whole, rather than specific functions. A good package vignette will often have one or more fully-worked examples together with a discussion describing how the package works and what it can do. To see if there any package vignettes, click the link at the bottom of the function’s help page to be taken to the package index. Any available demos, vignettes, or other general help will be listed at the top.</p>
</div>
<div id="app-select" class="section level3">
<h3><span class="header-section-number">A.1.2</span> The basics of accessing and selecting things</h3>
<p>Generally speaking, the tidyverse’s preferred methods for data
subsetting, filtering, slicing and selecting will keep you away from
the underlying mechanics of selecting and extracting elements of
vectors, matrices, or tables of data. Carrying out these operations
through functions like <code>select()</code>, <code>filter()</code>, <code>subset()</code>, and
<code>merge()</code> is generally safer and more reliable than accessing elements
directly. However, it is worth knowing the basics of these operations.
Sometimes accessing elements directly is the most convenient thing to
do. More importantly, we may use these techniques in small ways in our
code with some regularity. Here we very briefly introduce some of R’s
selection operators for vectors, arrays, and tables.</p>
<p>Consider the <code>my_numbers</code> and <code>your_numbers</code> vectors again.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1">my_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb319-2" data-line-number="2">your_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">31</span>, <span class="dv">71</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">21</span>, <span class="dv">6</span>)</a></code></pre>
<p>To access any particular element in <code>my_numbers</code>, we use square
brackets. Square brackets are not like the parentheses after
functions. They are used to pick out an element indexed by its
position:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" data-line-number="1">my_numbers[<span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 1</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" data-line-number="1">my_numbers[<span class="dv">7</span>]</a></code></pre>
<pre><code>## [1] 25</code></pre>
<p>Putting the number <em>n</em> inside the brackets will give us (or “return”)
the <em>n</em>th element in the vector, assuming there is one. To access a
<em>sequence</em> of elements within a vector we can do this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" data-line-number="1">my_numbers[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 2 3 1</code></pre>
<p>This shorthand notation tells R to count from the 2nd to the 4th
element, inclusive. We are not restricted to selecting contiguous
elements, either. We can make use of our <code>c()</code> function again:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" data-line-number="1">my_numbers[<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)]</a></code></pre>
<pre><code>## [1] 2 1</code></pre>
<p>R evaluates the expression <code>c(2,4)</code> first, and then extracts just the
second and the fourth element from <code>my_numbers</code>, ignoring the others.
You might wonder why we didn’t just write <code>my_numbers[2,3]</code> directly.
The answer is that this notation is used for objects arrayed in two
dimensions (i.e. something with rows and columns), like matrices, data
frames, or tibbles. We can make a two-dimensional object by creating
two different vectors with the <code>c()</code> function and using the <code>tibble()</code>
function to collect them together:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1">my_tb &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb328-2" data-line-number="2">    <span class="dt">mine =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>, <span class="dv">8</span><span class="op">:</span><span class="dv">11</span>),</a>
<a class="sourceLine" id="cb328-3" data-line-number="3">    <span class="dt">yours =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">20</span>,<span class="dv">16</span>, <span class="dv">34</span><span class="op">:</span><span class="dv">31</span>))</a>
<a class="sourceLine" id="cb328-4" data-line-number="4"/>
<a class="sourceLine" id="cb328-5" data-line-number="5"><span class="kw">class</span>(my_tb)</a></code></pre>
<pre><code>## [1] "tbl_df"     "tbl"        "data.frame"</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" data-line-number="1">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00
## 2  4.00 20.0 
## 3  5.00 16.0 
## 4  8.00 34.0 
## 5  9.00 33.0 
## 6 10.0  32.0 
## 7 11.0  31.0</code></pre>
<p>We<label for="tufte-mn-94" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-94" class="margin-toggle"/><span class="marginnote shownote">In these chunks of code you will see some explanatory text set off by the hash symbol, <code>#</code>. In R’s syntax, the hash symbol is used to designate a comment. On any line of code, text that appears after a <code>#</code> symbol will be ignored by R’s interpreter. It won’t be evaluated and it won’t trigger a syntax error.</span> index data frames, tibbles, and other arrays by row first, and then by column. Arrays may also have more than two dimensions.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="dv">1</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="dv">2</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>The columns in our tibble have names. We can select elements using
them, too. We do this by putting the name of the column in
quotes where we previously put the index number of the column:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>If we want to get all the elements of a particular column, we can
leave out the row index. This will mean all the rows will be included
for whichever column we select.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" data-line-number="1">my_tb[,<span class="st">"mine"</span>] <span class="co"># All rows, Col 1</span></a></code></pre>
<pre><code>## # A tibble: 7 x 1
##    mine
##   &lt;dbl&gt;
## 1  1.00
## 2  4.00
## 3  5.00
## 4  8.00
## 5  9.00
## 6 10.0 
## 7 11.0</code></pre>
<p>We can do this the other way around, too, selecting a particular row and showing all columns:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb346-1" data-line-number="1">my_tb[<span class="dv">4</span>,] <span class="co"># Row 4, all cols</span></a></code></pre>
<pre><code>## # A tibble: 1 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  8.00  34.0</code></pre>
<p>A better way of accessing particular columns in a data frame is via
the <code>$</code> operator, which can be used to extract components of various
sorts of object. This way we append the name of the column we want to
the name of the object it belongs to:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">my_tb<span class="op">$</span>mine</a></code></pre>
<pre><code>## [1]  1  4  5  8  9 10 11</code></pre>
<p>Elements of many other objects can be extracted in this way, too,
including nested objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" data-line-number="1">out &lt;-<span class="st"> </span><span class="kw">lm</span>(mine <span class="op">~</span><span class="st"> </span>yours, <span class="dt">data =</span> my_tb)</a>
<a class="sourceLine" id="cb350-2" data-line-number="2"/>
<a class="sourceLine" id="cb350-3" data-line-number="3">out<span class="op">$</span>coefficients</a></code></pre>
<pre><code>## (Intercept)       yours 
##  -0.0801192   0.2873422</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" data-line-number="1">out<span class="op">$</span>call</a></code></pre>
<pre><code>## lm(formula = mine ~ yours, data = my_tb)</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb354-1" data-line-number="1">out<span class="op">$</span>qr<span class="op">$</span>rank <span class="co"># nested </span></a></code></pre>
<pre><code>## [1] 2</code></pre>
<p>Finally, in the case of data frames the <code>$</code> operator also lets us add new columns to the object. For example, we can add the first two columns together, row by row. To create a column in this way, we put the <code>$</code> and the name of the new column on the left-hand side of the assignment.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" data-line-number="1">my_tb<span class="op">$</span>ours &lt;-<span class="st"> </span>my_tb<span class="op">$</span>mine <span class="op">+</span><span class="st"> </span>my_tb<span class="op">$</span>yours</a>
<a class="sourceLine" id="cb356-2" data-line-number="2">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 3
##    mine yours  ours
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00  4.00
## 2  4.00 20.0  24.0 
## 3  5.00 16.0  21.0 
## 4  8.00 34.0  42.0 
## 5  9.00 33.0  42.0 
## 6 10.0  32.0  42.0 
## 7 11.0  31.0  42.0</code></pre>
<p>In this book we do not generally access data via <code>[</code> or <code>$</code>. It is
particularly bad practice to access elements by their index number
only, as opposed to using names. In both cases, and especially the
latter, it is too easy to make a mistake and choose the wrong columns
or rows. In addition, if our table changes shape later on (e.g. due to
the addition of new original data) then any absolute reference to the
position of columns (rather than to their names) is very likely to
break. Still, we do use the <code>c()</code> function for small tasks quite
regularly, so it’s worth understanding how it can be used to pick out
elements from vectors.</p>
</div>
<div id="tidydata" class="section level3">
<h3><span class="header-section-number">A.1.3</span> Tidy data</h3>
<p>Working with R and ggplot is much easier if the data you use is in the
right shape. Ggplot wants your data to be <em>tidy</em>. For a more thorough
introduction to the idea of tidy data, see Chapters 5 and 12 of
<span class="citation">Wickham &amp; Grolemund (2016)</span>. To get a sense of what a tidy dataset looks
like in R, we will follow the discussion in <span class="citation">Wickham (2014)</span>. In a tidy
dataset,</p>
<ol style="list-style-type: decimal">
<li><em>Each variable is a column.</em></li>
<li><em>Each observation is a row.</em></li>
<li><em>Each type of observational unit forms a table.</em></li>
</ol>
<p>For most of your data analysis, the first two points are the most
important. This third one might be a little unfamiliar. It is a
feature of “normalized” data from the world of databases, where the
goal is to represent data in a series of related tables with minimal
duplication <span class="citation">(Codd, 1990)</span>. Data analysis more
usually works with a single large table of data, often with
considerable duplication of some variables down the rows.</p>
<p>Data presented in summary tables is often not “tidy” as defined here.
When structuring our data we need to be clear about how our data is
arranged. If your data is not tidily arranged, the chances are good
that you will have more difficulty, and maybe a <em>lot</em> more
difficulty, getting ggplot to draw the figure you want.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg1">Table A.1: </span>Some untidy data.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">treatmenta</th>
<th align="right">treatmentb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">John Smith</td>
<td align="right">NA</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="right">4</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="right">6</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg2">Table A.2: </span>The same data, still untidy, but in a different way.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">treatment</th>
<th align="right">John Smith</th>
<th align="right">Jane Doe</th>
<th align="right">Mary Johnson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">a</td>
<td align="right">NA</td>
<td align="right">4</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="right">18</td>
<td align="right">1</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>For example consider Table <a href="appendix.html#tab:ch-09-preg1">A.1</a> and Table <a href="appendix.html#tab:ch-09-preg2">A.2</a>
from Wickham’s discussion. They present the same data in different
ways, but each would cause trouble if we tried to work with it in
ggplot to make a graph. Table <a href="appendix.html#tab:ch-09-preg3">A.3</a> shows the same data
once again, this time in a tidied form.</p>
<p>Hadley Wickham notes five main ways tables of data tend not to be
tidy:</p>
<ol style="list-style-type: decimal">
<li><em>Column headers are values, not variable names</em>.</li>
<li><em>Multiple variables are stored in one column</em>.</li>
<li><em>Variables are stored in both rows and columns</em>.</li>
<li><em>Multiple types of observational units are stored in the same table</em>.</li>
<li><em>A single observational unit is stored in multiple tables</em>.</li>
</ol>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg3">Table A.3: </span>Tidied data. Every variable a column, every observation a row.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">treatment</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Jane Doe</td>
<td align="left">a</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="left">b</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">John Smith</td>
<td align="left">a</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">John Smith</td>
<td align="left">b</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="left">a</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Mary Johnson</td>
<td align="left">b</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>Data comes in an untidy form all the time, often for the good reason
that it can be presented that way using much less space, or with far
less repetition of labels and row elements. Figure
<a href="appendix.html#fig:ch-09-census-untidy">A.2</a> shows a the first few rows of a table of U.S.
Census Bureau data about educational attainment in the United States.
To begin with, it’s organized as a series of sub-tables down the
spreadsheet, broken out by age and sex. Second, the underlying
variable of interest, “Years of School Completed” is stored across
several columns, with an additional variable (level of schooling)
included across the columns also. It is not too hard to get the table
into a slightly more regular format by eliminating the blank rows, and
explicitly naming the sub-table rows. One can do this manually and get
to the point where it can be read in as an Excel or CSV file. This is
not ideal, as manually cleaning data runs against the commitment to do
as much as possible programmatically.<label for="tufte-mn-95" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-95" class="margin-toggle"/><span class="marginnote shownote"><code>readxl.tidyverse.org</code></span> We can automate the process
somewhat. The tidyverse comes with a <code>readxl</code> package that tries to
ease the pain a little.</p>
<div class="figure"><span id="fig:ch-09-census-untidy"/>
<p class="caption marginnote shownote">
Figure A.2: Untidy data from the Census.
</p>
<img src="../Images/c7abcd15676ccf4d2f644bebb6b0dfab.png" alt="Untidy data from the Census." width="100%" data-original-src="https://socviz.co/assets/ch-09-census-untidy-small.png"/>
</div>
<pre><code>## # A tibble: 366 x 11
##    age   sex    year total elem4 elem8   hs3   hs4 coll3 coll4 median
##    &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1 25-34 Male   2016 21845   116   468  1427  6386  6015  7432     NA
##  2 25-34 Male   2015 21427   166   488  1584  6198  5920  7071     NA
##  3 25-34 Male   2014 21217   151   512  1611  6323  5910  6710     NA
##  4 25-34 Male   2013 20816   161   582  1747  6058  5749  6519     NA
##  5 25-34 Male   2012 20464   161   579  1707  6127  5619  6270     NA
##  6 25-34 Male   2011 20985   190   657  1791  6444  5750  6151     NA
##  7 25-34 Male   2010 20689   186   641  1866  6458  5587  5951     NA
##  8 25-34 Male   2009 20440   184   695  1806  6495  5508  5752     NA
##  9 25-34 Male   2008 20210   172   714  1874  6356  5277  5816     NA
## 10 25-34 Male   2007 20024   246   757  1930  6361  5137  5593     NA
## # ... with 356 more rows</code></pre>
<p>The tidyverse has several tools to help you get the rest of the way in
converting your data from an untidy to a tidy state. These can mostly
be found in the <code>tidyr</code> and <code>dplyr</code> libraries. The former provides
functions for converting, for example, wide-format data to long-format
data, as well as assisting with the business of splitting and
combining variables that are untidily stored. The latter has a tools
that allow tidy tables to be further filtered, sliced, and analyzed at
different grouping levels, as we have seen throughout this book.</p>
<p>With our <code>edu</code> object, we can use the <code>gather()</code> function to transform
the schooling variables into a <em>key-value</em> arrangement. The key is the
underlying variable, and the value is the value it takes for that
observation. We create a new object, <code>edu_t</code> in this way.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" data-line-number="1">edu_t &lt;-<span class="st"> </span><span class="kw">gather</span>(<span class="dt">data =</span> edu,</a>
<a class="sourceLine" id="cb359-2" data-line-number="2">                <span class="dt">key =</span> school,</a>
<a class="sourceLine" id="cb359-3" data-line-number="3">                <span class="dt">value =</span> freq,</a>
<a class="sourceLine" id="cb359-4" data-line-number="4">                elem4<span class="op">:</span>coll4)</a>
<a class="sourceLine" id="cb359-5" data-line-number="5"/>
<a class="sourceLine" id="cb359-6" data-line-number="6"><span class="kw">head</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex    year total median school  freq
##   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 25-34 Male   2016 21845     NA elem4    116
## 2 25-34 Male   2015 21427     NA elem4    166
## 3 25-34 Male   2014 21217     NA elem4    151
## 4 25-34 Male   2013 20816     NA elem4    161
## 5 25-34 Male   2012 20464     NA elem4    161
## 6 25-34 Male   2011 20985     NA elem4    190</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb361-1" data-line-number="1"><span class="kw">tail</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex     year total median school  freq
##   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 55&gt;   Female  1959 16263   8.30 coll4    688
## 2 55&gt;   Female  1957 15581   8.20 coll4    630
## 3 55&gt;   Female  1952 13662   7.90 coll4    628
## 4 55&gt;   Female  1950 13150   8.40 coll4    436
## 5 55&gt;   Female  1947 11810   7.60 coll4    343
## 6 55&gt;   Female  1940  9777   8.30 coll4    219</code></pre>
<p>The educational categories previously spread over the columns have
been gathered into two new columns. The <code>school</code> variable is the <em>key</em>
column. It contains all of the education categories that were
previously given across the column headers, from 0-4 years of
elementary school to four or more years of college. They are now
stacked up on top of each other in the rows. The <code>freq</code> variable is
the <em>value</em> column, and contains the unique value of <code>schooling</code> for
each level of that variable. Once our data is in this long-form shape,
it is ready for easy use with ggplot and related tidyverse tools.</p>
</div>
</div>
<div id="common-problems-reading-in-data" class="section level2">
<h2><span class="header-section-number">A.2</span> Common problems reading in data</h2>
<div id="date-formats" class="section level3 unnumbered">
<h3>Date formats</h3>
<p>Date formats can be annoying. First, times and dates must be treated
differently from ordinary numbers. Second, there are many, many
different date formats, differing both in the precision with which
they are stored and the convention they follow about how to display
years, months, days, and so on. Consider the following data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" data-line-number="1"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date       N
##   &lt;chr&gt;  &lt;int&gt;
## 1 9/1/11 44426
## 2 9/2/11 55112
## 3 9/3/11 19263
## 4 9/4/11 12330
## 5 9/5/11  8534
## 6 9/6/11 59490</code></pre>
<p>The data in the <code>date</code> column has been read in as a character
string, but we want R to treat it as a date. If can’t treat it as a
date, we get bad results.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-01"/>
<img src="../Images/52465ae3bdb35038a8ba0f67225c35e2.png" alt="A bad date." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.3: A bad date.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb365-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<pre><code>## geom_path: Each group consists of only one observation.
## Do you need to adjust the group aesthetic?</code></pre>
<p>What has happened? The problem is that ggplot doesn’t know <code>date</code>
consists of dates. As a result, when we ask to plot it on the x-axis,
it tries to treat the unique elements of <code>date</code> like a categorical
variable instead. (That is, as a factor.) But because each date is
unique, its default effort at grouping the data results in every group
having only one observation in it (i.e., that particular row). The
ggplot function knows something is odd about this, and tries to let
you know. It wonders whether we’ve failed to set <code>group = &lt;something&gt;</code>
in our mapping.</p>
<p>For the sake of it, let’s see what happens when the bad date values
are <em>not</em> unique. We will make a new data frame by stacking two copies of
the data on top of each other. The <code>rbind()</code> function does this for
us. We end up with two copies of every observation.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-02"/>
<img src="../Images/773245f5dd69a1ceaa507762c031c2c0.png" alt="Still bad." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.4: Still bad.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" data-line-number="1">bad_date2 &lt;-<span class="st"> </span><span class="kw">rbind</span>(bad_date, bad_date)</a>
<a class="sourceLine" id="cb367-2" data-line-number="2"/>
<a class="sourceLine" id="cb367-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date2, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb367-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<p>Now ggplot doesn’t complain at all, because there’s more than one
observation per (inferred) group. But the plot is still wrong!</p>
<p>We will fix this problem using the <code>lubridate</code> library. It provides a
suite of convenience functions for converting date strings in various
formats and with various separators (such as <code>/</code> or <code>-</code> and so on)
into objects of class <code>Date</code> that R knows about. Here our bad dates
are in a month/day/year format, so we use <code>mdy()</code>. Consult the
lubridate library’s documentation to learn more about similar
convenience functions for converting character strings where the date
components appear in a different order.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb368-1" data-line-number="1"><span class="co"># install.packages("lubridate")</span></a>
<a class="sourceLine" id="cb368-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb368-3" data-line-number="3"/>
<a class="sourceLine" id="cb368-4" data-line-number="4">bad_date<span class="op">$</span>date &lt;-<span class="st"> </span><span class="kw">mdy</span>(bad_date<span class="op">$</span>date)</a>
<a class="sourceLine" id="cb368-5" data-line-number="5"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date           N
##   &lt;date&gt;     &lt;int&gt;
## 1 2011-09-01 44426
## 2 2011-09-02 55112
## 3 2011-09-03 19263
## 4 2011-09-04 12330
## 5 2011-09-05  8534
## 6 2011-09-06 59490</code></pre>
<p>Now <code>filldate_new</code> has a <code>Date</code> class. Let’s try the plot
again.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-04"/>
<img src="../Images/f7c5e594b621f7ef4cb6ac4478fb6eac.png" alt="Much better." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.5: Much better.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb370-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb370-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
</div>
<div id="year-only-dates" class="section level3 unnumbered">
<h3>Year-only dates</h3>
<p>Many variables are measured by the year and supplied in the data as a
four digit number rather than as a date. This can sometimes cause
headaches when we want to plot year on the x-axis. It happens most
often when the time series is relatively short. Consider this data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" data-line-number="1">url &lt;-<span class="st"> "https://cdn.rawgit.com/kjhealy/viz-organdata/master/organdonation.csv"</span></a>
<a class="sourceLine" id="cb371-2" data-line-number="2"/>
<a class="sourceLine" id="cb371-3" data-line-number="3">bad_year &lt;-<span class="st"> </span><span class="kw">read_csv</span>(url)</a>
<a class="sourceLine" id="cb371-4" data-line-number="4">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(<span class="dv">10</span>)</a></code></pre>
<pre><code>## # A tibble: 10 x 3
##    country        year donors
##    &lt;chr&gt;         &lt;int&gt;  &lt;dbl&gt;
##  1 United States  1994  19.4 
##  2 Australia      1999   8.67
##  3 Canada         2001  13.5 
##  4 Australia      1994  10.2 
##  5 Sweden         1993  15.2 
##  6 Ireland        1992  19.5 
##  7 Switzerland    1997  14.3 
##  8 Ireland        2000  17.6 
##  9 Switzerland    1998  15.4 
## 10 Norway           NA  NA</code></pre>
<p>This is a version of <code>organdata</code> but in a less clean format. The <code>year</code> variable is an integer (its class is <code>&lt;int&gt;</code>) and not a date. Let’s say we want to plot donation rate against year.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-integeryear"/>
<img src="../Images/cf406ce378ab743be8bbbd295c58ca8f.png" alt="Integer year shown with a decimal point." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-integeryear-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.6: Integer year shown with a decimal point.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_year, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> donors))</a>
<a class="sourceLine" id="cb373-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre>
<p>The decimal point on the x-axis labels is unwanted. We could sort this out cosmetically, by giving <code>scale_x_continuous()</code> a set of <code>breaks</code> and <code>labels</code> that represent the years as characters. Alternatively, we can change the class of the <code>year</code> variable. For convenience, we will tell R that the <code>year</code> variable should be treated as a Date measure, and not an integer. We’ll use a home-cooked function, <code>int_to_year()</code>, that takes
integers and converts them to dates.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" data-line-number="1">bad_year<span class="op">$</span>year &lt;-<span class="st"> </span><span class="kw">int_to_year</span>(bad_year<span class="op">$</span>year)</a>
<a class="sourceLine" id="cb374-2" data-line-number="2">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a></code></pre>
<pre><code>## # A tibble: 238 x 3
##    country   year       donors
##    &lt;chr&gt;     &lt;date&gt;      &lt;dbl&gt;
##  1 Australia NA          NA   
##  2 Australia 1991-01-01  12.1 
##  3 Australia 1992-01-01  12.4 
##  4 Australia 1993-01-01  12.5 
##  5 Australia 1994-01-01  10.2 
##  6 Australia 1995-01-01  10.2 
##  7 Australia 1996-01-01  10.6 
##  8 Australia 1997-01-01  10.3 
##  9 Australia 1998-01-01  10.5 
## 10 Australia 1999-01-01   8.67
## # ... with 228 more rows</code></pre>
<p>In the process, today’s day and month are introduced into the year
data, but that is irrelevant in this case, given that our data are
only observed in a yearly window to begin with. However, if you wish to
specify a generic day and month for all the observations, the function
allows you to do this.</p>
</div>
<div id="write-functions-for-repetitive-tasks" class="section level3">
<h3><span class="header-section-number">A.2.1</span> Write functions for repetitive tasks</h3>
<p>If you are working with a data set that you will be making a lot of
similar plots from, or will need to periodically look at in a way that
is repetitive but can’t be carried out in a single step once and for
all, then the chances are that you will start accumulating sequences
of code that you find yourself using repeatedly. When this happens,
the temptation will be to start copying and pasting these sequences
from one analysis to the next. We can see something of this tendency
in the code samples for this book. To make the exposition clearer, we
have periodically repeated chunks of code that differ only in the
dependent or independent variable being plotted.</p>
<p>You should try to avoid copying and pasting code repeatedly in this
way. Instead, this is an opportunity to write a function to help you
out a little. More or less everything in R is accomplished through
functions, and it’s not too difficult to write your own. This is
especially the case when you begin by thinking of functions as a way
to help you automate some local or smaller task, rather than a means
of accomplishing some very complex task. R has the resources to help
you build complex functions and function libraries, like ggplot
itself. But we can start quite small, with functions that help us
manage a particular dataset or data analysis.</p>
<p>Remember, functions take <em>inputs</em>, perform <em>actions</em>, and return <em>outputs</em>. For example, imagine a function that adds two numbers, <code>x</code> and <code>y</code>. In use, it might look like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb376-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">7</span>)</a></code></pre>
<pre><code>## [1] 8</code></pre>
<p>How do we <em>create</em> this function? Remember, everything is an object, so functions are just special kinds of object. And everything in R is done via functions. So, if we want to make a new function we will use an existing function do to it. In R, functions are created with <code>function()</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb378-1" data-line-number="1">add_xy &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb378-2" data-line-number="2">    x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb378-3" data-line-number="3">}</a></code></pre>
<p>You can see that <code>function()</code> is a little different from ordinary functions in two ways. First, the arguments we give it (here, <code>x</code> and <code>y</code>) are for the <code>add_xy</code> function that we are <em>creating</em>. Second, immediately after the <code>function(x, y)</code> statement there’s an opening brace, <code>{</code>, followed by a bit of R code that adds x and y, and then the closing brace <code>}</code>. That’s the content of the function. We assign this code to the <code>add_xy</code> object, and now we have a function that adds two numbers together and returns the result. The <code>x + y</code> line inside the parentheses is evaluated as if it were typed at the console, assuming you have told it what <code>x</code> and <code>y</code> are.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">5</span>, <span class="dt">y =</span> <span class="dv">2</span>)</a></code></pre>
<pre><code>## [1] 7</code></pre>
<p>Functions can take many kinds of arguments, and we can also tell them
what the default value of each argument should be by specifying it
inside the <code>function(...)</code> section. Functions are little programs that
have all the power of R at their disposal, including standard things
like flow-control through <code>if ... else</code> statements and so on. Here,
for instance, is a function that will make a scatter plot for any
Section in the ASA data, or optionally fit a smoother to the data
and plot that instead. Defining a function looks a little like calling one, except that we spell out the steps inside. We also specify the default arguments.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb381-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb381-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb381-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb381-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb381-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb381-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb381-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb381-9" data-line-number="9"/>
<a class="sourceLine" id="cb381-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb381-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb381-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb381-13" data-line-number="13">                              <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">3</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-14" data-line-number="14"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-15" data-line-number="15"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-16" data-line-number="16">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb381-17" data-line-number="17">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-18" data-line-number="18"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-19" data-line-number="19"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-20" data-line-number="20">    }</a>
<a class="sourceLine" id="cb381-21" data-line-number="21"/>
<a class="sourceLine" id="cb381-22" data-line-number="22">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb381-23" data-line-number="23">}</a></code></pre>
<p>This function is not very general. Nor is it particularly robust. But for the use we want to put it to, it works just fine.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Rationality"</span>)</a>
<a class="sourceLine" id="cb382-2" data-line-number="2"><span class="kw">plot_section</span>(<span class="st">"Sexualities"</span>, <span class="dt">smooth =</span> <span class="ot">TRUE</span>)</a></code></pre>
<div class="figure"><span id="fig:plot-section-example"/>
<p class="caption marginnote shownote">
Figure A.7: Using a function to plot your results.
</p>
<img src="../Images/2752e9cfed4f3c38227ed449f207ed3c.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-1.png"/><img src="../Images/87dcf314f4b6be8bb89c2d3262a68d61.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-2.png"/>
</div>
<p>If we were going to work with this data for long enough, we could make
the function progressively more general. For example, we can add the
special <code>...</code> argument (which means, roughly, “and any other named
arguments”) in a way that allows us to pass arguments through to the
<code>geom_smooth()</code> function in the way we’d expect if we were using it
directly. With that in place, we can pick the smoothing method we want.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb383-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb383-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb383-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>, ...){</a>
<a class="sourceLine" id="cb383-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb383-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb383-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb383-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb383-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb383-9" data-line-number="9"/>
<a class="sourceLine" id="cb383-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb383-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb383-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, ...) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-13" data-line-number="13"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-14" data-line-number="14"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-15" data-line-number="15">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb383-16" data-line-number="16">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-17" data-line-number="17"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-18" data-line-number="18"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb383-20" data-line-number="20"/>
<a class="sourceLine" id="cb383-21" data-line-number="21">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb383-22" data-line-number="22">}</a></code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Comm/Urban"</span>,</a>
<a class="sourceLine" id="cb384-2" data-line-number="2">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-3" data-line-number="3">             <span class="dt">method =</span> <span class="st">"loess"</span>)</a>
<a class="sourceLine" id="cb384-4" data-line-number="4"><span class="kw">plot_section</span>(<span class="st">"Children"</span>,</a>
<a class="sourceLine" id="cb384-5" data-line-number="5">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-6" data-line-number="6">             <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb384-7" data-line-number="7">             <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">2</span>))</a></code></pre>
<div class="figure"><span id="fig:ch-09-plot-function"/>
<p class="caption marginnote shownote">
Figure A.8: Our custom function can now pass arguments along to fit different smoothers to Section membership data.
</p>
<img src="../Images/e75ff4a3d54ffa56e423e228c0a57c17.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-1.png"/><img src="../Images/71f7dc2cba63a58337cf365b42199eb6.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-2.png"/>
</div>
</div>
</div>
<div id="managing-projects-and-files" class="section level2">
<h2><span class="header-section-number">A.3</span> Managing projects and files</h2>
<div id="markdown" class="section level3">
<h3><span class="header-section-number">A.3.1</span> RMarkdown and knitr</h3>
<p>Markdown<label for="tufte-mn-96" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-96" class="margin-toggle"/><span class="marginnote shownote"><code>en.wikipedia.org/wiki/Markdown</code></span> is a
loosely-standardized way of writing plain text that includes
information about the formatting of your document. It was originally
developed by John Gruber, with input from Aaron Swartz. The aim was to
make a simple format that could incorporate some structural
information about the document (such as headings and subheadings,
<em>emphasis</em>, hyperlinks, lists, footnotes, and so on), with minimal loss of readability in plain-text
form. A plain-text format like HTML is much more extensive and
well-defined than Markdown, but Markdown was meant to be simple. Over
the years, and despite various weaknesses, it has become a <em>de facto</em>
standard. Text editors and note-taking applications support it, and
tools exist to convert Markdown not just into HTML (its original
target output format) but many other document types as well. The most
powerful of these is Pandoc<label for="tufte-mn-97" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-97" class="margin-toggle"/><span class="marginnote shownote"><code>pandoc.org</code></span>, which can get you
from markdown to many other formats (and <em>vice versa</em>). Pandoc is what
powers RStudio’s ability to convert your notes to HTML, Microsoft
Word, and PDF documents.</p>
<p>Chapter 1 of this book encourages you to take notes and organize your
analysis using RMarkdown<label for="tufte-mn-98" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-98" class="margin-toggle"/><span class="marginnote shownote"><code>rmarkdown.rstudio.com</code></span> and (behind the scenes) knitr<label for="tufte-mn-99" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-99" class="margin-toggle"/><span class="marginnote shownote"><code>yihui.name/knitr</code></span>. These are R libraries that RStudio makes easy to use. RMarkdown extends Markdown by letting
you intersperse your notes with chunks of R code. Code chunks can have
labels and a few options that determine how they will behave when the
file is processed. After writing your notes and your code, you <code>knit</code>
the document <span class="citation">(Xie, 2015)</span>. That is, you feed your <code>.Rmd</code> file
to R, which processes the code chunks, and produces a new <code>.md</code> where
the code chunks have been replaced by their output. You can then turn
that Markdown file into a more readable PDF or HTML document, or the
Word document that a journal demands you send them.</p>
<p>Behind the scenes in RStudio, this is all done using the <code>knitr</code> and
<code>rmarkdown</code> libraries. The latter provides a <code>render()</code> function that
takes you from <code>.Rmd</code> to HTML or PDF in a single step. Conversely, if
you just want to extract the code you’ve written from the surrounding
text, then you “tangle” the file, which results in an <code>.R</code> file. The
strength of this approach is that is makes it much easier to document
your work properly. There is just one file for both the data analysis
and the writeup. The output of the analysis is created on the fly, and
the code to do it is embedded in the paper. If you need to do multiple
but identical (or very similar) analyses of different bits of data,
RMarkdown and <code>knitr</code> can make generating consistent and reliable
reports much easier.</p>
<p>Pandoc’s flavor of Markdown is the one used in knitr and
RStudio. It allows for a wide range of markup, and can handle many of
the nuts and bolts of scholarly writing, such as complex tables,
citations, bibliographies, references, and mathematics. In addition to
being able to produce documents in various <em>file</em> formats, it can also
produce many different <em>kinds</em> of document, from articles and handouts
to websites and slide decks. RStudio’s RMarkdown website has extensive
documentation and examples on the ins and outs of RMarkdown’s
capabilities, including information on customizing it if you wish.</p>
<p>Writing your notes and papers in a plain text format like this has
many advantages. It keeps your writing, your code, and your results
closer together, and allows you to use powerful version control
methods to keep track of your work and your results. Errors in data
analysis often well up out of the gap that typically exists between
the procedure used to produce a figure or table in a paper and the
subsequent use of that output later. In the ordinary way of doing
things, you have the code for your data analysis in one file, the
output it produced in another, and the text of your paper in a third
file. You do the analysis, collect the output and copy the relevant
results into your paper, often manually reformatting them on the way.
Each of these transitions introduces the opportunity for error. In
particular, it is easy for a table of results to get detached from the
sequence of steps that produced it. Almost everyone who has written a
quantitative paper has been confronted with the problem of reading an
old draft containing results or figures that need to be revisited or
reproduced (as a result of peer-review, say) but which lack any
information about the circumstances of their creation. Academic papers
take a long time to get through the cycle of writing, review,
revision, and publication, even when you’re working hard the whole
time. It is not uncommon to have to return to something you did two
years previously in order to answer some question or other from a
reviewer. You do not want to have to do everything over from scratch
in order to get the right answer. I am not exaggerating when I say
that, whatever the challenges of replicating the results of someone
else’s quantitative analysis, after a fairly short period of time
authors themselves find it hard to replicate their <em>own</em> work.
<em>Bit-rot</em> is the term of art in Computer Science for the seemingly
inevitable process of decay that overtakes a project just because
you left it alone on your computer for six months or more.</p>
<p>For small and medium-sized projects, plain text approaches that rely
on RMarkdown documents and the tools described here work well. Things
become a little more complicated as projects get larger. (This is not
an intrinsic flaw of plain-text methods, by the way. It is true no
matter how you choose to organize your project.) In general, it is
worth trying to keep your notes and analysis in a standardized and
simple format. The final outputs of projects (such as journal articles
or books) tend, as they approach completion, to descend into a rush of
specific fixes and adjustments, all running against the ideal of a
fully portable, reproducible analysis. It is worth trying to minimize
the scope of the inevitable final scramble.</p>
</div>
<div id="project-organization" class="section level3">
<h3><span class="header-section-number">A.3.2</span> Project organization</h3>
<p>Managing projects is a large topic of its own, and one that people have strong opinions about. Your goal should be to make your code and data portable, reproducible, and self-contained. In practice that means using a project based approach in R Studio. When you start an analysis with some new data, create a new project containing the data and the R or RMarkdown code you will be working with. It should then be possible, in the ideal case, to move that folder to another computer that also has R, RStudio, and any required libraries installed, and successfully re-run the contents of the project.</p>
<p>In practice that means two things. First, even though R is an object-oriented language, the only “real”, persistent things in your project should be the raw data files you start with, and the code that operates on them. The code is what is real. Your code manipulates the data and creates all of the objects and outputs you need. It’s possible to save objects in R but in general you should not need to do this for everyday analysis.</p>
<p>Second, your code should not refer to any file locations outside of the project folder. The project folder should be the “root” or ground floor for the files inside it. This means you should not use <em>absolute</em> file paths to save or refer to data or figures. Instead, use only <em>relative</em> paths. A relative path will start at the root of the project. So, for example, you should not load data with a command like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" data-line-number="1">## An absolute file path.</a>
<a class="sourceLine" id="cb385-2" data-line-number="2">## Notice the leading "/" that starts at the very top</a>
<a class="sourceLine" id="cb385-3" data-line-number="3">## of the computer's file hierarchy.</a>
<a class="sourceLine" id="cb385-4" data-line-number="4">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"/Users/kjhealy/projects/gss/data/gss.csv"</span>)</a></code></pre>
<p>Instead, because you have an R project file started in the <code>gss</code> folder you can use the <code>here()</code> library to specify a relative path, like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" data-line-number="1">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">here</span>(<span class="st">"data"</span>, <span class="st">"gss.csv"</span>))</a></code></pre>
<p>While you could type the relative paths out yourself, using <code>here()</code> has the advantage that it will work if, for example, you use Mac OS and you send your project to someone working on Windows. The same rule goes for saving your work, as we saw at the end of Chapter @(sec:makeplot), when you save individual plots as PDF or PNG files.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-org-simple-project"/>
<img src="../Images/121f0a5c0a13ac2f29b9f15a9cd8e0b4.png" alt="Folder organization for a simple project." width="100%" data-original-src="https://socviz.co/assets/ch-09-org-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.9: Folder organization for a simple project.<!--</p>-->
<!--</div>--></span>
</p>
<p>Within your project folder, a little organization goes a long way. You should get in the habit of keeping different parts of the project in different sub-folders of your working directory. More complex projects may have a more complex structure, but you can go a long way with some simple organization. RMarkdown files can be in the top level of your working directory, with separate sub-folders called <code>data/</code> (for your CSV files), one for <code>figures/</code> (that you might save) and perhaps one called <code>docs/</code> for information about your project or data files files. Rstudio can help with organization as well through its project management features.</p>
<p>Keeping your project organized just a little bit will prevent you from ending up with huge numbers of files of different kinds all sitting at the top of your working directory.</p>
</div>
</div>
<div id="some-features-of-this-book" class="section level2">
<h2><span class="header-section-number">A.4</span> Some features of this book</h2>
<div id="preparing-the-county-level-maps" class="section level3">
<h3><span class="header-section-number">A.4.1</span> Preparing the county-level maps</h3>
<p>The U.S. county-level maps in the <code>socviz</code> library were prepared using
shapefiles from the U.S. Census Bureau that were converted to GeoJSON
format by Eric Celeste.<label for="tufte-mn-100" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-100" class="margin-toggle"/><span class="marginnote shownote"><code>eric.clst.org/Stuff/USGeoJSON</code></span> The code to prepare the imported shapefile was written by Bob Rudis, and draws on the <code>rgdal</code> library to do the heavy lifting of importing the shapefile and transforming the projection. Bob’s code extracts the (county-identifying) rownames from the imported spatial data frame, and then moves Alaska and Hawaii to new locations in the bottom left of the map area, so that we can map all fifty states instead of just the lower forty eight.</p>
<p>First we read in the map file, set the projection, and set up an identifying variable we can work with later on to merge in data. The call to <code>CRS()</code> is a single long line of text conforming to a technical GIS specification defining the projection and other details that the map is encoded in. Long lines of code are conventionally indicated by the backslash charater, “<code>\</code>”, when we have to artificially break them on the page. Do not type the backslash if you write out this code yourself. We assume the mapfile is named <code>gz_2010_us_050_00_5m.json</code> and is in the <code>data/geojson</code> subfolder of the project directory.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb387-1" data-line-number="1"><span class="co"># You will need to use install.packages() to install</span></a>
<a class="sourceLine" id="cb387-2" data-line-number="2"><span class="co"># these map and GIS libraries if you do not already</span></a>
<a class="sourceLine" id="cb387-3" data-line-number="3"><span class="co"># have them.</span></a>
<a class="sourceLine" id="cb387-4" data-line-number="4"/>
<a class="sourceLine" id="cb387-5" data-line-number="5"><span class="kw">library</span>(maptools)</a>
<a class="sourceLine" id="cb387-6" data-line-number="6"><span class="kw">library</span>(mapproj)</a>
<a class="sourceLine" id="cb387-7" data-line-number="7"><span class="kw">library</span>(rgeos)</a>
<a class="sourceLine" id="cb387-8" data-line-number="8"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb387-9" data-line-number="9"/>
<a class="sourceLine" id="cb387-10" data-line-number="10">us_counties &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn=</span><span class="st">"data/geojson/gz_2010_us_050_00_5m.json"</span>,</a>
<a class="sourceLine" id="cb387-11" data-line-number="11">                       <span class="dt">layer=</span><span class="st">"OGRGeoJSON"</span>)</a>
<a class="sourceLine" id="cb387-12" data-line-number="12"/>
<a class="sourceLine" id="cb387-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">spTransform</span>(us_counties,</a>
<a class="sourceLine" id="cb387-14" data-line-number="14">                    <span class="kw">CRS</span>(<span class="st">"+proj=laea +lat_0=45 +lon_0=-100 \</span></a>
<a class="sourceLine" id="cb387-15" data-line-number="15"><span class="st">                         +x_0=0 +y_0=0 +a=6370997 +b=6370997 \</span></a>
<a class="sourceLine" id="cb387-16" data-line-number="16"><span class="st">                         +units=m +no_defs"</span>))</a>
<a class="sourceLine" id="cb387-17" data-line-number="17"/>
<a class="sourceLine" id="cb387-18" data-line-number="18">us_counties_aea<span class="op">@</span>data<span class="op">$</span>id &lt;-<span class="st"> </span><span class="kw">rownames</span>(us_counties_aea<span class="op">@</span>data)</a></code></pre>
<p>With the file imported, we then extract, rotate, shrink, and move Alaska, resetting the projection in the process. We also move Hawaii. The areas are identified by their State FIPS codes. We remove the old states and put the new ones back in, and remove Puerto Rico as our examples lack data for this region. If you have data for the area, you can move it between Texas and Florida.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1">alaska &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE <span class="op">==</span><span class="st"> "02"</span>,]</a>
<a class="sourceLine" id="cb388-2" data-line-number="2">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb388-3" data-line-number="3">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">scale=</span><span class="kw">max</span>(<span class="kw">apply</span>(<span class="kw">bbox</span>(alaska), <span class="dv">1</span>, diff)) <span class="op">/</span><span class="st"> </span><span class="fl">2.3</span>)</a>
<a class="sourceLine" id="cb388-4" data-line-number="4">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">shift=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2100000</span>, <span class="dv">-2500000</span>))</a>
<a class="sourceLine" id="cb388-5" data-line-number="5"><span class="kw">proj4string</span>(alaska) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-6" data-line-number="6"/>
<a class="sourceLine" id="cb388-7" data-line-number="7">hawaii &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE<span class="op">==</span><span class="st">"15"</span>,]</a>
<a class="sourceLine" id="cb388-8" data-line-number="8">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">35</span>)</a>
<a class="sourceLine" id="cb388-9" data-line-number="9">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">shift=</span><span class="kw">c</span>(<span class="dv">5400000</span>, <span class="dv">-1400000</span>))</a>
<a class="sourceLine" id="cb388-10" data-line-number="10"><span class="kw">proj4string</span>(hawaii) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-11" data-line-number="11"/>
<a class="sourceLine" id="cb388-12" data-line-number="12">us_counties_aea &lt;-<span class="st"> </span>us_counties_aea[<span class="op">!</span>us_counties_aea<span class="op">$</span>STATE <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"02"</span>, <span class="st">"15"</span>, <span class="st">"72"</span>),]</a>
<a class="sourceLine" id="cb388-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">rbind</span>(us_counties_aea, alaska, hawaii)</a></code></pre>
<p>Finally, we tidy the spatial object into a data frame that ggplot can use, and clean up the <code>id</code> label by stripping out a prefix from the string.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" data-line-number="1">county_map &lt;-<span class="st"> </span><span class="kw">tidy</span>(us_counties_aea, <span class="dt">region =</span> <span class="st">"GEO_ID"</span>)</a>
<a class="sourceLine" id="cb389-2" data-line-number="2">county_map<span class="op">$</span>id &lt;-<span class="st"> </span>stringr<span class="op">::</span><span class="kw">str_replace</span>(county_map<span class="op">$</span>id,</a>
<a class="sourceLine" id="cb389-3" data-line-number="3">                                      <span class="dt">pattern =</span> <span class="st">"0500000US"</span>, <span class="dt">replacement =</span> <span class="st">""</span>)</a></code></pre>
<p>At<label for="tufte-mn-101" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-101" class="margin-toggle"/><span class="marginnote shownote">For more detail and code for the merge, see <code>github.com/kjhealy/us-county</code></span> this point the <code>county_map</code> object is ready to be merged with a table of FIPS-coded US county data using either <code>merge()</code> or <code>left_join()</code>.</p>
</div>
<div id="this-books-plot-theme-and-its-map-theme" class="section level3">
<h3><span class="header-section-number">A.4.2</span> This book’s plot theme, and its map theme</h3>
<p>The ggplot theme used in this book is derived principally from the work (again) of
Bob Rudis. His <code>hrbrthemes</code> package provides <code>theme_ipsum()</code>, a compact theme that can be used with the Arial typeface or, in a variant, the freely available Roboto Condensed typeface. The main difference between the <code>theme_book()</code> used here and Rudis’s <code>theme_ipsum()</code> is the choice of typeface. The <code>hrbrthemes</code> package can be installed from GitHub in the usual way:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">"hrbrmstr/hrbrthemes"</span>)</a></code></pre>
<p>The<label for="tufte-mn-102" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-102" class="margin-toggle"/><span class="marginnote shownote"><code>github.com/kjhealy/myriad</code></span> book theme is also available on GitHub. This package does not include the font files themselves. These are available from Adobe, who make the typeface.</p>
<p>When drawing maps we also used a <code>theme_map()</code> function. This theme
begins with the built-in <code>theme_bw()</code> and turns off most of the
guide, scale, panel content that is not needed when presenting a map. It is available through the <code>socviz</code> library. The code looks like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">theme_map &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">base_size=</span><span class="dv">9</span>, <span class="dt">base_family=</span><span class="st">""</span>) {</a>
<a class="sourceLine" id="cb391-2" data-line-number="2">    <span class="kw">require</span>(grid)</a>
<a class="sourceLine" id="cb391-3" data-line-number="3">    <span class="kw">theme_bw</span>(<span class="dt">base_size=</span>base_size, <span class="dt">base_family=</span>base_family) <span class="op">%+replace%</span></a>
<a class="sourceLine" id="cb391-4" data-line-number="4"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-5" data-line-number="5">              <span class="dt">axis.text=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-6" data-line-number="6">              <span class="dt">axis.ticks=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-7" data-line-number="7">              <span class="dt">axis.title=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-8" data-line-number="8">              <span class="dt">panel.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-9" data-line-number="9">              <span class="dt">panel.border=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-10" data-line-number="10">              <span class="dt">panel.grid=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-11" data-line-number="11">              <span class="dt">panel.spacing=</span><span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>),</a>
<a class="sourceLine" id="cb391-12" data-line-number="12">              <span class="dt">plot.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-13" data-line-number="13">              <span class="dt">legend.justification =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb391-14" data-line-number="14">              <span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb391-15" data-line-number="15">              )</a>
<a class="sourceLine" id="cb391-16" data-line-number="16">}</a></code></pre>
<p>Themes are functions. Creating a theme means writing a function with a sequence of instructions about what thematic elements to modify, and how. We give it a default <code>base_size</code> argument and an empty <code>base_family</code> argument (for the font family). The <code>%+replace%</code> operator in the code is new to us. This is a convenience operator defined by ggplot and used for updating theme elements in bulk. Throughout the book we saw repeated use of the <code>+</code> operator to incrementally add to or tweak the content of a theme, as when we would do <code>+ theme(legend.position = "top")</code>. Using <code>+</code> added the instruction to the theme, adjusting whatever was specified and leaving everything else as it was. The <code>%+replace%</code> operator does something similar, but it has a stronger effect. We begin with <code>theme_bw()</code> and then use a <code>theme()</code> statement to add new content, as usual. The <code>%+replace%</code> operator replaces the entire element specified, rather than adding to it. Any element not specified in the <code>theme()</code> statement will be deleted from the new theme. So this is a way to create themes by both starting from existing ones, specifying new elements, and deleting anything not explicitly mentioned. See the documentation for <code>theme_get()</code> for more details. In the function here, you can see each of the thematic elements that are “switched off” using the <code>element_blank()</code> function.</p>



</div>
</div>
&#13;

<h2><span class="header-section-number">A.1</span> A little more about R</h2>
<div id="how-to-read-an-r-help-page" class="section level3">
<h3><span class="header-section-number">A.1.1</span> How to read an R help page</h3>
<p>Functions, datasets, and other built-in objects in R are documented in its help system. You can search or browse this documentation via the “Help” tab in RStudio’s lower right-hand window. The quality of R’s help pages varies somewhat. They tend to be on the terse side. However, they all have essentially the same structure and it is useful to know how to read them. Figure <a href="appendix.html#fig:ch-09-help">A.1</a> provides an overview of what to look for. Remember, functions take inputs, perform actions, and return outputs. Something goes in, it gets worked on, and then something comes out. That means you want to know what the function <em>requires</em>, what it <em>does</em>, and what it <em>returns</em>. What it requires is shown in the <em>Usage</em> and <em>Arguments</em> sections of the help page. The names of all the required and optional arguments are given by name and in the order the function expects them. Some arguments have default values. In the case of the <code>mean()</code> function the argument <code>na.rm</code> is set to <code>FALSE</code> by default. These will be shown in the <em>Usage</em> section. If a named argument has no default, you will have to give it a value. Depending on what the argument is, this might be a logical value, a number, a dataset, or any other object.</p>
<div class="figure fullwidth"><span id="fig:ch-09-help"/>
<img src="../Images/6ce9b70c44f6aef3373d3f1779e4bb78.png" alt="The structure of an R help page." width="100%" data-original-src="https://socviz.co/assets/ch-09-read-a-help-page.png"/>
<p class="caption marginnote shownote">
Figure A.1: The structure of an R help page.
</p>
</div>
<p>The other part to look at closely is the <em>Value</em> section, which tells you what the function returns once it has done its calculation. Again, depending on what the function is, this might simply be a single number or other short bit of output. But it could also be something as complex as a ggplot figure or a model object consisting of many separate parts organized as a list.</p>
<p>Well-documented packages will often have <em>Demos</em> and <em>Vignettes</em> attached to them. These are meant to describe the package as a whole, rather than specific functions. A good package vignette will often have one or more fully-worked examples together with a discussion describing how the package works and what it can do. To see if there any package vignettes, click the link at the bottom of the function’s help page to be taken to the package index. Any available demos, vignettes, or other general help will be listed at the top.</p>
</div>
<div id="app-select" class="section level3">
<h3><span class="header-section-number">A.1.2</span> The basics of accessing and selecting things</h3>
<p>Generally speaking, the tidyverse’s preferred methods for data
subsetting, filtering, slicing and selecting will keep you away from
the underlying mechanics of selecting and extracting elements of
vectors, matrices, or tables of data. Carrying out these operations
through functions like <code>select()</code>, <code>filter()</code>, <code>subset()</code>, and
<code>merge()</code> is generally safer and more reliable than accessing elements
directly. However, it is worth knowing the basics of these operations.
Sometimes accessing elements directly is the most convenient thing to
do. More importantly, we may use these techniques in small ways in our
code with some regularity. Here we very briefly introduce some of R’s
selection operators for vectors, arrays, and tables.</p>
<p>Consider the <code>my_numbers</code> and <code>your_numbers</code> vectors again.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1">my_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb319-2" data-line-number="2">your_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">31</span>, <span class="dv">71</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">21</span>, <span class="dv">6</span>)</a></code></pre>
<p>To access any particular element in <code>my_numbers</code>, we use square
brackets. Square brackets are not like the parentheses after
functions. They are used to pick out an element indexed by its
position:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" data-line-number="1">my_numbers[<span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 1</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" data-line-number="1">my_numbers[<span class="dv">7</span>]</a></code></pre>
<pre><code>## [1] 25</code></pre>
<p>Putting the number <em>n</em> inside the brackets will give us (or “return”)
the <em>n</em>th element in the vector, assuming there is one. To access a
<em>sequence</em> of elements within a vector we can do this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" data-line-number="1">my_numbers[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 2 3 1</code></pre>
<p>This shorthand notation tells R to count from the 2nd to the 4th
element, inclusive. We are not restricted to selecting contiguous
elements, either. We can make use of our <code>c()</code> function again:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" data-line-number="1">my_numbers[<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)]</a></code></pre>
<pre><code>## [1] 2 1</code></pre>
<p>R evaluates the expression <code>c(2,4)</code> first, and then extracts just the
second and the fourth element from <code>my_numbers</code>, ignoring the others.
You might wonder why we didn’t just write <code>my_numbers[2,3]</code> directly.
The answer is that this notation is used for objects arrayed in two
dimensions (i.e. something with rows and columns), like matrices, data
frames, or tibbles. We can make a two-dimensional object by creating
two different vectors with the <code>c()</code> function and using the <code>tibble()</code>
function to collect them together:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1">my_tb &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb328-2" data-line-number="2">    <span class="dt">mine =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>, <span class="dv">8</span><span class="op">:</span><span class="dv">11</span>),</a>
<a class="sourceLine" id="cb328-3" data-line-number="3">    <span class="dt">yours =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">20</span>,<span class="dv">16</span>, <span class="dv">34</span><span class="op">:</span><span class="dv">31</span>))</a>
<a class="sourceLine" id="cb328-4" data-line-number="4"/>
<a class="sourceLine" id="cb328-5" data-line-number="5"><span class="kw">class</span>(my_tb)</a></code></pre>
<pre><code>## [1] "tbl_df"     "tbl"        "data.frame"</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" data-line-number="1">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00
## 2  4.00 20.0 
## 3  5.00 16.0 
## 4  8.00 34.0 
## 5  9.00 33.0 
## 6 10.0  32.0 
## 7 11.0  31.0</code></pre>
<p>We<label for="tufte-mn-94" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-94" class="margin-toggle"/><span class="marginnote shownote">In these chunks of code you will see some explanatory text set off by the hash symbol, <code>#</code>. In R’s syntax, the hash symbol is used to designate a comment. On any line of code, text that appears after a <code>#</code> symbol will be ignored by R’s interpreter. It won’t be evaluated and it won’t trigger a syntax error.</span> index data frames, tibbles, and other arrays by row first, and then by column. Arrays may also have more than two dimensions.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="dv">1</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="dv">2</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>The columns in our tibble have names. We can select elements using
them, too. We do this by putting the name of the column in
quotes where we previously put the index number of the column:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>If we want to get all the elements of a particular column, we can
leave out the row index. This will mean all the rows will be included
for whichever column we select.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" data-line-number="1">my_tb[,<span class="st">"mine"</span>] <span class="co"># All rows, Col 1</span></a></code></pre>
<pre><code>## # A tibble: 7 x 1
##    mine
##   &lt;dbl&gt;
## 1  1.00
## 2  4.00
## 3  5.00
## 4  8.00
## 5  9.00
## 6 10.0 
## 7 11.0</code></pre>
<p>We can do this the other way around, too, selecting a particular row and showing all columns:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb346-1" data-line-number="1">my_tb[<span class="dv">4</span>,] <span class="co"># Row 4, all cols</span></a></code></pre>
<pre><code>## # A tibble: 1 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  8.00  34.0</code></pre>
<p>A better way of accessing particular columns in a data frame is via
the <code>$</code> operator, which can be used to extract components of various
sorts of object. This way we append the name of the column we want to
the name of the object it belongs to:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">my_tb<span class="op">$</span>mine</a></code></pre>
<pre><code>## [1]  1  4  5  8  9 10 11</code></pre>
<p>Elements of many other objects can be extracted in this way, too,
including nested objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" data-line-number="1">out &lt;-<span class="st"> </span><span class="kw">lm</span>(mine <span class="op">~</span><span class="st"> </span>yours, <span class="dt">data =</span> my_tb)</a>
<a class="sourceLine" id="cb350-2" data-line-number="2"/>
<a class="sourceLine" id="cb350-3" data-line-number="3">out<span class="op">$</span>coefficients</a></code></pre>
<pre><code>## (Intercept)       yours 
##  -0.0801192   0.2873422</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" data-line-number="1">out<span class="op">$</span>call</a></code></pre>
<pre><code>## lm(formula = mine ~ yours, data = my_tb)</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb354-1" data-line-number="1">out<span class="op">$</span>qr<span class="op">$</span>rank <span class="co"># nested </span></a></code></pre>
<pre><code>## [1] 2</code></pre>
<p>Finally, in the case of data frames the <code>$</code> operator also lets us add new columns to the object. For example, we can add the first two columns together, row by row. To create a column in this way, we put the <code>$</code> and the name of the new column on the left-hand side of the assignment.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" data-line-number="1">my_tb<span class="op">$</span>ours &lt;-<span class="st"> </span>my_tb<span class="op">$</span>mine <span class="op">+</span><span class="st"> </span>my_tb<span class="op">$</span>yours</a>
<a class="sourceLine" id="cb356-2" data-line-number="2">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 3
##    mine yours  ours
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00  4.00
## 2  4.00 20.0  24.0 
## 3  5.00 16.0  21.0 
## 4  8.00 34.0  42.0 
## 5  9.00 33.0  42.0 
## 6 10.0  32.0  42.0 
## 7 11.0  31.0  42.0</code></pre>
<p>In this book we do not generally access data via <code>[</code> or <code>$</code>. It is
particularly bad practice to access elements by their index number
only, as opposed to using names. In both cases, and especially the
latter, it is too easy to make a mistake and choose the wrong columns
or rows. In addition, if our table changes shape later on (e.g. due to
the addition of new original data) then any absolute reference to the
position of columns (rather than to their names) is very likely to
break. Still, we do use the <code>c()</code> function for small tasks quite
regularly, so it’s worth understanding how it can be used to pick out
elements from vectors.</p>
</div>
<div id="tidydata" class="section level3">
<h3><span class="header-section-number">A.1.3</span> Tidy data</h3>
<p>Working with R and ggplot is much easier if the data you use is in the
right shape. Ggplot wants your data to be <em>tidy</em>. For a more thorough
introduction to the idea of tidy data, see Chapters 5 and 12 of
<span class="citation">Wickham &amp; Grolemund (2016)</span>. To get a sense of what a tidy dataset looks
like in R, we will follow the discussion in <span class="citation">Wickham (2014)</span>. In a tidy
dataset,</p>
<ol style="list-style-type: decimal">
<li><em>Each variable is a column.</em></li>
<li><em>Each observation is a row.</em></li>
<li><em>Each type of observational unit forms a table.</em></li>
</ol>
<p>For most of your data analysis, the first two points are the most
important. This third one might be a little unfamiliar. It is a
feature of “normalized” data from the world of databases, where the
goal is to represent data in a series of related tables with minimal
duplication <span class="citation">(Codd, 1990)</span>. Data analysis more
usually works with a single large table of data, often with
considerable duplication of some variables down the rows.</p>
<p>Data presented in summary tables is often not “tidy” as defined here.
When structuring our data we need to be clear about how our data is
arranged. If your data is not tidily arranged, the chances are good
that you will have more difficulty, and maybe a <em>lot</em> more
difficulty, getting ggplot to draw the figure you want.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg1">Table A.1: </span>Some untidy data.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">treatmenta</th>
<th align="right">treatmentb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">John Smith</td>
<td align="right">NA</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="right">4</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="right">6</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg2">Table A.2: </span>The same data, still untidy, but in a different way.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">treatment</th>
<th align="right">John Smith</th>
<th align="right">Jane Doe</th>
<th align="right">Mary Johnson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">a</td>
<td align="right">NA</td>
<td align="right">4</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="right">18</td>
<td align="right">1</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>For example consider Table <a href="appendix.html#tab:ch-09-preg1">A.1</a> and Table <a href="appendix.html#tab:ch-09-preg2">A.2</a>
from Wickham’s discussion. They present the same data in different
ways, but each would cause trouble if we tried to work with it in
ggplot to make a graph. Table <a href="appendix.html#tab:ch-09-preg3">A.3</a> shows the same data
once again, this time in a tidied form.</p>
<p>Hadley Wickham notes five main ways tables of data tend not to be
tidy:</p>
<ol style="list-style-type: decimal">
<li><em>Column headers are values, not variable names</em>.</li>
<li><em>Multiple variables are stored in one column</em>.</li>
<li><em>Variables are stored in both rows and columns</em>.</li>
<li><em>Multiple types of observational units are stored in the same table</em>.</li>
<li><em>A single observational unit is stored in multiple tables</em>.</li>
</ol>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg3">Table A.3: </span>Tidied data. Every variable a column, every observation a row.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">treatment</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Jane Doe</td>
<td align="left">a</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="left">b</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">John Smith</td>
<td align="left">a</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">John Smith</td>
<td align="left">b</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="left">a</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Mary Johnson</td>
<td align="left">b</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>Data comes in an untidy form all the time, often for the good reason
that it can be presented that way using much less space, or with far
less repetition of labels and row elements. Figure
<a href="appendix.html#fig:ch-09-census-untidy">A.2</a> shows a the first few rows of a table of U.S.
Census Bureau data about educational attainment in the United States.
To begin with, it’s organized as a series of sub-tables down the
spreadsheet, broken out by age and sex. Second, the underlying
variable of interest, “Years of School Completed” is stored across
several columns, with an additional variable (level of schooling)
included across the columns also. It is not too hard to get the table
into a slightly more regular format by eliminating the blank rows, and
explicitly naming the sub-table rows. One can do this manually and get
to the point where it can be read in as an Excel or CSV file. This is
not ideal, as manually cleaning data runs against the commitment to do
as much as possible programmatically.<label for="tufte-mn-95" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-95" class="margin-toggle"/><span class="marginnote shownote"><code>readxl.tidyverse.org</code></span> We can automate the process
somewhat. The tidyverse comes with a <code>readxl</code> package that tries to
ease the pain a little.</p>
<div class="figure"><span id="fig:ch-09-census-untidy"/>
<p class="caption marginnote shownote">
Figure A.2: Untidy data from the Census.
</p>
<img src="../Images/c7abcd15676ccf4d2f644bebb6b0dfab.png" alt="Untidy data from the Census." width="100%" data-original-src="https://socviz.co/assets/ch-09-census-untidy-small.png"/>
</div>
<pre><code>## # A tibble: 366 x 11
##    age   sex    year total elem4 elem8   hs3   hs4 coll3 coll4 median
##    &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1 25-34 Male   2016 21845   116   468  1427  6386  6015  7432     NA
##  2 25-34 Male   2015 21427   166   488  1584  6198  5920  7071     NA
##  3 25-34 Male   2014 21217   151   512  1611  6323  5910  6710     NA
##  4 25-34 Male   2013 20816   161   582  1747  6058  5749  6519     NA
##  5 25-34 Male   2012 20464   161   579  1707  6127  5619  6270     NA
##  6 25-34 Male   2011 20985   190   657  1791  6444  5750  6151     NA
##  7 25-34 Male   2010 20689   186   641  1866  6458  5587  5951     NA
##  8 25-34 Male   2009 20440   184   695  1806  6495  5508  5752     NA
##  9 25-34 Male   2008 20210   172   714  1874  6356  5277  5816     NA
## 10 25-34 Male   2007 20024   246   757  1930  6361  5137  5593     NA
## # ... with 356 more rows</code></pre>
<p>The tidyverse has several tools to help you get the rest of the way in
converting your data from an untidy to a tidy state. These can mostly
be found in the <code>tidyr</code> and <code>dplyr</code> libraries. The former provides
functions for converting, for example, wide-format data to long-format
data, as well as assisting with the business of splitting and
combining variables that are untidily stored. The latter has a tools
that allow tidy tables to be further filtered, sliced, and analyzed at
different grouping levels, as we have seen throughout this book.</p>
<p>With our <code>edu</code> object, we can use the <code>gather()</code> function to transform
the schooling variables into a <em>key-value</em> arrangement. The key is the
underlying variable, and the value is the value it takes for that
observation. We create a new object, <code>edu_t</code> in this way.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" data-line-number="1">edu_t &lt;-<span class="st"> </span><span class="kw">gather</span>(<span class="dt">data =</span> edu,</a>
<a class="sourceLine" id="cb359-2" data-line-number="2">                <span class="dt">key =</span> school,</a>
<a class="sourceLine" id="cb359-3" data-line-number="3">                <span class="dt">value =</span> freq,</a>
<a class="sourceLine" id="cb359-4" data-line-number="4">                elem4<span class="op">:</span>coll4)</a>
<a class="sourceLine" id="cb359-5" data-line-number="5"/>
<a class="sourceLine" id="cb359-6" data-line-number="6"><span class="kw">head</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex    year total median school  freq
##   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 25-34 Male   2016 21845     NA elem4    116
## 2 25-34 Male   2015 21427     NA elem4    166
## 3 25-34 Male   2014 21217     NA elem4    151
## 4 25-34 Male   2013 20816     NA elem4    161
## 5 25-34 Male   2012 20464     NA elem4    161
## 6 25-34 Male   2011 20985     NA elem4    190</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb361-1" data-line-number="1"><span class="kw">tail</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex     year total median school  freq
##   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 55&gt;   Female  1959 16263   8.30 coll4    688
## 2 55&gt;   Female  1957 15581   8.20 coll4    630
## 3 55&gt;   Female  1952 13662   7.90 coll4    628
## 4 55&gt;   Female  1950 13150   8.40 coll4    436
## 5 55&gt;   Female  1947 11810   7.60 coll4    343
## 6 55&gt;   Female  1940  9777   8.30 coll4    219</code></pre>
<p>The educational categories previously spread over the columns have
been gathered into two new columns. The <code>school</code> variable is the <em>key</em>
column. It contains all of the education categories that were
previously given across the column headers, from 0-4 years of
elementary school to four or more years of college. They are now
stacked up on top of each other in the rows. The <code>freq</code> variable is
the <em>value</em> column, and contains the unique value of <code>schooling</code> for
each level of that variable. Once our data is in this long-form shape,
it is ready for easy use with ggplot and related tidyverse tools.</p>
</div>
&#13;

<h3><span class="header-section-number">A.1.1</span> How to read an R help page</h3>
<p>Functions, datasets, and other built-in objects in R are documented in its help system. You can search or browse this documentation via the “Help” tab in RStudio’s lower right-hand window. The quality of R’s help pages varies somewhat. They tend to be on the terse side. However, they all have essentially the same structure and it is useful to know how to read them. Figure <a href="appendix.html#fig:ch-09-help">A.1</a> provides an overview of what to look for. Remember, functions take inputs, perform actions, and return outputs. Something goes in, it gets worked on, and then something comes out. That means you want to know what the function <em>requires</em>, what it <em>does</em>, and what it <em>returns</em>. What it requires is shown in the <em>Usage</em> and <em>Arguments</em> sections of the help page. The names of all the required and optional arguments are given by name and in the order the function expects them. Some arguments have default values. In the case of the <code>mean()</code> function the argument <code>na.rm</code> is set to <code>FALSE</code> by default. These will be shown in the <em>Usage</em> section. If a named argument has no default, you will have to give it a value. Depending on what the argument is, this might be a logical value, a number, a dataset, or any other object.</p>
<div class="figure fullwidth"><span id="fig:ch-09-help"/>
<img src="../Images/6ce9b70c44f6aef3373d3f1779e4bb78.png" alt="The structure of an R help page." width="100%" data-original-src="https://socviz.co/assets/ch-09-read-a-help-page.png"/>
<p class="caption marginnote shownote">
Figure A.1: The structure of an R help page.
</p>
</div>
<p>The other part to look at closely is the <em>Value</em> section, which tells you what the function returns once it has done its calculation. Again, depending on what the function is, this might simply be a single number or other short bit of output. But it could also be something as complex as a ggplot figure or a model object consisting of many separate parts organized as a list.</p>
<p>Well-documented packages will often have <em>Demos</em> and <em>Vignettes</em> attached to them. These are meant to describe the package as a whole, rather than specific functions. A good package vignette will often have one or more fully-worked examples together with a discussion describing how the package works and what it can do. To see if there any package vignettes, click the link at the bottom of the function’s help page to be taken to the package index. Any available demos, vignettes, or other general help will be listed at the top.</p>
&#13;

<h3><span class="header-section-number">A.1.2</span> The basics of accessing and selecting things</h3>
<p>Generally speaking, the tidyverse’s preferred methods for data
subsetting, filtering, slicing and selecting will keep you away from
the underlying mechanics of selecting and extracting elements of
vectors, matrices, or tables of data. Carrying out these operations
through functions like <code>select()</code>, <code>filter()</code>, <code>subset()</code>, and
<code>merge()</code> is generally safer and more reliable than accessing elements
directly. However, it is worth knowing the basics of these operations.
Sometimes accessing elements directly is the most convenient thing to
do. More importantly, we may use these techniques in small ways in our
code with some regularity. Here we very briefly introduce some of R’s
selection operators for vectors, arrays, and tables.</p>
<p>Consider the <code>my_numbers</code> and <code>your_numbers</code> vectors again.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb319-1" data-line-number="1">my_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">25</span>)</a>
<a class="sourceLine" id="cb319-2" data-line-number="2">your_numbers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5</span>, <span class="dv">31</span>, <span class="dv">71</span>, <span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">21</span>, <span class="dv">6</span>)</a></code></pre>
<p>To access any particular element in <code>my_numbers</code>, we use square
brackets. Square brackets are not like the parentheses after
functions. They are used to pick out an element indexed by its
position:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb320-1" data-line-number="1">my_numbers[<span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 1</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb322-1" data-line-number="1">my_numbers[<span class="dv">7</span>]</a></code></pre>
<pre><code>## [1] 25</code></pre>
<p>Putting the number <em>n</em> inside the brackets will give us (or “return”)
the <em>n</em>th element in the vector, assuming there is one. To access a
<em>sequence</em> of elements within a vector we can do this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb324-1" data-line-number="1">my_numbers[<span class="dv">2</span><span class="op">:</span><span class="dv">4</span>]</a></code></pre>
<pre><code>## [1] 2 3 1</code></pre>
<p>This shorthand notation tells R to count from the 2nd to the 4th
element, inclusive. We are not restricted to selecting contiguous
elements, either. We can make use of our <code>c()</code> function again:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb326-1" data-line-number="1">my_numbers[<span class="kw">c</span>(<span class="dv">2</span>, <span class="dv">4</span>)]</a></code></pre>
<pre><code>## [1] 2 1</code></pre>
<p>R evaluates the expression <code>c(2,4)</code> first, and then extracts just the
second and the fourth element from <code>my_numbers</code>, ignoring the others.
You might wonder why we didn’t just write <code>my_numbers[2,3]</code> directly.
The answer is that this notation is used for objects arrayed in two
dimensions (i.e. something with rows and columns), like matrices, data
frames, or tibbles. We can make a two-dimensional object by creating
two different vectors with the <code>c()</code> function and using the <code>tibble()</code>
function to collect them together:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb328-1" data-line-number="1">my_tb &lt;-<span class="st"> </span><span class="kw">tibble</span>(</a>
<a class="sourceLine" id="cb328-2" data-line-number="2">    <span class="dt">mine =</span> <span class="kw">c</span>(<span class="dv">1</span>,<span class="dv">4</span>,<span class="dv">5</span>, <span class="dv">8</span><span class="op">:</span><span class="dv">11</span>),</a>
<a class="sourceLine" id="cb328-3" data-line-number="3">    <span class="dt">yours =</span> <span class="kw">c</span>(<span class="dv">3</span>,<span class="dv">20</span>,<span class="dv">16</span>, <span class="dv">34</span><span class="op">:</span><span class="dv">31</span>))</a>
<a class="sourceLine" id="cb328-4" data-line-number="4"/>
<a class="sourceLine" id="cb328-5" data-line-number="5"><span class="kw">class</span>(my_tb)</a></code></pre>
<pre><code>## [1] "tbl_df"     "tbl"        "data.frame"</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb330-1" data-line-number="1">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00
## 2  4.00 20.0 
## 3  5.00 16.0 
## 4  8.00 34.0 
## 5  9.00 33.0 
## 6 10.0  32.0 
## 7 11.0  31.0</code></pre>
<p>We<label for="tufte-mn-94" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-94" class="margin-toggle"/><span class="marginnote shownote">In these chunks of code you will see some explanatory text set off by the hash symbol, <code>#</code>. In R’s syntax, the hash symbol is used to designate a comment. On any line of code, text that appears after a <code>#</code> symbol will be ignored by R’s interpreter. It won’t be evaluated and it won’t trigger a syntax error.</span> index data frames, tibbles, and other arrays by row first, and then by column. Arrays may also have more than two dimensions.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb332-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="dv">1</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb334-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="dv">2</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>The columns in our tibble have names. We can select elements using
them, too. We do this by putting the name of the column in
quotes where we previously put the index number of the column:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb336-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb338-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb340-1" data-line-number="1">my_tb[<span class="dv">3</span>,<span class="st">"mine"</span>] <span class="co"># Row 3 Col 1</span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##    mine
##   &lt;dbl&gt;
## 1  5.00</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb342-1" data-line-number="1">my_tb[<span class="dv">1</span>,<span class="st">"yours"</span>] <span class="co"># Row 1, Col 2 </span></a></code></pre>
<pre><code>## # A tibble: 1 x 1
##   yours
##   &lt;dbl&gt;
## 1  3.00</code></pre>
<p>If we want to get all the elements of a particular column, we can
leave out the row index. This will mean all the rows will be included
for whichever column we select.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb344-1" data-line-number="1">my_tb[,<span class="st">"mine"</span>] <span class="co"># All rows, Col 1</span></a></code></pre>
<pre><code>## # A tibble: 7 x 1
##    mine
##   &lt;dbl&gt;
## 1  1.00
## 2  4.00
## 3  5.00
## 4  8.00
## 5  9.00
## 6 10.0 
## 7 11.0</code></pre>
<p>We can do this the other way around, too, selecting a particular row and showing all columns:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb346-1" data-line-number="1">my_tb[<span class="dv">4</span>,] <span class="co"># Row 4, all cols</span></a></code></pre>
<pre><code>## # A tibble: 1 x 2
##    mine yours
##   &lt;dbl&gt; &lt;dbl&gt;
## 1  8.00  34.0</code></pre>
<p>A better way of accessing particular columns in a data frame is via
the <code>$</code> operator, which can be used to extract components of various
sorts of object. This way we append the name of the column we want to
the name of the object it belongs to:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb348-1" data-line-number="1">my_tb<span class="op">$</span>mine</a></code></pre>
<pre><code>## [1]  1  4  5  8  9 10 11</code></pre>
<p>Elements of many other objects can be extracted in this way, too,
including nested objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb350-1" data-line-number="1">out &lt;-<span class="st"> </span><span class="kw">lm</span>(mine <span class="op">~</span><span class="st"> </span>yours, <span class="dt">data =</span> my_tb)</a>
<a class="sourceLine" id="cb350-2" data-line-number="2"/>
<a class="sourceLine" id="cb350-3" data-line-number="3">out<span class="op">$</span>coefficients</a></code></pre>
<pre><code>## (Intercept)       yours 
##  -0.0801192   0.2873422</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb352-1" data-line-number="1">out<span class="op">$</span>call</a></code></pre>
<pre><code>## lm(formula = mine ~ yours, data = my_tb)</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb354-1" data-line-number="1">out<span class="op">$</span>qr<span class="op">$</span>rank <span class="co"># nested </span></a></code></pre>
<pre><code>## [1] 2</code></pre>
<p>Finally, in the case of data frames the <code>$</code> operator also lets us add new columns to the object. For example, we can add the first two columns together, row by row. To create a column in this way, we put the <code>$</code> and the name of the new column on the left-hand side of the assignment.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb356-1" data-line-number="1">my_tb<span class="op">$</span>ours &lt;-<span class="st"> </span>my_tb<span class="op">$</span>mine <span class="op">+</span><span class="st"> </span>my_tb<span class="op">$</span>yours</a>
<a class="sourceLine" id="cb356-2" data-line-number="2">my_tb</a></code></pre>
<pre><code>## # A tibble: 7 x 3
##    mine yours  ours
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  1.00  3.00  4.00
## 2  4.00 20.0  24.0 
## 3  5.00 16.0  21.0 
## 4  8.00 34.0  42.0 
## 5  9.00 33.0  42.0 
## 6 10.0  32.0  42.0 
## 7 11.0  31.0  42.0</code></pre>
<p>In this book we do not generally access data via <code>[</code> or <code>$</code>. It is
particularly bad practice to access elements by their index number
only, as opposed to using names. In both cases, and especially the
latter, it is too easy to make a mistake and choose the wrong columns
or rows. In addition, if our table changes shape later on (e.g. due to
the addition of new original data) then any absolute reference to the
position of columns (rather than to their names) is very likely to
break. Still, we do use the <code>c()</code> function for small tasks quite
regularly, so it’s worth understanding how it can be used to pick out
elements from vectors.</p>
&#13;

<h3><span class="header-section-number">A.1.3</span> Tidy data</h3>
<p>Working with R and ggplot is much easier if the data you use is in the
right shape. Ggplot wants your data to be <em>tidy</em>. For a more thorough
introduction to the idea of tidy data, see Chapters 5 and 12 of
<span class="citation">Wickham &amp; Grolemund (2016)</span>. To get a sense of what a tidy dataset looks
like in R, we will follow the discussion in <span class="citation">Wickham (2014)</span>. In a tidy
dataset,</p>
<ol style="list-style-type: decimal">
<li><em>Each variable is a column.</em></li>
<li><em>Each observation is a row.</em></li>
<li><em>Each type of observational unit forms a table.</em></li>
</ol>
<p>For most of your data analysis, the first two points are the most
important. This third one might be a little unfamiliar. It is a
feature of “normalized” data from the world of databases, where the
goal is to represent data in a series of related tables with minimal
duplication <span class="citation">(Codd, 1990)</span>. Data analysis more
usually works with a single large table of data, often with
considerable duplication of some variables down the rows.</p>
<p>Data presented in summary tables is often not “tidy” as defined here.
When structuring our data we need to be clear about how our data is
arranged. If your data is not tidily arranged, the chances are good
that you will have more difficulty, and maybe a <em>lot</em> more
difficulty, getting ggplot to draw the figure you want.</p>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg1">Table A.1: </span>Some untidy data.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="right">treatmenta</th>
<th align="right">treatmentb</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">John Smith</td>
<td align="right">NA</td>
<td align="right">18</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="right">4</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="right">6</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg2">Table A.2: </span>The same data, still untidy, but in a different way.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">treatment</th>
<th align="right">John Smith</th>
<th align="right">Jane Doe</th>
<th align="right">Mary Johnson</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">a</td>
<td align="right">NA</td>
<td align="right">4</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">b</td>
<td align="right">18</td>
<td align="right">1</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>For example consider Table <a href="appendix.html#tab:ch-09-preg1">A.1</a> and Table <a href="appendix.html#tab:ch-09-preg2">A.2</a>
from Wickham’s discussion. They present the same data in different
ways, but each would cause trouble if we tried to work with it in
ggplot to make a graph. Table <a href="appendix.html#tab:ch-09-preg3">A.3</a> shows the same data
once again, this time in a tidied form.</p>
<p>Hadley Wickham notes five main ways tables of data tend not to be
tidy:</p>
<ol style="list-style-type: decimal">
<li><em>Column headers are values, not variable names</em>.</li>
<li><em>Multiple variables are stored in one column</em>.</li>
<li><em>Variables are stored in both rows and columns</em>.</li>
<li><em>Multiple types of observational units are stored in the same table</em>.</li>
<li><em>A single observational unit is stored in multiple tables</em>.</li>
</ol>
<p><!--
<caption>--><span class="marginnote shownote"><span id="tab:ch-09-preg3">Table A.3: </span>Tidied data. Every variable a column, every observation a row.</span><!--</caption>--></p>
<table>
<thead>
<tr class="header">
<th align="left">name</th>
<th align="left">treatment</th>
<th align="right">n</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Jane Doe</td>
<td align="left">a</td>
<td align="right">4</td>
</tr>
<tr class="even">
<td align="left">Jane Doe</td>
<td align="left">b</td>
<td align="right">1</td>
</tr>
<tr class="odd">
<td align="left">John Smith</td>
<td align="left">a</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">John Smith</td>
<td align="left">b</td>
<td align="right">18</td>
</tr>
<tr class="odd">
<td align="left">Mary Johnson</td>
<td align="left">a</td>
<td align="right">6</td>
</tr>
<tr class="even">
<td align="left">Mary Johnson</td>
<td align="left">b</td>
<td align="right">7</td>
</tr>
</tbody>
</table>
<p>Data comes in an untidy form all the time, often for the good reason
that it can be presented that way using much less space, or with far
less repetition of labels and row elements. Figure
<a href="appendix.html#fig:ch-09-census-untidy">A.2</a> shows a the first few rows of a table of U.S.
Census Bureau data about educational attainment in the United States.
To begin with, it’s organized as a series of sub-tables down the
spreadsheet, broken out by age and sex. Second, the underlying
variable of interest, “Years of School Completed” is stored across
several columns, with an additional variable (level of schooling)
included across the columns also. It is not too hard to get the table
into a slightly more regular format by eliminating the blank rows, and
explicitly naming the sub-table rows. One can do this manually and get
to the point where it can be read in as an Excel or CSV file. This is
not ideal, as manually cleaning data runs against the commitment to do
as much as possible programmatically.<label for="tufte-mn-95" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-95" class="margin-toggle"/><span class="marginnote shownote"><code>readxl.tidyverse.org</code></span> We can automate the process
somewhat. The tidyverse comes with a <code>readxl</code> package that tries to
ease the pain a little.</p>
<div class="figure"><span id="fig:ch-09-census-untidy"/>
<p class="caption marginnote shownote">
Figure A.2: Untidy data from the Census.
</p>
<img src="../Images/c7abcd15676ccf4d2f644bebb6b0dfab.png" alt="Untidy data from the Census." width="100%" data-original-src="https://socviz.co/assets/ch-09-census-untidy-small.png"/>
</div>
<pre><code>## # A tibble: 366 x 11
##    age   sex    year total elem4 elem8   hs3   hs4 coll3 coll4 median
##    &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
##  1 25-34 Male   2016 21845   116   468  1427  6386  6015  7432     NA
##  2 25-34 Male   2015 21427   166   488  1584  6198  5920  7071     NA
##  3 25-34 Male   2014 21217   151   512  1611  6323  5910  6710     NA
##  4 25-34 Male   2013 20816   161   582  1747  6058  5749  6519     NA
##  5 25-34 Male   2012 20464   161   579  1707  6127  5619  6270     NA
##  6 25-34 Male   2011 20985   190   657  1791  6444  5750  6151     NA
##  7 25-34 Male   2010 20689   186   641  1866  6458  5587  5951     NA
##  8 25-34 Male   2009 20440   184   695  1806  6495  5508  5752     NA
##  9 25-34 Male   2008 20210   172   714  1874  6356  5277  5816     NA
## 10 25-34 Male   2007 20024   246   757  1930  6361  5137  5593     NA
## # ... with 356 more rows</code></pre>
<p>The tidyverse has several tools to help you get the rest of the way in
converting your data from an untidy to a tidy state. These can mostly
be found in the <code>tidyr</code> and <code>dplyr</code> libraries. The former provides
functions for converting, for example, wide-format data to long-format
data, as well as assisting with the business of splitting and
combining variables that are untidily stored. The latter has a tools
that allow tidy tables to be further filtered, sliced, and analyzed at
different grouping levels, as we have seen throughout this book.</p>
<p>With our <code>edu</code> object, we can use the <code>gather()</code> function to transform
the schooling variables into a <em>key-value</em> arrangement. The key is the
underlying variable, and the value is the value it takes for that
observation. We create a new object, <code>edu_t</code> in this way.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb359-1" data-line-number="1">edu_t &lt;-<span class="st"> </span><span class="kw">gather</span>(<span class="dt">data =</span> edu,</a>
<a class="sourceLine" id="cb359-2" data-line-number="2">                <span class="dt">key =</span> school,</a>
<a class="sourceLine" id="cb359-3" data-line-number="3">                <span class="dt">value =</span> freq,</a>
<a class="sourceLine" id="cb359-4" data-line-number="4">                elem4<span class="op">:</span>coll4)</a>
<a class="sourceLine" id="cb359-5" data-line-number="5"/>
<a class="sourceLine" id="cb359-6" data-line-number="6"><span class="kw">head</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex    year total median school  freq
##   &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 25-34 Male   2016 21845     NA elem4    116
## 2 25-34 Male   2015 21427     NA elem4    166
## 3 25-34 Male   2014 21217     NA elem4    151
## 4 25-34 Male   2013 20816     NA elem4    161
## 5 25-34 Male   2012 20464     NA elem4    161
## 6 25-34 Male   2011 20985     NA elem4    190</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb361-1" data-line-number="1"><span class="kw">tail</span>(edu_t) </a></code></pre>
<pre><code>## # A tibble: 6 x 7
##   age   sex     year total median school  freq
##   &lt;chr&gt; &lt;chr&gt;  &lt;int&gt; &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;  &lt;dbl&gt;
## 1 55&gt;   Female  1959 16263   8.30 coll4    688
## 2 55&gt;   Female  1957 15581   8.20 coll4    630
## 3 55&gt;   Female  1952 13662   7.90 coll4    628
## 4 55&gt;   Female  1950 13150   8.40 coll4    436
## 5 55&gt;   Female  1947 11810   7.60 coll4    343
## 6 55&gt;   Female  1940  9777   8.30 coll4    219</code></pre>
<p>The educational categories previously spread over the columns have
been gathered into two new columns. The <code>school</code> variable is the <em>key</em>
column. It contains all of the education categories that were
previously given across the column headers, from 0-4 years of
elementary school to four or more years of college. They are now
stacked up on top of each other in the rows. The <code>freq</code> variable is
the <em>value</em> column, and contains the unique value of <code>schooling</code> for
each level of that variable. Once our data is in this long-form shape,
it is ready for easy use with ggplot and related tidyverse tools.</p>
&#13;

<h2><span class="header-section-number">A.2</span> Common problems reading in data</h2>
<div id="date-formats" class="section level3 unnumbered">
<h3>Date formats</h3>
<p>Date formats can be annoying. First, times and dates must be treated
differently from ordinary numbers. Second, there are many, many
different date formats, differing both in the precision with which
they are stored and the convention they follow about how to display
years, months, days, and so on. Consider the following data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" data-line-number="1"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date       N
##   &lt;chr&gt;  &lt;int&gt;
## 1 9/1/11 44426
## 2 9/2/11 55112
## 3 9/3/11 19263
## 4 9/4/11 12330
## 5 9/5/11  8534
## 6 9/6/11 59490</code></pre>
<p>The data in the <code>date</code> column has been read in as a character
string, but we want R to treat it as a date. If can’t treat it as a
date, we get bad results.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-01"/>
<img src="../Images/52465ae3bdb35038a8ba0f67225c35e2.png" alt="A bad date." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.3: A bad date.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb365-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<pre><code>## geom_path: Each group consists of only one observation.
## Do you need to adjust the group aesthetic?</code></pre>
<p>What has happened? The problem is that ggplot doesn’t know <code>date</code>
consists of dates. As a result, when we ask to plot it on the x-axis,
it tries to treat the unique elements of <code>date</code> like a categorical
variable instead. (That is, as a factor.) But because each date is
unique, its default effort at grouping the data results in every group
having only one observation in it (i.e., that particular row). The
ggplot function knows something is odd about this, and tries to let
you know. It wonders whether we’ve failed to set <code>group = &lt;something&gt;</code>
in our mapping.</p>
<p>For the sake of it, let’s see what happens when the bad date values
are <em>not</em> unique. We will make a new data frame by stacking two copies of
the data on top of each other. The <code>rbind()</code> function does this for
us. We end up with two copies of every observation.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-02"/>
<img src="../Images/773245f5dd69a1ceaa507762c031c2c0.png" alt="Still bad." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.4: Still bad.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" data-line-number="1">bad_date2 &lt;-<span class="st"> </span><span class="kw">rbind</span>(bad_date, bad_date)</a>
<a class="sourceLine" id="cb367-2" data-line-number="2"/>
<a class="sourceLine" id="cb367-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date2, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb367-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<p>Now ggplot doesn’t complain at all, because there’s more than one
observation per (inferred) group. But the plot is still wrong!</p>
<p>We will fix this problem using the <code>lubridate</code> library. It provides a
suite of convenience functions for converting date strings in various
formats and with various separators (such as <code>/</code> or <code>-</code> and so on)
into objects of class <code>Date</code> that R knows about. Here our bad dates
are in a month/day/year format, so we use <code>mdy()</code>. Consult the
lubridate library’s documentation to learn more about similar
convenience functions for converting character strings where the date
components appear in a different order.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb368-1" data-line-number="1"><span class="co"># install.packages("lubridate")</span></a>
<a class="sourceLine" id="cb368-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb368-3" data-line-number="3"/>
<a class="sourceLine" id="cb368-4" data-line-number="4">bad_date<span class="op">$</span>date &lt;-<span class="st"> </span><span class="kw">mdy</span>(bad_date<span class="op">$</span>date)</a>
<a class="sourceLine" id="cb368-5" data-line-number="5"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date           N
##   &lt;date&gt;     &lt;int&gt;
## 1 2011-09-01 44426
## 2 2011-09-02 55112
## 3 2011-09-03 19263
## 4 2011-09-04 12330
## 5 2011-09-05  8534
## 6 2011-09-06 59490</code></pre>
<p>Now <code>filldate_new</code> has a <code>Date</code> class. Let’s try the plot
again.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-04"/>
<img src="../Images/f7c5e594b621f7ef4cb6ac4478fb6eac.png" alt="Much better." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.5: Much better.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb370-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb370-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
</div>
<div id="year-only-dates" class="section level3 unnumbered">
<h3>Year-only dates</h3>
<p>Many variables are measured by the year and supplied in the data as a
four digit number rather than as a date. This can sometimes cause
headaches when we want to plot year on the x-axis. It happens most
often when the time series is relatively short. Consider this data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" data-line-number="1">url &lt;-<span class="st"> "https://cdn.rawgit.com/kjhealy/viz-organdata/master/organdonation.csv"</span></a>
<a class="sourceLine" id="cb371-2" data-line-number="2"/>
<a class="sourceLine" id="cb371-3" data-line-number="3">bad_year &lt;-<span class="st"> </span><span class="kw">read_csv</span>(url)</a>
<a class="sourceLine" id="cb371-4" data-line-number="4">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(<span class="dv">10</span>)</a></code></pre>
<pre><code>## # A tibble: 10 x 3
##    country        year donors
##    &lt;chr&gt;         &lt;int&gt;  &lt;dbl&gt;
##  1 United States  1994  19.4 
##  2 Australia      1999   8.67
##  3 Canada         2001  13.5 
##  4 Australia      1994  10.2 
##  5 Sweden         1993  15.2 
##  6 Ireland        1992  19.5 
##  7 Switzerland    1997  14.3 
##  8 Ireland        2000  17.6 
##  9 Switzerland    1998  15.4 
## 10 Norway           NA  NA</code></pre>
<p>This is a version of <code>organdata</code> but in a less clean format. The <code>year</code> variable is an integer (its class is <code>&lt;int&gt;</code>) and not a date. Let’s say we want to plot donation rate against year.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-integeryear"/>
<img src="../Images/cf406ce378ab743be8bbbd295c58ca8f.png" alt="Integer year shown with a decimal point." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-integeryear-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.6: Integer year shown with a decimal point.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_year, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> donors))</a>
<a class="sourceLine" id="cb373-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre>
<p>The decimal point on the x-axis labels is unwanted. We could sort this out cosmetically, by giving <code>scale_x_continuous()</code> a set of <code>breaks</code> and <code>labels</code> that represent the years as characters. Alternatively, we can change the class of the <code>year</code> variable. For convenience, we will tell R that the <code>year</code> variable should be treated as a Date measure, and not an integer. We’ll use a home-cooked function, <code>int_to_year()</code>, that takes
integers and converts them to dates.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" data-line-number="1">bad_year<span class="op">$</span>year &lt;-<span class="st"> </span><span class="kw">int_to_year</span>(bad_year<span class="op">$</span>year)</a>
<a class="sourceLine" id="cb374-2" data-line-number="2">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a></code></pre>
<pre><code>## # A tibble: 238 x 3
##    country   year       donors
##    &lt;chr&gt;     &lt;date&gt;      &lt;dbl&gt;
##  1 Australia NA          NA   
##  2 Australia 1991-01-01  12.1 
##  3 Australia 1992-01-01  12.4 
##  4 Australia 1993-01-01  12.5 
##  5 Australia 1994-01-01  10.2 
##  6 Australia 1995-01-01  10.2 
##  7 Australia 1996-01-01  10.6 
##  8 Australia 1997-01-01  10.3 
##  9 Australia 1998-01-01  10.5 
## 10 Australia 1999-01-01   8.67
## # ... with 228 more rows</code></pre>
<p>In the process, today’s day and month are introduced into the year
data, but that is irrelevant in this case, given that our data are
only observed in a yearly window to begin with. However, if you wish to
specify a generic day and month for all the observations, the function
allows you to do this.</p>
</div>
<div id="write-functions-for-repetitive-tasks" class="section level3">
<h3><span class="header-section-number">A.2.1</span> Write functions for repetitive tasks</h3>
<p>If you are working with a data set that you will be making a lot of
similar plots from, or will need to periodically look at in a way that
is repetitive but can’t be carried out in a single step once and for
all, then the chances are that you will start accumulating sequences
of code that you find yourself using repeatedly. When this happens,
the temptation will be to start copying and pasting these sequences
from one analysis to the next. We can see something of this tendency
in the code samples for this book. To make the exposition clearer, we
have periodically repeated chunks of code that differ only in the
dependent or independent variable being plotted.</p>
<p>You should try to avoid copying and pasting code repeatedly in this
way. Instead, this is an opportunity to write a function to help you
out a little. More or less everything in R is accomplished through
functions, and it’s not too difficult to write your own. This is
especially the case when you begin by thinking of functions as a way
to help you automate some local or smaller task, rather than a means
of accomplishing some very complex task. R has the resources to help
you build complex functions and function libraries, like ggplot
itself. But we can start quite small, with functions that help us
manage a particular dataset or data analysis.</p>
<p>Remember, functions take <em>inputs</em>, perform <em>actions</em>, and return <em>outputs</em>. For example, imagine a function that adds two numbers, <code>x</code> and <code>y</code>. In use, it might look like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb376-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">7</span>)</a></code></pre>
<pre><code>## [1] 8</code></pre>
<p>How do we <em>create</em> this function? Remember, everything is an object, so functions are just special kinds of object. And everything in R is done via functions. So, if we want to make a new function we will use an existing function do to it. In R, functions are created with <code>function()</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb378-1" data-line-number="1">add_xy &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb378-2" data-line-number="2">    x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb378-3" data-line-number="3">}</a></code></pre>
<p>You can see that <code>function()</code> is a little different from ordinary functions in two ways. First, the arguments we give it (here, <code>x</code> and <code>y</code>) are for the <code>add_xy</code> function that we are <em>creating</em>. Second, immediately after the <code>function(x, y)</code> statement there’s an opening brace, <code>{</code>, followed by a bit of R code that adds x and y, and then the closing brace <code>}</code>. That’s the content of the function. We assign this code to the <code>add_xy</code> object, and now we have a function that adds two numbers together and returns the result. The <code>x + y</code> line inside the parentheses is evaluated as if it were typed at the console, assuming you have told it what <code>x</code> and <code>y</code> are.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">5</span>, <span class="dt">y =</span> <span class="dv">2</span>)</a></code></pre>
<pre><code>## [1] 7</code></pre>
<p>Functions can take many kinds of arguments, and we can also tell them
what the default value of each argument should be by specifying it
inside the <code>function(...)</code> section. Functions are little programs that
have all the power of R at their disposal, including standard things
like flow-control through <code>if ... else</code> statements and so on. Here,
for instance, is a function that will make a scatter plot for any
Section in the ASA data, or optionally fit a smoother to the data
and plot that instead. Defining a function looks a little like calling one, except that we spell out the steps inside. We also specify the default arguments.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb381-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb381-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb381-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb381-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb381-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb381-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb381-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb381-9" data-line-number="9"/>
<a class="sourceLine" id="cb381-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb381-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb381-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb381-13" data-line-number="13">                              <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">3</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-14" data-line-number="14"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-15" data-line-number="15"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-16" data-line-number="16">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb381-17" data-line-number="17">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-18" data-line-number="18"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-19" data-line-number="19"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-20" data-line-number="20">    }</a>
<a class="sourceLine" id="cb381-21" data-line-number="21"/>
<a class="sourceLine" id="cb381-22" data-line-number="22">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb381-23" data-line-number="23">}</a></code></pre>
<p>This function is not very general. Nor is it particularly robust. But for the use we want to put it to, it works just fine.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Rationality"</span>)</a>
<a class="sourceLine" id="cb382-2" data-line-number="2"><span class="kw">plot_section</span>(<span class="st">"Sexualities"</span>, <span class="dt">smooth =</span> <span class="ot">TRUE</span>)</a></code></pre>
<div class="figure"><span id="fig:plot-section-example"/>
<p class="caption marginnote shownote">
Figure A.7: Using a function to plot your results.
</p>
<img src="../Images/2752e9cfed4f3c38227ed449f207ed3c.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-1.png"/><img src="../Images/87dcf314f4b6be8bb89c2d3262a68d61.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-2.png"/>
</div>
<p>If we were going to work with this data for long enough, we could make
the function progressively more general. For example, we can add the
special <code>...</code> argument (which means, roughly, “and any other named
arguments”) in a way that allows us to pass arguments through to the
<code>geom_smooth()</code> function in the way we’d expect if we were using it
directly. With that in place, we can pick the smoothing method we want.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb383-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb383-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb383-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>, ...){</a>
<a class="sourceLine" id="cb383-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb383-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb383-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb383-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb383-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb383-9" data-line-number="9"/>
<a class="sourceLine" id="cb383-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb383-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb383-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, ...) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-13" data-line-number="13"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-14" data-line-number="14"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-15" data-line-number="15">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb383-16" data-line-number="16">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-17" data-line-number="17"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-18" data-line-number="18"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb383-20" data-line-number="20"/>
<a class="sourceLine" id="cb383-21" data-line-number="21">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb383-22" data-line-number="22">}</a></code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Comm/Urban"</span>,</a>
<a class="sourceLine" id="cb384-2" data-line-number="2">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-3" data-line-number="3">             <span class="dt">method =</span> <span class="st">"loess"</span>)</a>
<a class="sourceLine" id="cb384-4" data-line-number="4"><span class="kw">plot_section</span>(<span class="st">"Children"</span>,</a>
<a class="sourceLine" id="cb384-5" data-line-number="5">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-6" data-line-number="6">             <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb384-7" data-line-number="7">             <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">2</span>))</a></code></pre>
<div class="figure"><span id="fig:ch-09-plot-function"/>
<p class="caption marginnote shownote">
Figure A.8: Our custom function can now pass arguments along to fit different smoothers to Section membership data.
</p>
<img src="../Images/e75ff4a3d54ffa56e423e228c0a57c17.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-1.png"/><img src="../Images/71f7dc2cba63a58337cf365b42199eb6.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-2.png"/>
</div>
</div>
&#13;

<h3>Date formats</h3>
<p>Date formats can be annoying. First, times and dates must be treated
differently from ordinary numbers. Second, there are many, many
different date formats, differing both in the precision with which
they are stored and the convention they follow about how to display
years, months, days, and so on. Consider the following data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb363-1" data-line-number="1"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date       N
##   &lt;chr&gt;  &lt;int&gt;
## 1 9/1/11 44426
## 2 9/2/11 55112
## 3 9/3/11 19263
## 4 9/4/11 12330
## 5 9/5/11  8534
## 6 9/6/11 59490</code></pre>
<p>The data in the <code>date</code> column has been read in as a character
string, but we want R to treat it as a date. If can’t treat it as a
date, we get bad results.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-01"/>
<img src="../Images/52465ae3bdb35038a8ba0f67225c35e2.png" alt="A bad date." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.3: A bad date.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb365-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb365-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<pre><code>## geom_path: Each group consists of only one observation.
## Do you need to adjust the group aesthetic?</code></pre>
<p>What has happened? The problem is that ggplot doesn’t know <code>date</code>
consists of dates. As a result, when we ask to plot it on the x-axis,
it tries to treat the unique elements of <code>date</code> like a categorical
variable instead. (That is, as a factor.) But because each date is
unique, its default effort at grouping the data results in every group
having only one observation in it (i.e., that particular row). The
ggplot function knows something is odd about this, and tries to let
you know. It wonders whether we’ve failed to set <code>group = &lt;something&gt;</code>
in our mapping.</p>
<p>For the sake of it, let’s see what happens when the bad date values
are <em>not</em> unique. We will make a new data frame by stacking two copies of
the data on top of each other. The <code>rbind()</code> function does this for
us. We end up with two copies of every observation.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-02"/>
<img src="../Images/773245f5dd69a1ceaa507762c031c2c0.png" alt="Still bad." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.4: Still bad.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb367-1" data-line-number="1">bad_date2 &lt;-<span class="st"> </span><span class="kw">rbind</span>(bad_date, bad_date)</a>
<a class="sourceLine" id="cb367-2" data-line-number="2"/>
<a class="sourceLine" id="cb367-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date2, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb367-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
<p>Now ggplot doesn’t complain at all, because there’s more than one
observation per (inferred) group. But the plot is still wrong!</p>
<p>We will fix this problem using the <code>lubridate</code> library. It provides a
suite of convenience functions for converting date strings in various
formats and with various separators (such as <code>/</code> or <code>-</code> and so on)
into objects of class <code>Date</code> that R knows about. Here our bad dates
are in a month/day/year format, so we use <code>mdy()</code>. Consult the
lubridate library’s documentation to learn more about similar
convenience functions for converting character strings where the date
components appear in a different order.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb368-1" data-line-number="1"><span class="co"># install.packages("lubridate")</span></a>
<a class="sourceLine" id="cb368-2" data-line-number="2"><span class="kw">library</span>(lubridate)</a>
<a class="sourceLine" id="cb368-3" data-line-number="3"/>
<a class="sourceLine" id="cb368-4" data-line-number="4">bad_date<span class="op">$</span>date &lt;-<span class="st"> </span><span class="kw">mdy</span>(bad_date<span class="op">$</span>date)</a>
<a class="sourceLine" id="cb368-5" data-line-number="5"><span class="kw">head</span>(bad_date)</a></code></pre>
<pre><code>## # A tibble: 6 x 2
##   date           N
##   &lt;date&gt;     &lt;int&gt;
## 1 2011-09-01 44426
## 2 2011-09-02 55112
## 3 2011-09-03 19263
## 4 2011-09-04 12330
## 5 2011-09-05  8534
## 6 2011-09-06 59490</code></pre>
<p>Now <code>filldate_new</code> has a <code>Date</code> class. Let’s try the plot
again.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-dates-04"/>
<img src="../Images/f7c5e594b621f7ef4cb6ac4478fb6eac.png" alt="Much better." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-dates-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.5: Much better.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb370-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_date, <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> N))</a>
<a class="sourceLine" id="cb370-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>()</a></code></pre>
&#13;

<h3>Year-only dates</h3>
<p>Many variables are measured by the year and supplied in the data as a
four digit number rather than as a date. This can sometimes cause
headaches when we want to plot year on the x-axis. It happens most
often when the time series is relatively short. Consider this data:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb371-1" data-line-number="1">url &lt;-<span class="st"> "https://cdn.rawgit.com/kjhealy/viz-organdata/master/organdonation.csv"</span></a>
<a class="sourceLine" id="cb371-2" data-line-number="2"/>
<a class="sourceLine" id="cb371-3" data-line-number="3">bad_year &lt;-<span class="st"> </span><span class="kw">read_csv</span>(url)</a>
<a class="sourceLine" id="cb371-4" data-line-number="4">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">sample_n</span>(<span class="dv">10</span>)</a></code></pre>
<pre><code>## # A tibble: 10 x 3
##    country        year donors
##    &lt;chr&gt;         &lt;int&gt;  &lt;dbl&gt;
##  1 United States  1994  19.4 
##  2 Australia      1999   8.67
##  3 Canada         2001  13.5 
##  4 Australia      1994  10.2 
##  5 Sweden         1993  15.2 
##  6 Ireland        1992  19.5 
##  7 Switzerland    1997  14.3 
##  8 Ireland        2000  17.6 
##  9 Switzerland    1998  15.4 
## 10 Norway           NA  NA</code></pre>
<p>This is a version of <code>organdata</code> but in a less clean format. The <code>year</code> variable is an integer (its class is <code>&lt;int&gt;</code>) and not a date. Let’s say we want to plot donation rate against year.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-integeryear"/>
<img src="../Images/cf406ce378ab743be8bbbd295c58ca8f.png" alt="Integer year shown with a decimal point." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-integeryear-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.6: Integer year shown with a decimal point.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb373-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> bad_year, <span class="kw">aes</span>(<span class="dt">x =</span> year, <span class="dt">y =</span> donors))</a>
<a class="sourceLine" id="cb373-2" data-line-number="2">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>()</a></code></pre>
<p>The decimal point on the x-axis labels is unwanted. We could sort this out cosmetically, by giving <code>scale_x_continuous()</code> a set of <code>breaks</code> and <code>labels</code> that represent the years as characters. Alternatively, we can change the class of the <code>year</code> variable. For convenience, we will tell R that the <code>year</code> variable should be treated as a Date measure, and not an integer. We’ll use a home-cooked function, <code>int_to_year()</code>, that takes
integers and converts them to dates.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb374-1" data-line-number="1">bad_year<span class="op">$</span>year &lt;-<span class="st"> </span><span class="kw">int_to_year</span>(bad_year<span class="op">$</span>year)</a>
<a class="sourceLine" id="cb374-2" data-line-number="2">bad_year <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>)</a></code></pre>
<pre><code>## # A tibble: 238 x 3
##    country   year       donors
##    &lt;chr&gt;     &lt;date&gt;      &lt;dbl&gt;
##  1 Australia NA          NA   
##  2 Australia 1991-01-01  12.1 
##  3 Australia 1992-01-01  12.4 
##  4 Australia 1993-01-01  12.5 
##  5 Australia 1994-01-01  10.2 
##  6 Australia 1995-01-01  10.2 
##  7 Australia 1996-01-01  10.6 
##  8 Australia 1997-01-01  10.3 
##  9 Australia 1998-01-01  10.5 
## 10 Australia 1999-01-01   8.67
## # ... with 228 more rows</code></pre>
<p>In the process, today’s day and month are introduced into the year
data, but that is irrelevant in this case, given that our data are
only observed in a yearly window to begin with. However, if you wish to
specify a generic day and month for all the observations, the function
allows you to do this.</p>
&#13;

<h3><span class="header-section-number">A.2.1</span> Write functions for repetitive tasks</h3>
<p>If you are working with a data set that you will be making a lot of
similar plots from, or will need to periodically look at in a way that
is repetitive but can’t be carried out in a single step once and for
all, then the chances are that you will start accumulating sequences
of code that you find yourself using repeatedly. When this happens,
the temptation will be to start copying and pasting these sequences
from one analysis to the next. We can see something of this tendency
in the code samples for this book. To make the exposition clearer, we
have periodically repeated chunks of code that differ only in the
dependent or independent variable being plotted.</p>
<p>You should try to avoid copying and pasting code repeatedly in this
way. Instead, this is an opportunity to write a function to help you
out a little. More or less everything in R is accomplished through
functions, and it’s not too difficult to write your own. This is
especially the case when you begin by thinking of functions as a way
to help you automate some local or smaller task, rather than a means
of accomplishing some very complex task. R has the resources to help
you build complex functions and function libraries, like ggplot
itself. But we can start quite small, with functions that help us
manage a particular dataset or data analysis.</p>
<p>Remember, functions take <em>inputs</em>, perform <em>actions</em>, and return <em>outputs</em>. For example, imagine a function that adds two numbers, <code>x</code> and <code>y</code>. In use, it might look like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb376-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">1</span>, <span class="dt">y =</span> <span class="dv">7</span>)</a></code></pre>
<pre><code>## [1] 8</code></pre>
<p>How do we <em>create</em> this function? Remember, everything is an object, so functions are just special kinds of object. And everything in R is done via functions. So, if we want to make a new function we will use an existing function do to it. In R, functions are created with <code>function()</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb378-1" data-line-number="1">add_xy &lt;-<span class="st"> </span><span class="cf">function</span>(x, y) {</a>
<a class="sourceLine" id="cb378-2" data-line-number="2">    x <span class="op">+</span><span class="st"> </span>y</a>
<a class="sourceLine" id="cb378-3" data-line-number="3">}</a></code></pre>
<p>You can see that <code>function()</code> is a little different from ordinary functions in two ways. First, the arguments we give it (here, <code>x</code> and <code>y</code>) are for the <code>add_xy</code> function that we are <em>creating</em>. Second, immediately after the <code>function(x, y)</code> statement there’s an opening brace, <code>{</code>, followed by a bit of R code that adds x and y, and then the closing brace <code>}</code>. That’s the content of the function. We assign this code to the <code>add_xy</code> object, and now we have a function that adds two numbers together and returns the result. The <code>x + y</code> line inside the parentheses is evaluated as if it were typed at the console, assuming you have told it what <code>x</code> and <code>y</code> are.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb379-1" data-line-number="1"><span class="kw">add_xy</span>(<span class="dt">x =</span> <span class="dv">5</span>, <span class="dt">y =</span> <span class="dv">2</span>)</a></code></pre>
<pre><code>## [1] 7</code></pre>
<p>Functions can take many kinds of arguments, and we can also tell them
what the default value of each argument should be by specifying it
inside the <code>function(...)</code> section. Functions are little programs that
have all the power of R at their disposal, including standard things
like flow-control through <code>if ... else</code> statements and so on. Here,
for instance, is a function that will make a scatter plot for any
Section in the ASA data, or optionally fit a smoother to the data
and plot that instead. Defining a function looks a little like calling one, except that we spell out the steps inside. We also specify the default arguments.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb381-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb381-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb381-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>){</a>
<a class="sourceLine" id="cb381-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb381-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb381-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb381-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb381-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb381-9" data-line-number="9"/>
<a class="sourceLine" id="cb381-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb381-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb381-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb381-13" data-line-number="13">                              <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">3</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-14" data-line-number="14"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-15" data-line-number="15"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-16" data-line-number="16">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb381-17" data-line-number="17">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-18" data-line-number="18"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb381-19" data-line-number="19"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb381-20" data-line-number="20">    }</a>
<a class="sourceLine" id="cb381-21" data-line-number="21"/>
<a class="sourceLine" id="cb381-22" data-line-number="22">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb381-23" data-line-number="23">}</a></code></pre>
<p>This function is not very general. Nor is it particularly robust. But for the use we want to put it to, it works just fine.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb382-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Rationality"</span>)</a>
<a class="sourceLine" id="cb382-2" data-line-number="2"><span class="kw">plot_section</span>(<span class="st">"Sexualities"</span>, <span class="dt">smooth =</span> <span class="ot">TRUE</span>)</a></code></pre>
<div class="figure"><span id="fig:plot-section-example"/>
<p class="caption marginnote shownote">
Figure A.7: Using a function to plot your results.
</p>
<img src="../Images/2752e9cfed4f3c38227ed449f207ed3c.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-1.png"/><img src="../Images/87dcf314f4b6be8bb89c2d3262a68d61.png" alt="Using a function to plot your results." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/plot-section-example-2.png"/>
</div>
<p>If we were going to work with this data for long enough, we could make
the function progressively more general. For example, we can add the
special <code>...</code> argument (which means, roughly, “and any other named
arguments”) in a way that allows us to pass arguments through to the
<code>geom_smooth()</code> function in the way we’d expect if we were using it
directly. With that in place, we can pick the smoothing method we want.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb383-1" data-line-number="1">plot_section &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">section=</span><span class="st">"Culture"</span>, <span class="dt">x =</span> <span class="st">"Year"</span>,</a>
<a class="sourceLine" id="cb383-2" data-line-number="2">                         <span class="dt">y =</span> <span class="st">"Members"</span>, <span class="dt">data =</span> asasec,</a>
<a class="sourceLine" id="cb383-3" data-line-number="3">                         <span class="dt">smooth=</span><span class="ot">FALSE</span>, ...){</a>
<a class="sourceLine" id="cb383-4" data-line-number="4">    <span class="kw">require</span>(ggplot2)</a>
<a class="sourceLine" id="cb383-5" data-line-number="5">    <span class="kw">require</span>(splines)</a>
<a class="sourceLine" id="cb383-6" data-line-number="6">    <span class="co"># Note use of aes_string() rather than aes() </span></a>
<a class="sourceLine" id="cb383-7" data-line-number="7">    p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">subset</span>(data, Sname<span class="op">==</span>section),</a>
<a class="sourceLine" id="cb383-8" data-line-number="8">            <span class="dt">mapping =</span> <span class="kw">aes_string</span>(<span class="dt">x=</span>x, <span class="dt">y=</span>y))</a>
<a class="sourceLine" id="cb383-9" data-line-number="9"/>
<a class="sourceLine" id="cb383-10" data-line-number="10">    <span class="cf">if</span>(smooth <span class="op">==</span><span class="st"> </span><span class="ot">TRUE</span>) {</a>
<a class="sourceLine" id="cb383-11" data-line-number="11">        p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">color =</span> <span class="st">"#999999"</span>,</a>
<a class="sourceLine" id="cb383-12" data-line-number="12">                              <span class="dt">size =</span> <span class="fl">1.2</span>, ...) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-13" data-line-number="13"><span class="st">            </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-14" data-line-number="14"><span class="st">            </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-15" data-line-number="15">    } <span class="cf">else</span> {</a>
<a class="sourceLine" id="cb383-16" data-line-number="16">    p0 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>(<span class="dt">color=</span> <span class="st">"#E69F00"</span>, <span class="dt">size=</span><span class="fl">1.2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-17" data-line-number="17"><span class="st">        </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">2005</span>, <span class="dv">2015</span>, <span class="dv">4</span>))) <span class="op">+</span></a>
<a class="sourceLine" id="cb383-18" data-line-number="18"><span class="st">        </span><span class="kw">labs</span>(<span class="dt">title =</span> section)</a>
<a class="sourceLine" id="cb383-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb383-20" data-line-number="20"/>
<a class="sourceLine" id="cb383-21" data-line-number="21">    <span class="kw">print</span>(p0)</a>
<a class="sourceLine" id="cb383-22" data-line-number="22">}</a></code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb384-1" data-line-number="1"><span class="kw">plot_section</span>(<span class="st">"Comm/Urban"</span>,</a>
<a class="sourceLine" id="cb384-2" data-line-number="2">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-3" data-line-number="3">             <span class="dt">method =</span> <span class="st">"loess"</span>)</a>
<a class="sourceLine" id="cb384-4" data-line-number="4"><span class="kw">plot_section</span>(<span class="st">"Children"</span>,</a>
<a class="sourceLine" id="cb384-5" data-line-number="5">             <span class="dt">smooth =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb384-6" data-line-number="6">             <span class="dt">method =</span> <span class="st">"lm"</span>,</a>
<a class="sourceLine" id="cb384-7" data-line-number="7">             <span class="dt">formula =</span> y <span class="op">~</span><span class="st"> </span><span class="kw">ns</span>(x, <span class="dv">2</span>))</a></code></pre>
<div class="figure"><span id="fig:ch-09-plot-function"/>
<p class="caption marginnote shownote">
Figure A.8: Our custom function can now pass arguments along to fit different smoothers to Section membership data.
</p>
<img src="../Images/e75ff4a3d54ffa56e423e228c0a57c17.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-1.png"/><img src="../Images/71f7dc2cba63a58337cf365b42199eb6.png" alt="Our custom function can now pass arguments along to fit different smoothers to Section membership data." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-09-plot-function-2.png"/>
</div>
&#13;

<h2><span class="header-section-number">A.3</span> Managing projects and files</h2>
<div id="markdown" class="section level3">
<h3><span class="header-section-number">A.3.1</span> RMarkdown and knitr</h3>
<p>Markdown<label for="tufte-mn-96" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-96" class="margin-toggle"/><span class="marginnote shownote"><code>en.wikipedia.org/wiki/Markdown</code></span> is a
loosely-standardized way of writing plain text that includes
information about the formatting of your document. It was originally
developed by John Gruber, with input from Aaron Swartz. The aim was to
make a simple format that could incorporate some structural
information about the document (such as headings and subheadings,
<em>emphasis</em>, hyperlinks, lists, footnotes, and so on), with minimal loss of readability in plain-text
form. A plain-text format like HTML is much more extensive and
well-defined than Markdown, but Markdown was meant to be simple. Over
the years, and despite various weaknesses, it has become a <em>de facto</em>
standard. Text editors and note-taking applications support it, and
tools exist to convert Markdown not just into HTML (its original
target output format) but many other document types as well. The most
powerful of these is Pandoc<label for="tufte-mn-97" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-97" class="margin-toggle"/><span class="marginnote shownote"><code>pandoc.org</code></span>, which can get you
from markdown to many other formats (and <em>vice versa</em>). Pandoc is what
powers RStudio’s ability to convert your notes to HTML, Microsoft
Word, and PDF documents.</p>
<p>Chapter 1 of this book encourages you to take notes and organize your
analysis using RMarkdown<label for="tufte-mn-98" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-98" class="margin-toggle"/><span class="marginnote shownote"><code>rmarkdown.rstudio.com</code></span> and (behind the scenes) knitr<label for="tufte-mn-99" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-99" class="margin-toggle"/><span class="marginnote shownote"><code>yihui.name/knitr</code></span>. These are R libraries that RStudio makes easy to use. RMarkdown extends Markdown by letting
you intersperse your notes with chunks of R code. Code chunks can have
labels and a few options that determine how they will behave when the
file is processed. After writing your notes and your code, you <code>knit</code>
the document <span class="citation">(Xie, 2015)</span>. That is, you feed your <code>.Rmd</code> file
to R, which processes the code chunks, and produces a new <code>.md</code> where
the code chunks have been replaced by their output. You can then turn
that Markdown file into a more readable PDF or HTML document, or the
Word document that a journal demands you send them.</p>
<p>Behind the scenes in RStudio, this is all done using the <code>knitr</code> and
<code>rmarkdown</code> libraries. The latter provides a <code>render()</code> function that
takes you from <code>.Rmd</code> to HTML or PDF in a single step. Conversely, if
you just want to extract the code you’ve written from the surrounding
text, then you “tangle” the file, which results in an <code>.R</code> file. The
strength of this approach is that is makes it much easier to document
your work properly. There is just one file for both the data analysis
and the writeup. The output of the analysis is created on the fly, and
the code to do it is embedded in the paper. If you need to do multiple
but identical (or very similar) analyses of different bits of data,
RMarkdown and <code>knitr</code> can make generating consistent and reliable
reports much easier.</p>
<p>Pandoc’s flavor of Markdown is the one used in knitr and
RStudio. It allows for a wide range of markup, and can handle many of
the nuts and bolts of scholarly writing, such as complex tables,
citations, bibliographies, references, and mathematics. In addition to
being able to produce documents in various <em>file</em> formats, it can also
produce many different <em>kinds</em> of document, from articles and handouts
to websites and slide decks. RStudio’s RMarkdown website has extensive
documentation and examples on the ins and outs of RMarkdown’s
capabilities, including information on customizing it if you wish.</p>
<p>Writing your notes and papers in a plain text format like this has
many advantages. It keeps your writing, your code, and your results
closer together, and allows you to use powerful version control
methods to keep track of your work and your results. Errors in data
analysis often well up out of the gap that typically exists between
the procedure used to produce a figure or table in a paper and the
subsequent use of that output later. In the ordinary way of doing
things, you have the code for your data analysis in one file, the
output it produced in another, and the text of your paper in a third
file. You do the analysis, collect the output and copy the relevant
results into your paper, often manually reformatting them on the way.
Each of these transitions introduces the opportunity for error. In
particular, it is easy for a table of results to get detached from the
sequence of steps that produced it. Almost everyone who has written a
quantitative paper has been confronted with the problem of reading an
old draft containing results or figures that need to be revisited or
reproduced (as a result of peer-review, say) but which lack any
information about the circumstances of their creation. Academic papers
take a long time to get through the cycle of writing, review,
revision, and publication, even when you’re working hard the whole
time. It is not uncommon to have to return to something you did two
years previously in order to answer some question or other from a
reviewer. You do not want to have to do everything over from scratch
in order to get the right answer. I am not exaggerating when I say
that, whatever the challenges of replicating the results of someone
else’s quantitative analysis, after a fairly short period of time
authors themselves find it hard to replicate their <em>own</em> work.
<em>Bit-rot</em> is the term of art in Computer Science for the seemingly
inevitable process of decay that overtakes a project just because
you left it alone on your computer for six months or more.</p>
<p>For small and medium-sized projects, plain text approaches that rely
on RMarkdown documents and the tools described here work well. Things
become a little more complicated as projects get larger. (This is not
an intrinsic flaw of plain-text methods, by the way. It is true no
matter how you choose to organize your project.) In general, it is
worth trying to keep your notes and analysis in a standardized and
simple format. The final outputs of projects (such as journal articles
or books) tend, as they approach completion, to descend into a rush of
specific fixes and adjustments, all running against the ideal of a
fully portable, reproducible analysis. It is worth trying to minimize
the scope of the inevitable final scramble.</p>
</div>
<div id="project-organization" class="section level3">
<h3><span class="header-section-number">A.3.2</span> Project organization</h3>
<p>Managing projects is a large topic of its own, and one that people have strong opinions about. Your goal should be to make your code and data portable, reproducible, and self-contained. In practice that means using a project based approach in R Studio. When you start an analysis with some new data, create a new project containing the data and the R or RMarkdown code you will be working with. It should then be possible, in the ideal case, to move that folder to another computer that also has R, RStudio, and any required libraries installed, and successfully re-run the contents of the project.</p>
<p>In practice that means two things. First, even though R is an object-oriented language, the only “real”, persistent things in your project should be the raw data files you start with, and the code that operates on them. The code is what is real. Your code manipulates the data and creates all of the objects and outputs you need. It’s possible to save objects in R but in general you should not need to do this for everyday analysis.</p>
<p>Second, your code should not refer to any file locations outside of the project folder. The project folder should be the “root” or ground floor for the files inside it. This means you should not use <em>absolute</em> file paths to save or refer to data or figures. Instead, use only <em>relative</em> paths. A relative path will start at the root of the project. So, for example, you should not load data with a command like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" data-line-number="1">## An absolute file path.</a>
<a class="sourceLine" id="cb385-2" data-line-number="2">## Notice the leading "/" that starts at the very top</a>
<a class="sourceLine" id="cb385-3" data-line-number="3">## of the computer's file hierarchy.</a>
<a class="sourceLine" id="cb385-4" data-line-number="4">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"/Users/kjhealy/projects/gss/data/gss.csv"</span>)</a></code></pre>
<p>Instead, because you have an R project file started in the <code>gss</code> folder you can use the <code>here()</code> library to specify a relative path, like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" data-line-number="1">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">here</span>(<span class="st">"data"</span>, <span class="st">"gss.csv"</span>))</a></code></pre>
<p>While you could type the relative paths out yourself, using <code>here()</code> has the advantage that it will work if, for example, you use Mac OS and you send your project to someone working on Windows. The same rule goes for saving your work, as we saw at the end of Chapter @(sec:makeplot), when you save individual plots as PDF or PNG files.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-org-simple-project"/>
<img src="../Images/121f0a5c0a13ac2f29b9f15a9cd8e0b4.png" alt="Folder organization for a simple project." width="100%" data-original-src="https://socviz.co/assets/ch-09-org-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.9: Folder organization for a simple project.<!--</p>-->
<!--</div>--></span>
</p>
<p>Within your project folder, a little organization goes a long way. You should get in the habit of keeping different parts of the project in different sub-folders of your working directory. More complex projects may have a more complex structure, but you can go a long way with some simple organization. RMarkdown files can be in the top level of your working directory, with separate sub-folders called <code>data/</code> (for your CSV files), one for <code>figures/</code> (that you might save) and perhaps one called <code>docs/</code> for information about your project or data files files. Rstudio can help with organization as well through its project management features.</p>
<p>Keeping your project organized just a little bit will prevent you from ending up with huge numbers of files of different kinds all sitting at the top of your working directory.</p>
</div>
&#13;

<h3><span class="header-section-number">A.3.1</span> RMarkdown and knitr</h3>
<p>Markdown<label for="tufte-mn-96" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-96" class="margin-toggle"/><span class="marginnote shownote"><code>en.wikipedia.org/wiki/Markdown</code></span> is a
loosely-standardized way of writing plain text that includes
information about the formatting of your document. It was originally
developed by John Gruber, with input from Aaron Swartz. The aim was to
make a simple format that could incorporate some structural
information about the document (such as headings and subheadings,
<em>emphasis</em>, hyperlinks, lists, footnotes, and so on), with minimal loss of readability in plain-text
form. A plain-text format like HTML is much more extensive and
well-defined than Markdown, but Markdown was meant to be simple. Over
the years, and despite various weaknesses, it has become a <em>de facto</em>
standard. Text editors and note-taking applications support it, and
tools exist to convert Markdown not just into HTML (its original
target output format) but many other document types as well. The most
powerful of these is Pandoc<label for="tufte-mn-97" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-97" class="margin-toggle"/><span class="marginnote shownote"><code>pandoc.org</code></span>, which can get you
from markdown to many other formats (and <em>vice versa</em>). Pandoc is what
powers RStudio’s ability to convert your notes to HTML, Microsoft
Word, and PDF documents.</p>
<p>Chapter 1 of this book encourages you to take notes and organize your
analysis using RMarkdown<label for="tufte-mn-98" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-98" class="margin-toggle"/><span class="marginnote shownote"><code>rmarkdown.rstudio.com</code></span> and (behind the scenes) knitr<label for="tufte-mn-99" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-99" class="margin-toggle"/><span class="marginnote shownote"><code>yihui.name/knitr</code></span>. These are R libraries that RStudio makes easy to use. RMarkdown extends Markdown by letting
you intersperse your notes with chunks of R code. Code chunks can have
labels and a few options that determine how they will behave when the
file is processed. After writing your notes and your code, you <code>knit</code>
the document <span class="citation">(Xie, 2015)</span>. That is, you feed your <code>.Rmd</code> file
to R, which processes the code chunks, and produces a new <code>.md</code> where
the code chunks have been replaced by their output. You can then turn
that Markdown file into a more readable PDF or HTML document, or the
Word document that a journal demands you send them.</p>
<p>Behind the scenes in RStudio, this is all done using the <code>knitr</code> and
<code>rmarkdown</code> libraries. The latter provides a <code>render()</code> function that
takes you from <code>.Rmd</code> to HTML or PDF in a single step. Conversely, if
you just want to extract the code you’ve written from the surrounding
text, then you “tangle” the file, which results in an <code>.R</code> file. The
strength of this approach is that is makes it much easier to document
your work properly. There is just one file for both the data analysis
and the writeup. The output of the analysis is created on the fly, and
the code to do it is embedded in the paper. If you need to do multiple
but identical (or very similar) analyses of different bits of data,
RMarkdown and <code>knitr</code> can make generating consistent and reliable
reports much easier.</p>
<p>Pandoc’s flavor of Markdown is the one used in knitr and
RStudio. It allows for a wide range of markup, and can handle many of
the nuts and bolts of scholarly writing, such as complex tables,
citations, bibliographies, references, and mathematics. In addition to
being able to produce documents in various <em>file</em> formats, it can also
produce many different <em>kinds</em> of document, from articles and handouts
to websites and slide decks. RStudio’s RMarkdown website has extensive
documentation and examples on the ins and outs of RMarkdown’s
capabilities, including information on customizing it if you wish.</p>
<p>Writing your notes and papers in a plain text format like this has
many advantages. It keeps your writing, your code, and your results
closer together, and allows you to use powerful version control
methods to keep track of your work and your results. Errors in data
analysis often well up out of the gap that typically exists between
the procedure used to produce a figure or table in a paper and the
subsequent use of that output later. In the ordinary way of doing
things, you have the code for your data analysis in one file, the
output it produced in another, and the text of your paper in a third
file. You do the analysis, collect the output and copy the relevant
results into your paper, often manually reformatting them on the way.
Each of these transitions introduces the opportunity for error. In
particular, it is easy for a table of results to get detached from the
sequence of steps that produced it. Almost everyone who has written a
quantitative paper has been confronted with the problem of reading an
old draft containing results or figures that need to be revisited or
reproduced (as a result of peer-review, say) but which lack any
information about the circumstances of their creation. Academic papers
take a long time to get through the cycle of writing, review,
revision, and publication, even when you’re working hard the whole
time. It is not uncommon to have to return to something you did two
years previously in order to answer some question or other from a
reviewer. You do not want to have to do everything over from scratch
in order to get the right answer. I am not exaggerating when I say
that, whatever the challenges of replicating the results of someone
else’s quantitative analysis, after a fairly short period of time
authors themselves find it hard to replicate their <em>own</em> work.
<em>Bit-rot</em> is the term of art in Computer Science for the seemingly
inevitable process of decay that overtakes a project just because
you left it alone on your computer for six months or more.</p>
<p>For small and medium-sized projects, plain text approaches that rely
on RMarkdown documents and the tools described here work well. Things
become a little more complicated as projects get larger. (This is not
an intrinsic flaw of plain-text methods, by the way. It is true no
matter how you choose to organize your project.) In general, it is
worth trying to keep your notes and analysis in a standardized and
simple format. The final outputs of projects (such as journal articles
or books) tend, as they approach completion, to descend into a rush of
specific fixes and adjustments, all running against the ideal of a
fully portable, reproducible analysis. It is worth trying to minimize
the scope of the inevitable final scramble.</p>
&#13;

<h3><span class="header-section-number">A.3.2</span> Project organization</h3>
<p>Managing projects is a large topic of its own, and one that people have strong opinions about. Your goal should be to make your code and data portable, reproducible, and self-contained. In practice that means using a project based approach in R Studio. When you start an analysis with some new data, create a new project containing the data and the R or RMarkdown code you will be working with. It should then be possible, in the ideal case, to move that folder to another computer that also has R, RStudio, and any required libraries installed, and successfully re-run the contents of the project.</p>
<p>In practice that means two things. First, even though R is an object-oriented language, the only “real”, persistent things in your project should be the raw data files you start with, and the code that operates on them. The code is what is real. Your code manipulates the data and creates all of the objects and outputs you need. It’s possible to save objects in R but in general you should not need to do this for everyday analysis.</p>
<p>Second, your code should not refer to any file locations outside of the project folder. The project folder should be the “root” or ground floor for the files inside it. This means you should not use <em>absolute</em> file paths to save or refer to data or figures. Instead, use only <em>relative</em> paths. A relative path will start at the root of the project. So, for example, you should not load data with a command like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb385-1" data-line-number="1">## An absolute file path.</a>
<a class="sourceLine" id="cb385-2" data-line-number="2">## Notice the leading "/" that starts at the very top</a>
<a class="sourceLine" id="cb385-3" data-line-number="3">## of the computer's file hierarchy.</a>
<a class="sourceLine" id="cb385-4" data-line-number="4">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="st">"/Users/kjhealy/projects/gss/data/gss.csv"</span>)</a></code></pre>
<p>Instead, because you have an R project file started in the <code>gss</code> folder you can use the <code>here()</code> library to specify a relative path, like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb386-1" data-line-number="1">my_data &lt;-<span class="st"> </span><span class="kw">read_csv</span>(<span class="kw">here</span>(<span class="st">"data"</span>, <span class="st">"gss.csv"</span>))</a></code></pre>
<p>While you could type the relative paths out yourself, using <code>here()</code> has the advantage that it will work if, for example, you use Mac OS and you send your project to someone working on Windows. The same rule goes for saving your work, as we saw at the end of Chapter @(sec:makeplot), when you save individual plots as PDF or PNG files.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-09-org-simple-project"/>
<img src="../Images/121f0a5c0a13ac2f29b9f15a9cd8e0b4.png" alt="Folder organization for a simple project." width="100%" data-original-src="https://socviz.co/assets/ch-09-org-1.png"/>
<!--
<p class="caption marginnote">-->Figure A.9: Folder organization for a simple project.<!--</p>-->
<!--</div>--></span>
</p>
<p>Within your project folder, a little organization goes a long way. You should get in the habit of keeping different parts of the project in different sub-folders of your working directory. More complex projects may have a more complex structure, but you can go a long way with some simple organization. RMarkdown files can be in the top level of your working directory, with separate sub-folders called <code>data/</code> (for your CSV files), one for <code>figures/</code> (that you might save) and perhaps one called <code>docs/</code> for information about your project or data files files. Rstudio can help with organization as well through its project management features.</p>
<p>Keeping your project organized just a little bit will prevent you from ending up with huge numbers of files of different kinds all sitting at the top of your working directory.</p>
&#13;

<h2><span class="header-section-number">A.4</span> Some features of this book</h2>
<div id="preparing-the-county-level-maps" class="section level3">
<h3><span class="header-section-number">A.4.1</span> Preparing the county-level maps</h3>
<p>The U.S. county-level maps in the <code>socviz</code> library were prepared using
shapefiles from the U.S. Census Bureau that were converted to GeoJSON
format by Eric Celeste.<label for="tufte-mn-100" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-100" class="margin-toggle"/><span class="marginnote shownote"><code>eric.clst.org/Stuff/USGeoJSON</code></span> The code to prepare the imported shapefile was written by Bob Rudis, and draws on the <code>rgdal</code> library to do the heavy lifting of importing the shapefile and transforming the projection. Bob’s code extracts the (county-identifying) rownames from the imported spatial data frame, and then moves Alaska and Hawaii to new locations in the bottom left of the map area, so that we can map all fifty states instead of just the lower forty eight.</p>
<p>First we read in the map file, set the projection, and set up an identifying variable we can work with later on to merge in data. The call to <code>CRS()</code> is a single long line of text conforming to a technical GIS specification defining the projection and other details that the map is encoded in. Long lines of code are conventionally indicated by the backslash charater, “<code>\</code>”, when we have to artificially break them on the page. Do not type the backslash if you write out this code yourself. We assume the mapfile is named <code>gz_2010_us_050_00_5m.json</code> and is in the <code>data/geojson</code> subfolder of the project directory.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb387-1" data-line-number="1"><span class="co"># You will need to use install.packages() to install</span></a>
<a class="sourceLine" id="cb387-2" data-line-number="2"><span class="co"># these map and GIS libraries if you do not already</span></a>
<a class="sourceLine" id="cb387-3" data-line-number="3"><span class="co"># have them.</span></a>
<a class="sourceLine" id="cb387-4" data-line-number="4"/>
<a class="sourceLine" id="cb387-5" data-line-number="5"><span class="kw">library</span>(maptools)</a>
<a class="sourceLine" id="cb387-6" data-line-number="6"><span class="kw">library</span>(mapproj)</a>
<a class="sourceLine" id="cb387-7" data-line-number="7"><span class="kw">library</span>(rgeos)</a>
<a class="sourceLine" id="cb387-8" data-line-number="8"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb387-9" data-line-number="9"/>
<a class="sourceLine" id="cb387-10" data-line-number="10">us_counties &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn=</span><span class="st">"data/geojson/gz_2010_us_050_00_5m.json"</span>,</a>
<a class="sourceLine" id="cb387-11" data-line-number="11">                       <span class="dt">layer=</span><span class="st">"OGRGeoJSON"</span>)</a>
<a class="sourceLine" id="cb387-12" data-line-number="12"/>
<a class="sourceLine" id="cb387-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">spTransform</span>(us_counties,</a>
<a class="sourceLine" id="cb387-14" data-line-number="14">                    <span class="kw">CRS</span>(<span class="st">"+proj=laea +lat_0=45 +lon_0=-100 \</span></a>
<a class="sourceLine" id="cb387-15" data-line-number="15"><span class="st">                         +x_0=0 +y_0=0 +a=6370997 +b=6370997 \</span></a>
<a class="sourceLine" id="cb387-16" data-line-number="16"><span class="st">                         +units=m +no_defs"</span>))</a>
<a class="sourceLine" id="cb387-17" data-line-number="17"/>
<a class="sourceLine" id="cb387-18" data-line-number="18">us_counties_aea<span class="op">@</span>data<span class="op">$</span>id &lt;-<span class="st"> </span><span class="kw">rownames</span>(us_counties_aea<span class="op">@</span>data)</a></code></pre>
<p>With the file imported, we then extract, rotate, shrink, and move Alaska, resetting the projection in the process. We also move Hawaii. The areas are identified by their State FIPS codes. We remove the old states and put the new ones back in, and remove Puerto Rico as our examples lack data for this region. If you have data for the area, you can move it between Texas and Florida.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1">alaska &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE <span class="op">==</span><span class="st"> "02"</span>,]</a>
<a class="sourceLine" id="cb388-2" data-line-number="2">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb388-3" data-line-number="3">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">scale=</span><span class="kw">max</span>(<span class="kw">apply</span>(<span class="kw">bbox</span>(alaska), <span class="dv">1</span>, diff)) <span class="op">/</span><span class="st"> </span><span class="fl">2.3</span>)</a>
<a class="sourceLine" id="cb388-4" data-line-number="4">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">shift=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2100000</span>, <span class="dv">-2500000</span>))</a>
<a class="sourceLine" id="cb388-5" data-line-number="5"><span class="kw">proj4string</span>(alaska) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-6" data-line-number="6"/>
<a class="sourceLine" id="cb388-7" data-line-number="7">hawaii &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE<span class="op">==</span><span class="st">"15"</span>,]</a>
<a class="sourceLine" id="cb388-8" data-line-number="8">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">35</span>)</a>
<a class="sourceLine" id="cb388-9" data-line-number="9">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">shift=</span><span class="kw">c</span>(<span class="dv">5400000</span>, <span class="dv">-1400000</span>))</a>
<a class="sourceLine" id="cb388-10" data-line-number="10"><span class="kw">proj4string</span>(hawaii) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-11" data-line-number="11"/>
<a class="sourceLine" id="cb388-12" data-line-number="12">us_counties_aea &lt;-<span class="st"> </span>us_counties_aea[<span class="op">!</span>us_counties_aea<span class="op">$</span>STATE <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"02"</span>, <span class="st">"15"</span>, <span class="st">"72"</span>),]</a>
<a class="sourceLine" id="cb388-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">rbind</span>(us_counties_aea, alaska, hawaii)</a></code></pre>
<p>Finally, we tidy the spatial object into a data frame that ggplot can use, and clean up the <code>id</code> label by stripping out a prefix from the string.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" data-line-number="1">county_map &lt;-<span class="st"> </span><span class="kw">tidy</span>(us_counties_aea, <span class="dt">region =</span> <span class="st">"GEO_ID"</span>)</a>
<a class="sourceLine" id="cb389-2" data-line-number="2">county_map<span class="op">$</span>id &lt;-<span class="st"> </span>stringr<span class="op">::</span><span class="kw">str_replace</span>(county_map<span class="op">$</span>id,</a>
<a class="sourceLine" id="cb389-3" data-line-number="3">                                      <span class="dt">pattern =</span> <span class="st">"0500000US"</span>, <span class="dt">replacement =</span> <span class="st">""</span>)</a></code></pre>
<p>At<label for="tufte-mn-101" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-101" class="margin-toggle"/><span class="marginnote shownote">For more detail and code for the merge, see <code>github.com/kjhealy/us-county</code></span> this point the <code>county_map</code> object is ready to be merged with a table of FIPS-coded US county data using either <code>merge()</code> or <code>left_join()</code>.</p>
</div>
<div id="this-books-plot-theme-and-its-map-theme" class="section level3">
<h3><span class="header-section-number">A.4.2</span> This book’s plot theme, and its map theme</h3>
<p>The ggplot theme used in this book is derived principally from the work (again) of
Bob Rudis. His <code>hrbrthemes</code> package provides <code>theme_ipsum()</code>, a compact theme that can be used with the Arial typeface or, in a variant, the freely available Roboto Condensed typeface. The main difference between the <code>theme_book()</code> used here and Rudis’s <code>theme_ipsum()</code> is the choice of typeface. The <code>hrbrthemes</code> package can be installed from GitHub in the usual way:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">"hrbrmstr/hrbrthemes"</span>)</a></code></pre>
<p>The<label for="tufte-mn-102" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-102" class="margin-toggle"/><span class="marginnote shownote"><code>github.com/kjhealy/myriad</code></span> book theme is also available on GitHub. This package does not include the font files themselves. These are available from Adobe, who make the typeface.</p>
<p>When drawing maps we also used a <code>theme_map()</code> function. This theme
begins with the built-in <code>theme_bw()</code> and turns off most of the
guide, scale, panel content that is not needed when presenting a map. It is available through the <code>socviz</code> library. The code looks like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">theme_map &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">base_size=</span><span class="dv">9</span>, <span class="dt">base_family=</span><span class="st">""</span>) {</a>
<a class="sourceLine" id="cb391-2" data-line-number="2">    <span class="kw">require</span>(grid)</a>
<a class="sourceLine" id="cb391-3" data-line-number="3">    <span class="kw">theme_bw</span>(<span class="dt">base_size=</span>base_size, <span class="dt">base_family=</span>base_family) <span class="op">%+replace%</span></a>
<a class="sourceLine" id="cb391-4" data-line-number="4"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-5" data-line-number="5">              <span class="dt">axis.text=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-6" data-line-number="6">              <span class="dt">axis.ticks=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-7" data-line-number="7">              <span class="dt">axis.title=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-8" data-line-number="8">              <span class="dt">panel.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-9" data-line-number="9">              <span class="dt">panel.border=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-10" data-line-number="10">              <span class="dt">panel.grid=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-11" data-line-number="11">              <span class="dt">panel.spacing=</span><span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>),</a>
<a class="sourceLine" id="cb391-12" data-line-number="12">              <span class="dt">plot.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-13" data-line-number="13">              <span class="dt">legend.justification =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb391-14" data-line-number="14">              <span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb391-15" data-line-number="15">              )</a>
<a class="sourceLine" id="cb391-16" data-line-number="16">}</a></code></pre>
<p>Themes are functions. Creating a theme means writing a function with a sequence of instructions about what thematic elements to modify, and how. We give it a default <code>base_size</code> argument and an empty <code>base_family</code> argument (for the font family). The <code>%+replace%</code> operator in the code is new to us. This is a convenience operator defined by ggplot and used for updating theme elements in bulk. Throughout the book we saw repeated use of the <code>+</code> operator to incrementally add to or tweak the content of a theme, as when we would do <code>+ theme(legend.position = "top")</code>. Using <code>+</code> added the instruction to the theme, adjusting whatever was specified and leaving everything else as it was. The <code>%+replace%</code> operator does something similar, but it has a stronger effect. We begin with <code>theme_bw()</code> and then use a <code>theme()</code> statement to add new content, as usual. The <code>%+replace%</code> operator replaces the entire element specified, rather than adding to it. Any element not specified in the <code>theme()</code> statement will be deleted from the new theme. So this is a way to create themes by both starting from existing ones, specifying new elements, and deleting anything not explicitly mentioned. See the documentation for <code>theme_get()</code> for more details. In the function here, you can see each of the thematic elements that are “switched off” using the <code>element_blank()</code> function.</p>



</div>
&#13;

<h3><span class="header-section-number">A.4.1</span> Preparing the county-level maps</h3>
<p>The U.S. county-level maps in the <code>socviz</code> library were prepared using
shapefiles from the U.S. Census Bureau that were converted to GeoJSON
format by Eric Celeste.<label for="tufte-mn-100" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-100" class="margin-toggle"/><span class="marginnote shownote"><code>eric.clst.org/Stuff/USGeoJSON</code></span> The code to prepare the imported shapefile was written by Bob Rudis, and draws on the <code>rgdal</code> library to do the heavy lifting of importing the shapefile and transforming the projection. Bob’s code extracts the (county-identifying) rownames from the imported spatial data frame, and then moves Alaska and Hawaii to new locations in the bottom left of the map area, so that we can map all fifty states instead of just the lower forty eight.</p>
<p>First we read in the map file, set the projection, and set up an identifying variable we can work with later on to merge in data. The call to <code>CRS()</code> is a single long line of text conforming to a technical GIS specification defining the projection and other details that the map is encoded in. Long lines of code are conventionally indicated by the backslash charater, “<code>\</code>”, when we have to artificially break them on the page. Do not type the backslash if you write out this code yourself. We assume the mapfile is named <code>gz_2010_us_050_00_5m.json</code> and is in the <code>data/geojson</code> subfolder of the project directory.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb387-1" data-line-number="1"><span class="co"># You will need to use install.packages() to install</span></a>
<a class="sourceLine" id="cb387-2" data-line-number="2"><span class="co"># these map and GIS libraries if you do not already</span></a>
<a class="sourceLine" id="cb387-3" data-line-number="3"><span class="co"># have them.</span></a>
<a class="sourceLine" id="cb387-4" data-line-number="4"/>
<a class="sourceLine" id="cb387-5" data-line-number="5"><span class="kw">library</span>(maptools)</a>
<a class="sourceLine" id="cb387-6" data-line-number="6"><span class="kw">library</span>(mapproj)</a>
<a class="sourceLine" id="cb387-7" data-line-number="7"><span class="kw">library</span>(rgeos)</a>
<a class="sourceLine" id="cb387-8" data-line-number="8"><span class="kw">library</span>(rgdal)</a>
<a class="sourceLine" id="cb387-9" data-line-number="9"/>
<a class="sourceLine" id="cb387-10" data-line-number="10">us_counties &lt;-<span class="st"> </span><span class="kw">readOGR</span>(<span class="dt">dsn=</span><span class="st">"data/geojson/gz_2010_us_050_00_5m.json"</span>,</a>
<a class="sourceLine" id="cb387-11" data-line-number="11">                       <span class="dt">layer=</span><span class="st">"OGRGeoJSON"</span>)</a>
<a class="sourceLine" id="cb387-12" data-line-number="12"/>
<a class="sourceLine" id="cb387-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">spTransform</span>(us_counties,</a>
<a class="sourceLine" id="cb387-14" data-line-number="14">                    <span class="kw">CRS</span>(<span class="st">"+proj=laea +lat_0=45 +lon_0=-100 \</span></a>
<a class="sourceLine" id="cb387-15" data-line-number="15"><span class="st">                         +x_0=0 +y_0=0 +a=6370997 +b=6370997 \</span></a>
<a class="sourceLine" id="cb387-16" data-line-number="16"><span class="st">                         +units=m +no_defs"</span>))</a>
<a class="sourceLine" id="cb387-17" data-line-number="17"/>
<a class="sourceLine" id="cb387-18" data-line-number="18">us_counties_aea<span class="op">@</span>data<span class="op">$</span>id &lt;-<span class="st"> </span><span class="kw">rownames</span>(us_counties_aea<span class="op">@</span>data)</a></code></pre>
<p>With the file imported, we then extract, rotate, shrink, and move Alaska, resetting the projection in the process. We also move Hawaii. The areas are identified by their State FIPS codes. We remove the old states and put the new ones back in, and remove Puerto Rico as our examples lack data for this region. If you have data for the area, you can move it between Texas and Florida.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb388-1" data-line-number="1">alaska &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE <span class="op">==</span><span class="st"> "02"</span>,]</a>
<a class="sourceLine" id="cb388-2" data-line-number="2">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">50</span>)</a>
<a class="sourceLine" id="cb388-3" data-line-number="3">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">scale=</span><span class="kw">max</span>(<span class="kw">apply</span>(<span class="kw">bbox</span>(alaska), <span class="dv">1</span>, diff)) <span class="op">/</span><span class="st"> </span><span class="fl">2.3</span>)</a>
<a class="sourceLine" id="cb388-4" data-line-number="4">alaska &lt;-<span class="st"> </span><span class="kw">elide</span>(alaska, <span class="dt">shift=</span><span class="kw">c</span>(<span class="op">-</span><span class="dv">2100000</span>, <span class="dv">-2500000</span>))</a>
<a class="sourceLine" id="cb388-5" data-line-number="5"><span class="kw">proj4string</span>(alaska) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-6" data-line-number="6"/>
<a class="sourceLine" id="cb388-7" data-line-number="7">hawaii &lt;-<span class="st"> </span>us_counties_aea[us_counties_aea<span class="op">$</span>STATE<span class="op">==</span><span class="st">"15"</span>,]</a>
<a class="sourceLine" id="cb388-8" data-line-number="8">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">rotate=</span><span class="op">-</span><span class="dv">35</span>)</a>
<a class="sourceLine" id="cb388-9" data-line-number="9">hawaii &lt;-<span class="st"> </span><span class="kw">elide</span>(hawaii, <span class="dt">shift=</span><span class="kw">c</span>(<span class="dv">5400000</span>, <span class="dv">-1400000</span>))</a>
<a class="sourceLine" id="cb388-10" data-line-number="10"><span class="kw">proj4string</span>(hawaii) &lt;-<span class="st"> </span><span class="kw">proj4string</span>(us_counties_aea)</a>
<a class="sourceLine" id="cb388-11" data-line-number="11"/>
<a class="sourceLine" id="cb388-12" data-line-number="12">us_counties_aea &lt;-<span class="st"> </span>us_counties_aea[<span class="op">!</span>us_counties_aea<span class="op">$</span>STATE <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">"02"</span>, <span class="st">"15"</span>, <span class="st">"72"</span>),]</a>
<a class="sourceLine" id="cb388-13" data-line-number="13">us_counties_aea &lt;-<span class="st"> </span><span class="kw">rbind</span>(us_counties_aea, alaska, hawaii)</a></code></pre>
<p>Finally, we tidy the spatial object into a data frame that ggplot can use, and clean up the <code>id</code> label by stripping out a prefix from the string.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb389-1" data-line-number="1">county_map &lt;-<span class="st"> </span><span class="kw">tidy</span>(us_counties_aea, <span class="dt">region =</span> <span class="st">"GEO_ID"</span>)</a>
<a class="sourceLine" id="cb389-2" data-line-number="2">county_map<span class="op">$</span>id &lt;-<span class="st"> </span>stringr<span class="op">::</span><span class="kw">str_replace</span>(county_map<span class="op">$</span>id,</a>
<a class="sourceLine" id="cb389-3" data-line-number="3">                                      <span class="dt">pattern =</span> <span class="st">"0500000US"</span>, <span class="dt">replacement =</span> <span class="st">""</span>)</a></code></pre>
<p>At<label for="tufte-mn-101" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-101" class="margin-toggle"/><span class="marginnote shownote">For more detail and code for the merge, see <code>github.com/kjhealy/us-county</code></span> this point the <code>county_map</code> object is ready to be merged with a table of FIPS-coded US county data using either <code>merge()</code> or <code>left_join()</code>.</p>
&#13;

<h3><span class="header-section-number">A.4.2</span> This book’s plot theme, and its map theme</h3>
<p>The ggplot theme used in this book is derived principally from the work (again) of
Bob Rudis. His <code>hrbrthemes</code> package provides <code>theme_ipsum()</code>, a compact theme that can be used with the Arial typeface or, in a variant, the freely available Roboto Condensed typeface. The main difference between the <code>theme_book()</code> used here and Rudis’s <code>theme_ipsum()</code> is the choice of typeface. The <code>hrbrthemes</code> package can be installed from GitHub in the usual way:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb390-1" data-line-number="1">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">"hrbrmstr/hrbrthemes"</span>)</a></code></pre>
<p>The<label for="tufte-mn-102" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-102" class="margin-toggle"/><span class="marginnote shownote"><code>github.com/kjhealy/myriad</code></span> book theme is also available on GitHub. This package does not include the font files themselves. These are available from Adobe, who make the typeface.</p>
<p>When drawing maps we also used a <code>theme_map()</code> function. This theme
begins with the built-in <code>theme_bw()</code> and turns off most of the
guide, scale, panel content that is not needed when presenting a map. It is available through the <code>socviz</code> library. The code looks like this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb391-1" data-line-number="1">theme_map &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">base_size=</span><span class="dv">9</span>, <span class="dt">base_family=</span><span class="st">""</span>) {</a>
<a class="sourceLine" id="cb391-2" data-line-number="2">    <span class="kw">require</span>(grid)</a>
<a class="sourceLine" id="cb391-3" data-line-number="3">    <span class="kw">theme_bw</span>(<span class="dt">base_size=</span>base_size, <span class="dt">base_family=</span>base_family) <span class="op">%+replace%</span></a>
<a class="sourceLine" id="cb391-4" data-line-number="4"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">axis.line=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-5" data-line-number="5">              <span class="dt">axis.text=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-6" data-line-number="6">              <span class="dt">axis.ticks=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-7" data-line-number="7">              <span class="dt">axis.title=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-8" data-line-number="8">              <span class="dt">panel.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-9" data-line-number="9">              <span class="dt">panel.border=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-10" data-line-number="10">              <span class="dt">panel.grid=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-11" data-line-number="11">              <span class="dt">panel.spacing=</span><span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"lines"</span>),</a>
<a class="sourceLine" id="cb391-12" data-line-number="12">              <span class="dt">plot.background=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb391-13" data-line-number="13">              <span class="dt">legend.justification =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</a>
<a class="sourceLine" id="cb391-14" data-line-number="14">              <span class="dt">legend.position =</span> <span class="kw">c</span>(<span class="dv">0</span>,<span class="dv">0</span>)</a>
<a class="sourceLine" id="cb391-15" data-line-number="15">              )</a>
<a class="sourceLine" id="cb391-16" data-line-number="16">}</a></code></pre>
<p>Themes are functions. Creating a theme means writing a function with a sequence of instructions about what thematic elements to modify, and how. We give it a default <code>base_size</code> argument and an empty <code>base_family</code> argument (for the font family). The <code>%+replace%</code> operator in the code is new to us. This is a convenience operator defined by ggplot and used for updating theme elements in bulk. Throughout the book we saw repeated use of the <code>+</code> operator to incrementally add to or tweak the content of a theme, as when we would do <code>+ theme(legend.position = "top")</code>. Using <code>+</code> added the instruction to the theme, adjusting whatever was specified and leaving everything else as it was. The <code>%+replace%</code> operator does something similar, but it has a stronger effect. We begin with <code>theme_bw()</code> and then use a <code>theme()</code> statement to add new content, as usual. The <code>%+replace%</code> operator replaces the entire element specified, rather than adding to it. Any element not specified in the <code>theme()</code> statement will be deleted from the new theme. So this is a way to create themes by both starting from existing ones, specifying new elements, and deleting anything not explicitly mentioned. See the documentation for <code>theme_get()</code> for more details. In the function here, you can see each of the thematic elements that are “switched off” using the <code>element_blank()</code> function.</p>



    
</body>
</html>