<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
  "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>8 Refine your plots</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>8 Refine your plots</h1>
<blockquote>原文：<a href="https://socviz.co/refineplots.html">https://socviz.co/refineplots.html</a></blockquote>

<p>So far we have mostly used ggplot’s default output when making our
plots, generally not looking at opportunities to tweak or customize
things to a any great extent. In general, when making figures during
exploratory data analysis, the default settings in ggplot should be
pretty good to work with. It’s only when we have some specific plot in
mind that the question of polishing the results comes up. Refining a
plot can mean several things. We might want to get the look of it just
right, based on our own tastes and our sense of what needs to be
highlighted. We might want to format it in a way that will meet the
expectations of a journal, or of a conference audience, or the general
public. We might want to tweak this or that feature of the plot or add
an annotation or additional detail not covered by the default output.
Or we might want to completely change the look of the entire thing,
given that all of the structural elements of the plot are in place. We
have the resources in ggplot to do all of these things.</p>
<p>Let’s begin by looking at a new dataset, <code>asasec</code>. This is some data on membership over time in special-interest sections of the American Sociological Association.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb281-1" data-line-number="1"><span class="kw">head</span>(asasec)</a></code></pre>
<pre><code>##                                Section         Sname
## 1      Aging and the Life Course (018)         Aging
## 2     Alcohol, Drugs and Tobacco (030) Alcohol/Drugs
## 3 Altruism and Social Solidarity (047)      Altruism
## 4            Animals and Society (042)       Animals
## 5             Asia/Asian America (024)          Asia
## 6            Body and Embodiment (048)          Body
##   Beginning Revenues Expenses Ending Journal Year Members
## 1     12752    12104    12007  12849      No 2005     598
## 2     11933     1144      400  12677      No 2005     301
## 3      1139     1862     1875   1126      No 2005      NA
## 4       473      820     1116    177      No 2005     209
## 5      9056     2116     1710   9462      No 2005     365
## 6      3408     1618     1920   3106      No 2005      NA</code></pre>
<p>In this dataset, we have membership data for each section over a ten
year period, but the data on section reserves and income (the
<code>Beginning</code> and <code>Revenues</code> variables) is for the 2015 year only. Let’s
look at the relationship between section membership and section
revenues for a single year, 2014.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-member-trends-01"/>
<img src="../Images/550dda0e187b4e254578ce9511d8460b.png" alt="Back to Basics." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-member-trends-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.1: Back to Basics.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb283-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(asasec, Year <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>),</a>
<a class="sourceLine" id="cb283-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Members, <span class="dt">y =</span> Revenues, <span class="dt">label =</span> Sname))</a>
<a class="sourceLine" id="cb283-3" data-line-number="3"/>
<a class="sourceLine" id="cb283-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>() <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>()</a></code></pre>
<pre><code>## `geom_smooth()` using method = 'loess' and formula 'y ~ x'</code></pre>
<p>This is our basic scatterplot-and-smoother graph. To refine it, let’s begin by identifying some outliers, switch from <code>loess</code> to OLS, and introduce a third variable.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-member-trends-02"/>
<img src="../Images/683a9ed4e04555d8c0248f73414d8c53.png" alt="Refining the plot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-member-trends-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.2: Refining the plot.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb285-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(asasec, Year <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>),</a>
<a class="sourceLine" id="cb285-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Members, <span class="dt">y =</span> Revenues, <span class="dt">label =</span> Sname))</a>
<a class="sourceLine" id="cb285-3" data-line-number="3"/>
<a class="sourceLine" id="cb285-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> Journal)) <span class="op">+</span></a>
<a class="sourceLine" id="cb285-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>)</a></code></pre>
<p>Now we can add some text labels. At this point it makes sense to use some intermediate objects to build things up as we go. We won’t show them all. But by now you should be able to see in your mind’s eye what an object like <code>p1</code> or <code>p2</code> will look like. And of course you should type out the code and check if you are right as you go.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb286-1" data-line-number="1">p0 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(asasec, Year <span class="op">==</span><span class="st"> </span><span class="dv">2014</span>),</a>
<a class="sourceLine" id="cb286-2" data-line-number="2">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Members, <span class="dt">y =</span> Revenues, <span class="dt">label =</span> Sname))</a>
<a class="sourceLine" id="cb286-3" data-line-number="3"/>
<a class="sourceLine" id="cb286-4" data-line-number="4">p1 &lt;-<span class="st"> </span>p0 <span class="op">+</span><span class="st"> </span><span class="kw">geom_smooth</span>(<span class="dt">method =</span> <span class="st">"lm"</span>, <span class="dt">se =</span> <span class="ot">FALSE</span>, <span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb286-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_point</span>(<span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">color =</span> Journal)) </a>
<a class="sourceLine" id="cb286-6" data-line-number="6"/>
<a class="sourceLine" id="cb286-7" data-line-number="7">p2 &lt;-<span class="st"> </span>p1 <span class="op">+</span><span class="st"> </span><span class="kw">geom_text_repel</span>(<span class="dt">data=</span><span class="kw">subset</span>(asasec,</a>
<a class="sourceLine" id="cb286-8" data-line-number="8">                                       Year <span class="op">==</span><span class="st"> </span><span class="dv">2014</span> <span class="op">&amp;</span><span class="st"> </span>Revenues <span class="op">&gt;</span><span class="st"> </span><span class="dv">7000</span>),</a>
<a class="sourceLine" id="cb286-9" data-line-number="9">                           <span class="dt">size =</span> <span class="dv">2</span>)</a></code></pre>
<p>Continuing with the <code>p2</code> object still, we can label the axes and scales. We also add a title and move the legend to make better use of the space in the plot.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-member-trends-04"/>
<img src="../Images/fc2e760e6e4923715f7fe6ac9d6f4dd1.png" alt="Refining the axes." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-member-trends-04-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.3: Refining the axes.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb287-1" data-line-number="1">p3 &lt;-<span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span><span class="kw">labs</span>(<span class="dt">x=</span><span class="st">"Membership"</span>,</a>
<a class="sourceLine" id="cb287-2" data-line-number="2">        <span class="dt">y=</span><span class="st">"Revenues"</span>,</a>
<a class="sourceLine" id="cb287-3" data-line-number="3">        <span class="dt">color =</span> <span class="st">"Section has own Journal"</span>,</a>
<a class="sourceLine" id="cb287-4" data-line-number="4">        <span class="dt">title =</span> <span class="st">"ASA Sections"</span>,</a>
<a class="sourceLine" id="cb287-5" data-line-number="5">        <span class="dt">subtitle =</span> <span class="st">"2014 Calendar year."</span>,</a>
<a class="sourceLine" id="cb287-6" data-line-number="6">        <span class="dt">caption =</span> <span class="st">"Source: ASA annual report."</span>)</a>
<a class="sourceLine" id="cb287-7" data-line-number="7">p4 &lt;-<span class="st"> </span>p3 <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb287-8" data-line-number="8"><span class="st">     </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>)</a>
<a class="sourceLine" id="cb287-9" data-line-number="9">p4</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerseq"/>
<img src="../Images/80480c221d3209108c2a4bd934d9626d.png" alt="RColorBrewer's sequential palettes." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerseq-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.4: RColorBrewer’s sequential palettes.<!--</p>-->
<!--</div>--></span>
</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerdiv"/>
<img src="../Images/db401a11edd3ff41309199b0fc7b7e57.png" alt="RColorBrewer's diverging palettes." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerdiv-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.5: RColorBrewer’s diverging palettes.<!--</p>-->
<!--</div>--></span>
</p>
<div id="use-color-to-your-advantage" class="section level2">
<h2><span class="header-section-number">8.1</span> Use color to your advantage</h2>
<p>You should choose a color palette in the first place based on its
ability to express the data you are plotting. An unordered categorical
variable like “Country” or “Sex”, for example, requires distinct
colors that won’t be easily confused with one another. An ordered
categorical variable like “Level of Education”, on the other hand,
requires a graded color scheme of some kind running from less to more
or earlier to later. There are other considerations, too. For example,
if your variable is ordered, is your scale centered on a neutral
midpoint with departures to extremes in each direction, as in a Likert
scale? Again, these questions are about ensuring accuracy and fidelity
when mapping a variable to a color scale. Take care to choose a
palette that reflects the structure of your data. For example, do not
map sequential scales to categorical palettes, or use a diverging
palette for a variable with no well-defined midpoint.</p>
<p>Separate from these mapping issues, there are considerations about
which colors in particular to choose. In general, the default color
palettes that ggplot makes available are well-chosen for their
perceptual properties and aesthetic qualities. We can also use color
and color layers as device for emphasis, to highlight particular data
points or parts of the plot, perhaps in conjunction with other
features.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerqual"/>
<img src="../Images/28765d703602bf5cd1d514e8e26db9cb.png" alt="RColorBrewer's qualitative palettes." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerqual-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.6: RColorBrewer’s qualitative palettes.<!--</p>-->
<!--</div>--></span>
</p>
<p>We choose color palettes for mappings through one of the <code>scale_</code>
functions for <code>color</code> or <code>fill</code>. While it is possible to very finely
control the look of your color schemes by varying the hue, chroma, and
luminance of each color you use via <code>scale_color_hue()</code>, or
<code>scale_fill_hue()</code>, in general this is not recommended. Instead you
should use the <code>RColorBrewer</code> package to make a wide range of named
color palettes available to you, and choose from those. When used in
conjunction with ggplot, you access these colors by specifying the
<code>scale_color_brewer()</code> or <code>scale_fill_brewer()</code> functions, depending
on the aesthetic you are mapping. Figure <a href="refineplots.html#fig:ch-08-brewerpals">8.7</a> shows
the named palettes you can use in this way.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerpals"/>
<img src="../Images/95b91c1a13faa395ecf14f1f6408d1af.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-1.png"/><img src="../Images/aedc13a3f5be16c006085a620331fcac.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-2.png"/><img src="../Images/78007d7d0fba02e6570b5e66c41d92b7.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-3.png"/>
<!--
<p class="caption marginnote">-->Figure 8.7: Some available palettes in use.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb288-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> organdata,</a>
<a class="sourceLine" id="cb288-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> roads, <span class="dt">y =</span> donors, <span class="dt">color =</span> world))</a>
<a class="sourceLine" id="cb288-3" data-line-number="3">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Set2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-4" data-line-number="4"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb288-5" data-line-number="5"/>
<a class="sourceLine" id="cb288-6" data-line-number="6">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Pastel2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-7" data-line-number="7"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb288-8" data-line-number="8"/>
<a class="sourceLine" id="cb288-9" data-line-number="9">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Dark2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-10" data-line-number="10"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a></code></pre>
<p>You can also specify colors manually, via <code>scale_color_manual()</code> or
<code>scale_fill_manual()</code>. These functions take a <code>value</code> argument that
can be specified as vector of color names or color values that R knows
about. R knows many color names (like <code>red</code>, and <code>green</code>, and
<code>cornflowerblue</code>. Try <code>demo('colors')</code> for an overview. Alternatively,
color values can be specified via their hexadecimal RGB value. This is
a way of encoding color values in the RGB colorspace, where each
channel can take a value from 0 to 255 like this. A color hex value
begins with a hash or pound character, <code>#</code>, followed by three pairs of
hexadecimal or “hex” numbers. Hex values are in Base 16, with the
first six letters of the alphabet standing for the numbers 10 to 15.
This allows a two-character hex number to range from 0 to 255. You
read them as <code>#rrggbb</code>, where <code>rr</code> is the two-digit hex code for the
red channel, <code>gg</code> for the green channel, and <code>bb</code> for the blue
channel. So <code>#CC55DD</code> translates in decimal to <code>CC</code> = 204 (red), <code>55</code>
= 85 (green), and <code>DD</code> = 221 (blue). It gives a strong pink color.</p>
<p>Going back to our ASA Membership plot, for example, we can manually
introduce a palette from <span class="citation">Chang (2013)</span> that’s friendly to color-blind viewers.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb289-1" data-line-number="1">cb_palette &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</a>
<a class="sourceLine" id="cb289-2" data-line-number="2">                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</a>
<a class="sourceLine" id="cb289-3" data-line-number="3"/>
<a class="sourceLine" id="cb289-4" data-line-number="4">p4 <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> cb_palette) </a></code></pre>
<div class="figure"><span id="fig:ch-08-customcolor"/>
<p class="caption marginnote shownote">
Figure 8.8: Using a custom color palette.
</p>
<img src="../Images/f3cef85f5074883b01a2f66e64ccf77b.png" alt="Using a custom color palette." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-customcolor-1.png"/>
</div>
<p>As is often the case, this work has already been done for us. If
we are serious about using a safe palette for color-blind viewers, we
should investigate the <code>dichromat</code> package instead.<label for="tufte-mn-82" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-82" class="margin-toggle"/><span class="marginnote shownote">The <code>colorblindr</code> package has similar functionality.</span> It provides a range of safe palettes and some useful functions for helping you
approximately see what your current palette might look like to a
viewer with one of several different kinds of color blindness.</p>
<p>For example, let’s use <code>RColorBrewer</code>’s <code>brewer.pal()</code> function to get five colors from ggplot’s default palette.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" data-line-number="1">Default &lt;-<span class="st"> </span><span class="kw">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Set2"</span>)</a></code></pre>
<p>Next, we can use a function from the <code>dichromat</code> library to transform these colors to new values that simulate different kinds of color blindness.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb291-1" data-line-number="1"><span class="kw">library</span>(dichromat)</a>
<a class="sourceLine" id="cb291-2" data-line-number="2"/>
<a class="sourceLine" id="cb291-3" data-line-number="3">types &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"deutan"</span>, <span class="st">"protan"</span>, <span class="st">"tritan"</span>)</a>
<a class="sourceLine" id="cb291-4" data-line-number="4"><span class="kw">names</span>(types) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Deuteronopia"</span>, <span class="st">"Protanopia"</span>, <span class="st">"Tritanopia"</span>)</a>
<a class="sourceLine" id="cb291-5" data-line-number="5"/>
<a class="sourceLine" id="cb291-6" data-line-number="6">color_table &lt;-<span class="st"> </span>types <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-7" data-line-number="7"><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">dichromat</span>(Default, .x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-8" data-line-number="8"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-9" data-line-number="9"><span class="st">    </span><span class="kw">add_column</span>(Default, <span class="dt">.before =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb291-10" data-line-number="10"/>
<a class="sourceLine" id="cb291-11" data-line-number="11">color_table</a></code></pre>
<pre><code>## # A tibble: 5 x 4
##   Default Deuteronopia Protanopia Tritanopia
##   &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;     
## 1 #66C2A5 #AEAEA7      #BABAA5    #82BDBD   
## 2 #FC8D62 #B6B661      #9E9E63    #F29494   
## 3 #8DA0CB #9C9CCB      #9E9ECB    #92ABAB   
## 4 #E78AC3 #ACACC1      #9898C3    #DA9C9C   
## 5 #A6D854 #CACA5E      #D3D355    #B6C8C8</code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-color-comp"/>
<img src="../Images/a2751e201c976fd23ab0f1eb95b8212b.png" alt="Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-color-comp-1.png"/><img src="../Images/c1e508616e1cf373ff78c83e9c593902.png" alt="Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-color-comp-2.png"/>
<!--
<p class="caption marginnote">-->Figure 8.9: Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" data-line-number="1"><span class="kw">color_comp</span>(color_table)</a></code></pre>
<p>In this code, we create a vector of <code>types</code> of color blindness that the <code>dichromat()</code> function knows about, and give them proper names. Then we make a table of colors for each type using the <code>purrr</code> library’s <code>map()</code> function. The rest of the pipeline converts the results from a list to a tibble and adds the original colors as the first column in the table. We can now plot them to see how they compare, using a convenience function from the <code>socviz</code> library.</p>
<p>The ability to manually specify colors can be useful when the meaning
of a category itself has a strong color association. Political
parties, for example, tend to have official or quasi-official party
colors that people associate with them. In such cases it is helpful to
be able to present results for, say, the Green Party in a
(perceptually balanced!) green color. When doing this, it is worth
keeping in mind that some colors are associated with categories
(especially categories of person) for outmoded reasons, or no very
good reason. Do not use stereotypical colors just because you can.</p>
</div>
<div id="layer-color-and-text-together" class="section level2">
<h2><span class="header-section-number">8.2</span> Layer color and text together</h2>
<p>Aside from mapping variables directly, color is also very useful when
we want to pick out or highlight some aspect of our data. In cases
like this that the layered approach of ggplot can really work to our
advantage. Let’s work through an example where we use manually
specified colors both for emphasis and because of their social
meaning.</p>
<p>We will build up a plot of data about the 2016 US general election. It
is contained in the <code>county_data</code> object in the <code>socviz</code> library. We
begin by defining a blue and red color for the Democrats and
Republicans. Then we create the basic setup and first layer of the
plot. We subset the data, including only counties with a value of “No”
on the <code>flipped</code> variable. We set the color of <code>geom_point()</code>
to be a light gray, as it will form the background layer of the
plot. And we apply a log transformation to the x-axis scale.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-01"/>
<img src="../Images/53e87e727f989adf8e4bc7e5600394e5.png" alt="The background layer." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.10: The background layer.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" data-line-number="1"><span class="co"># Democrat Blue and Republican Red</span></a>
<a class="sourceLine" id="cb294-2" data-line-number="2">party_colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#2E74C0"</span>, <span class="st">"#CB454A"</span>)</a>
<a class="sourceLine" id="cb294-3" data-line-number="3"/>
<a class="sourceLine" id="cb294-4" data-line-number="4">p0 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb294-5" data-line-number="5">                           flipped <span class="op">==</span><span class="st"> "No"</span>),</a>
<a class="sourceLine" id="cb294-6" data-line-number="6">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop,</a>
<a class="sourceLine" id="cb294-7" data-line-number="7">                           <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb294-8" data-line-number="8"/>
<a class="sourceLine" id="cb294-9" data-line-number="9">p1 &lt;-<span class="st"> </span>p0 <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.15</span>, <span class="dt">color =</span> <span class="st">"gray50"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels=</span>scales<span class="op">::</span>comma) </a>
<a class="sourceLine" id="cb294-11" data-line-number="11"/>
<a class="sourceLine" id="cb294-12" data-line-number="12">p1</a></code></pre>
<p>In the next step we add a second <code>geom_point()</code> layer. Here we start with the same dataset but extract a complementary subset from it. This time we choose the “Yes” counties on the <code>flipped</code> variable. The <code>x</code> and <code>y</code> mappings are the same, but we add a color scale for these points, mapping the <code>partywinner16</code> variable to the <code>color</code> aesthetic. Then we specify a manual color scale with <code>scale_color_manual()</code>, where the values are the blue and red <code>party_colors</code> we defined above.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-02"/>
<img src="../Images/d69576a9832a618317465f2ae189b30e.png" alt="The second layer." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.11: The second layer.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb295-1" data-line-number="1">p2 &lt;-<span class="st"> </span>p1 <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb295-2" data-line-number="2">                                    flipped <span class="op">==</span><span class="st"> "Yes"</span>),</a>
<a class="sourceLine" id="cb295-3" data-line-number="3">                      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop, <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb295-4" data-line-number="4">                                    <span class="dt">color =</span> partywinner16)) <span class="op">+</span></a>
<a class="sourceLine" id="cb295-5" data-line-number="5"><span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> party_colors)</a>
<a class="sourceLine" id="cb295-6" data-line-number="6"/>
<a class="sourceLine" id="cb295-7" data-line-number="7">p2</a></code></pre>
<p>The next layer sets the y-axis scale and the labels.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-03"/>
<img src="../Images/d870c3cd11377a43025a595b0503e56f.png" alt="Adding guides and labels, and fixing the x-axis scale." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-03-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.12: Adding guides and labels, and fixing the x-axis scale.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" data-line-number="1">p3 &lt;-<span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels=</span>scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-2" data-line-number="2"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"County flipped to ... "</span>,</a>
<a class="sourceLine" id="cb296-3" data-line-number="3">         <span class="dt">x =</span> <span class="st">"County Population (log scale)"</span>,</a>
<a class="sourceLine" id="cb296-4" data-line-number="4">         <span class="dt">y =</span> <span class="st">"Percent Black Population"</span>,</a>
<a class="sourceLine" id="cb296-5" data-line-number="5">         <span class="dt">title =</span> <span class="st">"Flipped counties, 2016"</span>,</a>
<a class="sourceLine" id="cb296-6" data-line-number="6">         <span class="dt">caption =</span> <span class="st">"Counties in gray did not flip."</span>)</a>
<a class="sourceLine" id="cb296-7" data-line-number="7"/>
<a class="sourceLine" id="cb296-8" data-line-number="8">p3</a></code></pre>
<p>Finally, we add a third layer using the <code>geom_text_repel()</code> function. Once again we supply a set of instructions to subset the data for this text layer. We are interested in the flipped counties that have with a relatively high percentage of African-American residents. The result, shown in Figure <a href="refineplots.html#fig:ch-08-flippers">8.13</a> is a complex but legible multi-layer plot with judicious use of color for variable coding and context.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" data-line-number="1">p4 &lt;-<span class="st"> </span>p3 <span class="op">+</span><span class="st"> </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb297-2" data-line-number="2">                                      flipped <span class="op">==</span><span class="st"> "Yes"</span> <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb297-3" data-line-number="3"><span class="st">                                      </span>black  <span class="op">&gt;</span><span class="st"> </span><span class="dv">25</span>),</a>
<a class="sourceLine" id="cb297-4" data-line-number="4">                           <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop,</a>
<a class="sourceLine" id="cb297-5" data-line-number="5">                                   <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb297-6" data-line-number="6">                                   <span class="dt">label =</span> state), <span class="dt">size =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb297-7" data-line-number="7"/>
<a class="sourceLine" id="cb297-8" data-line-number="8">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb297-9" data-line-number="9"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a></code></pre>
<p>When producing a graphic like this in ggplot, or when looking at good plots made by others, it should gradually become your habit to see not just the content of the plot but also the implicit or explicit structure that it has. First, you will be able to see the mappings that form the basis of the plot, picking out which variables are mapped to x and y, and which to to color, fill, shape, label, and so on. What geoms were used to produce them? Second, how have the scales been adjusted? Are the axes transformed? Are the fill and color legends combined? And third, especially as you practice making plots of your own, you will find yourself picking out the **layered* structure of the plot. What is the base layer? What has been drawn on top of it, and in what order? Which upper layers are formed from subsets of the data? Which are new datasets? Are there annotations? The ability to evaluate plots in this way, to apply the grammar of graphics in practice, is useful both for <em>looking</em> at plots and for thinking about how to <em>make</em> them.</p>
</div>
<div id="change-the-appearance-of-plots-with-themes" class="section level2">
<h2><span class="header-section-number">8.3</span> Change the appearance of plots with themes</h2>
<p>Our elections plot is in a pretty finished state. But if we want to change the overall look of it all at once, we can do that using ggplot’s theme engine. Themes can be turned on or off using the <code>theme_set()</code> function. It takes the name of a theme (which will itself be a function) as an argument. Try the following:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" data-line-number="1"><span class="kw">theme_set</span>(<span class="kw">theme_bw</span>())</a>
<a class="sourceLine" id="cb298-2" data-line-number="2">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb298-3" data-line-number="3"/>
<a class="sourceLine" id="cb298-4" data-line-number="4"><span class="kw">theme_set</span>(<span class="kw">theme_dark</span>())</a>
<a class="sourceLine" id="cb298-5" data-line-number="5">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a></code></pre>
<p>Internally, theme functions are a set of detailed instructions to turn on, turn off, or modify a large number of graphical elements on the plot. Once set, a theme applies to all subsequent plots and it remains active until it is replaced by a different theme. This be done either through the use of another <code>theme_set()</code> statement, or on a per-plot basis by adding the theme function to the end of the plot: <code>p4 + theme_gray()</code> would temporarily override the generally active theme for the <code>p4</code> object only. You can still use the <code>theme()</code> function to fine-tune any aspect of your plot, as seen above with the relocation of the legend to the top of the graph.</p>
<p>The ggplot library comes with several built-in themes, including <code>theme_minimal()</code> and <code>theme_classic()</code>, with <code>theme_gray()</code> or <code>theme_grey()</code> as the default. If these are not to your taste, install the <code>ggthemes</code> library for many more options. You can, for example, make ggplot output look like it has been featured in the <em>Economist</em>, or the <em>Wall Street Journal</em>, or in the pages of a book by Edward Tufte.</p>
<div class="figure fullwidth"><span id="fig:ch-08-flippers"/>
<img src="../Images/bf4a337c3b0ee3da335bbfbaea0cfbb6.png" alt="County-level election data from 2016." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-flippers-1.png"/>
<p class="caption marginnote shownote">
Figure 8.13: County-level election data from 2016.
</p>
</div>
<p>Using some themes might involve adjusting font sizes or
other elements as needed, if the defaults are too large or small. If
you use a theme with a colored background, you will also need to
consider what color palette you are using when mapping to <code>color</code> or
<code>fill</code> aesthetics. You can define your own themes either entirely from
scratch, or by starting with one you like and making adjustments from
there.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" data-line-number="1"><span class="kw">library</span>(ggthemes)</a>
<a class="sourceLine" id="cb299-2" data-line-number="2"/>
<a class="sourceLine" id="cb299-3" data-line-number="3"><span class="kw">theme_set</span>(<span class="kw">theme_economist</span>())</a>
<a class="sourceLine" id="cb299-4" data-line-number="4">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb299-5" data-line-number="5"/>
<a class="sourceLine" id="cb299-6" data-line-number="6"><span class="kw">theme_set</span>(<span class="kw">theme_wsj</span>())</a>
<a class="sourceLine" id="cb299-7" data-line-number="7"/>
<a class="sourceLine" id="cb299-8" data-line-number="8">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.6</span>)),</a>
<a class="sourceLine" id="cb299-9" data-line-number="9">           <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.35</span>)),</a>
<a class="sourceLine" id="cb299-10" data-line-number="10">           <span class="dt">plot.caption =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.35</span>)),</a>
<a class="sourceLine" id="cb299-11" data-line-number="11">           <span class="dt">legend.position =</span> <span class="st">"top"</span>)</a></code></pre>
<div class="figure fullwidth"><span id="fig:ch-08-themes-01"/>
<img src="../Images/ab8f017f9573b6a2a8f4fccd5f904f0b.png" alt="Economist and WSJ themes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-themes-01-1.png"/><img src="../Images/df968bfc94cb62255656f67337d4b654.png" alt="Economist and WSJ themes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-themes-01-2.png"/>
<p class="caption marginnote shownote">
Figure 8.14: Economist and WSJ themes.
</p>
</div>
<p>Generally speaking, themes with colored backgrounds customized
typefaces are best used when making one-off graphics or posters, when
preparing figures to integrate into a slide presentation, or when
conforming to a house or editorial style for publication. Take care to
consider how the choices you make will harmonize with the broader
printed or displayed material. Just as with the choice of palettes for
aesthetic mappings, when starting out it can be wisest to stick to the
defaults or consistently use a theme that has had its kinks already
ironed out. Claus<label for="tufte-mn-83" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-83" class="margin-toggle"/><span class="marginnote shownote">It also contains some convenience functions for laying out several plot objects in a single figure, amongst other features, as we shall see below in one of the case studies.</span> O. Wilke’s <code>cowplot</code> package, for instance, contains
a well-developed theme suitable for figures whose final destination is
a journal article. Bob Rudis’s <code>hrbrthemes</code> package,
meanwhile, has a distinctive and compact look and feel that takes
advantage of some freely-available typefaces. Both are available via
<code>install.packages()</code>.</p>
<p>The <code>theme()</code> function allows you to exert very fine-grained control
over the appearance of all kinds of text and graphical elements in a
plot. For example, we can change the color, typeface, and font weight
of text. If you have been following along writing your code, you will
have noticed that the plots you make have not been identical to the
ones shown in the text. The axis labels are in a slightly different
place from the default, the typeface is different, and there are other
smaller changes as well. The <code>theme_book()</code> function provides the
custom ggplot theme used throughout this book. The code for this theme
is based substantially on Bob Rudis’s <code>theme_ipsum()</code>, from his
<code>hrbrthemes</code> library. You can learn more about it in the Appendix. For
this one figure, we then adjust that theme even further by tweaking
the text size, and we also remove a number of elements by naming them
and making them disappear using <code>element_blank()</code>.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" data-line-number="1">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb300-2" data-line-number="2"/>
<a class="sourceLine" id="cb300-3" data-line-number="3">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb300-4" data-line-number="4">           <span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb300-5" data-line-number="5">                                     <span class="dt">lineheight=</span>.<span class="dv">5</span>,</a>
<a class="sourceLine" id="cb300-6" data-line-number="6">                                     <span class="dt">family=</span><span class="st">"Times"</span>,</a>
<a class="sourceLine" id="cb300-7" data-line-number="7">                                     <span class="dt">face=</span><span class="st">"bold.italic"</span>,</a>
<a class="sourceLine" id="cb300-8" data-line-number="8">                                     <span class="dt">colour=</span><span class="st">"orange"</span>),</a>
<a class="sourceLine" id="cb300-9" data-line-number="9">           <span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.1</span>),</a>
<a class="sourceLine" id="cb300-10" data-line-number="10">                                      <span class="dt">family=</span><span class="st">"Courier"</span>,</a>
<a class="sourceLine" id="cb300-11" data-line-number="11">                                      <span class="dt">face=</span><span class="st">"bold"</span>,</a>
<a class="sourceLine" id="cb300-12" data-line-number="12">                                      <span class="dt">color=</span><span class="st">"purple"</span>))</a></code></pre>
<div class="figure"><span id="fig:ch-08-theme-control"/>
<p class="caption marginnote shownote">
Figure 8.15: Controlling various theme elements directly.
</p>
<img src="../Images/b4563017d3271a4c1c7bc52779257207.png" alt="Controlling various theme elements directly." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-theme-control-1.png"/><img src="../Images/61c6d3a3a7750aab6846105026864eaa.png" alt="Controlling various theme elements directly." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-theme-control-2.png"/>
</div>
</div>
<div id="use-theme-elements-in-a-substantive-way" class="section level2">
<h2><span class="header-section-number">8.4</span> Use theme elements in a substantive way</h2>
<p>It makes good sense use themes as a way to fix design elements,
because that means you can subsequently ignore them, and focus instead
on the data you are examining. But it is also worth remembering that
ggplot’s theme system is very flexible. It permits a wide range of
design elements to be adjusted in order to create custom figures. For
instance, following an example from <span class="citation">Wehrwein (2017)</span>, we will
create an effective small multiple of the age distribution of GSS
respondents over the years. The <code>gss_lon</code> data contains information on
the age of each GSS respondent for all the years in the survey since
1972. The base of the figure is a scaled <code>geom_density()</code> layer of the
sort we saw earlier, this time faceted by the <code>year</code> variable. We will
fill the density curves with a dark grey color, and then add an
indicator of the mean age in each year, and a text layer for the
label. With those in place we then adjust the detail of several theme
elements, mostly to remove them. As before we use <code>element_text()</code> to
tweak the appearance of various text elements such as titles and
labels. And we also use <code>element_blank()</code> to remove several of them
altogether.</p>
<p>First, we need to calculate the mean age of the respondents for each
year of interest. Because the GSS has been around for most (but not
all) years since 1972, we will look at distributions about every four
years since the beginning. We use a short pipeline to extract the
average ages.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" data-line-number="1">yrs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">1972</span>, <span class="dv">1988</span>, <span class="dv">4</span>), <span class="dv">1993</span>, <span class="kw">seq</span>(<span class="dv">1996</span>, <span class="dv">2016</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb301-2" data-line-number="2"/>
<a class="sourceLine" id="cb301-3" data-line-number="3">mean_age &lt;-<span class="st"> </span>gss_lon <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(age <span class="op">%nin%</span><span class="st"> </span><span class="ot">NA</span> <span class="op">&amp;&amp;</span><span class="st"> </span>year <span class="op">%in%</span><span class="st"> </span>yrs) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-5" data-line-number="5"><span class="st">    </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-6" data-line-number="6"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">xbar =</span> <span class="kw">round</span>(<span class="kw">mean</span>(age, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb301-7" data-line-number="7">mean_age<span class="op">$</span>y &lt;-<span class="st"> </span><span class="fl">0.3</span></a>
<a class="sourceLine" id="cb301-8" data-line-number="8"/>
<a class="sourceLine" id="cb301-9" data-line-number="9">yr_labs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">85</span>, <span class="dt">y =</span> <span class="fl">0.8</span>,</a>
<a class="sourceLine" id="cb301-10" data-line-number="10">                      <span class="dt">year =</span> yrs)</a></code></pre>
<p>The <code>y</code> column in <code>mean_age</code> will come in handy when we want to
position the age as a text label. Next, we prepare the data and set up the geoms.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(gss_lon, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> age))</a>
<a class="sourceLine" id="cb302-3" data-line-number="3"/>
<a class="sourceLine" id="cb302-4" data-line-number="4">p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> <span class="st">"gray20"</span>, <span class="dt">color =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb302-5" data-line-number="5">                       <span class="dt">alpha =</span> <span class="fl">0.9</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">y =</span> ..scaled..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> <span class="kw">subset</span>(mean_age, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-7" data-line-number="7">               <span class="kw">aes</span>(<span class="dt">xintercept =</span> xbar), <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">subset</span>(mean_age, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-9" data-line-number="9">              <span class="kw">aes</span>(<span class="dt">x =</span> xbar, <span class="dt">y =</span> y, <span class="dt">label =</span> xbar), <span class="dt">nudge_x =</span> <span class="fl">7.5</span>,</a>
<a class="sourceLine" id="cb302-10" data-line-number="10">              <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">size =</span> <span class="fl">3.5</span>, <span class="dt">hjust =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-11" data-line-number="11"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">subset</span>(yr_labs, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-12" data-line-number="12">              <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> year)) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-13" data-line-number="13"><span class="st">    </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>., <span class="dt">switch =</span> <span class="st">"y"</span>)</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-gssage-real"/>
<img src="../Images/3bb2b0837c0c5e7d37998c78f140e887.png" alt="A customized small multiple." width="90%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-gssage-real-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.16: A customized small multiple.<!--</p>-->
<!--</div>--></span>
</p>
<p>The initial <code>p</code> object subsets the data by the years we have chosen,
and maps <code>x</code> to the <code>age</code> variable. The <code>geom_density()</code> call is the
base layer, with arguments to turn off its default line color, set the
fill to a shade of gray, and scale the y-axis between zero and one.</p>
<p>Using our summarized dataset, the <code>geom_vline()</code> layer draws a vertical
white line at the mean age of the distribution. The first of two text
geoms label the age line (in white). The first <code>geom_text()</code> call uses
a <code>nudge</code> argument to push the label slightly to the right of its
x-value. The second labels the year. We do this because we are about
to turn off the usual facet labels to make the plot more compact.
Finally we use <code>facet_grid()</code> to break out the age distributions by
year. We use the <code>switch</code> argument to move the labels to the left.</p>
<p>With the structure of the plot in place, we then style the elements in
the way that we want, using a series of instructions to <code>theme()</code>.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" data-line-number="1">p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme_book</span>(<span class="dt">base_size =</span> <span class="dv">10</span>, <span class="dt">plot_title_size =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb303-2" data-line-number="2">                <span class="dt">strip_text_size =</span> <span class="dv">32</span>, <span class="dt">panel_spacing =</span> <span class="kw">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-3" data-line-number="3"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">16</span>),</a>
<a class="sourceLine" id="cb303-4" data-line-number="4">          <span class="dt">axis.text.x=</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb303-5" data-line-number="5">          <span class="dt">axis.title.y=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-6" data-line-number="6">          <span class="dt">axis.text.y=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-7" data-line-number="7">          <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-8" data-line-number="8">          <span class="dt">strip.background =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-9" data-line-number="9">          <span class="dt">strip.text.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-10" data-line-number="10">          <span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-11" data-line-number="11">          <span class="dt">panel.grid.minor =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-12" data-line-number="12"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Age"</span>,</a>
<a class="sourceLine" id="cb303-13" data-line-number="13">         <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb303-14" data-line-number="14">         <span class="dt">title =</span> <span class="st">"Age Distribution of</span><span class="ch">\n</span><span class="st">GSS Respondents"</span>)</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-ggridges-real"/>
<img src="../Images/a0991183f8eebc093027020e8391278d.png" alt="A ridgeplot version of the age distribution plot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-ggridges-real-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.17: A ridgeplot version of the age distribution plot.<!--</p>-->
<!--</div>--></span>
</p>
<p>One of the pleasing things about ggplot’s developer community is that it often takes plot ideas that are first worked out in a once-off or bespoke way and generalizes them to the point where they are available as new geoms. Shortly after writing the code for the GSS age distributions in Figure <a href="refineplots.html#fig:ch-08-gssage-real">8.16</a>, the <code>ggridges</code> package was released. Written by Claus O. Wilke, it offers a different take on small-multiple density plots by allowing the distributions to overlap vertically to interesting effect. It is especially useful for repeated distributional measures that change in a clear direction. Here we redo our previous plot using a function from <code>ggridges</code>. Because <code>geom_density_ridges()</code> makes for a more compact display we trade-off showing the mean age value for the sake of displaying the distribution for every GSS year.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" data-line-number="1"><span class="kw">library</span>(ggridges)</a>
<a class="sourceLine" id="cb304-2" data-line-number="2"/>
<a class="sourceLine" id="cb304-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gss_lon,</a>
<a class="sourceLine" id="cb304-4" data-line-number="4">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> <span class="kw">factor</span>(year, <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="kw">unique</span>(year)),</a>
<a class="sourceLine" id="cb304-5" data-line-number="5">                                     <span class="dt">ordered =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb304-6" data-line-number="6"/>
<a class="sourceLine" id="cb304-7" data-line-number="7">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density_ridges</span>(<span class="dt">alpha =</span> <span class="fl">0.6</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">scale =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-8" data-line-number="8"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-9" data-line-number="9"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb304-10" data-line-number="10"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Age"</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb304-11" data-line-number="11">         <span class="dt">title =</span> <span class="st">"Age Distribution of</span><span class="ch">\n</span><span class="st">GSS Respondents"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-12" data-line-number="12"><span class="st">    </span><span class="kw">theme_ridges</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb304-13" data-line-number="13"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">16</span>, <span class="dt">face =</span> <span class="st">"bold"</span>))</a></code></pre>
<p>The <code>expand</code> argument in <code>scale_y_discrete()</code> adjusts the scaling of the y-axis slightly. It has the effect of shortening the distance between the axis labels and the first distribution, and it also prevents the top of the very first distribution from being cut off by the frame of the plot. The package also comes with its own theme, <code>theme_ridges()</code> that adjusts the labels so that they are aligned properly, and we use it here. The <code>geom_density_ridges()</code> function is also capable of reproducing the look of our original version. The degree of overlap in the distributions is controlled by the <code>scale</code> argument in the geom. You can experiment with setting it to values below or above one to see the effects on the layout of the plot.</p>
<p>Much more detailed information on the names of the various elements
you can control via <code>theme()</code> can be found in the ggplot documentation.
Setting these thematic elements in an ad hoc way is often one of the
first things people want to do when they make plot. But in practice,
apart from getting the overall size and scale of your plot squared
away, making small adjustments to theme elements should be the very
last thing you do in the plotting process. Ideally, once you have set
up a theme that works well for you, it should be something you
can avoid having to do at all.</p>
</div>
<div id="case-studies" class="section level2">
<h2><span class="header-section-number">8.5</span> Case studies</h2>
<p>Bad graphics are everywhere. Better ones are within our reach. For
the final few sections of this chapter we will work through a few
common visualization problems or dilemmas, as seen through some
real-life cases. In each case we will look at the original figures and
redraw them in new (and better) versions. In the process we will
introduce a few new functions and features of ggplot that we have not
seen yet. This, too, is true to life. Usually, it’s having to face
some practical design or visualization question that forces us to
ferret out the solution to our problem in the documentation, or come
up with some alternative answer on the fly ourselves. Let’s start with
a common case: the use of dual axes in trend plots.</p>
<div id="two-y-axes" class="section level3">
<h3><span class="header-section-number">8.5.1</span> Two y-axes</h3>
<p>In January of 2016, Liz Ann Sonders, Chief Investment Strategist with
Charles Schwab, Inc, tweeted about the apparent correlation between
two economic time series: the Standard and Poor’s 500 stock market
index, and the Monetary Base, a measure of the size of money supply.
The S&amp;P is an index that ranges from about 700 to about 2,100 over the
period of interest (about the last seven years). The Monetary Base
ranges from about 1.5 trillion to 4.1 trillion dollars over the same
period. This means that we can’t plot the two series directly. The
Monetary Base is so much larger that it would meake the S&amp;P 500 series
appear as a flat line at the bottom. While there are several
reasonable ways to address this, people often opt instead to have two
y-axes.</p>
<p>Because it is designed by responsible people, R makes it slightly
tricky to draw graphs with two y-axes. In fact, ggplot rules it out of
order altogether. It is possible to do it using R’s base graphics, if
you insist. Figure <a href="refineplots.html#fig:fred1">8.18</a> shows the result. I will not show
the code here. (You can find it at
<code>https://github.com/kjhealy/two-y-axes</code>.) This is partly because
graphics in base R work very differently from the approach we have
taken throughout this book, so it would just be confusing, and partly
because I do not wish to encourage young people to engage in immoral
acts.</p>
<div class="figure"><span id="fig:fred1"/>
<p class="caption marginnote shownote">
Figure 8.18: Two time series, each with its own y-axis.
</p>
<img src="../Images/041e16ecc2c41f412ffcfe78d4e8ff60.png" alt="Two time series, each with its own y-axis." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred1-1.png"/>
</div>
<p>Most of the time when people draw plots with two y-axes they want to line the series up as closely as possible because they suspect that there’s a substantive association between them, as in this case. The main problem with using two y-axes is that it makes it even easier than usual to fool yourself (or someone else) about the degree of association between the variables. This is because you can adjust the scaling of the axes to relative to one another in way that moves the data series around more or less however you like. For the first half of the graph in Figure <a href="refineplots.html#fig:fred1">8.18</a>, the red Monetary Base line tracks below the blue S&amp;P 500 and is above it for the second half.</p>
<div class="figure"><span id="fig:fred2"/>
<p class="caption marginnote shownote">
Figure 8.19: Variations on two y-axes.
</p>
<img src="../Images/34c65eccc31a8958f15c5cff04bb3f4e.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-1.png"/><img src="../Images/d408a2bf9b1a7abba25ddf5e49458a84.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-2.png"/>
</div>
<p>We can “fix” that by deciding to start the second y-axis at zero, which shifts the Monetary Base line above the S&amp;P line for the first half of the series and below it later on. The first panel in Figure <a href="refineplots.html#fig:fred2">8.19</a> shows the results. The second panel, meanwhile, adjusts the axes so that the axis tracking the S&amp;P starts at zero. The axis tracking the Monetary Base starts around its minimum (as is generally good practice), but now both axes max out around 4,000. The units are different, of course. The 4,000 on the S&amp;P side is an index number, while the Monetary Base number is 4,000 billion dollars. The effect is to flatten out the S&amp;P’s apparent growth quite a bit, muting the association between the two variables substantially. You could tell quite a different story with this one, if you felt like it.</p>
<p>How else might we draw this data? We could use a split- or broken-axis plot to show the two series at the same time. These can be effective sometimes, and they seem to have better perceptual properties than overlayed charts with dual axes <span class="citation">(Isenberg, Bezerianos, Dragicevic, &amp; Fekete, 2011)</span>. They are most useful in cases where the series you are plotting are of the same kind, but of very different magnitudes. That is not the case here.</p>
<p>Another compromise, if the series are not in the same units (or of widely differing magnitudes), is to rescale one of the series (e.g., by dividing or multiplying it by a thousand), or alternatively to index each of them to 100 at the start of the first period, and then plot them both. Index numbers can have complications of their own, but here they allow us use one axis instead of two, and also to calculate a sensible difference between the two series and plot that as well, in a panel below. It can be quite tricky to visually estimate the difference between series, in part because our perceptual tendency is to look for the <em>nearest</em> comparison point in the other series rather than the one directly above or below. Following <span class="citation">Cleveland (1994)</span>, we can also add a panel underneath that tracks the running difference between the two series. We begin by making each plot and storing them in an object. To do this, it will be convenient to fully tidy the data in to a long format, with the indexed series in the key variable and their corresponding scores as the values. We use tidyr’s <code>gather()</code> function for this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1"><span class="kw">head</span>(fredts)</a></code></pre>
<pre><code>##         date  sp500 monbase sp500_i monbase_i
## 1 2009-03-11 696.68 1542228 100.000   100.000
## 2 2009-03-18 766.73 1693133 110.055   109.785
## 3 2009-03-25 799.10 1693133 114.701   109.785
## 4 2009-04-01 809.06 1733017 116.131   112.371
## 5 2009-04-08 830.61 1733017 119.224   112.371
## 6 2009-04-15 852.21 1789878 122.324   116.058</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1">fredts_m &lt;-<span class="st"> </span>fredts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(date, sp500_i, monbase_i) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> series, <span class="dt">value =</span> score, sp500_i<span class="op">:</span>monbase_i)</a>
<a class="sourceLine" id="cb307-3" data-line-number="3"/>
<a class="sourceLine" id="cb307-4" data-line-number="4"><span class="kw">head</span>(fredts_m)</a></code></pre>
<pre><code>##         date  series   score
## 1 2009-03-11 sp500_i 100.000
## 2 2009-03-18 sp500_i 110.055
## 3 2009-03-25 sp500_i 114.701
## 4 2009-04-01 sp500_i 116.131
## 5 2009-04-08 sp500_i 119.224
## 6 2009-04-15 sp500_i 122.324</code></pre>
<p>Once the data are tidied in this way we can make our graph.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts_m,</a>
<a class="sourceLine" id="cb309-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> score,</a>
<a class="sourceLine" id="cb309-3" data-line-number="3">                          <span class="dt">group =</span> series,</a>
<a class="sourceLine" id="cb309-4" data-line-number="4">                          <span class="dt">color =</span> series))</a>
<a class="sourceLine" id="cb309-5" data-line-number="5">p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb309-6" data-line-number="6"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-7" data-line-number="7">         <span class="dt">y =</span> <span class="st">"Index"</span>,</a>
<a class="sourceLine" id="cb309-8" data-line-number="8">         <span class="dt">color =</span> <span class="st">"Series"</span>)</a>
<a class="sourceLine" id="cb309-9" data-line-number="9"/>
<a class="sourceLine" id="cb309-10" data-line-number="10">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts,</a>
<a class="sourceLine" id="cb309-11" data-line-number="11">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> sp500_i <span class="op">-</span><span class="st"> </span>monbase_i))</a>
<a class="sourceLine" id="cb309-12" data-line-number="12"/>
<a class="sourceLine" id="cb309-13" data-line-number="13">p2 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-14" data-line-number="14"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-15" data-line-number="15">         <span class="dt">y =</span> <span class="st">"Difference"</span>)</a></code></pre>
<p>Now we have our two plots, we want to lay them out nicely. We do not want them to appear in the same plot area, but we do want to compare them. It would be possible to do this with a facet, but that would mean doing a fair amount of data munging to get all three series (the two indices and the difference between them) into the same tidy data frame. An alternative is to make two separate plots and then arrange them just as we like. For instance, have the comparison of the two series take up most of the space, and put the plot of the index differences along the bottom in a smaller area.</p>
<p>The layout engine used by R and ggplot, called <code>grid</code>, does make this possible. It controls the layout and positioning of plot areas and objects at a lower level than ggplot. Programming <code>grid</code> layouts directly takes a little more work than using ggplot’s functions alone. Fortunately, there are some helper libraries that we can use to make things easier. One possibility is to use the <code>gridExtra</code> library. It provides a number of useful functions that let us talk to the grid engine, including <code>grid.arrange()</code>. This function takes a list of plot objects and instructions for how we would like them arranged. The <code>cowplot</code> library we mentioned earlier makes things even easier. It has a <code>plot_grid()</code> function that works much like <code>grid.arrange()</code> while also taking care of some fine details, including the proper alignment of axes across separate plot objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1">cowplot<span class="op">::</span><span class="kw">plot_grid</span>(p1, p2, <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>), <span class="dt">align =</span> <span class="st">"v"</span>)</a></code></pre>
<div class="figure"><span id="fig:fred5"/>
<p class="caption marginnote shownote">
Figure 8.20: Indexed series with a running difference below, using two separate plots.
</p>
<img src="../Images/8f934f33988b58c7b94664bebcd54e6e.png" alt="Indexed series with a running difference below, using two separate plots." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred5-1.png"/>
</div>
<p>The result is shown in Figure <a href="refineplots.html#fig:fred5">8.20</a>. It looks pretty good. In this version, the S&amp;P index runs above the Monetary Base for almost the whole series, whereas in the plot as originally drawn, they crossed.</p>
<p>The broader problem with dual-axis plots of this sort is that the apparent association between these variables is probably spurious. The original plot is enabling our desire to spot patterns, but substantively it is probably the case that both of these time series are tending to increase, but are not otherwise related in any deep way. If we were interested in establishing the true association between them, we might begin by naively regressing one on the other. We can try to predict the S&amp;P Index from the Monetary Base, for instance. If we do that, things look absolutely fantastic to begin with, as we appear to explain about 95% of the variance in the S&amp;P just by knowing the size of the Monetary Base from the same period. We’re going to be rich!</p>
<p>Sadly, we’re probably not going to be rich. While everyone knows that correlation is not causation, with time series data we get this problem twice-over. Even just considering a single series, each observation is often pretty closely correlated with the observation in the period immediately before it, or perhaps with the observation some regular number of periods before it. A time series might have a seasonal component that we would want to account for before making claims about its growth, for example. And if we ask what <em>predicts</em> its growth, then we will introduce some other time series, which will have trend properties of its own. In those circumstances, we more or less automatically violate the assumptions of ordinary regression analysis in a way that produces wildly overconfident estimates of association. The result, which may seem paradoxical when you first run across it, is that a lot of the machinery of time series analysis is about making the serial nature of the data go away.</p>
<p>Like any rule of thumb, it is possible to come up with exceptions, or talk oneself into them. We can imagine situations where the judicious use of dual y-axes might be a sensible way to present data to others, or might help a researcher productively explore a dataset. But in general I recommend against it because is already much too easy to present spurious, or at least overconfident, associations, especially with time series data. Scatterplots can do that just fine. Even with a single series, as we saw back in Chapter <a href="lookatdata.html#lookatdata">1</a>, we can make associations look steeper or flatter by fiddling with the aspect ratio. Using two y-axes gives you an extra degree of freedom to mess about with the data that, in most cases, you really should not take advantage of. A rule like this will not stop people who want to fool you with charts from trying, of course. But it might help you not fool yourself.</p>
</div>
<div id="redrawing-a-bad-slide" class="section level3">
<h3><span class="header-section-number">8.5.2</span> Redrawing a bad slide</h3>
<p>In late 2015, Marissa Mayer’s performance as CEO of Yahoo was being
criticized by many observers. One of them, Eric Jackson, an investment
fund manager, sent a 99-slide presentation to Yahoo’s board outlining
his best case against Mayer. (He also circulated it publicly.) The
style of the slides was typical of business presentations. Slides and
posters are a very useful means of communication. In my experience,
most people who complain about “Death by PowerPoint” have not sat
through enough talks where the presenter hasn’t even bothered to
prepare slides. But it is striking to see how fully the “slide deck”
has escaped its origins as an aid to communication and metastasized
into a freestanding quasi-format of its own. Business, the Military,
and Academia have all been infected by this tendency in various ways.
Never mind taking the time to write a memo or an article, just give us
endless pages of bullet points and charts. The disorienting effect is
of constant summaries of discussions that never took place.</p>
<div class="figure"><span id="fig:ch-08-yahoo-01"/>
<p class="caption marginnote shownote">
Figure 8.21: A bad slide.
</p>
<img src="../Images/bd5cbfa3fb2d27914de43e5af45d1905.png" alt="A bad slide." width="100%" data-original-src="https://socviz.co/assets/ch-08-yahoo-employees-revenue-0.jpg"/>
</div>
<p>In any case, Figure <a href="refineplots.html#fig:ch-08-yahoo-01">8.21</a> reproduces a typical slide from
the deck. It seems to want to say something about the relationship
between Yahoo’s number of employees and its revenue, in the context of
Mayer’s tenure as CEO. The natural thing to do would be to make some
kind of scatterplot to see if there was a relationship between these
variables. Instead, however, the slide puts time on the x-axis and
uses two y-axes to show the employee and revenue data. It plots the
revenues as a bar chart and the employee data as points connected by
slightly wavy lines. At first glance, it is not clear whether the
connecting line segments are just manually added or if there’s some
principle underlying the wiggles. (They turn out to have been created
in Excel.) The revenue values are used as labels within the bars. The
points are not labeled. Employee data goes to 2015 but revenue data
only to 2014. An arrow points to the date Mayer was hired as CEO, and
a red dotted line seems to indicate … actually I’m not sure. Maybe
some sort of threshold below which employee numbers should fall? Or
maybe just the last observed value, to allow comparison across the
series? It isn’t clear. Finally, notice that while the revenue numbers
are annual, there is more than one observation per year for some of
the later employee numbers.</p>
<p>How should we redraw this chart? Let’s focus on getting across the
relationship between employee numbers and revenue, as that seems to be
the motivation for it in the first place. As a secondary element, we
want to say something about Mayer’s role in this relationship. The
original sin of the slide is that it plots two series of numbers using
two different y-axes, as discussed above. We see this from business
analysts more often than not. Time is almost the only thing they
ever put on the x-axis.</p>
<p>To redraw the chart I took the numbers from the bars on the chart
together with employee data from QZ.com. Where there was quarterly
data in the slide, I used the end-of-year number for employees, except
for 2012. Mayer was appointed in July of 2012. Ideally we would have
quarterly revenue and quarterly employee data for all years, but given
that we do not, the most sensible thing to do is to keep things
annualized except for the one year of interest, when Mayer arrives as
CEO. It’s worth doing this because otherwise the large round of
layoffs that immediately preceded her arrival would be misattributed
to her tenure as CEO. The upshot is that we have two observations for
2012 in the dataset. They have the same revenue data but different
employee numbers. The figures can be found in the <code>yahoo</code> dataset.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" data-line-number="1"><span class="kw">head</span>(yahoo)</a></code></pre>
<pre><code>##   Year Revenue Employees Mayer
## 1 2004    3574      7600    No
## 2 2005    5257      9800    No
## 3 2006    6425     11400    No
## 4 2007    6969     14300    No
## 5 2008    7208     13600    No
## 6 2009    6460     13900    No</code></pre>
<p>The redrawing is straightforward. We could just draw a scatterplot and
color the points by whether Mayer was CEO at the time. By now you
should know how to do this quite easily. We can take a small step
further by making a scatterplot but also holding on to the temporal
element beloved of business analysts. We can use <code>geom_path()</code> and use
use line segments to “join the dots” of the yearly observations in
order, labeling each point with its year. The result is a plot that
shows the trajectory of the company over time, like a snail moving
across a flagstone. Again, bear in mind that we have two observations
for 2012.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-yahoo-02"/>
<img src="../Images/26956686ec141c73db47f554f76c6922.png" alt="Redrawing as a connected scatterplot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.22: Redrawing as a connected scatterplot.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb313-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Employees, <span class="dt">y =</span> Revenue))</a>
<a class="sourceLine" id="cb313-3" data-line-number="3">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">color =</span> Mayer, <span class="dt">label =</span> Year),</a>
<a class="sourceLine" id="cb313-5" data-line-number="5">              <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">fontface =</span> <span class="st">"bold"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-6" data-line-number="6"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-7" data-line-number="7"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"Mayer is CEO"</span>,</a>
<a class="sourceLine" id="cb313-8" data-line-number="8">         <span class="dt">x =</span> <span class="st">"Employees"</span>, <span class="dt">y =</span> <span class="st">"Revenue (Millions)"</span>,</a>
<a class="sourceLine" id="cb313-9" data-line-number="9">         <span class="dt">title =</span> <span class="st">"Yahoo Employees vs Revenues, 2004-2014"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-11" data-line-number="11"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>comma)</a></code></pre>
<p>This way of looking at the data suggests that Mayer was appointed
after a period of falling revenues and just following a very large
round of layoffs, a fairly common pattern with the leadership of large
firms. Since then, either through new hires or acquisitions, employee
numbers have crept back up a little while revenues have continued to
fall. This version conveys what the original slide was trying to get
across, but rather more clearly.</p>
<p>Alternatively, we can keep the analyst community happy by putting time
back on the x-axis and plotting the ratio of revenue to employees on
the y-axis. This gives us the linear time-trend trend back, only in a
more sensible fashion. We begin the plot by using <code>geom_vline()</code> to add
a vertical line marking Mayer’s accession to the CEO position.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb314-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Year, <span class="dt">y =</span> Revenue<span class="op">/</span>Employees))</a>
<a class="sourceLine" id="cb314-3" data-line-number="3"/>
<a class="sourceLine" id="cb314-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">2012</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">"gray60"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-6" data-line-number="6"><span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="dv">2013</span>, <span class="dt">y =</span> <span class="fl">0.44</span>,</a>
<a class="sourceLine" id="cb314-7" data-line-number="7">             <span class="dt">label =</span> <span class="st">" Mayer becomes CEO"</span>, <span class="dt">size =</span> <span class="fl">2.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-8" data-line-number="8"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Year</span><span class="ch">\n</span><span class="st">"</span>,</a>
<a class="sourceLine" id="cb314-9" data-line-number="9">         <span class="dt">y =</span> <span class="st">"Revenue/Employees"</span>,</a>
<a class="sourceLine" id="cb314-10" data-line-number="10">         <span class="dt">title =</span> <span class="st">"Yahoo Revenue to Employee Ratio, 2004-2014"</span>)</a></code></pre>
<div class="figure"><span id="fig:ch-08-yahoo-03"/>
<p class="caption marginnote shownote">
Figure 8.23: Plotting the ratio of revenue to employees against time.
</p>
<img src="../Images/5d7979ef42e6e8822633d6ff39e4b879.png" alt="Plotting the ratio of revenue to employees against time." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-03-1.png"/>
</div>
</div>
<div id="saying-no-to-pie" class="section level3">
<h3><span class="header-section-number">8.5.3</span> Saying no to pie</h3>
<p>For a third example, we turn to pie charts. Figure
<a href="refineplots.html#fig:ch-08-debt-piecharts">8.24</a> shows a pair of charts from a New York Federal
Reserve Bank briefing on the structure of debt in the United States
<span class="citation">(Chakrabarti, Haughwout, Lee, Scally, &amp; Klaauw, 2017)</span>. As we saw in Chapter <a href="lookatdata.html#lookatdata">1</a>, the perceptual qualities of pie charts are not great. In a single pie chart, it is usually harder than it should be to estimate and
compare the values shown, especially when there are more than a few
wedges and when there are a number of wedges reasonably close in size.
A Cleveland dot plot or a bar chart is usually a much more
straightforward way of comparing quantities. When comparing the wedges
between two pie charts, as in this case, the task is made harder again
as the viewer has to ping back and forth between the wedges of each
pie and the vertically oriented legend underneath.</p>
<div class="figure"><span id="fig:ch-08-debt-piecharts"/>
<p class="caption marginnote shownote">
Figure 8.24: Data on the structure of US student debts as of 2016.
</p>
<img src="../Images/bcaeddccebb00a59a13d4484637bf6ac.png" alt="Data on the structure of US student debts as of 2016." width="100%" data-original-src="https://socviz.co/assets/ch-08-debt-piecharts.png"/>
</div>
<p>There is an additional wrinkle in this case. The variable broken down
in each pie chart is not only categorical, it is also ordered from low
to high. The data describe the percent of all borrowers and the
percent of all balances divided up across the size of balances owed,
from less than five thousand dollars to more than two hundred thousand
dollars. It’s one thing to use a pie chart to display shares of an
unordered categorical variable, such as percent of total sales due to
pizza, lasanga, and risotto for example. Keeping track of ordered
categories in a pie chart is harder again, especially when we want to
make a comparison between two distributions. The wedges of these two
pie charts <em>are</em> ordered (clockwise, from the top), but it’s not so
easy to follow them. This is partly because of the pie-ness of the
chart, and partly because the color palette chosen for the categories
is not sequential. Instead it is unordered. The colors allow the debt
categories to be distinguished, but don’t pick out the sequence from
low to high values.</p>
<p>So not only is a less than ideal plot type being used here, it’s being
made to do a lot more work than usual, and with the wrong sort of
color palette. As is often the case with pie charts, the compromise
made to facilitate interpretation is to display all of the numerical
values for every wedge, and also to add a summary outside the pie. If
you find yourself having to do this, it’s worth asking whether the
chart could be redrawn, or whether you might as well just show a table
instead.</p>
<p>Here are two ways we might redraw these pie charts. As usual, neither
approach is perfect. Or rather, each approach draws attention to
features of the data in slightly different ways. Which works best
depends on what parts of the data we want to highlight. The data are
in an object called <code>studebt</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1"><span class="kw">head</span>(studebt)</a></code></pre>
<pre><code>## # A tibble: 6 x 4
##   Debt     type        pct Debtrc  
##   &lt;ord&gt;    &lt;fct&gt;     &lt;int&gt; &lt;ord&gt;   
## 1 Under $5 Borrowers    20 Under $5
## 2 $5-$10   Borrowers    17 $5-$10  
## 3 $10-$25  Borrowers    28 $10-$25 
## 4 $25-$50  Borrowers    19 $25-$50 
## 5 $50-$75  Borrowers     8 $50-$75 
## 6 $75-$100 Borrowers     3 $75-$100</code></pre>
<p>Our first effort to redraw the pie charts uses a faceted comparison of
the two distributions. We set up some labels in advance, as we
will reuse them. We also make a special label for the facets.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" data-line-number="1">p_xlab &lt;-<span class="st"> "Amount Owed, in thousands of Dollars"</span></a>
<a class="sourceLine" id="cb317-2" data-line-number="2">p_title &lt;-<span class="st"> "Outstanding Student Loans"</span></a>
<a class="sourceLine" id="cb317-3" data-line-number="3">p_subtitle &lt;-<span class="st"> "44 million borrowers owe a total of $1.3 trillion"</span></a>
<a class="sourceLine" id="cb317-4" data-line-number="4">p_caption &lt;-<span class="st"> "Source: FRB NY"</span></a>
<a class="sourceLine" id="cb317-5" data-line-number="5"/>
<a class="sourceLine" id="cb317-6" data-line-number="6">f_labs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">Borrowers</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Borrowers"</span>,</a>
<a class="sourceLine" id="cb317-7" data-line-number="7">            <span class="st">`</span><span class="dt">Balances</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Balances"</span>)</a>
<a class="sourceLine" id="cb317-8" data-line-number="8"/>
<a class="sourceLine" id="cb317-9" data-line-number="9">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> studebt,</a>
<a class="sourceLine" id="cb317-10" data-line-number="10">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Debt, <span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">fill =</span> type))</a>
<a class="sourceLine" id="cb317-11" data-line-number="11">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-12" data-line-number="12"><span class="st">    </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Dark2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-14" data-line-number="14"><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-15" data-line-number="15"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">strip.text.x =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-16" data-line-number="16"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">x =</span> p_xlab,</a>
<a class="sourceLine" id="cb317-17" data-line-number="17">      <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb317-18" data-line-number="18">      <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb317-19" data-line-number="19">      <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-20" data-line-number="20"><span class="st">    </span><span class="kw">facet_grid</span>(<span class="op">~</span><span class="st"> </span>type, <span class="dt">labeller =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-21" data-line-number="21"><span class="st">    </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure"><span id="fig:ch-08-studentpie-02"/>
<p class="caption marginnote shownote">
Figure 8.25: Faceting the pie charts.
</p>
<img src="../Images/dfb0b1e2d3bda96ec812ca103da70fe5.png" alt="Faceting the pie charts." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-02-1.png"/>
</div>
<p>There is a reasonable amount of customization in this graph. First,
the text of the facets is made bold in the <code>theme()</code> call. The graphical element is first named (<code>strip.text.x</code>) and then modified using the <code>element_text()</code> function. We also use a custom palette for the <code>fill</code> mapping, via <code>scale_fill_brewer()</code>. And finally we relabel the facets to something more informative than their bare
variable names. This is done using the <code>labeller</code> argument and the
<code>as_labeller()</code> function inside the <code>facet_grid()</code> call. At the
beginning of the plotting code, we set up an object called <code>f_labs</code>,
which is in effect a tiny data frame that associates new labels with
the values of the <code>type</code> variable in <code>studebt</code>. We use backticks (the angled quote character located next to the ‘1’ key on US keyboards) to pick out the values we want to relabel. The <code>as_labeller()</code> function takes this object and uses it to create new
text for the labels when <code>facet_grid()</code> is called.</p>
<p>Substantively, how is this plot better than the pie charts? We split
the data into the two categories, and showed the percentage shares as
bars. The percent scores are on the x-axis. Instead of using color to
distinguish the debt categories, we put their values on the y-axis
instead. This means we can compare within a category just by looking
down the bars. For instance, the left-hand panel shows that almost a
fifth of the 44 million people with student debt owe less than five
thousand dollars. Comparisons across categories are now easier as
well, as we can scan across a row to see, for instance, that while
just one percent or so of borrowers have more than $200,000 in debt,
that category accounts for more than 10 percent of all debts.</p>
<p>We could also have made this bar chart by putting the percentages on
the y-axis and the categories of amount owed on the x-axis. When the
categorical axis labels are long, though, I generally find it’s easier
to read them on the y-axis. Finally, while it looks nice and helps a
little to have the two categories of debt distinguished by color, the
colors on the graph are not encoding or mapping any information in the
data that is not already taken care of by the faceting. The <code>fill</code>
mapping is useful, but also redundant. This graph could easily
be in black and white, and would be just as informative if it were.</p>
<p>One thing that is not emphasized in a faceted chart like this is the
idea that each of the debt categories is a share or percentage of a
total amount. That is what a pie chart emphasizes more than anything,
but as we saw there’s a perceptual price to pay for that, especially
when the categories are ordered. But maybe we can hang on to the
emphasis on shares by using a different kind of barplot. Instead of
having separate bars distinguished by heights, we can array the
percentages for each distribution proportionally within a single bar.
We will make a stacked bar chart with just two main bars, and lie them
on their side for comparison.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb318-2" data-line-number="2"/>
<a class="sourceLine" id="cb318-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(studebt, <span class="kw">aes</span>(<span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">x =</span> type, <span class="dt">fill =</span> Debtrc))</a>
<a class="sourceLine" id="cb318-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">labels =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_fill_viridis</span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-8" data-line-number="8"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb318-9" data-line-number="9">                             <span class="dt">title.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-10" data-line-number="10">                             <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</a>
<a class="sourceLine" id="cb318-11" data-line-number="11">                             <span class="dt">keywidth =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb318-12" data-line-number="12">                             <span class="dt">nrow =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb318-14" data-line-number="14">       <span class="dt">fill =</span> <span class="st">"Amount Owed, in thousands of dollars"</span>,</a>
<a class="sourceLine" id="cb318-15" data-line-number="15">       <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb318-16" data-line-number="16">       <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb318-17" data-line-number="17">       <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-19" data-line-number="19">        <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb318-20" data-line-number="20">        <span class="dt">axis.ticks.length =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>),</a>
<a class="sourceLine" id="cb318-21" data-line-number="21">        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-22" data-line-number="22"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure fullwidth"><span id="fig:ch-08-studentpie-03"/>
<img src="../Images/54c15204088e48153d413d8d0635e9c0.png" alt="Debt distributions as horizontally segmented bars." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-03-1.png"/>
<p class="caption marginnote shownote">
Figure 8.26: Debt distributions as horizontally segmented bars.
</p>
</div>
<p>Once again, there is a substantial amount of customization in this
chart. I encourage you to peel it back one option at a time to see how
it changes. We use the <code>as_labeller()</code> with <code>f_labs</code> again, but in the
labels for the x-axis this time. We make a series of adjustments in the <code>theme()</code> call to customize the purely visual elements of the plot, making the y-axis labels larger, right-justified, and bold via <code>element_text()</code>; removing the axis tick marks, and also removing the y-axis grid lines via <code>element_blank()</code>.</p>
<p>More substantively, we take a lot of care about color in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a>. First, we set the border colors of the bars to
a light gray in <code>geom_bar()</code> to make the bar segments easier to
distinguish. Second, we draw on the <code>viridis</code> library again (as we did with our small-multiple maps in Chapter 7), using
<code>scale_fill_viridis()</code> for the color palette. Third, we are careful to map the income
categories in an ascending sequence of colors, and to adjust
the key so that the values run from low to high, from left to right,
and from yellow to purple. This is done partly by switching the <code>fill</code>
mapping from <code>Debt</code> to <code>Debtrc</code>. The categories of the latter are the
same as the former, but the sequence of income levels is coded in the
order we want. We also show the legend to the reader <em>first</em> by putting
it at the top, under the title and subtitle.</p>
<p>The rest of the work is done in the <code>guides()</code> call. We have not used
<code>guides()</code> much thus far except to turn off legends that we did not
want to display. But here we see its usefulness. We give <code>guides()</code> a
series of instructions about the <code>fill</code> mapping: reverse<label for="tufte-mn-84" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-84" class="margin-toggle"/><span class="marginnote shownote"><code>reverse = TRUE</code></span> the direction of the color coding; put<label for="tufte-mn-85" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-85" class="margin-toggle"/><span class="marginnote shownote"><code>title.position</code></span> the legend
title above the key; put<label for="tufte-mn-86" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-86" class="margin-toggle"/><span class="marginnote shownote"><code>label.position</code></span> the labels for the colors below the key; widen<label for="tufte-mn-87" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-87" class="margin-toggle"/><span class="marginnote shownote"><code>keywidth</code></span> the width of the color boxes a little, and place<label for="tufte-mn-88" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-88" class="margin-toggle"/><span class="marginnote shownote"><code>nrow</code></span> the whole key on a single row.</p>
<p>This is a lot of work, relatively speaking, but if you don’t do it the
plot will be much harder to read. Again, I encourage you to peel away
the layers and options in sequence to see how the plot changes. The version in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a> lets us more easily see how the
categories of dollar amounts owed break down as a percentage of all
balances, and as a percent of all borrowers. We can also eyeball
comparisons between the two types, especially at the far end of each
scale. It’s easy to see how a tiny percentage of borrowers account for
a disproportionately large share of total debt, for example. But even
with all of this careful work, estimating the size of each individual
segment is still not as easy here as it is in Figure
<a href="refineplots.html#fig:ch-08-studentpie-02">8.25</a>, the faceted version. This is because it’s harder to
estimate sizes when we don’t have an anchor point or baseline scale to
compare each piece to. (In the faceted plot, that comparison point was
the x-axis.) So the size of the “Under 5” segment in the bottom bar is
much easier to estimate than the size of the “$10-25” bar, for
instance. Our injunction to take care about using stacked bar charts
still has a lot of force, even when we try hard to make the best of
them.</p>
</div>
</div>
<div id="where-to-go-next-7" class="section level2">
<h2><span class="header-section-number">8.6</span> Where to go next</h2>
<p>We have reached the end of our introduction. From here on, you should be in a strong position to forge ahead in two main ways. The first is to become more confident and practised with your coding. Learning ggplot should encourage you to learn more about the set of tidyverse tools, and then by extension to learn more about R in general. What you choose to pursue will (and should) be driven by your own needs and interests as a scholar or data scientist. The most natural text to look at next is Garrett Grolemund<label for="tufte-mn-89" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-89" class="margin-toggle"/><span class="marginnote shownote"><code>r4ds.had.co.nz/</code></span> and Hadley Wickham’s <em>R for Data Science</em> <span class="citation">(Wickham &amp; Grolemund, 2016)</span>, which introduces tidyverse components that we have drawn on here but not pursued in depth. Other useful texts include <span class="citation">Chang (2013)</span> and Roger<label for="tufte-mn-90" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-90" class="margin-toggle"/><span class="marginnote shownote"><code>leanpub.com/rprogramming</code></span> Peng’s <em>R Programming for Data Science</em> (2016). The most thorough introduction to ggplot in particular can be found in <span class="citation">Wickham (2016)</span>.</p>
<p>Pushing ahead to use ggplot for new kinds of graphs will eventually get you to the point where ggplot does not quite do what you need, or does not quite provide the sort of geom you want. In that case, the first place to look is the world of extensions to the ggplot framework. We have used a few extensions in the book already. Like ggrepel and ggridges, extensions typically provide a new geoms or two to work with, which may be just what you need. Sometimes, as with Thomas Lin Pedersen’s <code>ggraph</code>, you get a whole family of geoms and associated tools—in <code>ggraph</code>’s case, a suite of tidy methods for the visualization of network data. Other modeling and analysis tasks may require more custom work, or coding that is closely connected to the kind of analysis being done. <span class="citation">Harrell (2016)</span> provides many clearly worked examples, mostly based on ggplot; <span class="citation">Gelman &amp; Hill (2018)</span> and <span class="citation">(Imai, 2017)</span> also introduce contemporary methods using R; <span class="citation">(Silge &amp; Robinson, 2017)</span> present a tidy approach to analyzing and visualizing textual data; while <span class="citation">Friendly &amp; Meyer (2017)</span> thoroughly explore the analysis of discrete data, an area that is often challenging to approach visually.</p>
<p>The second way you should push ahead is by looking at and thinking about other people’s graphs. The R Graph Gallery<label for="tufte-mn-92" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-92" class="margin-toggle"/><span class="marginnote shownote"><code>r-graph-gallery.com</code></span>, run by Yan Holtz, is a useful collection of examples of many kinds of graphics drawn with ggplot and other R tools. PolicyViz<label for="tufte-mn-93" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-93" class="margin-toggle"/><span class="marginnote shownote"><code>policyviz.com</code></span>, a site run by Jon Schwabish, covers a range of topics on data visualization. It regularly features case-studies where visualizations are reworked to improve them or cast new light on the data they present. But do not just look for examples that have code with them to begin with. As I have said before, a real strength of ggplot is the grammar of graphic that underpins it. That grammar is a model you can use to look at and interpret <em>any</em> graph, no matter how it was produced. It gives you a vocabulary that lets you say what the data, mappings, geoms, scales, guides, and layers of any particular graph might be. And because the grammar is implemented as the ggplot library, it is a short step from being able to anatomize the structure of a graph to being able to sketch an outline of the code you could write to reproduce it yourself.</p>
<p>While its underlying principles and goals are relatively stable, the techniques and tools of research are changing. This is especially true within the social sciences <span class="citation">(Salganik, 2018)</span>. Data visualization is an excellent entry-point to these new developments. Our tools for it are more versatile and powerful than ever. So, you should look at your data. Looking is not a replacement for thinking. It cannot force you to be honest; it cannot magically prevent you from making mistakes; and it cannot make your ideas true. But if you analyze data, visualization can help you uncover features in it. If you are honest, it can help you live up to your own standards. When you inevitably make errors, it can help you find and correct them. And if you have an idea and some good evidence for it, it can help you show it in a compelling way.</p>

</div>
&#13;

<h2><span class="header-section-number">8.1</span> Use color to your advantage</h2>
<p>You should choose a color palette in the first place based on its
ability to express the data you are plotting. An unordered categorical
variable like “Country” or “Sex”, for example, requires distinct
colors that won’t be easily confused with one another. An ordered
categorical variable like “Level of Education”, on the other hand,
requires a graded color scheme of some kind running from less to more
or earlier to later. There are other considerations, too. For example,
if your variable is ordered, is your scale centered on a neutral
midpoint with departures to extremes in each direction, as in a Likert
scale? Again, these questions are about ensuring accuracy and fidelity
when mapping a variable to a color scale. Take care to choose a
palette that reflects the structure of your data. For example, do not
map sequential scales to categorical palettes, or use a diverging
palette for a variable with no well-defined midpoint.</p>
<p>Separate from these mapping issues, there are considerations about
which colors in particular to choose. In general, the default color
palettes that ggplot makes available are well-chosen for their
perceptual properties and aesthetic qualities. We can also use color
and color layers as device for emphasis, to highlight particular data
points or parts of the plot, perhaps in conjunction with other
features.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerqual"/>
<img src="../Images/28765d703602bf5cd1d514e8e26db9cb.png" alt="RColorBrewer's qualitative palettes." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerqual-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.6: RColorBrewer’s qualitative palettes.<!--</p>-->
<!--</div>--></span>
</p>
<p>We choose color palettes for mappings through one of the <code>scale_</code>
functions for <code>color</code> or <code>fill</code>. While it is possible to very finely
control the look of your color schemes by varying the hue, chroma, and
luminance of each color you use via <code>scale_color_hue()</code>, or
<code>scale_fill_hue()</code>, in general this is not recommended. Instead you
should use the <code>RColorBrewer</code> package to make a wide range of named
color palettes available to you, and choose from those. When used in
conjunction with ggplot, you access these colors by specifying the
<code>scale_color_brewer()</code> or <code>scale_fill_brewer()</code> functions, depending
on the aesthetic you are mapping. Figure <a href="refineplots.html#fig:ch-08-brewerpals">8.7</a> shows
the named palettes you can use in this way.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-brewerpals"/>
<img src="../Images/95b91c1a13faa395ecf14f1f6408d1af.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-1.png"/><img src="../Images/aedc13a3f5be16c006085a620331fcac.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-2.png"/><img src="../Images/78007d7d0fba02e6570b5e66c41d92b7.png" alt="Some available palettes in use." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-brewerpals-3.png"/>
<!--
<p class="caption marginnote">-->Figure 8.7: Some available palettes in use.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb288-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> organdata,</a>
<a class="sourceLine" id="cb288-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> roads, <span class="dt">y =</span> donors, <span class="dt">color =</span> world))</a>
<a class="sourceLine" id="cb288-3" data-line-number="3">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Set2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-4" data-line-number="4"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb288-5" data-line-number="5"/>
<a class="sourceLine" id="cb288-6" data-line-number="6">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Pastel2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-7" data-line-number="7"><span class="st">        </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb288-8" data-line-number="8"/>
<a class="sourceLine" id="cb288-9" data-line-number="9">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_brewer</span>(<span class="dt">palette =</span> <span class="st">"Dark2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb288-10" data-line-number="10"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a></code></pre>
<p>You can also specify colors manually, via <code>scale_color_manual()</code> or
<code>scale_fill_manual()</code>. These functions take a <code>value</code> argument that
can be specified as vector of color names or color values that R knows
about. R knows many color names (like <code>red</code>, and <code>green</code>, and
<code>cornflowerblue</code>. Try <code>demo('colors')</code> for an overview. Alternatively,
color values can be specified via their hexadecimal RGB value. This is
a way of encoding color values in the RGB colorspace, where each
channel can take a value from 0 to 255 like this. A color hex value
begins with a hash or pound character, <code>#</code>, followed by three pairs of
hexadecimal or “hex” numbers. Hex values are in Base 16, with the
first six letters of the alphabet standing for the numbers 10 to 15.
This allows a two-character hex number to range from 0 to 255. You
read them as <code>#rrggbb</code>, where <code>rr</code> is the two-digit hex code for the
red channel, <code>gg</code> for the green channel, and <code>bb</code> for the blue
channel. So <code>#CC55DD</code> translates in decimal to <code>CC</code> = 204 (red), <code>55</code>
= 85 (green), and <code>DD</code> = 221 (blue). It gives a strong pink color.</p>
<p>Going back to our ASA Membership plot, for example, we can manually
introduce a palette from <span class="citation">Chang (2013)</span> that’s friendly to color-blind viewers.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb289-1" data-line-number="1">cb_palette &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#999999"</span>, <span class="st">"#E69F00"</span>, <span class="st">"#56B4E9"</span>, <span class="st">"#009E73"</span>,</a>
<a class="sourceLine" id="cb289-2" data-line-number="2">                <span class="st">"#F0E442"</span>, <span class="st">"#0072B2"</span>, <span class="st">"#D55E00"</span>, <span class="st">"#CC79A7"</span>)</a>
<a class="sourceLine" id="cb289-3" data-line-number="3"/>
<a class="sourceLine" id="cb289-4" data-line-number="4">p4 <span class="op">+</span><span class="st"> </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> cb_palette) </a></code></pre>
<div class="figure"><span id="fig:ch-08-customcolor"/>
<p class="caption marginnote shownote">
Figure 8.8: Using a custom color palette.
</p>
<img src="../Images/f3cef85f5074883b01a2f66e64ccf77b.png" alt="Using a custom color palette." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-customcolor-1.png"/>
</div>
<p>As is often the case, this work has already been done for us. If
we are serious about using a safe palette for color-blind viewers, we
should investigate the <code>dichromat</code> package instead.<label for="tufte-mn-82" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-82" class="margin-toggle"/><span class="marginnote shownote">The <code>colorblindr</code> package has similar functionality.</span> It provides a range of safe palettes and some useful functions for helping you
approximately see what your current palette might look like to a
viewer with one of several different kinds of color blindness.</p>
<p>For example, let’s use <code>RColorBrewer</code>’s <code>brewer.pal()</code> function to get five colors from ggplot’s default palette.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb290-1" data-line-number="1">Default &lt;-<span class="st"> </span><span class="kw">brewer.pal</span>(<span class="dv">5</span>, <span class="st">"Set2"</span>)</a></code></pre>
<p>Next, we can use a function from the <code>dichromat</code> library to transform these colors to new values that simulate different kinds of color blindness.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb291-1" data-line-number="1"><span class="kw">library</span>(dichromat)</a>
<a class="sourceLine" id="cb291-2" data-line-number="2"/>
<a class="sourceLine" id="cb291-3" data-line-number="3">types &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"deutan"</span>, <span class="st">"protan"</span>, <span class="st">"tritan"</span>)</a>
<a class="sourceLine" id="cb291-4" data-line-number="4"><span class="kw">names</span>(types) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"Deuteronopia"</span>, <span class="st">"Protanopia"</span>, <span class="st">"Tritanopia"</span>)</a>
<a class="sourceLine" id="cb291-5" data-line-number="5"/>
<a class="sourceLine" id="cb291-6" data-line-number="6">color_table &lt;-<span class="st"> </span>types <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-7" data-line-number="7"><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="op">~</span><span class="st"> </span><span class="kw">dichromat</span>(Default, .x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-8" data-line-number="8"><span class="st">    </span><span class="kw">as_tibble</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb291-9" data-line-number="9"><span class="st">    </span><span class="kw">add_column</span>(Default, <span class="dt">.before =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb291-10" data-line-number="10"/>
<a class="sourceLine" id="cb291-11" data-line-number="11">color_table</a></code></pre>
<pre><code>## # A tibble: 5 x 4
##   Default Deuteronopia Protanopia Tritanopia
##   &lt;chr&gt;   &lt;chr&gt;        &lt;chr&gt;      &lt;chr&gt;     
## 1 #66C2A5 #AEAEA7      #BABAA5    #82BDBD   
## 2 #FC8D62 #B6B661      #9E9E63    #F29494   
## 3 #8DA0CB #9C9CCB      #9E9ECB    #92ABAB   
## 4 #E78AC3 #ACACC1      #9898C3    #DA9C9C   
## 5 #A6D854 #CACA5E      #D3D355    #B6C8C8</code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-color-comp"/>
<img src="../Images/a2751e201c976fd23ab0f1eb95b8212b.png" alt="Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-color-comp-1.png"/><img src="../Images/c1e508616e1cf373ff78c83e9c593902.png" alt="Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-color-comp-2.png"/>
<!--
<p class="caption marginnote">-->Figure 8.9: Comparing a default color palette with an approximation of how the same palette appears to people with one of three kinds of color blindness.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb293-1" data-line-number="1"><span class="kw">color_comp</span>(color_table)</a></code></pre>
<p>In this code, we create a vector of <code>types</code> of color blindness that the <code>dichromat()</code> function knows about, and give them proper names. Then we make a table of colors for each type using the <code>purrr</code> library’s <code>map()</code> function. The rest of the pipeline converts the results from a list to a tibble and adds the original colors as the first column in the table. We can now plot them to see how they compare, using a convenience function from the <code>socviz</code> library.</p>
<p>The ability to manually specify colors can be useful when the meaning
of a category itself has a strong color association. Political
parties, for example, tend to have official or quasi-official party
colors that people associate with them. In such cases it is helpful to
be able to present results for, say, the Green Party in a
(perceptually balanced!) green color. When doing this, it is worth
keeping in mind that some colors are associated with categories
(especially categories of person) for outmoded reasons, or no very
good reason. Do not use stereotypical colors just because you can.</p>
&#13;

<h2><span class="header-section-number">8.2</span> Layer color and text together</h2>
<p>Aside from mapping variables directly, color is also very useful when
we want to pick out or highlight some aspect of our data. In cases
like this that the layered approach of ggplot can really work to our
advantage. Let’s work through an example where we use manually
specified colors both for emphasis and because of their social
meaning.</p>
<p>We will build up a plot of data about the 2016 US general election. It
is contained in the <code>county_data</code> object in the <code>socviz</code> library. We
begin by defining a blue and red color for the Democrats and
Republicans. Then we create the basic setup and first layer of the
plot. We subset the data, including only counties with a value of “No”
on the <code>flipped</code> variable. We set the color of <code>geom_point()</code>
to be a light gray, as it will form the background layer of the
plot. And we apply a log transformation to the x-axis scale.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-01"/>
<img src="../Images/53e87e727f989adf8e4bc7e5600394e5.png" alt="The background layer." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-01-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.10: The background layer.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb294-1" data-line-number="1"><span class="co"># Democrat Blue and Republican Red</span></a>
<a class="sourceLine" id="cb294-2" data-line-number="2">party_colors &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"#2E74C0"</span>, <span class="st">"#CB454A"</span>)</a>
<a class="sourceLine" id="cb294-3" data-line-number="3"/>
<a class="sourceLine" id="cb294-4" data-line-number="4">p0 &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb294-5" data-line-number="5">                           flipped <span class="op">==</span><span class="st"> "No"</span>),</a>
<a class="sourceLine" id="cb294-6" data-line-number="6">             <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop,</a>
<a class="sourceLine" id="cb294-7" data-line-number="7">                           <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>))</a>
<a class="sourceLine" id="cb294-8" data-line-number="8"/>
<a class="sourceLine" id="cb294-9" data-line-number="9">p1 &lt;-<span class="st"> </span>p0 <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">alpha =</span> <span class="fl">0.15</span>, <span class="dt">color =</span> <span class="st">"gray50"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb294-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_x_log10</span>(<span class="dt">labels=</span>scales<span class="op">::</span>comma) </a>
<a class="sourceLine" id="cb294-11" data-line-number="11"/>
<a class="sourceLine" id="cb294-12" data-line-number="12">p1</a></code></pre>
<p>In the next step we add a second <code>geom_point()</code> layer. Here we start with the same dataset but extract a complementary subset from it. This time we choose the “Yes” counties on the <code>flipped</code> variable. The <code>x</code> and <code>y</code> mappings are the same, but we add a color scale for these points, mapping the <code>partywinner16</code> variable to the <code>color</code> aesthetic. Then we specify a manual color scale with <code>scale_color_manual()</code>, where the values are the blue and red <code>party_colors</code> we defined above.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-02"/>
<img src="../Images/d69576a9832a618317465f2ae189b30e.png" alt="The second layer." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.11: The second layer.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb295-1" data-line-number="1">p2 &lt;-<span class="st"> </span>p1 <span class="op">+</span><span class="st"> </span><span class="kw">geom_point</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb295-2" data-line-number="2">                                    flipped <span class="op">==</span><span class="st"> "Yes"</span>),</a>
<a class="sourceLine" id="cb295-3" data-line-number="3">                      <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop, <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb295-4" data-line-number="4">                                    <span class="dt">color =</span> partywinner16)) <span class="op">+</span></a>
<a class="sourceLine" id="cb295-5" data-line-number="5"><span class="st">    </span><span class="kw">scale_color_manual</span>(<span class="dt">values =</span> party_colors)</a>
<a class="sourceLine" id="cb295-6" data-line-number="6"/>
<a class="sourceLine" id="cb295-7" data-line-number="7">p2</a></code></pre>
<p>The next layer sets the y-axis scale and the labels.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-elec-03"/>
<img src="../Images/d870c3cd11377a43025a595b0503e56f.png" alt="Adding guides and labels, and fixing the x-axis scale." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-elec-03-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.12: Adding guides and labels, and fixing the x-axis scale.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb296-1" data-line-number="1">p3 &lt;-<span class="st"> </span>p2 <span class="op">+</span><span class="st"> </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels=</span>scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb296-2" data-line-number="2"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"County flipped to ... "</span>,</a>
<a class="sourceLine" id="cb296-3" data-line-number="3">         <span class="dt">x =</span> <span class="st">"County Population (log scale)"</span>,</a>
<a class="sourceLine" id="cb296-4" data-line-number="4">         <span class="dt">y =</span> <span class="st">"Percent Black Population"</span>,</a>
<a class="sourceLine" id="cb296-5" data-line-number="5">         <span class="dt">title =</span> <span class="st">"Flipped counties, 2016"</span>,</a>
<a class="sourceLine" id="cb296-6" data-line-number="6">         <span class="dt">caption =</span> <span class="st">"Counties in gray did not flip."</span>)</a>
<a class="sourceLine" id="cb296-7" data-line-number="7"/>
<a class="sourceLine" id="cb296-8" data-line-number="8">p3</a></code></pre>
<p>Finally, we add a third layer using the <code>geom_text_repel()</code> function. Once again we supply a set of instructions to subset the data for this text layer. We are interested in the flipped counties that have with a relatively high percentage of African-American residents. The result, shown in Figure <a href="refineplots.html#fig:ch-08-flippers">8.13</a> is a complex but legible multi-layer plot with judicious use of color for variable coding and context.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb297-1" data-line-number="1">p4 &lt;-<span class="st"> </span>p3 <span class="op">+</span><span class="st"> </span><span class="kw">geom_text_repel</span>(<span class="dt">data =</span> <span class="kw">subset</span>(county_data,</a>
<a class="sourceLine" id="cb297-2" data-line-number="2">                                      flipped <span class="op">==</span><span class="st"> "Yes"</span> <span class="op">&amp;</span></a>
<a class="sourceLine" id="cb297-3" data-line-number="3"><span class="st">                                      </span>black  <span class="op">&gt;</span><span class="st"> </span><span class="dv">25</span>),</a>
<a class="sourceLine" id="cb297-4" data-line-number="4">                           <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> pop,</a>
<a class="sourceLine" id="cb297-5" data-line-number="5">                                   <span class="dt">y =</span> black<span class="op">/</span><span class="dv">100</span>,</a>
<a class="sourceLine" id="cb297-6" data-line-number="6">                                   <span class="dt">label =</span> state), <span class="dt">size =</span> <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb297-7" data-line-number="7"/>
<a class="sourceLine" id="cb297-8" data-line-number="8">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme_minimal</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb297-9" data-line-number="9"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a></code></pre>
<p>When producing a graphic like this in ggplot, or when looking at good plots made by others, it should gradually become your habit to see not just the content of the plot but also the implicit or explicit structure that it has. First, you will be able to see the mappings that form the basis of the plot, picking out which variables are mapped to x and y, and which to to color, fill, shape, label, and so on. What geoms were used to produce them? Second, how have the scales been adjusted? Are the axes transformed? Are the fill and color legends combined? And third, especially as you practice making plots of your own, you will find yourself picking out the **layered* structure of the plot. What is the base layer? What has been drawn on top of it, and in what order? Which upper layers are formed from subsets of the data? Which are new datasets? Are there annotations? The ability to evaluate plots in this way, to apply the grammar of graphics in practice, is useful both for <em>looking</em> at plots and for thinking about how to <em>make</em> them.</p>
&#13;

<h2><span class="header-section-number">8.3</span> Change the appearance of plots with themes</h2>
<p>Our elections plot is in a pretty finished state. But if we want to change the overall look of it all at once, we can do that using ggplot’s theme engine. Themes can be turned on or off using the <code>theme_set()</code> function. It takes the name of a theme (which will itself be a function) as an argument. Try the following:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb298-1" data-line-number="1"><span class="kw">theme_set</span>(<span class="kw">theme_bw</span>())</a>
<a class="sourceLine" id="cb298-2" data-line-number="2">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb298-3" data-line-number="3"/>
<a class="sourceLine" id="cb298-4" data-line-number="4"><span class="kw">theme_set</span>(<span class="kw">theme_dark</span>())</a>
<a class="sourceLine" id="cb298-5" data-line-number="5">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a></code></pre>
<p>Internally, theme functions are a set of detailed instructions to turn on, turn off, or modify a large number of graphical elements on the plot. Once set, a theme applies to all subsequent plots and it remains active until it is replaced by a different theme. This be done either through the use of another <code>theme_set()</code> statement, or on a per-plot basis by adding the theme function to the end of the plot: <code>p4 + theme_gray()</code> would temporarily override the generally active theme for the <code>p4</code> object only. You can still use the <code>theme()</code> function to fine-tune any aspect of your plot, as seen above with the relocation of the legend to the top of the graph.</p>
<p>The ggplot library comes with several built-in themes, including <code>theme_minimal()</code> and <code>theme_classic()</code>, with <code>theme_gray()</code> or <code>theme_grey()</code> as the default. If these are not to your taste, install the <code>ggthemes</code> library for many more options. You can, for example, make ggplot output look like it has been featured in the <em>Economist</em>, or the <em>Wall Street Journal</em>, or in the pages of a book by Edward Tufte.</p>
<div class="figure fullwidth"><span id="fig:ch-08-flippers"/>
<img src="../Images/bf4a337c3b0ee3da335bbfbaea0cfbb6.png" alt="County-level election data from 2016." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-flippers-1.png"/>
<p class="caption marginnote shownote">
Figure 8.13: County-level election data from 2016.
</p>
</div>
<p>Using some themes might involve adjusting font sizes or
other elements as needed, if the defaults are too large or small. If
you use a theme with a colored background, you will also need to
consider what color palette you are using when mapping to <code>color</code> or
<code>fill</code> aesthetics. You can define your own themes either entirely from
scratch, or by starting with one you like and making adjustments from
there.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb299-1" data-line-number="1"><span class="kw">library</span>(ggthemes)</a>
<a class="sourceLine" id="cb299-2" data-line-number="2"/>
<a class="sourceLine" id="cb299-3" data-line-number="3"><span class="kw">theme_set</span>(<span class="kw">theme_economist</span>())</a>
<a class="sourceLine" id="cb299-4" data-line-number="4">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position=</span><span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb299-5" data-line-number="5"/>
<a class="sourceLine" id="cb299-6" data-line-number="6"><span class="kw">theme_set</span>(<span class="kw">theme_wsj</span>())</a>
<a class="sourceLine" id="cb299-7" data-line-number="7"/>
<a class="sourceLine" id="cb299-8" data-line-number="8">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.6</span>)),</a>
<a class="sourceLine" id="cb299-9" data-line-number="9">           <span class="dt">legend.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.35</span>)),</a>
<a class="sourceLine" id="cb299-10" data-line-number="10">           <span class="dt">plot.caption =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="kw">rel</span>(<span class="fl">0.35</span>)),</a>
<a class="sourceLine" id="cb299-11" data-line-number="11">           <span class="dt">legend.position =</span> <span class="st">"top"</span>)</a></code></pre>
<div class="figure fullwidth"><span id="fig:ch-08-themes-01"/>
<img src="../Images/ab8f017f9573b6a2a8f4fccd5f904f0b.png" alt="Economist and WSJ themes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-themes-01-1.png"/><img src="../Images/df968bfc94cb62255656f67337d4b654.png" alt="Economist and WSJ themes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-themes-01-2.png"/>
<p class="caption marginnote shownote">
Figure 8.14: Economist and WSJ themes.
</p>
</div>
<p>Generally speaking, themes with colored backgrounds customized
typefaces are best used when making one-off graphics or posters, when
preparing figures to integrate into a slide presentation, or when
conforming to a house or editorial style for publication. Take care to
consider how the choices you make will harmonize with the broader
printed or displayed material. Just as with the choice of palettes for
aesthetic mappings, when starting out it can be wisest to stick to the
defaults or consistently use a theme that has had its kinks already
ironed out. Claus<label for="tufte-mn-83" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-83" class="margin-toggle"/><span class="marginnote shownote">It also contains some convenience functions for laying out several plot objects in a single figure, amongst other features, as we shall see below in one of the case studies.</span> O. Wilke’s <code>cowplot</code> package, for instance, contains
a well-developed theme suitable for figures whose final destination is
a journal article. Bob Rudis’s <code>hrbrthemes</code> package,
meanwhile, has a distinctive and compact look and feel that takes
advantage of some freely-available typefaces. Both are available via
<code>install.packages()</code>.</p>
<p>The <code>theme()</code> function allows you to exert very fine-grained control
over the appearance of all kinds of text and graphical elements in a
plot. For example, we can change the color, typeface, and font weight
of text. If you have been following along writing your code, you will
have noticed that the plots you make have not been identical to the
ones shown in the text. The axis labels are in a slightly different
place from the default, the typeface is different, and there are other
smaller changes as well. The <code>theme_book()</code> function provides the
custom ggplot theme used throughout this book. The code for this theme
is based substantially on Bob Rudis’s <code>theme_ipsum()</code>, from his
<code>hrbrthemes</code> library. You can learn more about it in the Appendix. For
this one figure, we then adjust that theme even further by tweaking
the text size, and we also remove a number of elements by naming them
and making them disappear using <code>element_blank()</code>.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb300-1" data-line-number="1">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>)</a>
<a class="sourceLine" id="cb300-2" data-line-number="2"/>
<a class="sourceLine" id="cb300-3" data-line-number="3">p4 <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb300-4" data-line-number="4">           <span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="dv">2</span>),</a>
<a class="sourceLine" id="cb300-5" data-line-number="5">                                     <span class="dt">lineheight=</span>.<span class="dv">5</span>,</a>
<a class="sourceLine" id="cb300-6" data-line-number="6">                                     <span class="dt">family=</span><span class="st">"Times"</span>,</a>
<a class="sourceLine" id="cb300-7" data-line-number="7">                                     <span class="dt">face=</span><span class="st">"bold.italic"</span>,</a>
<a class="sourceLine" id="cb300-8" data-line-number="8">                                     <span class="dt">colour=</span><span class="st">"orange"</span>),</a>
<a class="sourceLine" id="cb300-9" data-line-number="9">           <span class="dt">axis.text.x =</span> <span class="kw">element_text</span>(<span class="dt">size=</span><span class="kw">rel</span>(<span class="fl">1.1</span>),</a>
<a class="sourceLine" id="cb300-10" data-line-number="10">                                      <span class="dt">family=</span><span class="st">"Courier"</span>,</a>
<a class="sourceLine" id="cb300-11" data-line-number="11">                                      <span class="dt">face=</span><span class="st">"bold"</span>,</a>
<a class="sourceLine" id="cb300-12" data-line-number="12">                                      <span class="dt">color=</span><span class="st">"purple"</span>))</a></code></pre>
<div class="figure"><span id="fig:ch-08-theme-control"/>
<p class="caption marginnote shownote">
Figure 8.15: Controlling various theme elements directly.
</p>
<img src="../Images/b4563017d3271a4c1c7bc52779257207.png" alt="Controlling various theme elements directly." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-theme-control-1.png"/><img src="../Images/61c6d3a3a7750aab6846105026864eaa.png" alt="Controlling various theme elements directly." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-theme-control-2.png"/>
</div>
&#13;

<h2><span class="header-section-number">8.4</span> Use theme elements in a substantive way</h2>
<p>It makes good sense use themes as a way to fix design elements,
because that means you can subsequently ignore them, and focus instead
on the data you are examining. But it is also worth remembering that
ggplot’s theme system is very flexible. It permits a wide range of
design elements to be adjusted in order to create custom figures. For
instance, following an example from <span class="citation">Wehrwein (2017)</span>, we will
create an effective small multiple of the age distribution of GSS
respondents over the years. The <code>gss_lon</code> data contains information on
the age of each GSS respondent for all the years in the survey since
1972. The base of the figure is a scaled <code>geom_density()</code> layer of the
sort we saw earlier, this time faceted by the <code>year</code> variable. We will
fill the density curves with a dark grey color, and then add an
indicator of the mean age in each year, and a text layer for the
label. With those in place we then adjust the detail of several theme
elements, mostly to remove them. As before we use <code>element_text()</code> to
tweak the appearance of various text elements such as titles and
labels. And we also use <code>element_blank()</code> to remove several of them
altogether.</p>
<p>First, we need to calculate the mean age of the respondents for each
year of interest. Because the GSS has been around for most (but not
all) years since 1972, we will look at distributions about every four
years since the beginning. We use a short pipeline to extract the
average ages.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb301-1" data-line-number="1">yrs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="kw">seq</span>(<span class="dv">1972</span>, <span class="dv">1988</span>, <span class="dv">4</span>), <span class="dv">1993</span>, <span class="kw">seq</span>(<span class="dv">1996</span>, <span class="dv">2016</span>, <span class="dv">4</span>))</a>
<a class="sourceLine" id="cb301-2" data-line-number="2"/>
<a class="sourceLine" id="cb301-3" data-line-number="3">mean_age &lt;-<span class="st"> </span>gss_lon <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-4" data-line-number="4"><span class="st">    </span><span class="kw">filter</span>(age <span class="op">%nin%</span><span class="st"> </span><span class="ot">NA</span> <span class="op">&amp;&amp;</span><span class="st"> </span>year <span class="op">%in%</span><span class="st"> </span>yrs) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-5" data-line-number="5"><span class="st">    </span><span class="kw">group_by</span>(year) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb301-6" data-line-number="6"><span class="st">    </span><span class="kw">summarize</span>(<span class="dt">xbar =</span> <span class="kw">round</span>(<span class="kw">mean</span>(age, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>), <span class="dv">0</span>))</a>
<a class="sourceLine" id="cb301-7" data-line-number="7">mean_age<span class="op">$</span>y &lt;-<span class="st"> </span><span class="fl">0.3</span></a>
<a class="sourceLine" id="cb301-8" data-line-number="8"/>
<a class="sourceLine" id="cb301-9" data-line-number="9">yr_labs &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">85</span>, <span class="dt">y =</span> <span class="fl">0.8</span>,</a>
<a class="sourceLine" id="cb301-10" data-line-number="10">                      <span class="dt">year =</span> yrs)</a></code></pre>
<p>The <code>y</code> column in <code>mean_age</code> will come in handy when we want to
position the age as a text label. Next, we prepare the data and set up the geoms.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb302-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> <span class="kw">subset</span>(gss_lon, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> age))</a>
<a class="sourceLine" id="cb302-3" data-line-number="3"/>
<a class="sourceLine" id="cb302-4" data-line-number="4">p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density</span>(<span class="dt">fill =</span> <span class="st">"gray20"</span>, <span class="dt">color =</span> <span class="ot">FALSE</span>,</a>
<a class="sourceLine" id="cb302-5" data-line-number="5">                       <span class="dt">alpha =</span> <span class="fl">0.9</span>, <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">y =</span> ..scaled..)) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_vline</span>(<span class="dt">data =</span> <span class="kw">subset</span>(mean_age, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-7" data-line-number="7">               <span class="kw">aes</span>(<span class="dt">xintercept =</span> xbar), <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">size =</span> <span class="fl">0.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-8" data-line-number="8"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">subset</span>(mean_age, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-9" data-line-number="9">              <span class="kw">aes</span>(<span class="dt">x =</span> xbar, <span class="dt">y =</span> y, <span class="dt">label =</span> xbar), <span class="dt">nudge_x =</span> <span class="fl">7.5</span>,</a>
<a class="sourceLine" id="cb302-10" data-line-number="10">              <span class="dt">color =</span> <span class="st">"white"</span>, <span class="dt">size =</span> <span class="fl">3.5</span>, <span class="dt">hjust =</span> <span class="dv">1</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-11" data-line-number="11"><span class="st">    </span><span class="kw">geom_text</span>(<span class="dt">data =</span> <span class="kw">subset</span>(yr_labs, year <span class="op">%in%</span><span class="st"> </span>yrs),</a>
<a class="sourceLine" id="cb302-12" data-line-number="12">              <span class="kw">aes</span>(<span class="dt">x =</span> x, <span class="dt">y =</span> y, <span class="dt">label =</span> year)) <span class="op">+</span></a>
<a class="sourceLine" id="cb302-13" data-line-number="13"><span class="st">    </span><span class="kw">facet_grid</span>(year <span class="op">~</span><span class="st"> </span>., <span class="dt">switch =</span> <span class="st">"y"</span>)</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-gssage-real"/>
<img src="../Images/3bb2b0837c0c5e7d37998c78f140e887.png" alt="A customized small multiple." width="90%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-gssage-real-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.16: A customized small multiple.<!--</p>-->
<!--</div>--></span>
</p>
<p>The initial <code>p</code> object subsets the data by the years we have chosen,
and maps <code>x</code> to the <code>age</code> variable. The <code>geom_density()</code> call is the
base layer, with arguments to turn off its default line color, set the
fill to a shade of gray, and scale the y-axis between zero and one.</p>
<p>Using our summarized dataset, the <code>geom_vline()</code> layer draws a vertical
white line at the mean age of the distribution. The first of two text
geoms label the age line (in white). The first <code>geom_text()</code> call uses
a <code>nudge</code> argument to push the label slightly to the right of its
x-value. The second labels the year. We do this because we are about
to turn off the usual facet labels to make the plot more compact.
Finally we use <code>facet_grid()</code> to break out the age distributions by
year. We use the <code>switch</code> argument to move the labels to the left.</p>
<p>With the structure of the plot in place, we then style the elements in
the way that we want, using a series of instructions to <code>theme()</code>.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb303-1" data-line-number="1">p1 <span class="op">+</span><span class="st"> </span><span class="kw">theme_book</span>(<span class="dt">base_size =</span> <span class="dv">10</span>, <span class="dt">plot_title_size =</span> <span class="dv">10</span>,</a>
<a class="sourceLine" id="cb303-2" data-line-number="2">                <span class="dt">strip_text_size =</span> <span class="dv">32</span>, <span class="dt">panel_spacing =</span> <span class="kw">unit</span>(<span class="fl">0.1</span>, <span class="st">"lines"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-3" data-line-number="3"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">plot.title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">16</span>),</a>
<a class="sourceLine" id="cb303-4" data-line-number="4">          <span class="dt">axis.text.x=</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb303-5" data-line-number="5">          <span class="dt">axis.title.y=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-6" data-line-number="6">          <span class="dt">axis.text.y=</span><span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-7" data-line-number="7">          <span class="dt">axis.ticks.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-8" data-line-number="8">          <span class="dt">strip.background =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-9" data-line-number="9">          <span class="dt">strip.text.y =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-10" data-line-number="10">          <span class="dt">panel.grid.major =</span> <span class="kw">element_blank</span>(),</a>
<a class="sourceLine" id="cb303-11" data-line-number="11">          <span class="dt">panel.grid.minor =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb303-12" data-line-number="12"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Age"</span>,</a>
<a class="sourceLine" id="cb303-13" data-line-number="13">         <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb303-14" data-line-number="14">         <span class="dt">title =</span> <span class="st">"Age Distribution of</span><span class="ch">\n</span><span class="st">GSS Respondents"</span>)</a></code></pre>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-ggridges-real"/>
<img src="../Images/a0991183f8eebc093027020e8391278d.png" alt="A ridgeplot version of the age distribution plot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-ggridges-real-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.17: A ridgeplot version of the age distribution plot.<!--</p>-->
<!--</div>--></span>
</p>
<p>One of the pleasing things about ggplot’s developer community is that it often takes plot ideas that are first worked out in a once-off or bespoke way and generalizes them to the point where they are available as new geoms. Shortly after writing the code for the GSS age distributions in Figure <a href="refineplots.html#fig:ch-08-gssage-real">8.16</a>, the <code>ggridges</code> package was released. Written by Claus O. Wilke, it offers a different take on small-multiple density plots by allowing the distributions to overlap vertically to interesting effect. It is especially useful for repeated distributional measures that change in a clear direction. Here we redo our previous plot using a function from <code>ggridges</code>. Because <code>geom_density_ridges()</code> makes for a more compact display we trade-off showing the mean age value for the sake of displaying the distribution for every GSS year.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb304-1" data-line-number="1"><span class="kw">library</span>(ggridges)</a>
<a class="sourceLine" id="cb304-2" data-line-number="2"/>
<a class="sourceLine" id="cb304-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> gss_lon,</a>
<a class="sourceLine" id="cb304-4" data-line-number="4">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> age, <span class="dt">y =</span> <span class="kw">factor</span>(year, <span class="dt">levels =</span> <span class="kw">rev</span>(<span class="kw">unique</span>(year)),</a>
<a class="sourceLine" id="cb304-5" data-line-number="5">                                     <span class="dt">ordered =</span> <span class="ot">TRUE</span>)))</a>
<a class="sourceLine" id="cb304-6" data-line-number="6"/>
<a class="sourceLine" id="cb304-7" data-line-number="7">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_density_ridges</span>(<span class="dt">alpha =</span> <span class="fl">0.6</span>, <span class="dt">fill =</span> <span class="st">"lightblue"</span>, <span class="dt">scale =</span> <span class="fl">1.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-8" data-line-number="8"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">breaks =</span> <span class="kw">c</span>(<span class="dv">25</span>, <span class="dv">50</span>, <span class="dv">75</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-9" data-line-number="9"><span class="st">    </span><span class="kw">scale_y_discrete</span>(<span class="dt">expand =</span> <span class="kw">c</span>(<span class="fl">0.01</span>, <span class="dv">0</span>)) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb304-10" data-line-number="10"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Age"</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb304-11" data-line-number="11">         <span class="dt">title =</span> <span class="st">"Age Distribution of</span><span class="ch">\n</span><span class="st">GSS Respondents"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb304-12" data-line-number="12"><span class="st">    </span><span class="kw">theme_ridges</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb304-13" data-line-number="13"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">title =</span> <span class="kw">element_text</span>(<span class="dt">size =</span> <span class="dv">16</span>, <span class="dt">face =</span> <span class="st">"bold"</span>))</a></code></pre>
<p>The <code>expand</code> argument in <code>scale_y_discrete()</code> adjusts the scaling of the y-axis slightly. It has the effect of shortening the distance between the axis labels and the first distribution, and it also prevents the top of the very first distribution from being cut off by the frame of the plot. The package also comes with its own theme, <code>theme_ridges()</code> that adjusts the labels so that they are aligned properly, and we use it here. The <code>geom_density_ridges()</code> function is also capable of reproducing the look of our original version. The degree of overlap in the distributions is controlled by the <code>scale</code> argument in the geom. You can experiment with setting it to values below or above one to see the effects on the layout of the plot.</p>
<p>Much more detailed information on the names of the various elements
you can control via <code>theme()</code> can be found in the ggplot documentation.
Setting these thematic elements in an ad hoc way is often one of the
first things people want to do when they make plot. But in practice,
apart from getting the overall size and scale of your plot squared
away, making small adjustments to theme elements should be the very
last thing you do in the plotting process. Ideally, once you have set
up a theme that works well for you, it should be something you
can avoid having to do at all.</p>
&#13;

<h2><span class="header-section-number">8.5</span> Case studies</h2>
<p>Bad graphics are everywhere. Better ones are within our reach. For
the final few sections of this chapter we will work through a few
common visualization problems or dilemmas, as seen through some
real-life cases. In each case we will look at the original figures and
redraw them in new (and better) versions. In the process we will
introduce a few new functions and features of ggplot that we have not
seen yet. This, too, is true to life. Usually, it’s having to face
some practical design or visualization question that forces us to
ferret out the solution to our problem in the documentation, or come
up with some alternative answer on the fly ourselves. Let’s start with
a common case: the use of dual axes in trend plots.</p>
<div id="two-y-axes" class="section level3">
<h3><span class="header-section-number">8.5.1</span> Two y-axes</h3>
<p>In January of 2016, Liz Ann Sonders, Chief Investment Strategist with
Charles Schwab, Inc, tweeted about the apparent correlation between
two economic time series: the Standard and Poor’s 500 stock market
index, and the Monetary Base, a measure of the size of money supply.
The S&amp;P is an index that ranges from about 700 to about 2,100 over the
period of interest (about the last seven years). The Monetary Base
ranges from about 1.5 trillion to 4.1 trillion dollars over the same
period. This means that we can’t plot the two series directly. The
Monetary Base is so much larger that it would meake the S&amp;P 500 series
appear as a flat line at the bottom. While there are several
reasonable ways to address this, people often opt instead to have two
y-axes.</p>
<p>Because it is designed by responsible people, R makes it slightly
tricky to draw graphs with two y-axes. In fact, ggplot rules it out of
order altogether. It is possible to do it using R’s base graphics, if
you insist. Figure <a href="refineplots.html#fig:fred1">8.18</a> shows the result. I will not show
the code here. (You can find it at
<code>https://github.com/kjhealy/two-y-axes</code>.) This is partly because
graphics in base R work very differently from the approach we have
taken throughout this book, so it would just be confusing, and partly
because I do not wish to encourage young people to engage in immoral
acts.</p>
<div class="figure"><span id="fig:fred1"/>
<p class="caption marginnote shownote">
Figure 8.18: Two time series, each with its own y-axis.
</p>
<img src="../Images/041e16ecc2c41f412ffcfe78d4e8ff60.png" alt="Two time series, each with its own y-axis." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred1-1.png"/>
</div>
<p>Most of the time when people draw plots with two y-axes they want to line the series up as closely as possible because they suspect that there’s a substantive association between them, as in this case. The main problem with using two y-axes is that it makes it even easier than usual to fool yourself (or someone else) about the degree of association between the variables. This is because you can adjust the scaling of the axes to relative to one another in way that moves the data series around more or less however you like. For the first half of the graph in Figure <a href="refineplots.html#fig:fred1">8.18</a>, the red Monetary Base line tracks below the blue S&amp;P 500 and is above it for the second half.</p>
<div class="figure"><span id="fig:fred2"/>
<p class="caption marginnote shownote">
Figure 8.19: Variations on two y-axes.
</p>
<img src="../Images/34c65eccc31a8958f15c5cff04bb3f4e.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-1.png"/><img src="../Images/d408a2bf9b1a7abba25ddf5e49458a84.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-2.png"/>
</div>
<p>We can “fix” that by deciding to start the second y-axis at zero, which shifts the Monetary Base line above the S&amp;P line for the first half of the series and below it later on. The first panel in Figure <a href="refineplots.html#fig:fred2">8.19</a> shows the results. The second panel, meanwhile, adjusts the axes so that the axis tracking the S&amp;P starts at zero. The axis tracking the Monetary Base starts around its minimum (as is generally good practice), but now both axes max out around 4,000. The units are different, of course. The 4,000 on the S&amp;P side is an index number, while the Monetary Base number is 4,000 billion dollars. The effect is to flatten out the S&amp;P’s apparent growth quite a bit, muting the association between the two variables substantially. You could tell quite a different story with this one, if you felt like it.</p>
<p>How else might we draw this data? We could use a split- or broken-axis plot to show the two series at the same time. These can be effective sometimes, and they seem to have better perceptual properties than overlayed charts with dual axes <span class="citation">(Isenberg, Bezerianos, Dragicevic, &amp; Fekete, 2011)</span>. They are most useful in cases where the series you are plotting are of the same kind, but of very different magnitudes. That is not the case here.</p>
<p>Another compromise, if the series are not in the same units (or of widely differing magnitudes), is to rescale one of the series (e.g., by dividing or multiplying it by a thousand), or alternatively to index each of them to 100 at the start of the first period, and then plot them both. Index numbers can have complications of their own, but here they allow us use one axis instead of two, and also to calculate a sensible difference between the two series and plot that as well, in a panel below. It can be quite tricky to visually estimate the difference between series, in part because our perceptual tendency is to look for the <em>nearest</em> comparison point in the other series rather than the one directly above or below. Following <span class="citation">Cleveland (1994)</span>, we can also add a panel underneath that tracks the running difference between the two series. We begin by making each plot and storing them in an object. To do this, it will be convenient to fully tidy the data in to a long format, with the indexed series in the key variable and their corresponding scores as the values. We use tidyr’s <code>gather()</code> function for this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1"><span class="kw">head</span>(fredts)</a></code></pre>
<pre><code>##         date  sp500 monbase sp500_i monbase_i
## 1 2009-03-11 696.68 1542228 100.000   100.000
## 2 2009-03-18 766.73 1693133 110.055   109.785
## 3 2009-03-25 799.10 1693133 114.701   109.785
## 4 2009-04-01 809.06 1733017 116.131   112.371
## 5 2009-04-08 830.61 1733017 119.224   112.371
## 6 2009-04-15 852.21 1789878 122.324   116.058</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1">fredts_m &lt;-<span class="st"> </span>fredts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(date, sp500_i, monbase_i) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> series, <span class="dt">value =</span> score, sp500_i<span class="op">:</span>monbase_i)</a>
<a class="sourceLine" id="cb307-3" data-line-number="3"/>
<a class="sourceLine" id="cb307-4" data-line-number="4"><span class="kw">head</span>(fredts_m)</a></code></pre>
<pre><code>##         date  series   score
## 1 2009-03-11 sp500_i 100.000
## 2 2009-03-18 sp500_i 110.055
## 3 2009-03-25 sp500_i 114.701
## 4 2009-04-01 sp500_i 116.131
## 5 2009-04-08 sp500_i 119.224
## 6 2009-04-15 sp500_i 122.324</code></pre>
<p>Once the data are tidied in this way we can make our graph.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts_m,</a>
<a class="sourceLine" id="cb309-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> score,</a>
<a class="sourceLine" id="cb309-3" data-line-number="3">                          <span class="dt">group =</span> series,</a>
<a class="sourceLine" id="cb309-4" data-line-number="4">                          <span class="dt">color =</span> series))</a>
<a class="sourceLine" id="cb309-5" data-line-number="5">p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb309-6" data-line-number="6"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-7" data-line-number="7">         <span class="dt">y =</span> <span class="st">"Index"</span>,</a>
<a class="sourceLine" id="cb309-8" data-line-number="8">         <span class="dt">color =</span> <span class="st">"Series"</span>)</a>
<a class="sourceLine" id="cb309-9" data-line-number="9"/>
<a class="sourceLine" id="cb309-10" data-line-number="10">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts,</a>
<a class="sourceLine" id="cb309-11" data-line-number="11">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> sp500_i <span class="op">-</span><span class="st"> </span>monbase_i))</a>
<a class="sourceLine" id="cb309-12" data-line-number="12"/>
<a class="sourceLine" id="cb309-13" data-line-number="13">p2 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-14" data-line-number="14"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-15" data-line-number="15">         <span class="dt">y =</span> <span class="st">"Difference"</span>)</a></code></pre>
<p>Now we have our two plots, we want to lay them out nicely. We do not want them to appear in the same plot area, but we do want to compare them. It would be possible to do this with a facet, but that would mean doing a fair amount of data munging to get all three series (the two indices and the difference between them) into the same tidy data frame. An alternative is to make two separate plots and then arrange them just as we like. For instance, have the comparison of the two series take up most of the space, and put the plot of the index differences along the bottom in a smaller area.</p>
<p>The layout engine used by R and ggplot, called <code>grid</code>, does make this possible. It controls the layout and positioning of plot areas and objects at a lower level than ggplot. Programming <code>grid</code> layouts directly takes a little more work than using ggplot’s functions alone. Fortunately, there are some helper libraries that we can use to make things easier. One possibility is to use the <code>gridExtra</code> library. It provides a number of useful functions that let us talk to the grid engine, including <code>grid.arrange()</code>. This function takes a list of plot objects and instructions for how we would like them arranged. The <code>cowplot</code> library we mentioned earlier makes things even easier. It has a <code>plot_grid()</code> function that works much like <code>grid.arrange()</code> while also taking care of some fine details, including the proper alignment of axes across separate plot objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1">cowplot<span class="op">::</span><span class="kw">plot_grid</span>(p1, p2, <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>), <span class="dt">align =</span> <span class="st">"v"</span>)</a></code></pre>
<div class="figure"><span id="fig:fred5"/>
<p class="caption marginnote shownote">
Figure 8.20: Indexed series with a running difference below, using two separate plots.
</p>
<img src="../Images/8f934f33988b58c7b94664bebcd54e6e.png" alt="Indexed series with a running difference below, using two separate plots." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred5-1.png"/>
</div>
<p>The result is shown in Figure <a href="refineplots.html#fig:fred5">8.20</a>. It looks pretty good. In this version, the S&amp;P index runs above the Monetary Base for almost the whole series, whereas in the plot as originally drawn, they crossed.</p>
<p>The broader problem with dual-axis plots of this sort is that the apparent association between these variables is probably spurious. The original plot is enabling our desire to spot patterns, but substantively it is probably the case that both of these time series are tending to increase, but are not otherwise related in any deep way. If we were interested in establishing the true association between them, we might begin by naively regressing one on the other. We can try to predict the S&amp;P Index from the Monetary Base, for instance. If we do that, things look absolutely fantastic to begin with, as we appear to explain about 95% of the variance in the S&amp;P just by knowing the size of the Monetary Base from the same period. We’re going to be rich!</p>
<p>Sadly, we’re probably not going to be rich. While everyone knows that correlation is not causation, with time series data we get this problem twice-over. Even just considering a single series, each observation is often pretty closely correlated with the observation in the period immediately before it, or perhaps with the observation some regular number of periods before it. A time series might have a seasonal component that we would want to account for before making claims about its growth, for example. And if we ask what <em>predicts</em> its growth, then we will introduce some other time series, which will have trend properties of its own. In those circumstances, we more or less automatically violate the assumptions of ordinary regression analysis in a way that produces wildly overconfident estimates of association. The result, which may seem paradoxical when you first run across it, is that a lot of the machinery of time series analysis is about making the serial nature of the data go away.</p>
<p>Like any rule of thumb, it is possible to come up with exceptions, or talk oneself into them. We can imagine situations where the judicious use of dual y-axes might be a sensible way to present data to others, or might help a researcher productively explore a dataset. But in general I recommend against it because is already much too easy to present spurious, or at least overconfident, associations, especially with time series data. Scatterplots can do that just fine. Even with a single series, as we saw back in Chapter <a href="lookatdata.html#lookatdata">1</a>, we can make associations look steeper or flatter by fiddling with the aspect ratio. Using two y-axes gives you an extra degree of freedom to mess about with the data that, in most cases, you really should not take advantage of. A rule like this will not stop people who want to fool you with charts from trying, of course. But it might help you not fool yourself.</p>
</div>
<div id="redrawing-a-bad-slide" class="section level3">
<h3><span class="header-section-number">8.5.2</span> Redrawing a bad slide</h3>
<p>In late 2015, Marissa Mayer’s performance as CEO of Yahoo was being
criticized by many observers. One of them, Eric Jackson, an investment
fund manager, sent a 99-slide presentation to Yahoo’s board outlining
his best case against Mayer. (He also circulated it publicly.) The
style of the slides was typical of business presentations. Slides and
posters are a very useful means of communication. In my experience,
most people who complain about “Death by PowerPoint” have not sat
through enough talks where the presenter hasn’t even bothered to
prepare slides. But it is striking to see how fully the “slide deck”
has escaped its origins as an aid to communication and metastasized
into a freestanding quasi-format of its own. Business, the Military,
and Academia have all been infected by this tendency in various ways.
Never mind taking the time to write a memo or an article, just give us
endless pages of bullet points and charts. The disorienting effect is
of constant summaries of discussions that never took place.</p>
<div class="figure"><span id="fig:ch-08-yahoo-01"/>
<p class="caption marginnote shownote">
Figure 8.21: A bad slide.
</p>
<img src="../Images/bd5cbfa3fb2d27914de43e5af45d1905.png" alt="A bad slide." width="100%" data-original-src="https://socviz.co/assets/ch-08-yahoo-employees-revenue-0.jpg"/>
</div>
<p>In any case, Figure <a href="refineplots.html#fig:ch-08-yahoo-01">8.21</a> reproduces a typical slide from
the deck. It seems to want to say something about the relationship
between Yahoo’s number of employees and its revenue, in the context of
Mayer’s tenure as CEO. The natural thing to do would be to make some
kind of scatterplot to see if there was a relationship between these
variables. Instead, however, the slide puts time on the x-axis and
uses two y-axes to show the employee and revenue data. It plots the
revenues as a bar chart and the employee data as points connected by
slightly wavy lines. At first glance, it is not clear whether the
connecting line segments are just manually added or if there’s some
principle underlying the wiggles. (They turn out to have been created
in Excel.) The revenue values are used as labels within the bars. The
points are not labeled. Employee data goes to 2015 but revenue data
only to 2014. An arrow points to the date Mayer was hired as CEO, and
a red dotted line seems to indicate … actually I’m not sure. Maybe
some sort of threshold below which employee numbers should fall? Or
maybe just the last observed value, to allow comparison across the
series? It isn’t clear. Finally, notice that while the revenue numbers
are annual, there is more than one observation per year for some of
the later employee numbers.</p>
<p>How should we redraw this chart? Let’s focus on getting across the
relationship between employee numbers and revenue, as that seems to be
the motivation for it in the first place. As a secondary element, we
want to say something about Mayer’s role in this relationship. The
original sin of the slide is that it plots two series of numbers using
two different y-axes, as discussed above. We see this from business
analysts more often than not. Time is almost the only thing they
ever put on the x-axis.</p>
<p>To redraw the chart I took the numbers from the bars on the chart
together with employee data from QZ.com. Where there was quarterly
data in the slide, I used the end-of-year number for employees, except
for 2012. Mayer was appointed in July of 2012. Ideally we would have
quarterly revenue and quarterly employee data for all years, but given
that we do not, the most sensible thing to do is to keep things
annualized except for the one year of interest, when Mayer arrives as
CEO. It’s worth doing this because otherwise the large round of
layoffs that immediately preceded her arrival would be misattributed
to her tenure as CEO. The upshot is that we have two observations for
2012 in the dataset. They have the same revenue data but different
employee numbers. The figures can be found in the <code>yahoo</code> dataset.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" data-line-number="1"><span class="kw">head</span>(yahoo)</a></code></pre>
<pre><code>##   Year Revenue Employees Mayer
## 1 2004    3574      7600    No
## 2 2005    5257      9800    No
## 3 2006    6425     11400    No
## 4 2007    6969     14300    No
## 5 2008    7208     13600    No
## 6 2009    6460     13900    No</code></pre>
<p>The redrawing is straightforward. We could just draw a scatterplot and
color the points by whether Mayer was CEO at the time. By now you
should know how to do this quite easily. We can take a small step
further by making a scatterplot but also holding on to the temporal
element beloved of business analysts. We can use <code>geom_path()</code> and use
use line segments to “join the dots” of the yearly observations in
order, labeling each point with its year. The result is a plot that
shows the trajectory of the company over time, like a snail moving
across a flagstone. Again, bear in mind that we have two observations
for 2012.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-yahoo-02"/>
<img src="../Images/26956686ec141c73db47f554f76c6922.png" alt="Redrawing as a connected scatterplot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.22: Redrawing as a connected scatterplot.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb313-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Employees, <span class="dt">y =</span> Revenue))</a>
<a class="sourceLine" id="cb313-3" data-line-number="3">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">color =</span> Mayer, <span class="dt">label =</span> Year),</a>
<a class="sourceLine" id="cb313-5" data-line-number="5">              <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">fontface =</span> <span class="st">"bold"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-6" data-line-number="6"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-7" data-line-number="7"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"Mayer is CEO"</span>,</a>
<a class="sourceLine" id="cb313-8" data-line-number="8">         <span class="dt">x =</span> <span class="st">"Employees"</span>, <span class="dt">y =</span> <span class="st">"Revenue (Millions)"</span>,</a>
<a class="sourceLine" id="cb313-9" data-line-number="9">         <span class="dt">title =</span> <span class="st">"Yahoo Employees vs Revenues, 2004-2014"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-11" data-line-number="11"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>comma)</a></code></pre>
<p>This way of looking at the data suggests that Mayer was appointed
after a period of falling revenues and just following a very large
round of layoffs, a fairly common pattern with the leadership of large
firms. Since then, either through new hires or acquisitions, employee
numbers have crept back up a little while revenues have continued to
fall. This version conveys what the original slide was trying to get
across, but rather more clearly.</p>
<p>Alternatively, we can keep the analyst community happy by putting time
back on the x-axis and plotting the ratio of revenue to employees on
the y-axis. This gives us the linear time-trend trend back, only in a
more sensible fashion. We begin the plot by using <code>geom_vline()</code> to add
a vertical line marking Mayer’s accession to the CEO position.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb314-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Year, <span class="dt">y =</span> Revenue<span class="op">/</span>Employees))</a>
<a class="sourceLine" id="cb314-3" data-line-number="3"/>
<a class="sourceLine" id="cb314-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">2012</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">"gray60"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-6" data-line-number="6"><span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="dv">2013</span>, <span class="dt">y =</span> <span class="fl">0.44</span>,</a>
<a class="sourceLine" id="cb314-7" data-line-number="7">             <span class="dt">label =</span> <span class="st">" Mayer becomes CEO"</span>, <span class="dt">size =</span> <span class="fl">2.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-8" data-line-number="8"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Year</span><span class="ch">\n</span><span class="st">"</span>,</a>
<a class="sourceLine" id="cb314-9" data-line-number="9">         <span class="dt">y =</span> <span class="st">"Revenue/Employees"</span>,</a>
<a class="sourceLine" id="cb314-10" data-line-number="10">         <span class="dt">title =</span> <span class="st">"Yahoo Revenue to Employee Ratio, 2004-2014"</span>)</a></code></pre>
<div class="figure"><span id="fig:ch-08-yahoo-03"/>
<p class="caption marginnote shownote">
Figure 8.23: Plotting the ratio of revenue to employees against time.
</p>
<img src="../Images/5d7979ef42e6e8822633d6ff39e4b879.png" alt="Plotting the ratio of revenue to employees against time." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-03-1.png"/>
</div>
</div>
<div id="saying-no-to-pie" class="section level3">
<h3><span class="header-section-number">8.5.3</span> Saying no to pie</h3>
<p>For a third example, we turn to pie charts. Figure
<a href="refineplots.html#fig:ch-08-debt-piecharts">8.24</a> shows a pair of charts from a New York Federal
Reserve Bank briefing on the structure of debt in the United States
<span class="citation">(Chakrabarti, Haughwout, Lee, Scally, &amp; Klaauw, 2017)</span>. As we saw in Chapter <a href="lookatdata.html#lookatdata">1</a>, the perceptual qualities of pie charts are not great. In a single pie chart, it is usually harder than it should be to estimate and
compare the values shown, especially when there are more than a few
wedges and when there are a number of wedges reasonably close in size.
A Cleveland dot plot or a bar chart is usually a much more
straightforward way of comparing quantities. When comparing the wedges
between two pie charts, as in this case, the task is made harder again
as the viewer has to ping back and forth between the wedges of each
pie and the vertically oriented legend underneath.</p>
<div class="figure"><span id="fig:ch-08-debt-piecharts"/>
<p class="caption marginnote shownote">
Figure 8.24: Data on the structure of US student debts as of 2016.
</p>
<img src="../Images/bcaeddccebb00a59a13d4484637bf6ac.png" alt="Data on the structure of US student debts as of 2016." width="100%" data-original-src="https://socviz.co/assets/ch-08-debt-piecharts.png"/>
</div>
<p>There is an additional wrinkle in this case. The variable broken down
in each pie chart is not only categorical, it is also ordered from low
to high. The data describe the percent of all borrowers and the
percent of all balances divided up across the size of balances owed,
from less than five thousand dollars to more than two hundred thousand
dollars. It’s one thing to use a pie chart to display shares of an
unordered categorical variable, such as percent of total sales due to
pizza, lasanga, and risotto for example. Keeping track of ordered
categories in a pie chart is harder again, especially when we want to
make a comparison between two distributions. The wedges of these two
pie charts <em>are</em> ordered (clockwise, from the top), but it’s not so
easy to follow them. This is partly because of the pie-ness of the
chart, and partly because the color palette chosen for the categories
is not sequential. Instead it is unordered. The colors allow the debt
categories to be distinguished, but don’t pick out the sequence from
low to high values.</p>
<p>So not only is a less than ideal plot type being used here, it’s being
made to do a lot more work than usual, and with the wrong sort of
color palette. As is often the case with pie charts, the compromise
made to facilitate interpretation is to display all of the numerical
values for every wedge, and also to add a summary outside the pie. If
you find yourself having to do this, it’s worth asking whether the
chart could be redrawn, or whether you might as well just show a table
instead.</p>
<p>Here are two ways we might redraw these pie charts. As usual, neither
approach is perfect. Or rather, each approach draws attention to
features of the data in slightly different ways. Which works best
depends on what parts of the data we want to highlight. The data are
in an object called <code>studebt</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1"><span class="kw">head</span>(studebt)</a></code></pre>
<pre><code>## # A tibble: 6 x 4
##   Debt     type        pct Debtrc  
##   &lt;ord&gt;    &lt;fct&gt;     &lt;int&gt; &lt;ord&gt;   
## 1 Under $5 Borrowers    20 Under $5
## 2 $5-$10   Borrowers    17 $5-$10  
## 3 $10-$25  Borrowers    28 $10-$25 
## 4 $25-$50  Borrowers    19 $25-$50 
## 5 $50-$75  Borrowers     8 $50-$75 
## 6 $75-$100 Borrowers     3 $75-$100</code></pre>
<p>Our first effort to redraw the pie charts uses a faceted comparison of
the two distributions. We set up some labels in advance, as we
will reuse them. We also make a special label for the facets.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" data-line-number="1">p_xlab &lt;-<span class="st"> "Amount Owed, in thousands of Dollars"</span></a>
<a class="sourceLine" id="cb317-2" data-line-number="2">p_title &lt;-<span class="st"> "Outstanding Student Loans"</span></a>
<a class="sourceLine" id="cb317-3" data-line-number="3">p_subtitle &lt;-<span class="st"> "44 million borrowers owe a total of $1.3 trillion"</span></a>
<a class="sourceLine" id="cb317-4" data-line-number="4">p_caption &lt;-<span class="st"> "Source: FRB NY"</span></a>
<a class="sourceLine" id="cb317-5" data-line-number="5"/>
<a class="sourceLine" id="cb317-6" data-line-number="6">f_labs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">Borrowers</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Borrowers"</span>,</a>
<a class="sourceLine" id="cb317-7" data-line-number="7">            <span class="st">`</span><span class="dt">Balances</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Balances"</span>)</a>
<a class="sourceLine" id="cb317-8" data-line-number="8"/>
<a class="sourceLine" id="cb317-9" data-line-number="9">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> studebt,</a>
<a class="sourceLine" id="cb317-10" data-line-number="10">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Debt, <span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">fill =</span> type))</a>
<a class="sourceLine" id="cb317-11" data-line-number="11">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-12" data-line-number="12"><span class="st">    </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Dark2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-14" data-line-number="14"><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-15" data-line-number="15"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">strip.text.x =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-16" data-line-number="16"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">x =</span> p_xlab,</a>
<a class="sourceLine" id="cb317-17" data-line-number="17">      <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb317-18" data-line-number="18">      <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb317-19" data-line-number="19">      <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-20" data-line-number="20"><span class="st">    </span><span class="kw">facet_grid</span>(<span class="op">~</span><span class="st"> </span>type, <span class="dt">labeller =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-21" data-line-number="21"><span class="st">    </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure"><span id="fig:ch-08-studentpie-02"/>
<p class="caption marginnote shownote">
Figure 8.25: Faceting the pie charts.
</p>
<img src="../Images/dfb0b1e2d3bda96ec812ca103da70fe5.png" alt="Faceting the pie charts." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-02-1.png"/>
</div>
<p>There is a reasonable amount of customization in this graph. First,
the text of the facets is made bold in the <code>theme()</code> call. The graphical element is first named (<code>strip.text.x</code>) and then modified using the <code>element_text()</code> function. We also use a custom palette for the <code>fill</code> mapping, via <code>scale_fill_brewer()</code>. And finally we relabel the facets to something more informative than their bare
variable names. This is done using the <code>labeller</code> argument and the
<code>as_labeller()</code> function inside the <code>facet_grid()</code> call. At the
beginning of the plotting code, we set up an object called <code>f_labs</code>,
which is in effect a tiny data frame that associates new labels with
the values of the <code>type</code> variable in <code>studebt</code>. We use backticks (the angled quote character located next to the ‘1’ key on US keyboards) to pick out the values we want to relabel. The <code>as_labeller()</code> function takes this object and uses it to create new
text for the labels when <code>facet_grid()</code> is called.</p>
<p>Substantively, how is this plot better than the pie charts? We split
the data into the two categories, and showed the percentage shares as
bars. The percent scores are on the x-axis. Instead of using color to
distinguish the debt categories, we put their values on the y-axis
instead. This means we can compare within a category just by looking
down the bars. For instance, the left-hand panel shows that almost a
fifth of the 44 million people with student debt owe less than five
thousand dollars. Comparisons across categories are now easier as
well, as we can scan across a row to see, for instance, that while
just one percent or so of borrowers have more than $200,000 in debt,
that category accounts for more than 10 percent of all debts.</p>
<p>We could also have made this bar chart by putting the percentages on
the y-axis and the categories of amount owed on the x-axis. When the
categorical axis labels are long, though, I generally find it’s easier
to read them on the y-axis. Finally, while it looks nice and helps a
little to have the two categories of debt distinguished by color, the
colors on the graph are not encoding or mapping any information in the
data that is not already taken care of by the faceting. The <code>fill</code>
mapping is useful, but also redundant. This graph could easily
be in black and white, and would be just as informative if it were.</p>
<p>One thing that is not emphasized in a faceted chart like this is the
idea that each of the debt categories is a share or percentage of a
total amount. That is what a pie chart emphasizes more than anything,
but as we saw there’s a perceptual price to pay for that, especially
when the categories are ordered. But maybe we can hang on to the
emphasis on shares by using a different kind of barplot. Instead of
having separate bars distinguished by heights, we can array the
percentages for each distribution proportionally within a single bar.
We will make a stacked bar chart with just two main bars, and lie them
on their side for comparison.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb318-2" data-line-number="2"/>
<a class="sourceLine" id="cb318-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(studebt, <span class="kw">aes</span>(<span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">x =</span> type, <span class="dt">fill =</span> Debtrc))</a>
<a class="sourceLine" id="cb318-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">labels =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_fill_viridis</span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-8" data-line-number="8"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb318-9" data-line-number="9">                             <span class="dt">title.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-10" data-line-number="10">                             <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</a>
<a class="sourceLine" id="cb318-11" data-line-number="11">                             <span class="dt">keywidth =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb318-12" data-line-number="12">                             <span class="dt">nrow =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb318-14" data-line-number="14">       <span class="dt">fill =</span> <span class="st">"Amount Owed, in thousands of dollars"</span>,</a>
<a class="sourceLine" id="cb318-15" data-line-number="15">       <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb318-16" data-line-number="16">       <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb318-17" data-line-number="17">       <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-19" data-line-number="19">        <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb318-20" data-line-number="20">        <span class="dt">axis.ticks.length =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>),</a>
<a class="sourceLine" id="cb318-21" data-line-number="21">        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-22" data-line-number="22"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure fullwidth"><span id="fig:ch-08-studentpie-03"/>
<img src="../Images/54c15204088e48153d413d8d0635e9c0.png" alt="Debt distributions as horizontally segmented bars." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-03-1.png"/>
<p class="caption marginnote shownote">
Figure 8.26: Debt distributions as horizontally segmented bars.
</p>
</div>
<p>Once again, there is a substantial amount of customization in this
chart. I encourage you to peel it back one option at a time to see how
it changes. We use the <code>as_labeller()</code> with <code>f_labs</code> again, but in the
labels for the x-axis this time. We make a series of adjustments in the <code>theme()</code> call to customize the purely visual elements of the plot, making the y-axis labels larger, right-justified, and bold via <code>element_text()</code>; removing the axis tick marks, and also removing the y-axis grid lines via <code>element_blank()</code>.</p>
<p>More substantively, we take a lot of care about color in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a>. First, we set the border colors of the bars to
a light gray in <code>geom_bar()</code> to make the bar segments easier to
distinguish. Second, we draw on the <code>viridis</code> library again (as we did with our small-multiple maps in Chapter 7), using
<code>scale_fill_viridis()</code> for the color palette. Third, we are careful to map the income
categories in an ascending sequence of colors, and to adjust
the key so that the values run from low to high, from left to right,
and from yellow to purple. This is done partly by switching the <code>fill</code>
mapping from <code>Debt</code> to <code>Debtrc</code>. The categories of the latter are the
same as the former, but the sequence of income levels is coded in the
order we want. We also show the legend to the reader <em>first</em> by putting
it at the top, under the title and subtitle.</p>
<p>The rest of the work is done in the <code>guides()</code> call. We have not used
<code>guides()</code> much thus far except to turn off legends that we did not
want to display. But here we see its usefulness. We give <code>guides()</code> a
series of instructions about the <code>fill</code> mapping: reverse<label for="tufte-mn-84" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-84" class="margin-toggle"/><span class="marginnote shownote"><code>reverse = TRUE</code></span> the direction of the color coding; put<label for="tufte-mn-85" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-85" class="margin-toggle"/><span class="marginnote shownote"><code>title.position</code></span> the legend
title above the key; put<label for="tufte-mn-86" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-86" class="margin-toggle"/><span class="marginnote shownote"><code>label.position</code></span> the labels for the colors below the key; widen<label for="tufte-mn-87" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-87" class="margin-toggle"/><span class="marginnote shownote"><code>keywidth</code></span> the width of the color boxes a little, and place<label for="tufte-mn-88" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-88" class="margin-toggle"/><span class="marginnote shownote"><code>nrow</code></span> the whole key on a single row.</p>
<p>This is a lot of work, relatively speaking, but if you don’t do it the
plot will be much harder to read. Again, I encourage you to peel away
the layers and options in sequence to see how the plot changes. The version in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a> lets us more easily see how the
categories of dollar amounts owed break down as a percentage of all
balances, and as a percent of all borrowers. We can also eyeball
comparisons between the two types, especially at the far end of each
scale. It’s easy to see how a tiny percentage of borrowers account for
a disproportionately large share of total debt, for example. But even
with all of this careful work, estimating the size of each individual
segment is still not as easy here as it is in Figure
<a href="refineplots.html#fig:ch-08-studentpie-02">8.25</a>, the faceted version. This is because it’s harder to
estimate sizes when we don’t have an anchor point or baseline scale to
compare each piece to. (In the faceted plot, that comparison point was
the x-axis.) So the size of the “Under 5” segment in the bottom bar is
much easier to estimate than the size of the “$10-25” bar, for
instance. Our injunction to take care about using stacked bar charts
still has a lot of force, even when we try hard to make the best of
them.</p>
</div>
&#13;

<h3><span class="header-section-number">8.5.1</span> Two y-axes</h3>
<p>In January of 2016, Liz Ann Sonders, Chief Investment Strategist with
Charles Schwab, Inc, tweeted about the apparent correlation between
two economic time series: the Standard and Poor’s 500 stock market
index, and the Monetary Base, a measure of the size of money supply.
The S&amp;P is an index that ranges from about 700 to about 2,100 over the
period of interest (about the last seven years). The Monetary Base
ranges from about 1.5 trillion to 4.1 trillion dollars over the same
period. This means that we can’t plot the two series directly. The
Monetary Base is so much larger that it would meake the S&amp;P 500 series
appear as a flat line at the bottom. While there are several
reasonable ways to address this, people often opt instead to have two
y-axes.</p>
<p>Because it is designed by responsible people, R makes it slightly
tricky to draw graphs with two y-axes. In fact, ggplot rules it out of
order altogether. It is possible to do it using R’s base graphics, if
you insist. Figure <a href="refineplots.html#fig:fred1">8.18</a> shows the result. I will not show
the code here. (You can find it at
<code>https://github.com/kjhealy/two-y-axes</code>.) This is partly because
graphics in base R work very differently from the approach we have
taken throughout this book, so it would just be confusing, and partly
because I do not wish to encourage young people to engage in immoral
acts.</p>
<div class="figure"><span id="fig:fred1"/>
<p class="caption marginnote shownote">
Figure 8.18: Two time series, each with its own y-axis.
</p>
<img src="../Images/041e16ecc2c41f412ffcfe78d4e8ff60.png" alt="Two time series, each with its own y-axis." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred1-1.png"/>
</div>
<p>Most of the time when people draw plots with two y-axes they want to line the series up as closely as possible because they suspect that there’s a substantive association between them, as in this case. The main problem with using two y-axes is that it makes it even easier than usual to fool yourself (or someone else) about the degree of association between the variables. This is because you can adjust the scaling of the axes to relative to one another in way that moves the data series around more or less however you like. For the first half of the graph in Figure <a href="refineplots.html#fig:fred1">8.18</a>, the red Monetary Base line tracks below the blue S&amp;P 500 and is above it for the second half.</p>
<div class="figure"><span id="fig:fred2"/>
<p class="caption marginnote shownote">
Figure 8.19: Variations on two y-axes.
</p>
<img src="../Images/34c65eccc31a8958f15c5cff04bb3f4e.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-1.png"/><img src="../Images/d408a2bf9b1a7abba25ddf5e49458a84.png" alt="Variations on two y-axes." width="50%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred2-2.png"/>
</div>
<p>We can “fix” that by deciding to start the second y-axis at zero, which shifts the Monetary Base line above the S&amp;P line for the first half of the series and below it later on. The first panel in Figure <a href="refineplots.html#fig:fred2">8.19</a> shows the results. The second panel, meanwhile, adjusts the axes so that the axis tracking the S&amp;P starts at zero. The axis tracking the Monetary Base starts around its minimum (as is generally good practice), but now both axes max out around 4,000. The units are different, of course. The 4,000 on the S&amp;P side is an index number, while the Monetary Base number is 4,000 billion dollars. The effect is to flatten out the S&amp;P’s apparent growth quite a bit, muting the association between the two variables substantially. You could tell quite a different story with this one, if you felt like it.</p>
<p>How else might we draw this data? We could use a split- or broken-axis plot to show the two series at the same time. These can be effective sometimes, and they seem to have better perceptual properties than overlayed charts with dual axes <span class="citation">(Isenberg, Bezerianos, Dragicevic, &amp; Fekete, 2011)</span>. They are most useful in cases where the series you are plotting are of the same kind, but of very different magnitudes. That is not the case here.</p>
<p>Another compromise, if the series are not in the same units (or of widely differing magnitudes), is to rescale one of the series (e.g., by dividing or multiplying it by a thousand), or alternatively to index each of them to 100 at the start of the first period, and then plot them both. Index numbers can have complications of their own, but here they allow us use one axis instead of two, and also to calculate a sensible difference between the two series and plot that as well, in a panel below. It can be quite tricky to visually estimate the difference between series, in part because our perceptual tendency is to look for the <em>nearest</em> comparison point in the other series rather than the one directly above or below. Following <span class="citation">Cleveland (1994)</span>, we can also add a panel underneath that tracks the running difference between the two series. We begin by making each plot and storing them in an object. To do this, it will be convenient to fully tidy the data in to a long format, with the indexed series in the key variable and their corresponding scores as the values. We use tidyr’s <code>gather()</code> function for this:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb305-1" data-line-number="1"><span class="kw">head</span>(fredts)</a></code></pre>
<pre><code>##         date  sp500 monbase sp500_i monbase_i
## 1 2009-03-11 696.68 1542228 100.000   100.000
## 2 2009-03-18 766.73 1693133 110.055   109.785
## 3 2009-03-25 799.10 1693133 114.701   109.785
## 4 2009-04-01 809.06 1733017 116.131   112.371
## 5 2009-04-08 830.61 1733017 119.224   112.371
## 6 2009-04-15 852.21 1789878 122.324   116.058</code></pre>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb307-1" data-line-number="1">fredts_m &lt;-<span class="st"> </span>fredts <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">select</span>(date, sp500_i, monbase_i) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb307-2" data-line-number="2"><span class="st">    </span><span class="kw">gather</span>(<span class="dt">key =</span> series, <span class="dt">value =</span> score, sp500_i<span class="op">:</span>monbase_i)</a>
<a class="sourceLine" id="cb307-3" data-line-number="3"/>
<a class="sourceLine" id="cb307-4" data-line-number="4"><span class="kw">head</span>(fredts_m)</a></code></pre>
<pre><code>##         date  series   score
## 1 2009-03-11 sp500_i 100.000
## 2 2009-03-18 sp500_i 110.055
## 3 2009-03-25 sp500_i 114.701
## 4 2009-04-01 sp500_i 116.131
## 5 2009-04-08 sp500_i 119.224
## 6 2009-04-15 sp500_i 122.324</code></pre>
<p>Once the data are tidied in this way we can make our graph.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb309-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts_m,</a>
<a class="sourceLine" id="cb309-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> score,</a>
<a class="sourceLine" id="cb309-3" data-line-number="3">                          <span class="dt">group =</span> series,</a>
<a class="sourceLine" id="cb309-4" data-line-number="4">                          <span class="dt">color =</span> series))</a>
<a class="sourceLine" id="cb309-5" data-line-number="5">p1 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb309-6" data-line-number="6"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-7" data-line-number="7">         <span class="dt">y =</span> <span class="st">"Index"</span>,</a>
<a class="sourceLine" id="cb309-8" data-line-number="8">         <span class="dt">color =</span> <span class="st">"Series"</span>)</a>
<a class="sourceLine" id="cb309-9" data-line-number="9"/>
<a class="sourceLine" id="cb309-10" data-line-number="10">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> fredts,</a>
<a class="sourceLine" id="cb309-11" data-line-number="11">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> date, <span class="dt">y =</span> sp500_i <span class="op">-</span><span class="st"> </span>monbase_i))</a>
<a class="sourceLine" id="cb309-12" data-line-number="12"/>
<a class="sourceLine" id="cb309-13" data-line-number="13">p2 &lt;-<span class="st"> </span>p <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span></a>
<a class="sourceLine" id="cb309-14" data-line-number="14"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Date"</span>,</a>
<a class="sourceLine" id="cb309-15" data-line-number="15">         <span class="dt">y =</span> <span class="st">"Difference"</span>)</a></code></pre>
<p>Now we have our two plots, we want to lay them out nicely. We do not want them to appear in the same plot area, but we do want to compare them. It would be possible to do this with a facet, but that would mean doing a fair amount of data munging to get all three series (the two indices and the difference between them) into the same tidy data frame. An alternative is to make two separate plots and then arrange them just as we like. For instance, have the comparison of the two series take up most of the space, and put the plot of the index differences along the bottom in a smaller area.</p>
<p>The layout engine used by R and ggplot, called <code>grid</code>, does make this possible. It controls the layout and positioning of plot areas and objects at a lower level than ggplot. Programming <code>grid</code> layouts directly takes a little more work than using ggplot’s functions alone. Fortunately, there are some helper libraries that we can use to make things easier. One possibility is to use the <code>gridExtra</code> library. It provides a number of useful functions that let us talk to the grid engine, including <code>grid.arrange()</code>. This function takes a list of plot objects and instructions for how we would like them arranged. The <code>cowplot</code> library we mentioned earlier makes things even easier. It has a <code>plot_grid()</code> function that works much like <code>grid.arrange()</code> while also taking care of some fine details, including the proper alignment of axes across separate plot objects.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb310-1" data-line-number="1">cowplot<span class="op">::</span><span class="kw">plot_grid</span>(p1, p2, <span class="dt">nrow =</span> <span class="dv">2</span>, <span class="dt">rel_heights =</span> <span class="kw">c</span>(<span class="fl">0.75</span>, <span class="fl">0.25</span>), <span class="dt">align =</span> <span class="st">"v"</span>)</a></code></pre>
<div class="figure"><span id="fig:fred5"/>
<p class="caption marginnote shownote">
Figure 8.20: Indexed series with a running difference below, using two separate plots.
</p>
<img src="../Images/8f934f33988b58c7b94664bebcd54e6e.png" alt="Indexed series with a running difference below, using two separate plots." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/fred5-1.png"/>
</div>
<p>The result is shown in Figure <a href="refineplots.html#fig:fred5">8.20</a>. It looks pretty good. In this version, the S&amp;P index runs above the Monetary Base for almost the whole series, whereas in the plot as originally drawn, they crossed.</p>
<p>The broader problem with dual-axis plots of this sort is that the apparent association between these variables is probably spurious. The original plot is enabling our desire to spot patterns, but substantively it is probably the case that both of these time series are tending to increase, but are not otherwise related in any deep way. If we were interested in establishing the true association between them, we might begin by naively regressing one on the other. We can try to predict the S&amp;P Index from the Monetary Base, for instance. If we do that, things look absolutely fantastic to begin with, as we appear to explain about 95% of the variance in the S&amp;P just by knowing the size of the Monetary Base from the same period. We’re going to be rich!</p>
<p>Sadly, we’re probably not going to be rich. While everyone knows that correlation is not causation, with time series data we get this problem twice-over. Even just considering a single series, each observation is often pretty closely correlated with the observation in the period immediately before it, or perhaps with the observation some regular number of periods before it. A time series might have a seasonal component that we would want to account for before making claims about its growth, for example. And if we ask what <em>predicts</em> its growth, then we will introduce some other time series, which will have trend properties of its own. In those circumstances, we more or less automatically violate the assumptions of ordinary regression analysis in a way that produces wildly overconfident estimates of association. The result, which may seem paradoxical when you first run across it, is that a lot of the machinery of time series analysis is about making the serial nature of the data go away.</p>
<p>Like any rule of thumb, it is possible to come up with exceptions, or talk oneself into them. We can imagine situations where the judicious use of dual y-axes might be a sensible way to present data to others, or might help a researcher productively explore a dataset. But in general I recommend against it because is already much too easy to present spurious, or at least overconfident, associations, especially with time series data. Scatterplots can do that just fine. Even with a single series, as we saw back in Chapter <a href="lookatdata.html#lookatdata">1</a>, we can make associations look steeper or flatter by fiddling with the aspect ratio. Using two y-axes gives you an extra degree of freedom to mess about with the data that, in most cases, you really should not take advantage of. A rule like this will not stop people who want to fool you with charts from trying, of course. But it might help you not fool yourself.</p>
&#13;

<h3><span class="header-section-number">8.5.2</span> Redrawing a bad slide</h3>
<p>In late 2015, Marissa Mayer’s performance as CEO of Yahoo was being
criticized by many observers. One of them, Eric Jackson, an investment
fund manager, sent a 99-slide presentation to Yahoo’s board outlining
his best case against Mayer. (He also circulated it publicly.) The
style of the slides was typical of business presentations. Slides and
posters are a very useful means of communication. In my experience,
most people who complain about “Death by PowerPoint” have not sat
through enough talks where the presenter hasn’t even bothered to
prepare slides. But it is striking to see how fully the “slide deck”
has escaped its origins as an aid to communication and metastasized
into a freestanding quasi-format of its own. Business, the Military,
and Academia have all been infected by this tendency in various ways.
Never mind taking the time to write a memo or an article, just give us
endless pages of bullet points and charts. The disorienting effect is
of constant summaries of discussions that never took place.</p>
<div class="figure"><span id="fig:ch-08-yahoo-01"/>
<p class="caption marginnote shownote">
Figure 8.21: A bad slide.
</p>
<img src="../Images/bd5cbfa3fb2d27914de43e5af45d1905.png" alt="A bad slide." width="100%" data-original-src="https://socviz.co/assets/ch-08-yahoo-employees-revenue-0.jpg"/>
</div>
<p>In any case, Figure <a href="refineplots.html#fig:ch-08-yahoo-01">8.21</a> reproduces a typical slide from
the deck. It seems to want to say something about the relationship
between Yahoo’s number of employees and its revenue, in the context of
Mayer’s tenure as CEO. The natural thing to do would be to make some
kind of scatterplot to see if there was a relationship between these
variables. Instead, however, the slide puts time on the x-axis and
uses two y-axes to show the employee and revenue data. It plots the
revenues as a bar chart and the employee data as points connected by
slightly wavy lines. At first glance, it is not clear whether the
connecting line segments are just manually added or if there’s some
principle underlying the wiggles. (They turn out to have been created
in Excel.) The revenue values are used as labels within the bars. The
points are not labeled. Employee data goes to 2015 but revenue data
only to 2014. An arrow points to the date Mayer was hired as CEO, and
a red dotted line seems to indicate … actually I’m not sure. Maybe
some sort of threshold below which employee numbers should fall? Or
maybe just the last observed value, to allow comparison across the
series? It isn’t clear. Finally, notice that while the revenue numbers
are annual, there is more than one observation per year for some of
the later employee numbers.</p>
<p>How should we redraw this chart? Let’s focus on getting across the
relationship between employee numbers and revenue, as that seems to be
the motivation for it in the first place. As a secondary element, we
want to say something about Mayer’s role in this relationship. The
original sin of the slide is that it plots two series of numbers using
two different y-axes, as discussed above. We see this from business
analysts more often than not. Time is almost the only thing they
ever put on the x-axis.</p>
<p>To redraw the chart I took the numbers from the bars on the chart
together with employee data from QZ.com. Where there was quarterly
data in the slide, I used the end-of-year number for employees, except
for 2012. Mayer was appointed in July of 2012. Ideally we would have
quarterly revenue and quarterly employee data for all years, but given
that we do not, the most sensible thing to do is to keep things
annualized except for the one year of interest, when Mayer arrives as
CEO. It’s worth doing this because otherwise the large round of
layoffs that immediately preceded her arrival would be misattributed
to her tenure as CEO. The upshot is that we have two observations for
2012 in the dataset. They have the same revenue data but different
employee numbers. The figures can be found in the <code>yahoo</code> dataset.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb311-1" data-line-number="1"><span class="kw">head</span>(yahoo)</a></code></pre>
<pre><code>##   Year Revenue Employees Mayer
## 1 2004    3574      7600    No
## 2 2005    5257      9800    No
## 3 2006    6425     11400    No
## 4 2007    6969     14300    No
## 5 2008    7208     13600    No
## 6 2009    6460     13900    No</code></pre>
<p>The redrawing is straightforward. We could just draw a scatterplot and
color the points by whether Mayer was CEO at the time. By now you
should know how to do this quite easily. We can take a small step
further by making a scatterplot but also holding on to the temporal
element beloved of business analysts. We can use <code>geom_path()</code> and use
use line segments to “join the dots” of the yearly observations in
order, labeling each point with its year. The result is a plot that
shows the trajectory of the company over time, like a snail moving
across a flagstone. Again, bear in mind that we have two observations
for 2012.</p>
<p>
<span class="marginnote shownote">
<!--
<div class="figure">--><span id="fig:ch-08-yahoo-02"/>
<img src="../Images/26956686ec141c73db47f554f76c6922.png" alt="Redrawing as a connected scatterplot." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-02-1.png"/>
<!--
<p class="caption marginnote">-->Figure 8.22: Redrawing as a connected scatterplot.<!--</p>-->
<!--</div>--></span>
</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb313-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb313-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Employees, <span class="dt">y =</span> Revenue))</a>
<a class="sourceLine" id="cb313-3" data-line-number="3">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_path</span>(<span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-4" data-line-number="4"><span class="st">    </span><span class="kw">geom_text</span>(<span class="kw">aes</span>(<span class="dt">color =</span> Mayer, <span class="dt">label =</span> Year),</a>
<a class="sourceLine" id="cb313-5" data-line-number="5">              <span class="dt">size =</span> <span class="dv">3</span>, <span class="dt">fontface =</span> <span class="st">"bold"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-6" data-line-number="6"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"bottom"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-7" data-line-number="7"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">color =</span> <span class="st">"Mayer is CEO"</span>,</a>
<a class="sourceLine" id="cb313-8" data-line-number="8">         <span class="dt">x =</span> <span class="st">"Employees"</span>, <span class="dt">y =</span> <span class="st">"Revenue (Millions)"</span>,</a>
<a class="sourceLine" id="cb313-9" data-line-number="9">         <span class="dt">title =</span> <span class="st">"Yahoo Employees vs Revenues, 2004-2014"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-10" data-line-number="10"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>dollar) <span class="op">+</span></a>
<a class="sourceLine" id="cb313-11" data-line-number="11"><span class="st">    </span><span class="kw">scale_x_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>comma)</a></code></pre>
<p>This way of looking at the data suggests that Mayer was appointed
after a period of falling revenues and just following a very large
round of layoffs, a fairly common pattern with the leadership of large
firms. Since then, either through new hires or acquisitions, employee
numbers have crept back up a little while revenues have continued to
fall. This version conveys what the original slide was trying to get
across, but rather more clearly.</p>
<p>Alternatively, we can keep the analyst community happy by putting time
back on the x-axis and plotting the ratio of revenue to employees on
the y-axis. This gives us the linear time-trend trend back, only in a
more sensible fashion. We begin the plot by using <code>geom_vline()</code> to add
a vertical line marking Mayer’s accession to the CEO position.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb314-1" data-line-number="1">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> yahoo,</a>
<a class="sourceLine" id="cb314-2" data-line-number="2">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Year, <span class="dt">y =</span> Revenue<span class="op">/</span>Employees))</a>
<a class="sourceLine" id="cb314-3" data-line-number="3"/>
<a class="sourceLine" id="cb314-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_vline</span>(<span class="dt">xintercept =</span> <span class="dv">2012</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-5" data-line-number="5"><span class="st">    </span><span class="kw">geom_line</span>(<span class="dt">color =</span> <span class="st">"gray60"</span>, <span class="dt">size =</span> <span class="dv">2</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-6" data-line-number="6"><span class="st">    </span><span class="kw">annotate</span>(<span class="st">"text"</span>, <span class="dt">x =</span> <span class="dv">2013</span>, <span class="dt">y =</span> <span class="fl">0.44</span>,</a>
<a class="sourceLine" id="cb314-7" data-line-number="7">             <span class="dt">label =</span> <span class="st">" Mayer becomes CEO"</span>, <span class="dt">size =</span> <span class="fl">2.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb314-8" data-line-number="8"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="st">"Year</span><span class="ch">\n</span><span class="st">"</span>,</a>
<a class="sourceLine" id="cb314-9" data-line-number="9">         <span class="dt">y =</span> <span class="st">"Revenue/Employees"</span>,</a>
<a class="sourceLine" id="cb314-10" data-line-number="10">         <span class="dt">title =</span> <span class="st">"Yahoo Revenue to Employee Ratio, 2004-2014"</span>)</a></code></pre>
<div class="figure"><span id="fig:ch-08-yahoo-03"/>
<p class="caption marginnote shownote">
Figure 8.23: Plotting the ratio of revenue to employees against time.
</p>
<img src="../Images/5d7979ef42e6e8822633d6ff39e4b879.png" alt="Plotting the ratio of revenue to employees against time." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-yahoo-03-1.png"/>
</div>
&#13;

<h3><span class="header-section-number">8.5.3</span> Saying no to pie</h3>
<p>For a third example, we turn to pie charts. Figure
<a href="refineplots.html#fig:ch-08-debt-piecharts">8.24</a> shows a pair of charts from a New York Federal
Reserve Bank briefing on the structure of debt in the United States
<span class="citation">(Chakrabarti, Haughwout, Lee, Scally, &amp; Klaauw, 2017)</span>. As we saw in Chapter <a href="lookatdata.html#lookatdata">1</a>, the perceptual qualities of pie charts are not great. In a single pie chart, it is usually harder than it should be to estimate and
compare the values shown, especially when there are more than a few
wedges and when there are a number of wedges reasonably close in size.
A Cleveland dot plot or a bar chart is usually a much more
straightforward way of comparing quantities. When comparing the wedges
between two pie charts, as in this case, the task is made harder again
as the viewer has to ping back and forth between the wedges of each
pie and the vertically oriented legend underneath.</p>
<div class="figure"><span id="fig:ch-08-debt-piecharts"/>
<p class="caption marginnote shownote">
Figure 8.24: Data on the structure of US student debts as of 2016.
</p>
<img src="../Images/bcaeddccebb00a59a13d4484637bf6ac.png" alt="Data on the structure of US student debts as of 2016." width="100%" data-original-src="https://socviz.co/assets/ch-08-debt-piecharts.png"/>
</div>
<p>There is an additional wrinkle in this case. The variable broken down
in each pie chart is not only categorical, it is also ordered from low
to high. The data describe the percent of all borrowers and the
percent of all balances divided up across the size of balances owed,
from less than five thousand dollars to more than two hundred thousand
dollars. It’s one thing to use a pie chart to display shares of an
unordered categorical variable, such as percent of total sales due to
pizza, lasanga, and risotto for example. Keeping track of ordered
categories in a pie chart is harder again, especially when we want to
make a comparison between two distributions. The wedges of these two
pie charts <em>are</em> ordered (clockwise, from the top), but it’s not so
easy to follow them. This is partly because of the pie-ness of the
chart, and partly because the color palette chosen for the categories
is not sequential. Instead it is unordered. The colors allow the debt
categories to be distinguished, but don’t pick out the sequence from
low to high values.</p>
<p>So not only is a less than ideal plot type being used here, it’s being
made to do a lot more work than usual, and with the wrong sort of
color palette. As is often the case with pie charts, the compromise
made to facilitate interpretation is to display all of the numerical
values for every wedge, and also to add a summary outside the pie. If
you find yourself having to do this, it’s worth asking whether the
chart could be redrawn, or whether you might as well just show a table
instead.</p>
<p>Here are two ways we might redraw these pie charts. As usual, neither
approach is perfect. Or rather, each approach draws attention to
features of the data in slightly different ways. Which works best
depends on what parts of the data we want to highlight. The data are
in an object called <code>studebt</code>:</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb315-1" data-line-number="1"><span class="kw">head</span>(studebt)</a></code></pre>
<pre><code>## # A tibble: 6 x 4
##   Debt     type        pct Debtrc  
##   &lt;ord&gt;    &lt;fct&gt;     &lt;int&gt; &lt;ord&gt;   
## 1 Under $5 Borrowers    20 Under $5
## 2 $5-$10   Borrowers    17 $5-$10  
## 3 $10-$25  Borrowers    28 $10-$25 
## 4 $25-$50  Borrowers    19 $25-$50 
## 5 $50-$75  Borrowers     8 $50-$75 
## 6 $75-$100 Borrowers     3 $75-$100</code></pre>
<p>Our first effort to redraw the pie charts uses a faceted comparison of
the two distributions. We set up some labels in advance, as we
will reuse them. We also make a special label for the facets.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb317-1" data-line-number="1">p_xlab &lt;-<span class="st"> "Amount Owed, in thousands of Dollars"</span></a>
<a class="sourceLine" id="cb317-2" data-line-number="2">p_title &lt;-<span class="st"> "Outstanding Student Loans"</span></a>
<a class="sourceLine" id="cb317-3" data-line-number="3">p_subtitle &lt;-<span class="st"> "44 million borrowers owe a total of $1.3 trillion"</span></a>
<a class="sourceLine" id="cb317-4" data-line-number="4">p_caption &lt;-<span class="st"> "Source: FRB NY"</span></a>
<a class="sourceLine" id="cb317-5" data-line-number="5"/>
<a class="sourceLine" id="cb317-6" data-line-number="6">f_labs &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">`</span><span class="dt">Borrowers</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Borrowers"</span>,</a>
<a class="sourceLine" id="cb317-7" data-line-number="7">            <span class="st">`</span><span class="dt">Balances</span><span class="st">`</span> =<span class="st"> "Percent of</span><span class="ch">\n</span><span class="st">all Balances"</span>)</a>
<a class="sourceLine" id="cb317-8" data-line-number="8"/>
<a class="sourceLine" id="cb317-9" data-line-number="9">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(<span class="dt">data =</span> studebt,</a>
<a class="sourceLine" id="cb317-10" data-line-number="10">            <span class="dt">mapping =</span> <span class="kw">aes</span>(<span class="dt">x =</span> Debt, <span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">fill =</span> type))</a>
<a class="sourceLine" id="cb317-11" data-line-number="11">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-12" data-line-number="12"><span class="st">    </span><span class="kw">scale_fill_brewer</span>(<span class="dt">type =</span> <span class="st">"qual"</span>, <span class="dt">palette =</span> <span class="st">"Dark2"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-14" data-line-number="14"><span class="st">    </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="ot">FALSE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-15" data-line-number="15"><span class="st">    </span><span class="kw">theme</span>(<span class="dt">strip.text.x =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-16" data-line-number="16"><span class="st">    </span><span class="kw">labs</span>(<span class="dt">y =</span> <span class="ot">NULL</span>, <span class="dt">x =</span> p_xlab,</a>
<a class="sourceLine" id="cb317-17" data-line-number="17">      <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb317-18" data-line-number="18">      <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb317-19" data-line-number="19">      <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-20" data-line-number="20"><span class="st">    </span><span class="kw">facet_grid</span>(<span class="op">~</span><span class="st"> </span>type, <span class="dt">labeller =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb317-21" data-line-number="21"><span class="st">    </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure"><span id="fig:ch-08-studentpie-02"/>
<p class="caption marginnote shownote">
Figure 8.25: Faceting the pie charts.
</p>
<img src="../Images/dfb0b1e2d3bda96ec812ca103da70fe5.png" alt="Faceting the pie charts." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-02-1.png"/>
</div>
<p>There is a reasonable amount of customization in this graph. First,
the text of the facets is made bold in the <code>theme()</code> call. The graphical element is first named (<code>strip.text.x</code>) and then modified using the <code>element_text()</code> function. We also use a custom palette for the <code>fill</code> mapping, via <code>scale_fill_brewer()</code>. And finally we relabel the facets to something more informative than their bare
variable names. This is done using the <code>labeller</code> argument and the
<code>as_labeller()</code> function inside the <code>facet_grid()</code> call. At the
beginning of the plotting code, we set up an object called <code>f_labs</code>,
which is in effect a tiny data frame that associates new labels with
the values of the <code>type</code> variable in <code>studebt</code>. We use backticks (the angled quote character located next to the ‘1’ key on US keyboards) to pick out the values we want to relabel. The <code>as_labeller()</code> function takes this object and uses it to create new
text for the labels when <code>facet_grid()</code> is called.</p>
<p>Substantively, how is this plot better than the pie charts? We split
the data into the two categories, and showed the percentage shares as
bars. The percent scores are on the x-axis. Instead of using color to
distinguish the debt categories, we put their values on the y-axis
instead. This means we can compare within a category just by looking
down the bars. For instance, the left-hand panel shows that almost a
fifth of the 44 million people with student debt owe less than five
thousand dollars. Comparisons across categories are now easier as
well, as we can scan across a row to see, for instance, that while
just one percent or so of borrowers have more than $200,000 in debt,
that category accounts for more than 10 percent of all debts.</p>
<p>We could also have made this bar chart by putting the percentages on
the y-axis and the categories of amount owed on the x-axis. When the
categorical axis labels are long, though, I generally find it’s easier
to read them on the y-axis. Finally, while it looks nice and helps a
little to have the two categories of debt distinguished by color, the
colors on the graph are not encoding or mapping any information in the
data that is not already taken care of by the faceting. The <code>fill</code>
mapping is useful, but also redundant. This graph could easily
be in black and white, and would be just as informative if it were.</p>
<p>One thing that is not emphasized in a faceted chart like this is the
idea that each of the debt categories is a share or percentage of a
total amount. That is what a pie chart emphasizes more than anything,
but as we saw there’s a perceptual price to pay for that, especially
when the categories are ordered. But maybe we can hang on to the
emphasis on shares by using a different kind of barplot. Instead of
having separate bars distinguished by heights, we can array the
percentages for each distribution proportionally within a single bar.
We will make a stacked bar chart with just two main bars, and lie them
on their side for comparison.</p>
<p class="sourceCode"/><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb318-1" data-line-number="1"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb318-2" data-line-number="2"/>
<a class="sourceLine" id="cb318-3" data-line-number="3">p &lt;-<span class="st"> </span><span class="kw">ggplot</span>(studebt, <span class="kw">aes</span>(<span class="dt">y =</span> pct<span class="op">/</span><span class="dv">100</span>, <span class="dt">x =</span> type, <span class="dt">fill =</span> Debtrc))</a>
<a class="sourceLine" id="cb318-4" data-line-number="4">p <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="dt">stat =</span> <span class="st">"identity"</span>, <span class="dt">color =</span> <span class="st">"gray80"</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-5" data-line-number="5"><span class="st">  </span><span class="kw">scale_x_discrete</span>(<span class="dt">labels =</span> <span class="kw">as_labeller</span>(f_labs)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-6" data-line-number="6"><span class="st">  </span><span class="kw">scale_y_continuous</span>(<span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-7" data-line-number="7"><span class="st">  </span><span class="kw">scale_fill_viridis</span>(<span class="dt">discrete =</span> <span class="ot">TRUE</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-8" data-line-number="8"><span class="st">  </span><span class="kw">guides</span>(<span class="dt">fill =</span> <span class="kw">guide_legend</span>(<span class="dt">reverse =</span> <span class="ot">TRUE</span>,</a>
<a class="sourceLine" id="cb318-9" data-line-number="9">                             <span class="dt">title.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-10" data-line-number="10">                             <span class="dt">label.position =</span> <span class="st">"bottom"</span>,</a>
<a class="sourceLine" id="cb318-11" data-line-number="11">                             <span class="dt">keywidth =</span> <span class="dv">3</span>,</a>
<a class="sourceLine" id="cb318-12" data-line-number="12">                             <span class="dt">nrow =</span> <span class="dv">1</span>)) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-13" data-line-number="13"><span class="st">  </span><span class="kw">labs</span>(<span class="dt">x =</span> <span class="ot">NULL</span>, <span class="dt">y =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb318-14" data-line-number="14">       <span class="dt">fill =</span> <span class="st">"Amount Owed, in thousands of dollars"</span>,</a>
<a class="sourceLine" id="cb318-15" data-line-number="15">       <span class="dt">caption =</span> p_caption,</a>
<a class="sourceLine" id="cb318-16" data-line-number="16">       <span class="dt">title =</span> p_title,</a>
<a class="sourceLine" id="cb318-17" data-line-number="17">       <span class="dt">subtitle =</span> p_subtitle) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-18" data-line-number="18"><span class="st">  </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">"top"</span>,</a>
<a class="sourceLine" id="cb318-19" data-line-number="19">        <span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">face =</span> <span class="st">"bold"</span>, <span class="dt">hjust =</span> <span class="dv">1</span>, <span class="dt">size =</span> <span class="dv">12</span>),</a>
<a class="sourceLine" id="cb318-20" data-line-number="20">        <span class="dt">axis.ticks.length =</span> <span class="kw">unit</span>(<span class="dv">0</span>, <span class="st">"cm"</span>),</a>
<a class="sourceLine" id="cb318-21" data-line-number="21">        <span class="dt">panel.grid.major.y =</span> <span class="kw">element_blank</span>()) <span class="op">+</span></a>
<a class="sourceLine" id="cb318-22" data-line-number="22"><span class="st">  </span><span class="kw">coord_flip</span>()</a></code></pre>
<div class="figure fullwidth"><span id="fig:ch-08-studentpie-03"/>
<img src="../Images/54c15204088e48153d413d8d0635e9c0.png" alt="Debt distributions as horizontally segmented bars." width="100%" data-original-src="https://socviz.co/dataviz-pdfl_files/figure-html4/ch-08-studentpie-03-1.png"/>
<p class="caption marginnote shownote">
Figure 8.26: Debt distributions as horizontally segmented bars.
</p>
</div>
<p>Once again, there is a substantial amount of customization in this
chart. I encourage you to peel it back one option at a time to see how
it changes. We use the <code>as_labeller()</code> with <code>f_labs</code> again, but in the
labels for the x-axis this time. We make a series of adjustments in the <code>theme()</code> call to customize the purely visual elements of the plot, making the y-axis labels larger, right-justified, and bold via <code>element_text()</code>; removing the axis tick marks, and also removing the y-axis grid lines via <code>element_blank()</code>.</p>
<p>More substantively, we take a lot of care about color in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a>. First, we set the border colors of the bars to
a light gray in <code>geom_bar()</code> to make the bar segments easier to
distinguish. Second, we draw on the <code>viridis</code> library again (as we did with our small-multiple maps in Chapter 7), using
<code>scale_fill_viridis()</code> for the color palette. Third, we are careful to map the income
categories in an ascending sequence of colors, and to adjust
the key so that the values run from low to high, from left to right,
and from yellow to purple. This is done partly by switching the <code>fill</code>
mapping from <code>Debt</code> to <code>Debtrc</code>. The categories of the latter are the
same as the former, but the sequence of income levels is coded in the
order we want. We also show the legend to the reader <em>first</em> by putting
it at the top, under the title and subtitle.</p>
<p>The rest of the work is done in the <code>guides()</code> call. We have not used
<code>guides()</code> much thus far except to turn off legends that we did not
want to display. But here we see its usefulness. We give <code>guides()</code> a
series of instructions about the <code>fill</code> mapping: reverse<label for="tufte-mn-84" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-84" class="margin-toggle"/><span class="marginnote shownote"><code>reverse = TRUE</code></span> the direction of the color coding; put<label for="tufte-mn-85" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-85" class="margin-toggle"/><span class="marginnote shownote"><code>title.position</code></span> the legend
title above the key; put<label for="tufte-mn-86" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-86" class="margin-toggle"/><span class="marginnote shownote"><code>label.position</code></span> the labels for the colors below the key; widen<label for="tufte-mn-87" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-87" class="margin-toggle"/><span class="marginnote shownote"><code>keywidth</code></span> the width of the color boxes a little, and place<label for="tufte-mn-88" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-88" class="margin-toggle"/><span class="marginnote shownote"><code>nrow</code></span> the whole key on a single row.</p>
<p>This is a lot of work, relatively speaking, but if you don’t do it the
plot will be much harder to read. Again, I encourage you to peel away
the layers and options in sequence to see how the plot changes. The version in Figure
<a href="refineplots.html#fig:ch-08-studentpie-03">8.26</a> lets us more easily see how the
categories of dollar amounts owed break down as a percentage of all
balances, and as a percent of all borrowers. We can also eyeball
comparisons between the two types, especially at the far end of each
scale. It’s easy to see how a tiny percentage of borrowers account for
a disproportionately large share of total debt, for example. But even
with all of this careful work, estimating the size of each individual
segment is still not as easy here as it is in Figure
<a href="refineplots.html#fig:ch-08-studentpie-02">8.25</a>, the faceted version. This is because it’s harder to
estimate sizes when we don’t have an anchor point or baseline scale to
compare each piece to. (In the faceted plot, that comparison point was
the x-axis.) So the size of the “Under 5” segment in the bottom bar is
much easier to estimate than the size of the “$10-25” bar, for
instance. Our injunction to take care about using stacked bar charts
still has a lot of force, even when we try hard to make the best of
them.</p>
&#13;

<h2><span class="header-section-number">8.6</span> Where to go next</h2>
<p>We have reached the end of our introduction. From here on, you should be in a strong position to forge ahead in two main ways. The first is to become more confident and practised with your coding. Learning ggplot should encourage you to learn more about the set of tidyverse tools, and then by extension to learn more about R in general. What you choose to pursue will (and should) be driven by your own needs and interests as a scholar or data scientist. The most natural text to look at next is Garrett Grolemund<label for="tufte-mn-89" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-89" class="margin-toggle"/><span class="marginnote shownote"><code>r4ds.had.co.nz/</code></span> and Hadley Wickham’s <em>R for Data Science</em> <span class="citation">(Wickham &amp; Grolemund, 2016)</span>, which introduces tidyverse components that we have drawn on here but not pursued in depth. Other useful texts include <span class="citation">Chang (2013)</span> and Roger<label for="tufte-mn-90" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-90" class="margin-toggle"/><span class="marginnote shownote"><code>leanpub.com/rprogramming</code></span> Peng’s <em>R Programming for Data Science</em> (2016). The most thorough introduction to ggplot in particular can be found in <span class="citation">Wickham (2016)</span>.</p>
<p>Pushing ahead to use ggplot for new kinds of graphs will eventually get you to the point where ggplot does not quite do what you need, or does not quite provide the sort of geom you want. In that case, the first place to look is the world of extensions to the ggplot framework. We have used a few extensions in the book already. Like ggrepel and ggridges, extensions typically provide a new geoms or two to work with, which may be just what you need. Sometimes, as with Thomas Lin Pedersen’s <code>ggraph</code>, you get a whole family of geoms and associated tools—in <code>ggraph</code>’s case, a suite of tidy methods for the visualization of network data. Other modeling and analysis tasks may require more custom work, or coding that is closely connected to the kind of analysis being done. <span class="citation">Harrell (2016)</span> provides many clearly worked examples, mostly based on ggplot; <span class="citation">Gelman &amp; Hill (2018)</span> and <span class="citation">(Imai, 2017)</span> also introduce contemporary methods using R; <span class="citation">(Silge &amp; Robinson, 2017)</span> present a tidy approach to analyzing and visualizing textual data; while <span class="citation">Friendly &amp; Meyer (2017)</span> thoroughly explore the analysis of discrete data, an area that is often challenging to approach visually.</p>
<p>The second way you should push ahead is by looking at and thinking about other people’s graphs. The R Graph Gallery<label for="tufte-mn-92" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-92" class="margin-toggle"/><span class="marginnote shownote"><code>r-graph-gallery.com</code></span>, run by Yan Holtz, is a useful collection of examples of many kinds of graphics drawn with ggplot and other R tools. PolicyViz<label for="tufte-mn-93" class="margin-toggle">⊕</label><input type="checkbox" id="tufte-mn-93" class="margin-toggle"/><span class="marginnote shownote"><code>policyviz.com</code></span>, a site run by Jon Schwabish, covers a range of topics on data visualization. It regularly features case-studies where visualizations are reworked to improve them or cast new light on the data they present. But do not just look for examples that have code with them to begin with. As I have said before, a real strength of ggplot is the grammar of graphic that underpins it. That grammar is a model you can use to look at and interpret <em>any</em> graph, no matter how it was produced. It gives you a vocabulary that lets you say what the data, mappings, geoms, scales, guides, and layers of any particular graph might be. And because the grammar is implemented as the ggplot library, it is a short step from being able to anatomize the structure of a graph to being able to sketch an outline of the code you could write to reproduce it yourself.</p>
<p>While its underlying principles and goals are relatively stable, the techniques and tools of research are changing. This is especially true within the social sciences <span class="citation">(Salganik, 2018)</span>. Data visualization is an excellent entry-point to these new developments. Our tools for it are more versatile and powerful than ever. So, you should look at your data. Looking is not a replacement for thinking. It cannot force you to be honest; it cannot magically prevent you from making mistakes; and it cannot make your ideas true. But if you analyze data, visualization can help you uncover features in it. If you are honest, it can help you live up to your own standards. When you inevitably make errors, it can help you find and correct them. And if you have an idea and some good evidence for it, it can help you show it in a compelling way.</p>

    
</body>
</html>