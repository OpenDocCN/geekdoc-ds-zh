["```py\nlibrary(arrow)\nlibrary(broom.mixed)\nlibrary(gutenbergr)\nlibrary(haven)\nlibrary(labelled)\nlibrary(modelsummary)\nlibrary(rstanarm)\nlibrary(tidybayes)\nlibrary(tidyverse)\nlibrary(tinytable)\n```", "```py\nset.seed(853)\n\npop_size <- 1000000\n\nsim_population <-\n tibble(\n age = rbinom(n = pop_size, size = 1, prob = 0.5),\n nationality = rbinom(n = pop_size, size = 1, prob = 0.5),\n probability = (age + nationality + 0.1) / 2.2, # prevent certainty\n prefers_tea = rbinom(n = pop_size, 1, prob = probability)\n ) \n\nsim_population\n```", "```py\n# A tibble: 1,000,000 × 4\n     age nationality probability prefers_tea\n   <int>       <int>       <dbl>       <int>\n 1     0           1      0.5              0\n 2     0           0      0.0455           0\n 3     0           1      0.5              1\n 4     0           0      0.0455           0\n 5     0           0      0.0455           0\n 6     0           0      0.0455           0\n 7     0           1      0.5              0\n 8     0           0      0.0455           0\n 9     0           1      0.5              1\n10     0           0      0.0455           0\n# ℹ 999,990 more rows\n```", "```py\nsim_population |>\n count(age, nationality, prefers_tea) |> \n tt() |> \n style_tt(j = 1:4, align = \"lllr\") |> \n format_tt(digits = 0, num_mark_big = \",\", num_fmt = \"decimal\") |> \n setNames( c(\"Age\", \"Nationality\", \"Prefers tea\", \"Number\"))\n```", "```py\nset.seed(853)\n\ntea_sample <- \n sim_population |> \n slice_sample(n = 1000, weight_by = probability)\n```", "```py\ntea_sample |>\n count(age, nationality, prefers_tea) |> \n tt() |> \n style_tt(j = 1:4, align = \"lllr\") |> \n format_tt(digits = 0, num_mark_big = \",\", num_fmt = \"decimal\") |> \n setNames(c(\"Age\", \"Nationality\", \"Prefers tea\", \"Number\"))\n```", "```py\ntea_preference_model <-\n stan_glmer(\n prefers_tea ~ (1 | age) + (1 | nationality),\n data = tea_sample,\n family = binomial(link = \"logit\"),\n prior = normal(location = 0, scale = 0.5, autoscale = TRUE),\n prior_intercept = normal(location = 0, scale = 0.5, autoscale = TRUE),\n seed = 853\n )\n\nsaveRDS(\n tea_preference_model,\n file = \"tea_preference_model.rds\"\n)\n```", "```py\ntea_preference_model <-\n readRDS(file = \"tea_preference_model.rds\")\n```", "```py\nmodelsummary(\n list(\n \"Tea preferences\" = tea_preference_model\n )\n)\n```", "```py\ntea_preference_model |>\n spread_draws(`(Intercept)`, b[, group]) |>\n mutate(condition_mean = `(Intercept)` + b) |>\n ggplot(aes(y = group, x = condition_mean)) +\n stat_halfeye() +\n theme_minimal()\n```", "```py\nset.seed(853)\n\ntea_poststrat_dataset <- \n sim_population |> \n slice_sample(n = 10000) |> \n select(-prefers_tea)\n\ntea_poststrat_dataset\n```", "```py\n# A tibble: 10,000 × 3\n     age nationality probability\n   <int>       <int>       <dbl>\n 1     0           1      0.5   \n 2     0           1      0.5   \n 3     0           1      0.5   \n 4     0           1      0.5   \n 5     1           0      0.5   \n 6     1           0      0.5   \n 7     0           0      0.0455\n 8     1           0      0.5   \n 9     1           0      0.5   \n10     1           0      0.5   \n# ℹ 9,990 more rows\n```", "```py\npredicted_tea_preference <-\n tea_preference_model |>\n add_epred_draws(newdata = tea_poststrat_dataset,\n value = \"preference\") |>\n ungroup() |>\n summarise(\n average_preference = mean(preference),\n lower = quantile(preference, 0.025),\n upper = quantile(preference, 0.975),\n .by = c(age, nationality, .row)\n )\n\npredicted_tea_preference |>\n count(age, nationality, average_preference)\n```", "```py\n# A tibble: 4 × 4\n    age nationality average_preference     n\n  <int>       <int>              <dbl> <int>\n1     0           0             0.0657  2416\n2     0           1             0.528   2505\n3     1           0             0.496   2544\n4     1           1             0.941   2535\n```", "```py\ncomparison <- tibble(\n Type = c(\"Truth\", \"Biased sample\", \"MRP estimate\"),\n Estimate = c(\n mean(sim_population$prefers_tea),\n mean(tea_sample$prefers_tea),\n mean(predicted_tea_preference$average_preference)\n )\n)\n\ncomparison |> \n tt() |> \n style_tt(j = 1:2, align = \"lr\") |> \n format_tt(digits = 2, num_mark_big = \",\", num_fmt = \"decimal\")\n```", "```py\nnationscape_data <- \n read_csv(file = \"nationscape_data.csv\")\n```", "```py\nnationscape_data\n```", "```py\n# A tibble: 5,200 × 5\n   gender state vote_biden age_group education_level    \n * <chr>  <chr>      <dbl> <chr>     <chr>              \n 1 female WI             0 45-59     Post sec +         \n 2 female VA             0 45-59     Post sec +         \n 3 female TX             0 60+       High school or less\n 4 female WA             0 45-59     High school or less\n 5 female MA             1 18-29     Some post sec      \n 6 female TX             1 30-44     Some post sec      \n 7 female CA             0 60+       Some post sec      \n 8 female NC             0 45-59     Post sec +         \n 9 female MD             0 60+       Post sec +         \n10 female FL             1 45-59     Some post sec      \n# ℹ 5,190 more rows\n```", "```py\n# Format state names to match IPUMS\nstates_names_and_abbrevs <-\n tibble(stateicp = state.name, state = state.abb)\n\nnationscape_data <-\n nationscape_data |>\n left_join(states_names_and_abbrevs, by = \"state\")\n\nrm(states_names_and_abbrevs)\n\n# Make lowercase to match IPUMS data\nnationscape_data <-\n nationscape_data |>\n mutate(stateicp = tolower(stateicp))\n\n# Replace NAs with DC\nnationscape_data$stateicp <-\n replace_na(nationscape_data$stateicp, \"district of columbia\")\n\n# Tidy the class\nnationscape_data <-\n nationscape_data |>\n mutate(across(c(gender, stateicp, education_level, age_group), \n as_factor))\n```", "```py\nwrite_parquet(x = nationscape_data,\n sink = \"nationscape_data_cleaned.parquet\")\n```", "```py\npoststrat_data\n```", "```py\n# A tibble: 407,354 × 4\n   gender age_group education_level     stateicp\n * <fct>  <fct>     <fct>               <fct>   \n 1 male   60+       High school or less alabama \n 2 male   60+       Some post sec       alabama \n 3 male   18-29     High school or less alabama \n 4 female 18-29     Some post sec       alabama \n 5 male   30-44     Some post sec       alabama \n 6 female 18-29     High school or less alabama \n 7 female 60+       High school or less alabama \n 8 female 18-29     Some post sec       alabama \n 9 male   60+       High school or less alabama \n10 male   45-59     High school or less alabama \n# ℹ 407,344 more rows\n```", "```py\npoststrat_data_cells <-\n poststrat_data |>\n count(stateicp, gender, age_group, education_level)\n```", "```py\npoststrat_data_cells <-\n poststrat_data_cells |>\n mutate(prop = n / sum(n),\n .by = stateicp)\n\npoststrat_data_cells\n```", "```py\n# A tibble: 1,627 × 6\n   stateicp    gender age_group education_level         n    prop\n   <fct>       <fct>  <fct>     <fct>               <int>   <dbl>\n 1 connecticut male   18-29     High school or less   194 0.0419 \n 2 connecticut male   18-29     Some post sec         128 0.0276 \n 3 connecticut male   18-29     Post sec +             72 0.0156 \n 4 connecticut male   18-29     Grad degree            14 0.00302\n 5 connecticut male   30-44     High school or less   132 0.0285 \n 6 connecticut male   30-44     Some post sec          93 0.0201 \n 7 connecticut male   30-44     Post sec +            147 0.0317 \n 8 connecticut male   30-44     Grad degree            88 0.0190 \n 9 connecticut male   45-59     High school or less   187 0.0404 \n10 connecticut male   45-59     Some post sec          88 0.0190 \n# ℹ 1,617 more rows\n```", "```py\nnationscape_data <- \n read_parquet(file = \"nationscape_data_cleaned.parquet\")\n```", "```py\nus_election_model <-\n stan_glmer(\n vote_biden ~ gender + (1|age_group) + (1|stateicp) + (1|education_level),\n data = nationscape_data,\n family = binomial(link = \"logit\"),\n prior = normal(location = 0, scale = 2.5, autoscale = TRUE),\n prior_intercept = normal(location = 0, scale = 2.5, autoscale = TRUE),\n cores = 4,\n adapt_delta = 0.99,\n seed = 853\n )\n```", "```py\nsaveRDS(\n us_election_model,\n file = \"us_election_model_mrp.rds\"\n)\n```", "```py\nus_election_model <-\n readRDS(file = \"us_election_model_mrp.rds\")\n```", "```py\nmodelsummary(\n us_election_model\n)\n```", "```py\nus_election_model |>\n spread_draws(`(Intercept)`, b[, group]) |>\n mutate(condition_mean = `(Intercept)` + b) |>\n separate(col = group, \n into = c(\"type\", \"instance\"), \n sep = \":\", remove = FALSE) |> \n filter(type != \"stateicp\") |> \n ggplot(aes(y = group, x = condition_mean)) +\n stat_halfeye() +\n theme_minimal()\n```", "```py\nus_election_model |>\n spread_draws(`(Intercept)`, b[, group]) |>\n mutate(condition_mean = `(Intercept)` + b) |>\n separate(col = group, into = c(\"type\", \"instance\"), sep = \":\", remove = FALSE) |> \n filter(type == \"stateicp\") |> \n filter(instance %in% \n c(\"california\", \"florida\", \"michigan\", \"new_york\", \"pennsylvania\", \n \"vermont\", \"west_virginia\", \"wisconsin\")\n ) |> \n ggplot(aes(y = group, x = condition_mean)) +\n stat_halfeye() +\n theme_minimal()\n```", "```py\nbiden_support_by_state <-\n us_election_model |>\n add_epred_draws(newdata = poststrat_data_cells) |>\n rename(support_biden_predict = .epred) |>\n mutate(support_biden_predict_prop = support_biden_predict * prop) |>\n ungroup() |> \n summarise(support_biden_predict = sum(support_biden_predict_prop),\n .by = c(stateicp, .draw)) |>\n summarise(\n mean = mean(support_biden_predict),\n lower = quantile(support_biden_predict, 0.025),\n upper = quantile(support_biden_predict, 0.975),\n .by = stateicp\n )\n\nhead(biden_support_by_state)\n```", "```py\n# A tibble: 6 × 4\n  stateicp       mean lower upper\n  <fct>         <dbl> <dbl> <dbl>\n1 connecticut   0.624 0.284 0.884\n2 maine         0.535 0.211 0.840\n3 massachusetts 0.623 0.292 0.884\n4 new hampshire 0.531 0.201 0.834\n5 rhode island  0.540 0.206 0.841\n6 vermont       0.582 0.256 0.872\n```", "```py\nbiden_support_by_state |>\n ggplot(aes(y = mean, x = fct_reorder(stateicp, mean), \n color = \"MRP estimate\")) +\n geom_point() +\n geom_errorbar(aes(ymin = lower, ymax = upper), width = 0) +\n geom_point(\n data = nationscape_data |>\n summarise(n = n(),\n .by = c(stateicp, vote_biden)) |>\n mutate(prop = n / sum(n),\n .by = stateicp) |>\n filter(vote_biden == 1),\n aes(y = prop, x = stateicp, color = \"Nationscape raw data\")\n ) +\n geom_hline(yintercept = 0.5, linetype = \"dashed\") +\n labs(\n x = \"State\",\n y = \"Estimated proportion support for Biden\",\n color = \"Source\"\n ) +\n theme_classic() +\n scale_color_brewer(palette = \"Set1\") +\n coord_flip() +\n theme(legend.position = \"bottom\")\n```"]