["```py\nlibrary(beepr)\nlibrary(broom)\nlibrary(broom.mixed)\nlibrary(modelsummary)\nlibrary(purrr)\nlibrary(rstanarm)\nlibrary(testthat)\nlibrary(tictoc)\nlibrary(tidyverse)\nlibrary(tinytable)\n```", "```py\nset.seed(853)\n\nnormal_example <-\n tibble(draws = rnorm(n = 20, mean = 0, sd = 1))\n\nnormal_example |> pull(draws)\n```", "```py\n [1] -0.35980342 -0.04064753 -1.78216227 -1.12242282 -1.00278400  1.77670433\n [7] -1.38825825 -0.49749494 -0.55798959 -0.82438245  1.66877818 -0.68196486\n[13]  0.06519751 -0.25985911  0.32900796 -0.43696568 -0.32288891  0.11455483\n[19]  0.84239206  0.34248268\n```", "```py\nestimated_mean <-\n sum(normal_example$draws) / nrow(normal_example)\n\nnormal_example <-\n normal_example |>\n mutate(diff_square = (draws - estimated_mean) ^ 2)\n\nestimated_standard_deviation <-\n sqrt(sum(normal_example$diff_square) / (nrow(normal_example) - 1))\n\nestimated_standard_error <-\n estimated_standard_deviation / sqrt(nrow(normal_example))\n\ntibble(mean = estimated_mean,\n sd = estimated_standard_deviation,\n se = estimated_standard_error) |> \n tt() |> \n style_tt(j = 1:3, align = \"lrr\") |> \n format_tt(digits = 2, num_mark_big = \",\", num_fmt = \"decimal\") |> \n setNames(c(\n \"Estimated mean\",\n \"Estimated standard deviation\",\n \"Estimated standard error\"\n ))\n```", "```py\nset.seed(853)\n\nnormal_takes_shapes <-\n map_dfr(c(2, 5, 10, 50, 100, 500, 1000, 10000, 100000),\n ~ tibble(\n number_draws = rep(paste(.x, \"draws\"), .x),\n draws = rnorm(.x, mean = 0, sd = 1)\n ))\n\nnormal_takes_shapes |>\n mutate(number_draws = as_factor(number_draws)) |>\n ggplot(aes(x = draws)) +\n geom_density() +\n theme_minimal() +\n facet_wrap(vars(number_draws),\n scales = \"free_y\") +\n labs(x = \"Draw\",\n y = \"Density\")\n```", "```py\nset.seed(853)\n\nnum_observations <- 200\nexpected_relationship <- 8.4\nfast_time <- 15\ngood_time <- 30\n\nsim_run_data <-\n tibble(\n five_km_time =\n runif(n = num_observations, min = fast_time, max = good_time),\n noise = rnorm(n = num_observations, mean = 0, sd = 20),\n marathon_time = five_km_time * expected_relationship + noise\n ) |>\n mutate(\n five_km_time = round(x = five_km_time, digits = 1),\n marathon_time = round(x = marathon_time, digits = 1)\n ) |>\n select(-noise)\n```", "```py\nbase_plot <- \n sim_run_data |>\n ggplot(aes(x = five_km_time, y = marathon_time)) +\n geom_point(alpha = 0.5) +\n labs(\n x = \"Five-kilometer time (minutes)\",\n y = \"Marathon time (minutes)\"\n ) +\n theme_classic()\n\n# Panel (a)\nbase_plot\n\n# Panel (b)\nbase_plot +\n geom_smooth(\n method = \"lm\",\n se = FALSE,\n color = \"black\",\n linetype = \"dashed\",\n formula = \"y ~ x\"\n )\n\n# Panel (c)\nbase_plot +\n geom_smooth(\n method = \"lm\",\n se = TRUE,\n color = \"black\",\n linetype = \"dashed\",\n formula = \"y ~ x\"\n )\n```", "```py\n# Check the class and number of observations are as expected\nstopifnot(\n class(sim_run_data$marathon_time) == \"numeric\",\n class(sim_run_data$five_km_time) == \"numeric\",\n nrow(sim_run_data) == 200\n)\n\nsim_run_data_first_model <-\n lm(\n marathon_time ~ five_km_time,\n data = sim_run_data\n )\n\nstopifnot(between(\n sim_run_data_first_model$coefficients[2],\n 6,\n 10\n))\n```", "```py\nsummary(sim_run_data_first_model)\n```", "```py\n Call:\nlm(formula = marathon_time ~ five_km_time, data = sim_run_data)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-49.289 -11.948   0.153  11.396  46.511 \n\nCoefficients:\n             Estimate Std. Error t value Pr(>|t|)    \n(Intercept)    4.4692     6.7517   0.662    0.509    \nfive_km_time   8.2049     0.3005  27.305   <2e-16 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 17.42 on 198 degrees of freedom\nMultiple R-squared:  0.7902,    Adjusted R-squared:  0.7891 \nF-statistic: 745.5 on 1 and 198 DF,  p-value: < 2.2e-16\n```", "```py\nmodelsummary(\n list(\n \"Five km only\" = sim_run_data_first_model,\n \"Five km only, centered\" = sim_run_data_centered_model\n ),\n fmt = 2\n)\n```", "```py\nsim_run_data <-\n sim_run_data |>\n mutate(centered_time = five_km_time - mean(sim_run_data$five_km_time))\n\nsim_run_data_centered_model <-\n lm(\n marathon_time ~ centered_time,\n data = sim_run_data\n )\n```", "```py\nsim_run_data <-\n augment(\n sim_run_data_first_model,\n data = sim_run_data\n )\n```", "```py\n# Plot a)\nggplot(sim_run_data, aes(x = .resid)) +\n geom_histogram(binwidth = 1) +\n theme_classic() +\n labs(y = \"Number of occurrences\", x = \"Residuals\")\n\n# Plot b)\nggplot(sim_run_data, aes(x = five_km_time, y = .resid)) +\n geom_point() +\n geom_hline(yintercept = 0, linetype = \"dotted\", color = \"grey\") +\n theme_classic() +\n labs(y = \"Residuals\", x = \"Five-kilometer time (minutes)\")\n\n# Plot c)\nggplot(sim_run_data, aes(x = marathon_time, y = .resid)) +\n geom_point() +\n geom_hline(yintercept = 0, linetype = \"dotted\", color = \"grey\") +\n theme_classic() +\n labs(y = \"Residuals\", x = \"Marathon time (minutes)\")\n\n# Plot d)\nggplot(sim_run_data, aes(x = marathon_time, y = .fitted)) +\n geom_point() +\n geom_abline(intercept = 0, slope = 1, linetype = \"dashed\") +\n theme_classic() +\n labs(y = \"Estimated marathon time\", x = \"Actual marathon time\")\n```", "```py\nslow_in_rain <- 10\n\nsim_run_data <-\n sim_run_data |>\n mutate(was_raining = sample(\n c(\"Yes\", \"No\"),\n size = num_observations,\n replace = TRUE,\n prob = c(0.2, 0.8)\n )) |>\n mutate(\n marathon_time = if_else(\n was_raining == \"Yes\",\n marathon_time + slow_in_rain,\n marathon_time\n )\n ) |>\n select(five_km_time, marathon_time, was_raining)\n```", "```py\nstopifnot(\n class(sim_run_data$marathon_time) == \"numeric\",\n class(sim_run_data$five_km_time) == \"numeric\",\n class(sim_run_data$was_raining) == \"character\",\n all(complete.cases(sim_run_data)),\n nrow(sim_run_data) == 200\n)\n\nsim_run_data_rain_model <-\n lm(\n marathon_time ~ five_km_time + was_raining,\n data = sim_run_data\n )\n\nstopifnot(\n between(sim_run_data_rain_model$coefficients[3], 0, 20)\n )\n\nsummary(sim_run_data_rain_model)\n```", "```py\n Call:\nlm(formula = marathon_time ~ five_km_time + was_raining, data = sim_run_data)\n\nResiduals:\n    Min      1Q  Median      3Q     Max \n-50.760 -11.942   0.471  11.719  46.916 \n\nCoefficients:\n               Estimate Std. Error t value Pr(>|t|)    \n(Intercept)      3.8791     6.8385   0.567 0.571189    \nfive_km_time     8.2164     0.3016  27.239  < 2e-16 ***\nwas_rainingYes  11.8753     3.2189   3.689 0.000291 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nResidual standard error: 17.45 on 197 degrees of freedom\nMultiple R-squared:  0.791, Adjusted R-squared:  0.7889 \nF-statistic: 372.8 on 2 and 197 DF,  p-value: < 2.2e-16\n```", "```py\ntest_that(\"Check class\", {\n expect_type(sim_run_data$marathon_time, \"double\")\n expect_type(sim_run_data$five_km_time, \"double\")\n expect_type(sim_run_data$was_raining, \"character\")\n})\n```", "```py\ntest_that(\"Check number of observations is correct\", {\n expect_equal(nrow(sim_run_data), 200)\n})\n\ntest_that(\"Check complete\", {\n expect_true(all(complete.cases(sim_run_data)))\n})\n```", "```py\ntest_that(\"Check coefficients\", {\n expect_gt(sim_run_data_rain_model$coefficients[3], 0)\n expect_lt(sim_run_data_rain_model$coefficients[3], 20)\n})\n```", "```py\ntest_file(\"tests/test_observations.R\")\ntest_file(\"tests/test_class.R\")\n\nsim_run_data_rain_model <-\n lm(\n marathon_time ~ five_km_time + was_raining,\n data = sim_run_data\n )\n\ntest_file(\"tests/test_coefficient_estimates.R\")\n```", "```py\nslow_in_humidity <- 15\n\nsim_run_data <- sim_run_data |>\n mutate(\n humidity = sample(c(\"High\", \"Low\"), size = num_observations, \n replace = TRUE, prob = c(0.2, 0.8)),\n marathon_time = \n marathon_time + if_else(humidity == \"High\", slow_in_humidity, 0),\n weather_conditions = case_when(\n was_raining == \"No\" & humidity == \"Low\" ~ \"No rain, not humid\",\n was_raining == \"Yes\" & humidity == \"Low\" ~ \"Rain, not humid\",\n was_raining == \"No\" & humidity == \"High\" ~ \"No rain, humid\",\n was_raining == \"Yes\" & humidity == \"High\" ~ \"Rain, humid\"\n )\n )\n```", "```py\nbase <-\n sim_run_data |>\n ggplot(aes(x = five_km_time, y = marathon_time)) +\n labs(\n x = \"Five-kilometer time (minutes)\",\n y = \"Marathon time (minutes)\"\n ) +\n theme_classic() +\n scale_color_brewer(palette = \"Set1\") +\n theme(legend.position = \"bottom\")\n\nbase +\n geom_point(aes(color = was_raining)) +\n geom_smooth(\n aes(color = was_raining),\n method = \"lm\",\n alpha = 0.3,\n linetype = \"dashed\",\n formula = \"y ~ x\"\n ) +\n labs(color = \"Was raining\")\n\nbase +\n geom_point(aes(color = weather_conditions)) +\n geom_smooth(\n aes(color = weather_conditions),\n method = \"lm\",\n alpha = 0.3,\n linetype = \"dashed\",\n formula = \"y ~ x\"\n ) +\n labs(color = \"Conditions\")\n```", "```py\nsim_run_data_rain_and_humidity_model <-\n lm(\n marathon_time ~ five_km_time + was_raining * humidity,\n data = sim_run_data\n )\n\nmodelsummary(\n list(\n \"Five km only\" = sim_run_data_first_model,\n \"Add rain\" = sim_run_data_rain_model,\n \"Add humidity\" = sim_run_data_rain_and_humidity_model\n ),\n fmt = 2\n)\n```", "```py\nsim_run_data_first_model_rstanarm <-\n stan_glm(\n formula = marathon_time ~ five_km_time + was_raining,\n data = sim_run_data,\n family = gaussian(),\n prior = normal(location = 0, scale = 2.5),\n prior_intercept = normal(location = 0, scale = 2.5),\n prior_aux = exponential(rate = 1),\n seed = 853\n )\n\nbeep()\n\nsaveRDS(\n sim_run_data_first_model_rstanarm,\n file = \"sim_run_data_first_model_rstanarm.rds\"\n)\n```", "```py\nsim_run_data_first_model_rstanarm <-\n readRDS(file = \"sim_run_data_first_model_rstanarm.rds\")\n```", "```py\nprior_summary(sim_run_data_first_model_rstanarm)\n```", "```py\nPriors for model 'sim_run_data_first_model_rstanarm' \n------\nIntercept (after predictors centered)\n ~ normal(location = 0, scale = 2.5)\n\nCoefficients\n ~ normal(location = [0,0], scale = [2.5,2.5])\n\nAuxiliary (sigma)\n ~ exponential(rate = 1)\n------\nSee help('prior_summary.stanreg') for more details\n```", "```py\ndraws <- 1000\n\npriors <-\n tibble(\n sigma = rep(rexp(n = draws, rate = 1), times = 16),\n beta_0 = rep(rnorm(n = draws, mean = 0, sd = 2.5), times = 16),\n beta_1 = rep(rnorm(n = draws, mean = 0, sd = 2.5), times = 16),\n five_km_time = rep(15:30, each = draws),\n mu = beta_0 + beta_1 * five_km_time\n ) |>\n rowwise() |>\n mutate(\n marathon_time = rnorm(n = 1, mean = mu, sd = sigma)\n )\n```", "```py\npriors |>\n ggplot(aes(x = marathon_time)) +\n geom_histogram(binwidth = 10) +\n theme_classic()\n\npriors |>\n ggplot(aes(x = five_km_time, y = marathon_time)) +\n geom_point(alpha = 0.1) +\n theme_classic()\n```", "```py\ndraws <- 1000\n\nupdated_priors <-\n tibble(\n sigma = rep(rexp(n = draws, rate = 1), times = 16),\n beta_0 = rep(rnorm(n = draws, mean = 0, sd = 2.5), times = 16),\n beta_1 = rep(rnorm(n = draws, mean = 8, sd = 2.5), times = 16),\n five_km_time = rep(15:30, each = draws),\n mu = beta_0 + beta_1 * five_km_time\n ) |>\n rowwise() |>\n mutate(\n marathon_time = rnorm(n = 1, mean = mu, sd = sigma)\n )\n```", "```py\nupdated_priors |>\n ggplot(aes(x = marathon_time)) +\n geom_histogram(binwidth = 10) +\n theme_classic()\n\nupdated_priors |>\n ggplot(aes(x = five_km_time, y = marathon_time)) +\n geom_point(alpha = 0.1) +\n theme_classic()\n```", "```py\nsim_run_data_second_model_rstanarm <-\n stan_glm(\n formula = marathon_time ~ five_km_time + was_raining,\n data = sim_run_data,\n family = gaussian(),\n prior = normal(location = 8, scale = 2.5, autoscale = TRUE),\n prior_intercept = normal(0, 2.5, autoscale = TRUE),\n prior_aux = exponential(rate = 1, autoscale = TRUE),\n seed = 853\n )\n\nsaveRDS(\n sim_run_data_second_model_rstanarm,\n file = \"sim_run_data_second_model_rstanarm.rds\"\n)\n```", "```py\nmodelsummary(\n list(\n \"Non-scaled priors\" = sim_run_data_first_model_rstanarm,\n \"Auto-scaling priors\" = sim_run_data_second_model_rstanarm\n ),\n fmt = 2\n)\n```", "```py\nprior_summary(sim_run_data_second_model_rstanarm)\n```", "```py\nPriors for model 'sim_run_data_second_model_rstanarm' \n------\nIntercept (after predictors centered)\n  Specified prior:\n    ~ normal(location = 0, scale = 2.5)\n  Adjusted prior:\n    ~ normal(location = 0, scale = 95)\n\nCoefficients\n  Specified prior:\n    ~ normal(location = [8,8], scale = [2.5,2.5])\n  Adjusted prior:\n    ~ normal(location = [8,8], scale = [ 22.64,245.52])\n\nAuxiliary (sigma)\n  Specified prior:\n    ~ exponential(rate = 1)\n  Adjusted prior:\n    ~ exponential(rate = 0.026)\n------\nSee help('prior_summary.stanreg') for more details\n```", "```py\npp_check(sim_run_data_second_model_rstanarm) +\n theme_classic() +\n theme(legend.position = \"bottom\")\n\nposterior_vs_prior(sim_run_data_second_model_rstanarm) +\n theme_minimal() +\n scale_color_brewer(palette = \"Set1\") +\n theme(legend.position = \"bottom\") +\n coord_flip()\n```", "```py\nplot(\n sim_run_data_second_model_rstanarm,\n \"areas\"\n)\n```", "```py\nplot(sim_run_data_second_model_rstanarm, \"trace\")\n\nplot(sim_run_data_second_model_rstanarm, \"rhat\")\n```", "```py\ntic(\"First bit of code\")\nprint(\"Fast code\")\n```", "```py\n[1] \"Fast code\"\n```", "```py\ntoc()\n```", "```py\nFirst bit of code: 0 sec elapsed\n```", "```py\ntic(\"Second bit of code\")\nSys.sleep(3)\nprint(\"Slow code\")\n```", "```py\n[1] \"Slow code\"\n```", "```py\ntoc()\n```", "```py\nSecond bit of code: 3.008 sec elapsed\n```", "```py\nsimulated_data <-\n tibble(\n random_draws = runif(n = 1000000, min = 0, max = 1000) |> round(),\n more_random_draws = runif(n = 1000000, min = 0, max = 1000) |> round()\n )\n\nplan(sequential)\n\ntic()\nsimulated_data <-\n simulated_data |>\n rowwise() |>\n mutate(which_is_smaller =\n min(c(random_draws,\n more_random_draws)))\ntoc()\n\nplan(multisession)\n\ntic()\nsimulated_data <-\n future(simulated_data |>\n rowwise() |>\n mutate(which_is_smaller =\n min(c(\n random_draws,\n more_random_draws\n ))))\ntoc()\n```", "```py\npalmerpenguins::penguins |> \n filter(species == \"Adelie\") |> \n ggplot(aes(x = bill_length_mm, y = bill_depth_mm)) +\n geom_point()\n```"]