# 为什么 SQL Server 消耗这么多内存

> 原文：<https://www.dataquest.io/blog/why-does-sql-server-consume-so-much-memory/>

December 1, 2021![header](img/ab85da66fbefa79bbadcdf434c3bda53.png)

据该公司称，微软 SQL Server 是一个关系数据库管理系统(RDBMS)。在关系数据库中，所有的 SQL 服务器都使用 SQL 编程语言，这是众所周知的，并被广泛使用。微软创建了 [SQL Server 的 Transact-SQL 实现](https://www.dataquest.io/blog/sql-vs-t-sql/)，也称为 t-SQL，由 SQL Server 使用。许多在 [SQL](https://www.dataquest.io/blog/python-pandas-databases/) 中找不到的编程结构也包含在 T-SQL 中。

总的来说，SQL Server 是微软数据平台的重要组成部分，因为它通过内存技术为任务关键型应用程序提供了令人兴奋的性能水平，通过 Excel 等知名工具更快地洞察和透视任何类型的数据，并提供了用于开发内部和基于云的解决方案的平台以及解决方案管理平台。

在撰写本文时，SQL Server 已经存在了 32 年。它是一个成熟的产品，几乎肯定不会满足每个开发团队的所有需求，但它确实涵盖了开发团队对数据访问的绝大多数需求。

我们日常使用的大量服务严重依赖于 SQL Server 数据库。这些服务包括金融机构、博彩公司、政府机构、医疗行业和知名网站。

## SQL server 的功能和优势

高可用性是 [SQL 服务器](https://en.wikipedia.org/wiki/Microsoft_SQL_Server)的标准特性，允许高正常运行时间和更快的切换。所有这些都是在不耗尽系统内存的情况下完成的。由于增加了内存功能，SQL Server 的数据库和分析引擎现在具有更大的灵活性和易用性。可能最显著的特征是它与服务器平台的微软服务器家族无缝集成。

## SQL server 使用了多少内存？

SQL Server 使用了我的服务器上大约 87.5%的 RAM。这导致了许多性能问题，包括速度慢。当我们开始调查这个问题时，我们可以发现许多死胡同。互联网上常见的解决方案是增加 SQL Server 的最大执行时间。在这方面已经做了很多工作，而且它显示。如果你[雇佣一个开发者](https://adevait.com)，你可能会得到你需要的帮助。

SQL Server 将消耗所有可用内存。默认情况下，该数字对应于计算机上可用的数字内存总量。因此，你的看法是正确的。换句话说，如果您给 SQL Server 24 GB 内存，它会尽一切努力充分利用这些内存。当 SQL Server 和操作系统争用资源时，低性能是不可避免的副产品。

SQL Server 的缓冲池受到服务器配置中设置的最大服务器内存限制配置的限制(几乎是存储数据页和过程缓存的地方)。缓冲池不是 SQL Server 中唯一的内存工作线程；还有许多其他内存工作程序(适用于 2008 版 R2 和更高版本)。但是，这将始终是内存需求最高的应用程序。

Microsoft SQL Server 数据库引擎的缓冲池受服务器的最小和最大内存设置的限制。

## 服务器配置选项

通过为特定的 SQL Server 实例自定义最小和最大服务器内存选择，可以改变 SQL Server 内存管理器管理的内存量(以兆字节为单位)。SQL Server 的内存需求可以根据系统上的可用资源进行动态调整。

要设置固定的内存量，请按照下列步骤操作:

*   在对象资源管理器中右键单击服务器，并从上下文菜单中选择属性。
*   从下拉菜单中选择内存节点。
*   在“服务器内存选项”下，在相应的字段中输入所需的最小服务器内存和最大服务器内存。

如果希望 SQL Server 能够根据可用的系统资源动态更改其内存需求，请使用默认设置。在默认配置中，最小服务器内存设置为 0 兆字节，最大服务器内存默认设置为 2147483647 兆字节(MB)。

## 释放服务器

必要时，可以将 SQL 配置为只使用特定数量的 RAM。否则会消耗最大量的资源。这是在彻底调查服务器并确认 SQL Server 消耗了服务器总 10GB RAM 容量中的 9GB 后的标准过程。任何人都会将 SQL 可用的内存限制在 6GB，以避免服务器崩溃，并给它一些喘息的空间。此外，如果你看性能，你会注意到它是符合规定的。

## 最优消费

虽然前面的解决方案可能足以让我们摆脱困境，但很明显，理想的解决方案是找到一种方法来准确地确定每个数据库(DB)消耗多少内存，以便确定 SQL Server 实例需要多少内存。简单。只需要运行一个 SQL 查询就可以看到它。

根据我们对总 RAM 内存的观察，我们可以添加总的“db buffer MB ”,并查看 SQL 总共消耗了多少 RAM 内存。例如，如果我们将 SQL 限制降低到 9GB 并运行查询，我们可以看到数据库只消耗了 3GB 的 RAM 内存，这比上一个示例少得多。

结果，最初关于 SQL Server 内存消耗过多的假设被证明是正确的。尽管数据库只消耗 3GB 的内存，但如果我们将实例限制为 6GB，SQL Server 会设法充分利用可用内存。我们会谈论观察自己记忆的行为。

## 真实应用

这一结果最重要的方面是它可以投入实际使用。假设 SQL 只需要 3GB 的内存就能正常工作，那么是否可以将 SQL 的内存使用限制在 4GB，以避免浪费整个内存分配呢？是的。

在此图中，我们可以看到运行新查询后数据库的具体消耗。此外，如果我们定期运行这个查询并跟踪平均值，我们就可以确定消耗量是否会波动。

## 监控的重要性

在我们目前正在处理的这种情况下，监测的重要性立即变得显而易见。有了 [SQL Server 的 RAM 内存消耗](https://docs.microsoft.com/en-us/sql/relational-databases/performance-monitor/monitor-memory-usage?view=sql-server-ver15)的历史记录，我们可以计算出一个合理的平均值，然后设置可以分配多少内存的限制。

监控使我们能够开发一个确定最大值和最小值及其关系的尺度。如果超过这些阈值，或者如果应用程序消耗的内存超过预期，客户端和技术人员都不会收到警报电子邮件。

## 重要说明

将单个 SQL Server 实例的最大服务器内存增加到建议值以上，可能会迫使该 SQL Server 实例与同一服务器节点上运行的其他 SQL Server 实例争用内存。如果您将内存限制设置得太低，您可能会遇到严重的内存不足或性能问题。如果将最大服务器内存参数设置得太低，SQL Server 可能无法正常启动。

更改最大服务器内存参数后，如果您无法启动 SQL Server，请尝试使用-f 启动参数启动它，并将最大服务器内存参数恢复到以前的值。