# 贵公司不能犯的三个基础架构错误

> 原文：<https://review.firstround.com/the-three-infrastructure-mistakes-your-company-must-not-make>

1992 年 **[阿维·弗里德曼](https://www.linkedin.com/in/avifreedman "null")** 准备从天普大学毕业的时候，在费城根本买不到互联网服务。字面上。如果你想给某人汇钱去注册一个拨号账户，没有人可以汇钱给你。但是弗里德曼已经在运行公共访问 Unix 机器，并让他认识的人登录。所以他决定将他个人的挫折转化为一家公司，为该地区的每个人提供拨号上网服务。

他想，“嗯，不会那么难吧。我会买一个商业的 24-7 互联网接入链接，并添加一些调制解调器。”不久之后，弗里德曼创立了费城第一家 ISP。早期的经历对他大有裨益。Netaxs 和许多类似的互联网服务提供商建立了商业互联网，催生了一个人的社区，他们现在运行着世界上一些最大的企业、网络、云和服务提供商基础设施。

从那以后，弗里德曼在网络世界中一路走来。他为全球主干网提供商 AboveNet(现在是 Zayo 的一部分)管理工程；在 **[Akamai](https://www.akamai.com/ "null")** 待了 10 年，经营网络集团，创建专注基础设施的服务；然后担任托管和云公司 ServerCentral 的 CTO。两年半前，他创立了 **[Kentik](https://www.kentik.com/ "null")** 让公司完全了解其网络流量、性能和安全性。他见证了 100 多家初创公司扩展基础设施，是我们所能找到的关于技术基础设施的最佳建议来源之一。

**在这篇独家文章中，弗里德曼分享了初创公司在设置系统时犯的三个最大的错误(通常会导致公司倒闭:**

他们把自己关在云监狱里。

他们被“潮人工具”所吸引。

它们不是为可监控性而设计的。

但是如果你在工作的地方发现了这些症状，不要担心。如果你在建立自己的公司时意识到这些陷阱，就有可能避免它们。

# 欢迎来到云监狱

“这是一个我一遍又一遍看到的故事:一家初创公司获得了 25 万美元的信贷，用于在云上建立他们的基础设施。太牛逼了。太美了。弗里德曼说:“开始时每月只有 2 万美元。“但后来他们增长了，变成了 5 万美元，然后是每月 10 万美元。突然，他们没有信用了。它涨到 15 万美元，20 万美元。这时他们的董事会突然出现，说，“等等，等等，发生了什么事？”“人应该是你最大的成本，而你却把这一切都倾注到云上！”因此，这家初创公司绞尽脑汁，挤来挤去，直到他们的月收入降至 8 万美元——优化他们的数据库即服务使用，购买现场或预留实例，调整其实例类型，跟踪并删除未使用的对象和块存储。过了一段时间，他们达到了硬包装的 80，000 美元以上，并且还在增长——没有进一步轻松优化的空间。"

如果他们想以他们和董事会希望的速度增长，他们将很快回到并超过高水位——他们对此无能为力。他们很难负担起维持业务所需的基础设施，尤其是在 2016 年，人们越来越关注利润和单位经济。

举个例子，五年前，一家做视频编码和流媒体的公司带着 30 万美元/月的价格来到弗里德曼。他们手中的账单越来越多，这导致了负利润——他们增长越快，亏损越快。他帮助他们将 500TB 和 10gb/秒的流从他们的公共云提供商迁移到他们自己的基础架构，并在此过程中将他们的账单降低到每月 10 万美元以下。，包括知道如何处理物理基础设施和路由器的员工。如今，他们每月花费 25 万美元。基础设施和带宽，估计他们的 Amazon 账单将超过每月 1，000，000 美元。

他们在经历磨难后说的话很关键:“伙计，我们希望我们事先花时间自己运行至少一些基础设施，这样我们就不会被困住了——并且一旦我们扩大规模，就有能力更容易地迁移。”用现代的术语来说，他们更喜欢运行一些基于云的基础设施和他们自己的服务器的“混合体”——或者至少是一个多云系统。

每个人都希望能够回到过去，告诉自己使用云来发展，但不要束缚于任何一个提供商。

“云监狱正在觉醒，发现你在基础设施上花费了太多的钱，并且完全依赖于你的云提供商，”Freedman 说。“一旦发生这种情况，就不容易转换了。您正在使用他们特定的服务和环境。您已经迷上了他们为您做的事情，迁移可能会非常困难和昂贵。”

例如，亚马逊(他选择它只是因为它是行业领导者)有许多令人上瘾的属性。它使得像用户身份这样的事情变得很容易。认证。排队。电子邮件。通知。无缝数据库。这些都是轻量级的服务，可以节省你很多时间，但前提是你使用 AWS。神奇的是(对亚马逊而言),尽管存储和带宽成本不断上升，但它们阻止了人们迁移。亚马逊的顾客无法想象没有这些福利的生活。

“醒醒！他说:“你的董事会打电话来问你，为什么你的毛利率从来没有超过 40%，为什么你在基础设施上的支出超过了开发商。”“你解释说，事物应该以对数的形式增长。成本应该会随着增长而下降，但事实并非如此。”尤其是在今天的风险投资市场，这种令人困惑的借口是行不通的。

对于其收入依赖于互联网上的位交付的公司来说，以混合或多云模式运行以能够控制和确保出色的客户体验变得至关重要。现代网络性能管理工具可以检测和查明导致用户性能下降的拥塞，但云提供商通常不愿意调查或修复流量交付的远程“互联网中”问题。

这一点，甚至超过成本，已经成为 Freedman 看到的数十家公司迁移其系统中面向用户部分的驱动力。这一趋势在 SaaS 世界尤为明显，在那里，客户成功和用户体验不仅是更新和保留的核心驱动力，也是收入增长的核心驱动力。

那么，你应该怎么做呢？

“你要睁大眼睛进入基础设施，要知道云并不总是更便宜或更高效，”Freedman 说。“就像您有(或应该有)一个灾难恢复计划或安全应急计划一样，知道当您达到一定规模，由于成本或性能原因无法在云中运行所有内容时，您该怎么办。至少要知道如何运行自己的一些基础设施，并雇佣对这些选项有一定了解和经验的早期团队成员。”

他的意思不是买一栋楼，安装冷却器和机架。他的意思是租赁他人运营的现有设施中的托管空间，以及购买或租赁服务器和路由器。对于许多初创企业基础架构中常见的非爆发式工作负载，尤其是“单调增加”的工作负载，这在规模上仍然更具成本效益。

**你越早开始考虑这个问题越好。如果你能成功，开始运行多云平台，建立一个小型基础设施，交叉连接到你的云提供商。**

弗里德曼身体力行。例如，他成立 2.5 年的公司 Kentik 从未将生产工作负载放在公共云上。在 Equinix 设施中运行，管理数 Pb 的存储，并为 100 家公司分析流量，他们的带宽和托管账单以及设备折旧成本都是大约每月 20，000 美元。作为一家成立 2.5 年的数据分析公司，他们的毛利率超过 50%，并且还在不断增长，包括运营人员，因为他们决定完全跳过公共云来处理生产工作负载。

“当你决定运行自己的入门基础设施时，你每个月在空间、电力和带宽上的花费不到 1 万美元，”他说。“当然，您可能从 50，000 美元开始，然后增长到 300-500，000 美元的一次性设备采购。但相对于云计算、存储和带宽而言，这实际上仍然很低，以至于现在您可以很早就雇佣员工来管理您的基础架构。”

在专用基础设施中运行实际的服务器也容易得多。虽然这在 10 年前还是一件新奇的事情，但现在大多数运营团队“将服务器视为牛，而不是宠物”，并且可以使用配置管理系统灵活地部署应用程序，如 **[【厨师】](https://www.chef.io/solutions/infrastructure-automation/ "null")****[木偶](https://puppet.com/solutions/configuration-management "null")****[盐](https://saltstack.com/ "null")** 或 **[Ansible](https://www.ansible.com/configuration-management "null")** ，或者通过容器化和容器编排系统。

**员工与众不同。**早期雇佣的三到五个人就可以同时运行云和专用基础架构，而同一个团队通常可以运行一个比他们开始时大 10 倍的系统。它极大地促进了规模的扩大。“尽快雇用一名上校...一位基础架构上校，他有运行混合的丰富历史，至少有一些云和一些物理基础架构。这样，当你的成本增加时，会有一个聪明的人在看着你，他们会知道什么时候扣动扳机，朝着正确的方向做出改变。在值得你早期投资的东西清单上，这是第一位的。”

关于公共(基于虚拟化的)云迁移的最后一个技巧是:“对于持续运行的特别是存储密集型的工作负载，考虑‘裸机’云和专用服务器提供商，如 **[SoftLayer](http://www.softlayer.com/ "null")** 、 **[LeaseWeb](https://www.leaseweb.com/ "null")** 、 **[OVH](https://www.ovh.com/us/dedicated-servers/hosting/ "null")** 、 **[数据包](https://www.packet.net/ "null")** 等，”弗里德曼说。“特别是如果您资金紧张，或者不需要或不想运行自己的网络来控制或提高性能。”

你怎么知道你可能要去云监狱？

弗里德曼建议初创公司观察以下指标，以衡量它们是否可能正在接近危险地带:

合计您的账单中与“永远在线”和“稳定状态”或不断增长的工作负载相关的部分。当这些项目超过每月 100，000 美元时。马克，你可能会比你预期的更早到达临界点。

观察除基本计算、网络和存储之外，您从云提供商处购买了多少基础设施服务。特别是身份验证、负载平衡、SQL 和 NoSQL 服务。你有其他选择吗？如果时机成熟，您现在购买的服务是否可以通过直接连接到您自己的基础设施来正常工作？

监控当前提供商无法或不愿解决的网络性能问题，例如某些地区或互联网提供商的数据包丢失和低吞吐量。如果您不能通过使用 CDNs 和 SD-WAN 加速服务来解决这些问题，这就是一个危险信号。对于许多 SaaS 和网络公司来说，性能成为运行多云或至少一些专用基础设施的关键驱动因素，他们可以对这些基础设施进行性能负载平衡。

**如果你已经被困在云监狱了怎么办？**

解决方案回到了员工身上。如果你还没有，准备雇佣几个了解剧本的“基础设施运营”人员——他们以前运营过基础设施。他们会打电话给 **[Equinix](http://www.equinix.com/ "null")** 、 **[CyrusOne](http://www.cyrusone.com/ "null")** 、 **Switch** 或类似的提供商，获得主机代管柜或机柜，提供带宽，并选择、订购和安装服务器。从零开始，这可能是一个 6 到 12 个月的过程，尤其是如果有数 Pb 的数据要移动，或者公司的收入快速增长。

但弗里德曼也看到它在 2 到 3 个月内完成，尽管有大量“紧急工程”的帮助。或者，如果您的占地面积较小或控制需求较低，他们可能会跳过专用网络/主机托管，而只是从添加一些专用服务器或“裸机云”开始。

Freedman 亲眼目睹了 30 家网络公司经历这种类型的转变，其中大多数都有 3 到 5 名核心人员负责网络和物理服务器管理。好消息是，只要你有跑道，就有可能在公共云费用开始把你生吞活剥的时候挖出来。

如果你花了很多钱，不确定你能否通过当前的云使用获得巨大的毛利润，但又招不到基础设施呆子员工，不要绝望。“网络社区非常开放，人们通常乐于社交和提供帮助，”弗里德曼说。“去参加 [NANOG](https://www.nanog.org/about/home "null") 、 [RIPE](https://www.ripe.net/ "null") 、[杏](https://www.apricot.net/ "null")，或者你当地的社交聚会或会议。建立联系，提出问题，你通常可以找到可以帮助你分析和规划基础设施的人。”

**外卖**

重要的是，Freedman 并不是说创业公司不应该一开始就使用云计算——尤其是当你得到风险投资支持时，可以获得信用额度。

对于创业和处理突发工作负载来说，云是一种非常棒的、节省资本的方式。你只需要知道突破点在哪里。

当您打包好稳定状态的工作负载后，您的云账单已经达到每月几十万，并且还在以数万的速度定期增长，但这可能已经太晚了。在这个里程碑之前，您需要更多地转换到您自己的基础设施上。

“人们会迷失方向，因为他们不在乎效率何时会降低 100 万或 200 万美元/年。但它可能会悄悄靠近你，成为你整个公司的生存威胁，决定你是赚钱还是获得更多资金，还是一败涂地。那时，人们希望他们能更早地考虑这个问题。”

# 爱上时尚工具

“人们喜欢新工具。弗里德曼说:“他们听说一家‘令人印象深刻’的网络公司开发了一种技术基础设施工具来解决一个特定的问题，他们必须尝试一下，因为这听起来既方便又省时，而且时髦。”“我们在肯蒂克上当了。我们看到了解决特定分布式系统问题的东西，然后说，‘哦，看起来不错——我们一直想要这样的东西！’幸运的是，它只花费了我们大量的时间和内部痛苦，但没有导致用户可见的停机。“其他公司就没这么幸运了。

即使是世界上最聪明的人也会厌倦反复使用同样的东西。他们总是想要能够大规模解决问题的新工具。

“如果你决定使用你在黑客新闻上看到的‘新热点’,记住这一点:它可能是在完全适合它的情况下以其最好的方式展示的。因此，只有给它完全相同的输入，期望完全相同的输出，并在完全相同的应用中使用它，它才能工作，”弗里德曼说。“如果任何东西偏离了它的一个令人敬畏的用例——这显然是它的制造者使用它的方式——它很可能会崩溃。”

大约一年前，Kentik 开始使用为服务发现开发的系统进行监控。但它实际上从未被设计成他们开始使用时的规模。当旨在将基础架构粘合在一起的系统开始导致微中断时，他们的运营团队一年中每周要花费 5 到 10 个小时来浪费时间。最终他们离开了这里。他见过许多公司在工具和组件导致更严重的停机时进行紧急迁移。

如果你在黑客新闻上发现了这个工具，而且它还不到 18 个月——“危险，威尔·罗宾逊！”

弗里德曼在这个问题上的一个最重要的建议是:当涉及到基础设施组件时，尽可能保持简单。(并保持适度的怀疑态度。)“当涉及到您的基础架构时，尤其是将所有东西粘合在一起的核心组件(存储、负载平衡、服务发现)，您真的需要使用本身不会引起问题的东西。您的应用程序和组件的其余部分可能已经有足够多的问题了。”

**那么，你应该怎么做呢？**

作为一名高管，如果你看到你的团队被一个时髦的工具所诱惑，你需要暂停一下，并问:“我们试图解决的问题到底有多大？”你可以用这些问题来衡量你的感受:

你愿意做出多大的取舍？

你愿意冒多大的风险？能亏吗？时间？顾客？

你必须为组件或工具的开发做出贡献吗？你能负担得起一个兼职工人或更多的人来开发一个组件到不同规模的工作吗？

这个组件有多成熟，对于您正在运行的应用程序类型来说，它是否正在使用？

你有什么证据证明这个工具在各种情况下都是稳定的？

如果该工具运行良好，它可以节省多少时间和精力？

这是不是一个你最终必须自己编写的工具或组件，因为其他当前的选择是如此痛苦？

你能找到记录了失败模式的人吗？尤其是如果没有的话，你有时间自己投资去搞清楚这些问题，以及脆弱性和恢复路径吗？

几乎总是，这个挑战会阻止你使用新工具。然而，有三个条件(理想的组合)可以证明使用实验组件的合理性:

您可以在基础设施的每个其他方面使用理解、测试和可靠的组件。

你需要解决一个会因为成本或可用性而让你出局的问题。(也就是说，为了生存，你需要组件可能提供的快速规模或经济性。)

您有一个无法解决的问题，而这个问题是您的客户或用户体验的核心——在这种情况下，成为一个新兴工具的开发社区的一部分可能比从头开始构建更便宜。

**在后两种情况下，更昂贵的选择是不要用工具做实验。但除非孤注一掷，否则这通常是个错误。**

最好的操作员不会使用一个部件，除非他们知道它是如何损坏的。

“每个组件都有缺陷，”弗里德曼说。“除非你有这方面的经验，尤其是如果它处于活跃的开发阶段，并且其中一些开发人员不是你的内部人员，否则你就没有安全网。”

最好的防御之一是提醒自己风险有多大。

Freedman 说:“我见过许多公司因为基础架构层的多重不稳定性而出现 3 天的停机，而这些基础架构层本应把所有其他东西都粘在一起。

当然，它可能是可修复的，但是当你的世界因此着火时，那就不仅仅是痛苦了。常见的反应是去掉有问题的组件，这将带来它自己的后果。他见过初创公司——尤其是那些使用未经测试的存储系统的公司——丢失关键的基础设施元数据，更糟糕的是:**客户数据**。这是大多数人无法挽回的背信弃义。他建议，对存储组件要格外小心。

“如果你是一家初创公司的创始人，召集你的领导层开会。当涉及到工具时，在门口检查宗教和乐趣，并发誓检查和平衡彼此关于使用什么组件的决定。”以上问题互相请教，不要妥协。

当你的公司稍微大一点的时候，创建一个“架构评审委员会”也是有帮助的——本质上，是一群聪明的、见多识广的人，他们将批准新组件的使用。这是 Akamai 擅长的事情。

“我在‘拱门板’的两边——提交设计以供审查，并一度代表网络架构。弗里德曼说:“董事会的功能就像一个好律师为首席执行官做的那样。“他们询问了所有细节，并给了我他们的判断，指出了风险，指出了选择和先例。它帮助每个人避免了一些糟糕的决定。至少，这种过程迫使人们不仅围绕系统和组件架构，而且围绕采用新的外部工具和组件进行明确的讨论。”

![](img/1109436ff8d795d67cfb683f9f60d01d.png)

Freedman at Kentik HQ.

# 可监控性设计

“测试优先的开发”已经成为现代的口头禅这有很多很好的理由。如果你对某个东西理解不够好，不能测试它，你可能不应该写那个代码。但是弗里德曼提出了一个略有不同的论点:

他说:“不要首先只考虑你的测试能力，你还必须考虑你的监控能力。“如果您不知道该组件将如何与基础架构的其余部分结合运行，或者不知道如何放置您需要的工具，那么放置该组件可能会很危险。”

测试通常指的是单元测试，单元测试关注的是孤立的组件。但很多时候，当事情变糟时，这是动态系统中事物如何相互作用的意外后果——而不是事物如何自行运转。

在构建之前，您必须考虑所有可能的交互，以及仪器(让您能够看到那些交互)将会是什么样子。尤其是在分布式系统中，问题往往出现在远离触发“涟漪”效应的实际根本原因的地方，从而导致您所看到的症状。

当复杂系统出现问题时，通常是因为某个组件给出了一个延迟的答案，或者一个稍微不正确的答案，造成了级联问题，这样用户面临的性能问题就会出现在与其根本原因不同的地方。这是那种适当的仪器可以快速确定的事情。

Freedman 在初创公司和大规模项目中都见过复杂的仪器工作。在 Akamai，开发人员首先被鼓励，然后被迫在每个基础设施组件中编写代码，然后他们(和基础设施经理)可以随时查询以了解发生了什么。这已经足够好了，开发人员很少需要登录机器进行调试，这可能会导致安全、性能和规模问题。然而，关键是对这种工具要积极主动——特别是在组件之间的接口上。追溯需要更长的时间。

“思考一个组件如何在分布式系统中工作的严谨态度是非常有益的，”弗里德曼说。“内置主动式或反应式仪器有助于跨越单元测试的限制，即认为组件工作是因为您测试了预期的输入并获得了预期的输出。”

监控的想法是不革命的。但是大多数人在设计时没有考虑到可监控性。

“在 Kentik 之前，我在运营 readnews，这是一家新闻组公司，其系统在全球 4 个地方运行，有 8 种不同的软件组件，人们全天候使用，”Freedman 说。“最终，我们对这些组件进行了检测，以令人作呕的细节报告它们的运行情况，以及它们提供给——并从中获得服务——的组件的运行情况。在此之前，调试一个性能问题平均需要几天时间，而且经常会出现我们根本没有数据可调试的问题。”

**Readnews 在其所有组件中添加了两种特定类型的仪器:**

对系统中完成的每项工作跟踪用户和唯一的事务 ID，并将这些元素嵌入到日志数据中。

将网络性能数据添加到每个事务中(包括内部事务和面向互联网的事务)。

最好的情况是让每个组件将它们的详细日志传送给您，并建立一个单独的系统来关联它们。“在 usenet 公司，一旦我们嵌入了用户和交易身份，并导出了相关的网络性能数据，我们就开始获得可操作的警报，因为我们在事情变得不一致时就开始捕捉它们，”他说。“当我们这样做时，我们运行基础架构所需的时间从一周 20 小时的诊断和调试变成了一周几个小时的重启组件、发现错误、修复并继续工作。它还允许我们花时间主动解决互联网性能问题，我们与一些最大的批发客户共享详细的日志和我们的分析门户，这样他们就可以在没有我们帮助的情况下处理支持问题。”

随着将基础设施分解为“微服务”变得越来越普遍，这种工具和分布式跟踪变得至关重要。特别是对于通过互联网收集所有收入的公司来说，能够快速查明问题是由系统、应用程序还是本地、云或互联网网络引起的非常关键。

然而，仅仅导出这些额外的日志和指标是不够的，运营商需要能够处理和理解它们的工具，以便按用户、应用和网络组件跟踪性能。

“APM(应用程序性能监控)工具不足以快速查明这些问题，”Freedman 说。“他们通常不了解人们使用的定制组件，或者不了解正确的内部指标。”

也就是说，度量和日志处理系统通常只能看到拼图的一部分，而今天的网络可见性系统并不能深入应用程序内部。他说，为了获得完整的图像，通常需要综合现代 APM、网络、指标和日志处理系统，这些系统可以通过开放 API 进行互操作。

弗里德曼建议实施的一个关键新兴工具类型是“分布式追踪”系统，通常模仿谷歌的“Dapper”系统。这些系统通常提供 glue 来帮助保存用户数据和完成的每一项工作的事务 ID，并提供关联和报告来跟踪事务细节和查看总体趋势。

但是，Freedman 说，即使没有正式的分布式跟踪工具，只是在指标和日志中发出正确的工具是一个很好的第一步，并提供您的系统将需要的“食物”,以便能够将应用程序、网络和系统指标与性能和稳定性的实际用户体验相关联。

虽然插装可能会引导您使用新的或“时髦的工具”，但这并不像上面强调的那些工具那样存在巨大的可用性风险，这些工具本质上是将您的系统粘在一起的。“是的，分布式跟踪框架是一个新的热点，但它是一个非常安全的实验。主要警告是，您需要确保您的监控基础架构不会在增加的负载下崩溃。”另一个行之有效的技巧是进行“抽样”跟踪，在这种情况下，您只为大约 1，000 个事务 id 中的一个发出(或存储)数据，并为您正在积极调试的用户动态启用非抽样跟踪。

# 概括起来

基础设施可能是无声的杀手。前一天，你还在经营一家公司，向客户提供一些特殊而新颖的东西——与使之成为可能的底层技术完全无关——而下一天，你却被账单或 bug 所困扰。更不用说，被性能问题困扰。当你的公司正在起飞的时候，被如此基础的东西拖垮是多么令人失望啊！然而，这种事情一直在发生。

弗里德曼在这里强调的三个错误绝不是他在传奇职业生涯中看到的唯一错误。他们只是碰巧是最常见和最昂贵的。幸运的是，他们教授的课程可以帮助您避免许多其他与架构相关的问题:

早点考虑吧。这么早你就觉得太早了。

同时，谷歌那样做并不意味着它适合你。

建立制衡制度。招募能告诉你何时该说何时的专家。

尽你所能预测未来，并随着你的成长不断迭代。

保守地玩。不要向潮流低头。慢慢来。尽可能收集所有数据。

首先不要伤害。不惜一切代价保护你的用户体验。让他们的信任变得神圣。

有了这个建议，你就能掌握公司命运的一大部分。你拥有的控制权越多，你就越能专注于你着手解决的真正问题。