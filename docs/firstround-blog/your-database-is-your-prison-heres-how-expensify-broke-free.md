# 你的数据库就是你的监狱——以下是 Expensify 如何挣脱束缚

> 原文：<https://review.firstround.com/your-database-is-your-prison-heres-how-expensify-broke-free>

当费用管理公司 **[Expensify](https://www.expensify.com/ "null")** 最初设计其数据库架构时，它正在为大众构建自己的公司卡。hit 与金融机构合作有严格的要求:毫秒内的响应时间、多台服务器的实时复制以及每笔交易的记录和验证。当时，对于一家初创公司来说，构建一个高层次的企业级架构似乎有些矫枉过正。当 it 转向费用报告时，它仍然拥有强大的技术。创业公司往往直到后来才知道他们早期的决策有多有价值。只有在事后， **[大卫·巴雷特](https://www.linkedin.com/in/davidmbarrett "null")** 才意识到 Expensify 的数据库架构的早期限制是如何导致其许多关键竞争优势的。

作为 Expensify 的创始人和首席执行官，Barrett 已经看到了在早期数据库设计上过度投资的优势，这不仅是因为产品的功能，也是因为这种激进的商业模式能够获得与竞争对手截然不同的客户。2015 年，它的增长率超过 120%，比最接近的竞争对手高出近 70%。这家开支管理初创公司现在为 20，000 多家公司提供帮助。Barrett 将公司的大部分能力归功于其技术决策，特别是其异常强大的数据库架构。

在这次独家采访中，Barrett 解释了初创公司如何在数据库架构方面陷入破坏性的默认，并解构了要避免的具体错误。他分享了三个关键步骤，让你在技术和商业模式上获得成功。最后，他分享了如果您需要更改数据库架构，如何中途修正。

# 许多初创公司在数据库架构上步履蹒跚

初创公司被告知他们应该是“数据驱动的”，但他们在做出关键技术决策时很少知道这意味着什么。“刚开始的时候，你没有数据，也没有客户。您所做的一切都可以轻松地放在一个数据库中，由一台 web 服务器提供支持。巴雷特说:“你选择你以前使用过的工具，或者目前流行的工具，然后抱最好的希望。“随着您的成长，慢慢地，您开始需要多台服务器，因为单个服务器的性能或可靠性已经不够了。因此，您一个接一个地将另一台服务器硬塞进您唯一的数据中心。随着规模的扩大，您可以一点一点地增加容量。”

这就是为什么这种方法会让许多初创公司陷入困境:

松鼠比比皆是。在皮克斯的电影 *Up* 中，主角会说话的金毛寻回犬 Dug 说到一半停下来移开目光，惊叫道“松鼠！”每当一个人穿过他的视线。别被挖了。“大多数公司从他们最熟悉的东西开始。这是一个安全的选择，而且一开始就主张最小化风险是很容易的。不幸的是，人们只能熟悉过去，而世界属于未来，”巴雷特说。“更大胆的公司会退后一步，看看有什么新的、比他们熟悉的更好的东西。这可能是好事。但是，太多的公司将“流行”误认为“更好”，并选择未经证实的技术，而这些技术在他们决定使用什么时恰好是流行的。这会以一种缓慢而痛苦的方式扼杀你的创业。”

几年前，巴雷特曾在一家试图开发 Dropbox 早期版本的公司工作。“所有的技术都在那里，但他们坚持使用这种可怕的 P2P 技术，称为 [JXTA](https://en.wikipedia.org/wiki/JXTA "null") ，而不是一系列简单的集中式服务器。Barrett 说:“尽管我们没有客户，因此也没有数据要存储，但我们的首席技术官将公司押在了一个奇特的分布式系统上，声称这是扩展到 Pb 级数据的唯一方法。“像大多数性感的‘超可扩展’解决方案一样，实际上它甚至不能扩展到*兆字节*，因为它使用起来是一场噩梦，而且从未在生产环境中使用过。该公司几经转型，四年后，Dropbox 建立了一个更明显的解决方案，包括更合理的新旧结合，并占领了世界。”

你不是谷歌。这并不是说你不能或者不会成为像谷歌那样的巨头。但是不要从这个假设开始。“受欢迎的通常是一些非常新颖的技术，由一家性感的公司驱动，具有非常复杂的需求，并大规模出现。巴雷特说:“作为一家全新的创业公司，你的需求与谷歌的需求相同的可能性很小。“有一些好的数据库可供选择，比如 Postgres，但是它们正在失去光芒，因为它们太无聊了(T2)。更令人兴奋的是，谷歌使用了这种真正多样化的数据库技术。我想成为谷歌那样的人，所以我要利用它的技术。"

但是人们忘记了谷歌以这种方式发展其技术基础的原因是因为它运行着世界上最大的搜索引擎。“为搜索引擎提供动力的技术与为许多其他业务提供动力的技术不同。谷歌每天需要吸收大量数据，其中只有极小一部分是变化的或有趣的。过去，谷歌基本上每天都会复制一份互联网。这意味着它能够使用一种数据索引方法，这种方法可以非常快速地搜索和添加数据，但在添加后选择性地删除或更改数据时却非常缓慢。这对谷歌来说没问题，因为每天他们都会把整个东西扔掉，然后从头开始，”巴雷特说。“绝大多数企业都没有这样做。相反，他们正在慢慢积累一组更加密集的数据——账户、密码和可编辑的文档——你不能扔掉它们重新开始，而是需要随着时间的推移不断更新。”

你的创业公司是在做互联网日报的副本吗？如果不是，就不要试图模仿谷歌的数据库架构。

# 如何大开眼界地了解数据库架构

复制许多受欢迎的技术基础或你钦佩的公司的危险在于，它们可能与你的公司非常不同。他们做出的决定实际上会对你产生约束。但是当他们绕过这些约束时，这些参数可能会成为你的绊脚石。以下是在设计数据库架构时如何降低这种风险。

**做** ***你的*** **之前的数学规范勾引你。很容易被数据库的性能所打动，而不去想你实际需要什么。“当你听说一个数据库可以被分散在一千台计算机上处理数十亿字节的数据时，不要昏过去。首先，问问你自己:“我真正期望拥有多少数据？”巴雷特说:“你需要 1000 倍数据的可能性是非常小的。即使在今天，如果我们不关心可靠性和可维护性，我们可能会从一台 5 年前的数据库服务器上运行所有 Expensify。人们忘记了今天的计算机是多么的强大和便宜。美国国家航空航天局(NASA)带着一台比你的 iPhone 功能小 1 万倍的计算机去了月球，即使是一台廉价的服务器也能处理比这多 1000 倍的数据。对于一般的创业公司来说，在接下来的几年中，需要多台服务器容量的可能性非常低*。"***

**维护优先于产能**。“今天，最便宜的戴尔服务器配有双核 2.8GHz 处理器和 500 GB RAID 存储，售价仅 700 多美元。升级到 8 核 3.7GHz 盒子，64GB 内存和 10TB 存储，价格约为 3200 美元——远远低于 Expensify 每月花在咖啡上的费用。大多数初创公司都会在超出市场上最便宜的服务器之前失败或被收购，特别是因为存储成本的下降速度远远超过大多数初创公司的增长速度。尽管 EC2 对云管理收取额外费用，但它仍然便宜两倍。不管你是租还是买你的硬件，对于绝大多数创业公司来说，容量不是也永远不会是一个真正的问题。但是维护会。如果您的单台服务器出现问题，或者您只需要升级，当您重新启动它时会发生什么？你的整个服务就消失了。一句话:电脑便宜得离谱——多买几台，不是为了容量，而是为了冗余。”

![](img/b7dbf77424bbdee82aa30f955b7d8eaf.png)

Expensify Founder and CEO David Barrett

**在安全上吹毛求疵**。“大多数数据库可以通过两种方式访问。第一个是对数据库进行一般查询。另一种方式是通过所谓的[存储过程](https://en.wikipedia.org/wiki/Stored_procedure "null")。Barrett 说:“诚然，所有数据库都有安全措施，但它们并非生而平等。“大多数时髦的新数据库都依赖于内置在 web 服务器代码中的安全性。问题是你的网络服务器是最有可能被入侵的*，因为它们直接位于互联网上。如果他们这样做了，他们就可以绕过安全措施，不受限制地访问数据库。存储过程在数据库本身内部执行，使您能够将安全性构建到数据库层中，从而避开 web 黑客的攻击。在不知不觉中，绝大多数初创公司——尤其是消费类公司——都在选择无法以安全方式制造的技术。一旦他们有了客户，在不停机的情况下进行安全改造的成本比他们一开始就这么做要高得多。”*

一旦我们有了成堆的现金，就去买个保险箱吧。创业公司往往就是这么考虑数据库安全的。

# 下面是要做的事情

早期，成长期。消费者，企业。每个创业公司都有自己的一套环境，但巴雷特认为，有一个经验法则可以服务于一系列寻求智能和有意数据库架构的技术公司。以下是如何做到这一点:

**从三个数据中心开始。**鉴于当今的技术使之成为可能，Barrett 认为，每一家初创公司都应该从第一天就在三个数据中心起步。“三是个神奇的数字，”他说。“一个还不够好，因为它倒下只是时间问题。互联网会死，或者停电。不管是什么，总会出问题，所以单个数据库是不够的。两者的问题在于，你容易患上所谓的“大脑分裂综合症”。如果每个数据中心的服务器彼此失去联系，不清楚对方是完全消失还是只是暂时无法访问。如果在同一时间，他们都认为另一个倒下了，那么他们都认为自己在负责，并重复努力。在我们的世界中，这可能意味着他们都报销了相同的费用报告，并重复支付。这可不好。"

同一个时钟，你永远知道时间。有两个不同的时钟，你永远不会知道，因为你不知道哪个是正确的。

由于一个数据中心易受影响，而两个数据中心很容易交叉，所以从三个数据中心的服务器开始。“如果您有三个，这意味着在任何时候，您都可能会失去整个数据中心，但仍然会剩下两个。巴雷特说:“两个人可以构成法定人数，并决定一个决定。“这听起来像是第一天就要做的很多，但可能会更糟。当没有人盯着你的时候，提前解决这个问题会好得多。投资者没有对你不满，客户也没有惊慌失措。为前期扩展奠定基础。在 AWS 中使用三个不同的数据中心或三个不同的可用性区域。又便宜又容易。这只是需要远见。”

**找到并使用复制技术。**为什么更多的创业公司不从三个数据中心开始？构建三个数据中心意味着在第一天，在您拥有任何数据之前，您需要处理复制问题。每个数据中心中的每台服务器都需要不断地与其他服务器共享数据，以便每台服务器共享相同级别的信息。

“但是，经典的复制技术实际上是针对拥有备用或备份服务器而优化的，当主服务器出现故障时，每个人都可以“故障切换”到该服务器。这个故障转移过程要么是手动的，要么是与自定义脚本一起“丢弃”请求。巴雷特说:“不管怎样，失败都是一个严重的问题，会影响到现有的客户。“更现代的解决方案是在考虑复制和故障切换的情况下构建的，因此服务器宕机是一个很平常的事情，不会丢失请求，不需要手动操作，也不会对客户造成影响。此外，与专为单个数据中心内非常快速、非常可靠的网络设计的经典解决方案不同，新解决方案经过优化，可在全球数据中心之间相对较慢且不可靠的互联网连接上工作。”

挑战的一部分是过时的关系数据库管理系统的优势。“如果你试图用 MySQL 做这件事，那将会非常困难，因为它是一个为磁盘超级慢和小的时代设计的旧数据库。文件系统不能大于 4GB。它是为一个与我们今天生活的世界完全不同的世界而设计的，”巴雷特说。“今天，一切都在[固态硬盘](https://en.wikipedia.org/wiki/Solid-state_drive "null")上，甚至缓存在内存中——因此速度超快。这就是 MySQL 的难题。它仍在使用，但针对一系列不再存在的约束进行了优化，因此它具有旧世界的所有包袱，但并不真正具有新世界的优势。”

有一些工具可以帮助同步不同数据中心的服务器，但开源、易于实现的工具才刚刚出现。“在三个数据中心推出一些经典解决方案仍然很困难，在 2007 年，如果没有 Oracle 这样的大公司，这几乎是不可能的。公平地说，Percona 可能有效，但它太新了，我当时没有发现，”Barrett 说。“由于我有 P2P 软件的背景，我们决定自己构建一个解决方案。由此产生的技术被称为[基岩](http://bedrockdb.com/ "null")，它使实时复制、地理冗余分布的操作变得容易，而没有 Oracle 或 MySQL 的复杂性。就每台服务器而言，它在本地环境中只有一个数据库，但是技术将它们连接起来，并负责所有的复制。为了好玩，我们还让它说 MySQL 协议，这样它就可以*几乎*成为替代者。”

Expensify 计划免费提供这项技术，因为它在寻找解决方案时没有多少选择。“最初，它只是针对我们无法现成找到的特定问题的专有解决方案。但是随着时间的推移，我们意识到它有多么强大，以及任何人都可以使用它。因为具有自动、无损故障转移的无缝集群的理念与任何关心性能和可用性的人都有关系，而性能和可用性与每个人都有关系，”Barrett 说。“但很少有人会有理由自己建造它，因为它的核心技术, [Paxos 分布式共识算法](https://en.wikipedia.org/wiki/Paxos_(computer_science) "null"),很难获得成功。这使得一组同等的服务器能够可靠地选择一个主服务器来协调分布式事务和重新平衡流量，并在故障发生后几毫秒内完成。但我们已经花了八年时间对它进行了几个数量级的磨练，因此它在各种现实条件下都非常坚固，因此我们认为它已经准备好进行更广泛的使用。”

决定是否对你的数据进行分区。从不同的数据中心选择三台服务器并选择复制技术后，确定是否要对数据进行分区。分区包括将数据库分解成整体中不同的独立部分。这个选择会影响很多未来的决定。

“事实上，每个人都是从‘脱节的群体’开始的，因为这在概念上是最简单的。Barrett 说:“无论是面向个人的消费产品还是面向公司的企业产品，用户之间的关系在一开始就非常明显。“例如，如果您正在进行企业文档存储，最初看起来很明显，您只需要在公司内部的员工之间共享文档。您甚至可能与企业客户签订合同，要求数据在物理上被隔离—毕竟，这有什么坏处呢？”

风险是有一天你遇到了一个意想不到的用例，它把你以前认为不相关的人联系起来。“假设一家律师事务所为两个不同的客户工作，每个客户都托管在两个不同的数据库中。突然之间,“不连贯的群体”模式崩溃了，因为将律师事务所放在一个数据库中意味着它无法“看到”另一个数据库中的文件。您的技术现在阻止了您的产品支持这一关键用例，而您可能已经通过签署依赖于它的企业协议巩固了这一技术。”

另一种方法是一开始就假设任何两个用户*可能有一天*想要共享数据，因此从一开始就设计一个共享数据库。“这让你走上了一条完全不同的技术之路，因为你不能再只是‘扔硬件’来解决问题。Barrett 说:“如果您的数据库已满，您不能只为下一批客户建立一个新的数据库，您需要找到一种方法来升级整个数据库，而且不需要为每个人都关闭它。”。“为您的所有用户维护一个连续的数据库的好处是，您消除了谁可以与谁共享的限制，无论是现在还是将来。缺点是单个大型数据库比一堆小型数据库更难维护，尤其是在您使用传统数据库解决方案的情况下。”

# 航向修正入门

不是每个创业公司都有从零开始的奢侈。如果你已经有意或无意地做出了其他一些选择，有一些方法可以让你走上正轨。按下铁路道岔可能需要一些努力，但是火车还没有离开车站。

**选择跨多个可用性区域复制的数据库。**“大多数初创公司会说，‘我有一个运行我的 web 服务器的 EC2 实例，一个作为我的数据库的 RDS 实例，或者我在 S3 存储一些数据。这一切都在一个可用性区域内，”不要在第一天就把自己逼入困境:构建以支持 Amazon 或不同数据中心的多个可用性区域。"

**试试 Expensify 的复制技术**。“从 MySQL 切换到基岩很容易:如果你很小，你可能会在半夜关闭你的服务器，导出你的数据，再导入到基岩，你的网络服务器不会知道其中的区别，因为基岩使用 MySQL 协议。”

**从存储过程**开始。“问问你自己:‘如果黑客入侵了我的网络服务器，会有多糟糕？’如果答案是“非常糟糕”，那么将您的身份验证逻辑移到数据库内部的存储过程中。它更加安全，为最终用户保持了更好的分层和更高的性能。"

# 将它整合在一起

大多数人不会将数据库架构描述为性感。但是，在拥有客户或他们的数据之前做好准备是至关重要的。您如何组织、扩展和保护这些数据不仅会影响您的技术，还会影响您业务模式的可扩展性。从三个不同的数据中心或可用性区域中的至少一台服务器开始。选择一种复制技术，使它们能够精确可靠地相互通信。检查用户之间的关系，以决定是否应该对数据进行分区。考虑使用存储过程来保护您的数据。最大的挑战不是决定采用这种方法，而是适应从 MySQL 等流行的数据库管理系统转向。

“不要像谷歌一样围绕数据库架构做决策。但是也不要给你的创业公司设置限制，那会消除它将来成为“谷歌”的机会。事实是，许多创业公司在这些问题出现之前就已经失败了。但是问问你自己:你是为了成功还是失败而优化？”巴雷特问道。“严格的要求和早期的机遇让我们对数据库架构进行了更深入的思考。我们现在知道，foundation 不仅帮助我们扩展了我们预期的需求，还支持了我们从未想象过的所有令人惊叹的深度数据和人工智能机会。鉴于我们最初对数据库架构做出的决定，这是唯一可能的，我们将所有数据保存在一个巨大的桶中，可以以任何可以想象的方式进行切片、切块和混合。另一种选择是严峻的。如果你在第一天没有意识到你正在建造一座监狱，那些栅栏就真的很难移动。”