# 位置基流体：密度和表面约束

> 原文：[`phys-sim-book.github.io/lec32.4-position_based_fluids.html`](https://phys-sim-book.github.io/lec32.4-position_based_fluids.html)



位置基动力学框架可以从固体优雅地扩展到模拟不可压缩流体。这种方法被称为位置基流体（PBF）[[Macklin & Muller 2013]](bibliography.html#macklin2013position)，它用一组几何约束替换了传统光滑粒子流体动力学（SPH）[[Koschier et al. 2020]](bibliography.html#koschier2020smoothed)中的复杂压力求解。这种方法继承了 PBD 的稳定性和效率，允许使用适合实时应用的大时间步长，同时有效地执行表征不可压缩流的恒定密度条件。

### 每个粒子的密度约束

PBF 的基本原理是确保每个流体粒子周围的密度保持恒定。给定粒子位置的密度是通过对其邻居的基于核的求和来估计的。

对于位于位置 pi​ 的粒子 i 的密度 ρi​，其估计值为：ρi​=j∑​mj​W(pi​−pj​,h)(33.4.1)，其中求和是对所有邻近粒子 j 进行的，mj​ 是粒子 j 的质量，h 是平滑核半径，W 是径向对称的平滑核函数。为了简化，我们可以假设所有粒子具有相等的质量，并将其吸收到密度计算中。

目标是确保这个估计密度 ρi​ 与用户定义的静止密度 ρ0​ 匹配。这被表述为每个粒子的约束函数 Ci​。

> ****定义 33.4.1 (PBF 密度约束).**** 对于每个粒子 i，密度约束 Ci​ 被定义为从静止密度 ρ0​ 的缩放偏差：Ci​(p1​,...,pN​)=ρ0​ρi​​−1(33.4.2)。当 Ci​=0 时，约束得到满足。

为了解决这个约束系统，PBF 为每个粒子计算一个位置校正 Δpi​。遵循 PBD 方法，我们首先计算 Ci​ 关于粒子 k 位置的梯度：∇pk​​Ci​=ρ0​1​j∑​mj​∇pk​​W(pi​−pj​,h)={ρ0​1​∑j​mj​∇W(pi​−pj​,h)−ρ0​mk​​∇W(pi​−pk​,h)​if k=iif k=i​(33.4.3) 标准的 PBD 求解器使用公式 λi​=−Ci​/(∑k​∥∇pk​​Ci​∥2) 对每个约束 Ci​ 计算一个单 Lagrange 乘子 λi​。然后，从其自身约束和邻居约束的影响中推导出粒子的位置校正 Δpi​。由于核梯度（∇pi​​W(pi​−pj​,h)=−∇pj​​W(pi​−pj​,h)）的对称性，这导致粒子 i 的位置校正更新规则简单且高效：Δpi​=ρ0​1​j∑​(λi​+λj​)∇W(pi​−pj​,h)(33.4.4)。在这里，通常使用具有非零梯度的尖锐核，以防止粒子聚集。

> ***备注 33.4.1（鲁棒性和约束软化）*** 当一个粒子附近邻居很少时，会出现一个实际问题，因为分母∑k∥∇pkCi∥2 可能接近零，导致大的、不稳定的位置修正。为了防止这种情况，向分母添加了一个小的松弛参数ε，软化了约束。这被称为约束力混合（CFM）[[Smith 等人 2005]](bibliography.html#smith2005open)。然后：λi = -∑k∥∇pkCi∥2 + εCi(p1,...,pN) (33.4.5)

### 校正拉伸不稳定性

在基于 SPH 的流体模拟中，一个众所周知的问题是“拉伸不稳定性”，其中由于无法满足静止密度，靠近自由表面的粒子会聚集在一起。PBF 通过结合一个人工压力项提供了一个直接的解决方案。

具体来说，引入了一个人工压力项 scorr，以在附近的粒子之间创建短程排斥力。这个项是 W 的函数：scorr = -k(W(Δq, h)W(pi - pj, h))n (33.4.6)，其中 k 和 n 是小的正常数（例如，k=0.1,n=4），Δq 是一个表示内核半径内的小距离的向量（例如，∥Δq∥=0.3h）。这个项仅用于推开粒子，并直接纳入从方程(33.4.4)的位置修正计算：Δpi = ρ0¹/2j∑(λi + λj + scorr)∇W(pi - pj, h) (33.4.7)。这防止了聚集，并在流体边界上隐式地创建了一种类似表面张力的效果。

### 速度级修正：粘度和涡量

虽然 PBF 中的主要约束操作在位置上，但速度级更新仍然是必要的，以模拟粘度等现象并重新引入失去的能量。这些作为后处理应用于主 PBD 求解器循环更新位置和速度之后。

**XSPH 粘度:** 为了赋予更连贯、类似液体的运动，并减少粒子混合，应用了 XSPH 粘度。它调整每个粒子的速度，使其更接近其邻居的平均速度：vinew = vi + cj∑(vj - vi)W(pi - pj, h) (33.4.8)，其中 c 是一个正的粘度系数，通常是一个很小的值，如 0.01。

**涡量约束:** PBD 的迭代性质可能会引入数值阻尼，导致流体失去旋转能量，看起来过于粘稠。可以通过在每个粒子处计算涡量（速度场的旋度）ωi = ∇×vi 并应用校正力 fvorticity = ε(N×ωi)来重新引入小尺度的旋转细节来使用涡量约束来对抗这种情况。然后，将这个力积分以更新粒子速度。
