# 约束求解器

> 原文：[`phys-sim-book.github.io/lec31.4-solver.html`](https://phys-sim-book.github.io/lec31.4-solver.html)

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.4/dist/katex.min.css">

PBD 算法的核心是约束求解器，它通过迭代地将预测的粒子位置投影以满足定义的约束。由于这种投影必须在物理上合理进行，理想情况下应保持系统的总线动量和角动量以适应内部约束，我们采用非线性 Gauss-Seidel 求解器。

### 约束投影：动量守恒

为了尽可能保持物理上的合理性，我们确保对于任何内部约束，修正步骤不应引入虚假的外部力，通常称为“幽灵力”。这是通过确保线动量和角动量的净变化为零来实现的。设Δpi 为粒子 i 的位置修正。如果修正不改变质心，则线动量是守恒的：

i∑miΔpi=0

如果修正产生的净扭矩相对于一个共同的旋转中心 c 为零，则角动量是守恒的：

i∑(pi−c)×(miΔpi)=0

> ***备注 32.4.1（约束梯度）*** 一个关键的洞察是，如果连接粒子位置的修正向量Δp=[Δp1T,…,ΔpnT]T 被选为与约束梯度∇pC 平行，即：Δp⊤∇pC=0，那么对于许多常见的内部约束（这些约束与刚体变换无关），当粒子质量相等时，动量会自动守恒。

因此，每个粒子的修正将被假设为与约束梯度平行。这一选择得到了支持，因为梯度指向约束函数最陡上升的方向，因此朝相反方向移动是减少约束误差的最直接方式。

### 位置修正（一般约束）

考虑一个涉及 n 个粒子的单个约束 C(p1,…,pn)=0。给定一组违反此约束的预测位置 p（即，C(p)≠0），我们寻求一个修正Δp，使得 C(p+Δp)=0。为了使问题可处理，我们使用当前位置 p 周围的一阶泰勒展开线性化约束函数：C(p+Δp)≈C(p)+∇pC(p)⊤Δp+O(∥Δp∥2)≻0。(32.4.1)

如上所述，我们将校正限制在约束梯度的方向上。这使我们能够用单个未知标量λ来定义单个粒子 i 的校正，该标量λ充当拉格朗日乘子：Δpi=−λwi∇piC(p)(32.4.2)，其中 wi=1/mi 是质量倒数，确保较轻的粒子位移更大。负号是一个约定，用于将λ与正约束违反的排斥力概念对齐。对于所有涉及的粒子，这可以表示为向量形式：Δp=−λM−1∇pC，其中 M 是对角质量矩阵。

为了找到λ的值，我们将方程(32.4.2)中的校正代入线性化约束方程(32.4.1)。对于等式约束，这变为：C(p)+∇pC(p)⊤(−λM−1∇pC(p))=0 通过求解拉格朗日乘子λ得到：λ=∑j=1n​wj∥∇pjC(p)∥2C(p)(32.4.3)。一旦确定了λ，每个粒子的位置校正Δpi 就完全定义了。我们还可以通过将方程(32.4.3)代入方程(32.4.2)来写出完整的校正表达式：Δpi=−∑j=1n​wj∥∇pjC∥2C(p1,…,pn)wi∇piC(p)(32.4.4)。这个方程是 PBD 求解器的基石。它提供了一种直接且计算效率高的方法来计算满足单个线性化约束并尊重粒子质量所需的位置校正。这个投影在每个时间步内对每个约束求解多次。需要注意的是，对于沿着梯度线性的约束，例如简单的距离约束，这种线性化是精确的，约束可以在单步中满足。

> ****示例 32.4.1（距离约束）**** 让我们考虑最基本的约束之一：距离约束，它强制两个粒子 p1 和 p2 之间保持固定的分离距离 d。这是建模弹簧的拉伸阻力、布网边缘或物体之间的刚性连接的常用构建块。
> 
> 约束函数定义为当前距离与期望的静止距离 d 之间的差：C(p1​,p2​)=∥p1​−p2​∥−d 这个函数直接测量需要纠正的错误。虽然可以从方程 (32.4.4) 中的通用投影方法应用，但对于这个特定且常见的情况，结果简化为一个非常直观的形式。每个粒子的最终位置修正直接给出如下：Δp1​Δp2​​=−w1​+w2​w1​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​=+w1​+w2​w2​​(∥p1​−p2​∥−d)∥p1​−p2​∥p1​−p2​​ The term (∥p1​−p2​∥−d) 表示沿着连接粒子的向量上所需的总修正量。然后，根据它们的逆质量比 wi​/(w1​+w2​) 在两个粒子之间分配这个总修正。修正沿着单位向量 (p1​−p2​)/∥p1​−p2​∥ 应用，如果粒子之间距离太远（C>0），则将粒子推向彼此；如果粒子之间太近（C<0），则将粒子推开。这种公式直接满足线性动量守恒！

### 分层求解器

PBD 中的标准 Gauss-Seidel 求解器对于低频、大规模形变表现出收敛速度慢，因为修正只局部传播。为了加速这个过程，分层位置基于动力学 (HPBD) [[Müller 2008]](bibliography.html#muller2008hierarchical) 引入了一种多分辨率方法。系统被表示为一个从粗到细的网格层次结构。求解器首先在最低级别上操作，允许大规模错误的修正快速在整个对象上传播。然后，通过插值（延长）将这些修正传递并逐级细化，在单次粗到细的遍历中完成。这种受多网格启发的技术显著提高了收敛速度。为了正确工作，粗级别上的约束必须是单边的（不等式约束），仅抵抗拉伸，以避免人为地限制对象的大规模弯曲和折叠。
