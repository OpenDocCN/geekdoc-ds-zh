# 编译阶段

> 原文：[`en.algorithmica.org/hpc/compilation/stages/`](https://en.algorithmica.org/hpc/compilation/stages/)

在直接跳到编译器优化之前，这是本章的大部分内容，让我们首先简要回顾一下“大局”。跳过无聊的部分，将 C 程序转换为可执行文件有 4 个阶段：

1.  **预处理**扩展宏，从头文件中提取包含的源代码，并从源代码中删除注释：`gcc -E source.c`（将预处理的源代码输出到 stdout）

1.  **编译**解析源代码，检查语法错误，将其转换为中间表示，执行优化，最后将其翻译成汇编语言：`gcc -S file.c`（生成一个`.s`文件）

1.  **汇编**将汇编语言转换为机器代码，除了任何外部函数调用（如`printf`）都被占位符替换：`gcc -c file.c`（生成一个`.o`文件，称为*目标文件*）

1.  **链接**最终通过插入它们的实际地址来解决函数调用，并生成一个可执行的二进制文件：`gcc -o binary file.c`

在这些每个阶段中都有提高程序性能的可能性。

### [#](https://en.algorithmica.org/hpc/compilation/stages/#interprocedural-optimization)过程间优化

我们有最后一个阶段，链接，因为按文件逐个编译程序然后链接这些文件既容易又快，这样你可以并行执行，还可以缓存中间结果。

它还提供了将代码作为*库*分发的功能，这些库可以是*静态*的或*共享*的：

+   *静态*库只是预编译的目标文件的集合，编译器将它们与其他源代码合并以生成单个可执行文件，就像它通常所做的那样。

+   *动态*或*共享*库是预编译的可执行文件，它们包含有关其可调用位置的其他元信息，这些引用在运行时被解析。正如其名所示，这允许*共享*多个程序之间的编译二进制文件。

使用静态库的主要优点是你可以执行需要更多上下文（而不仅仅是库函数签名）的各种*过程间优化*，例如函数内联或删除死代码。要强制链接器查找并仅接受静态库，你可以传递`-static`选项。

这个过程被称为*链接时优化（LTO）*，这是可能的，因为现代编译器也会在目标文件中存储某种形式的*中间表示*，这使得它们可以对整个程序执行某些轻量级优化。这也允许在同一个程序中使用不同的编译语言，如果它们的编译器使用相同的中间表示，甚至可以在语言障碍之间进行优化。

LTO 是一个相对较新的特性（它在 GCC 中大约出现在 2014 年），并且它还远未完善。在 C 和 C++ 中，确保由于单独编译而不会丢失性能的方法是创建一个 *仅包含头文件的库*。正如其名所示，它们只是包含所有函数完整定义的头文件，因此通过简单地包含它们，编译器就可以访问所有可能的优化。尽管您确实需要每次从头开始重新编译库代码，但这种方法保留了完全的控制权，并确保不会丢失任何性能。

### [#](https://en.algorithmica.org/hpc/compilation/stages/#inspecting-the-output)检查输出

检查每个阶段的输出可以为您提供关于程序中发生情况的宝贵见解。

您可以通过向编译器传递 `-S` 标志来从源代码获取汇编代码，编译器随后将生成一个人类可读的 `*.s` 文件。如果您传递 `-fverbose-asm`，此文件还将包含有关源代码行号和正在使用的变量的编译器注释。如果您只是想查看一小段代码并且感到懒惰，可以使用 [Compiler Explorer](https://godbolt.org/)，这是一个非常实用的在线工具，可以将源代码转换为汇编代码，通过颜色突出显示逻辑汇编块，包含一个小的 x86 指令集参考，并且还提供了大量其他编译器、目标平台和语言的选项。

除了汇编代码之外，另一个非常有用的抽象级别是编译器执行的优化所基于的中间表示。IR 定义了计算流程本身，并且对架构特性（如寄存器数量或特定的指令集）的依赖性要小得多。检查这些内容通常有助于了解编译器是如何“看到”您的程序的，但这超出了本书的范围。

我们将在本章中主要使用 [GCC](https://gcc.gnu.org/)，但在必要时也会尝试复制 [Clang](https://clang.llvm.org/) 的示例。这两个编译器在很大程度上是兼容的，大部分差异仅在于一些优化标志和微小的语法细节。[← ../Compilation](https://en.algorithmica.org/hpc/compilation/)[标志和目标 →](https://en.algorithmica.org/hpc/compilation/flags/)
