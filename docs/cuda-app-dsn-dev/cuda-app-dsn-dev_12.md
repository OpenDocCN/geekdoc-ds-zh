第十一章 CUDA 在实际问题中的应用 CUDA 使开发者能够在 GPU 上将应用程序的加速能力提高一个到三个数量级，相比于传统处理器。了解如何在 CUDA 中思考和编程是成长为熟练 CUDA 程序员的必要第一步。请参考互联网和技术文献，寻找提供通用解决方案和设计模式的项目，这些模式可以适应你的项目。CUDA 速度快；重新发明轮子则很慢。本书中的章节旨在教授并提供一些未来应用的初步框架。例如，第二章中的简单 C++函数框架实现了一种通用的并行映射，用于模式识别和优化，其在 GPU 上的运行速度比高端四核处理器快 85 倍，并且在单核性能上提供了 341 倍的提升。第十章将这个例子扩展到使用 MPI 在包含数百个 GPU 的计算集群上运行。500 GPU TACC Longhorn 集群是一个可以利用这种并行映射提供近半个 petaflop（500,000 gigaflops）单精度浮点性能的系统。这些例子将你的 GPU 变成一个引擎，用于在复杂数据中寻找模式，其能力超过了 1996 年之前存在的最大超级计算机。数据可视化是 GPU 计算能力的自然延伸。如第九章所示，将 CUDA 与 OpenGL 互操作性结合意味着数据甚至不需要从 GPU 上移动。也就是说，在线信息和技术文献远远超出了这些例子和本书的页面。本章指引了其他高级用法和编程项目的方向。**关键词**MDS（多维尺度分析）、互信息、力导向图布局、系统发育树、数据降维。维度诅咒、支持向量机（SVM）、蒙特卡洛。CUDA 使开发者能够在 GPU 上将应用程序的加速能力提高一个到三个数量级，相比于传统处理器。了解如何在 CUDA 中思考和编程是成长为熟练 CUDA 程序员的必要第一步。请参考互联网和技术文献，寻找提供通用解决方案和设计模式的项目，这些模式可以适应你的项目。CUDA 速度快；重新发明轮子则很慢。本书中的章节旨在教授并提供一些未来应用的初步框架。例如，第二章中的简单 C++函数框架实现了一种通用的并行映射，用于模式识别和优化，其在 GPU 上的运行速度比高端四核处理器快 85 倍，并且在单核性能上提供了 341 倍的提升。第十章将这个例子扩展到使用 MPI 在包含数百个 GPU 的计算集群上运行。500 GPU TACC Longhorn 集群是一个可以利用这种并行映射提供近半个 petaflop（500,000 gigaflops）单精度浮点性能的系统。这些例子将你的 GPU 变成一个引擎，用于在复杂数据中寻找模式，其能力超过了 1996 年之前存在的最大超级计算机。¹ 数据可视化是 GPU 计算能力的自然延伸。如第九章所示，将 CUDA 与 OpenGL 互操作性结合意味着数据甚至不需要从 GPU 上移动。也就是说，在线信息和技术文献远远超出了这些例子和本书的页面。本章指引了其他高级用法和编程项目的方向。¹美国桑迪亚国家实验室在 1996 年建造了第一台能够执行超过一万亿次浮点运算的超级计算机。请不要将本章视为详尽无遗的列表。相反，它提供了一些流行技术和使用 CUDA 的包的广泛介绍。大多数讨论的方法将提供一个可下载的 CUDA 源包的链接，可以进行审查、构建和使用。互联网上和技术文献中还有许多其他优秀资源。一个好的起点是开发者专区的 CUDA 展示，其中包含数百个 CUDA 技术和论文的链接。²²[`developer.nvidia.com/cuda-action-research-apps`](http://developer.nvidia.com/cuda-action-research-apps)。在本章结束时，读者将了解到：■ 几种将高维数据降至低维的技术。■ 用于可视化的力导向图。■ 多维尺度分析（MDS）。■ 互信息。■ 蒙特卡洛方法。■ 分子建模。

# 处理高维数据

我们生活在数据时代。自动系统收集物理和社会系统中交易和互动的绝大多数细节。模式是存在的，但它们在哪里？通过简单的数据库查询或互联网搜索，可以提取一个有趣的数据集，该数据集将每个事件的不同度量（或观察）连接起来。这些事件可能是顾客购买或数百颗恒星的频谱数据。多个事件可以表示为矩阵的行，其中每一行是一个事件，每一行的列包含关于该事件的测量。一个常见的问题是，“哪些行彼此相似？”换一种说法，问题变为，“哪些事件，或向量，彼此接近？”对于许多问题，可以使用诸如*欧几里得距离*之类的度量来计算矩阵中每一行的距离。欧几里得距离是使用尺子和勾股定理获得的距离度量。那些在距离上接近的行可以被认为是“相似”的，而那些距离较远的则是“不相似”。除了欧几里得距离之外，还有许多其他的距离度量，但欧几里得距离直观上容易理解。《第三章》中讨论的维度诅咒是为什么在高维空间中工作对于许多问题来说不切实际的原因。例如，要求所有在给定点附近某个距离内的行，在高维空间中可能会返回没有值（因为采样非常稀疏）或几乎所有的数据（因为搜索区域的体积非常大，包含了大部分或所有已知数据）。在两种情况下，答案都是没有意义的。将搜索的维度降低到指数级别会减少搜索区域的体积。这就是为什么数据挖掘者喜欢在低维空间中工作——它增加了得到有意义答案的机会，“在低维空间中，哪些点彼此接近？”当然，用于将高维数据转换为低维空间的投影必须保留点之间的距离关系。

## PCA/NLPCA

如第三章所讨论，自动编码器、主成分分析（PCA）和非线性主成分分析（NLPCA）是一些用于将高维数据表示为低维空间的技术。第三章中的示例代码本质上是将高维数据通过信息瓶颈（瓶颈神经元）进行处理，以便能够重建这些高维数据。通过测量原始数据和重建数据之间的误差，可以衡量成功的程度。低误差意味着低维投影保留了高维数据中点与点之间的距离关系。第三章中的示例代码可以通过修改**genData()**方法来适应你自己的数据集。同样，第十章中的数据生成器可以更改为一个将你自己的数据写入文件的生成器。在这两种情况下，修改*CalcError.h*文件可以让你定义自己的 PCA 或 NLPCA 架构。使用一个、两个或三个瓶颈神经元意味着低维数据可以通过大多数 2D 和 3D 图形软件包（如 gnuPlot、Excel、MATLAB 等）进行可视化。有关自动编码器和其他基于神经网络的方法的更多信息，请参见 Geoffrey Hinton 的工作（Hinton & Salakhutdinov, 2006）³以及许多其他人。[`nlpca.org`](http://nlpca.org)网站是学习 NLPCA 的一个很好的起点，特别是对于 MATLAB 用户。[`www.cs.toronto.edu/~hinton/`](http://www.cs.toronto.edu/~hinton/)。

## 多维尺度分析

多维尺度分析（MDS）提供了一种关于降维的替代视角。MDS 是另一种经典方法，它将高维数据集映射到低维空间，但其目的是尽量保持成对的距离。已经开发出了许多经典方法的变种。一篇很好的参考书籍是*多维尺度分析*（Cox & Cox, 2008）。Glimmer 包在 GPU 上实现了 MDS（Ingram, Munzner, & Olano, 2009）。根据数据大小，速度提升的范围为传统处理器的 10 到 15 倍。源代码可以从不列颠哥伦比亚大学的网站免费下载。⁴⁴[`www.cs.ubc.ca/~sfingram/glimmer/`](http://www.cs.ubc.ca/~sfingram/glimmer)。

## K-Means 聚类

K-means 聚类将若干事件划分为 k 个簇，每个事件都归属于距离其均值最近的簇。在当今的实际应用中，拥有十亿数据点的数据集已十分常见。借助 CUDA GPU 加速，惠普公司报告称，拥有十亿数据点的数据集可以在几分钟内完成聚类处理（Wu, Zhang, & Hsu, 2009）。惠普软件声称，相较于在八核 CPU 上运行的高度优化的仅 CPU 版本，其性能提升了一个数量级；而与流行的 MineBench 基准测试（Narayanan et al., 2006）在单核上运行时相比，性能提升了约 300 倍。许多其他研究者（Hong-tao, Li-li, Dan-tong, Zhan-shan, & He, 2009；Ma & Agrawal, 2009；Shalom, Dash, & Tue, 2008）也报告了 K-means 聚类的显著加速。Serban Giuroiu 编写的 K-means 版本可以从 GitHub 上免费下载。⁵ 据称其运行速度是顺序版本的 50 倍。[`github.com/serban/kmeans`](https://github.com/serban/kmeans)。

## 期望最大化

K-means 和 MDS 类似于高斯混合模型的期望最大化（EM）算法，它们都试图找到数据中自然聚类的中心，并且采用了类似的迭代优化方法。EM 算法广泛应用于信号处理和数据挖掘领域。EM 方法有一个免费下载版本，报告称其速度比参考 CPU 实现快了 170 倍。⁶ NVIDIA 发布了一篇论文，报告了一个类似的加速结果，与一个简单实现相比有类似的速度提升（Kumar, Satoor, & Buck, 2009）。EM 方法也可以在本书提供的优化框架中作为函数式对象实现。本章后面将讨论的 CUDA-MEME 包是另一个免费的 EM 包。[`andrewharp.com/gmmcuda`](http://andrewharp.com/gmmcuda)。期望最大化算法还被用于发现社交网络和生物数据中的模式。报告称，GPU-MEME 在单个 GPU 上提供了数量级的加速，在计算集群上提供了两倍数量级的加速（Chen, Schmidt, Weiguo, & Müller-Wittig, 2008）。CUDA-MEME 是基于 GPU-MEME 论文的一个免费下载的模式发现软件包⁷。[`www.nvidia.com/object/meme_on_tesla.html`](http://www.nvidia.com/object/meme_on_tesla.html)。

## 支持向量机

支持向量机（SVM）是一种流行的机器学习方法，用于分析数据和识别模式。SVM 通过构建一个*N*维的*超平面*（将平面推广到*N*维）来进行分类，该平面最优地将数据分为两类。它们广泛用于分类和回归分析等任务。SVM 模型与神经网络密切相关。事实上，使用 sigmoid 核函数的 SVM 模型相当于一个二层感知机神经网络。在文献中已报道，使用 GPU 加速的速度提升可达到 150 倍（Catanzaro, Sundaram, & Keutzer, 2008）。SVM 也可以作为本书中提供的优化框架中的一个函子来实现。cuSVM 包可以从互联网上免费下载。⁸ 该包也可以通过 gputools 包中的**gpuSvnTrain()**方法从 R 统计语言中访问。作者报告的加速比为 22 到 172 倍，超过了现有软件的速度（Carpenter, 2011）。来自南洋理工大学的 CUDA-SVM 包可以在[`sourceforge.net`](http://sourceforge.net)上获得。另一个 SVM 包，multisvm，可以从[`code.google.com`](http://code.google.com)免费下载。⁸[`patternsonascreen.net/cuSVM.html`](http://patternsonascreen.net/cuSVM.html)。

## 贝叶斯网络

贝叶斯信念网络是一个有向图，并且有一组相关的概率表。节点表示变量，这些变量可以是离散的或连续的。图中的弧线表示变量之间的因果/影响关系。贝叶斯网络的关键特性是它们可以用来推理不确定性。当与统计技术结合使用时，这些图形模型在数据分析中有几个优势：  

## 互信息

互信息的概念起源于信息论，并广泛应用于多个学科。例如，互信息可以用于确定艾滋病病毒中与结构或功能相关的位点（Korber, Farber, Wolpert, & Lapedes, 1993）。特别是，Korber 等人的论文展示了如何使用*自助法（bootstrapping）*来确定高成对互信息不太可能是偶然产生的置信度。（统计学中的自助法可以通过多种技术实现，包括从原始数据集中进行有放回的随机抽样。）互信息还可以用于提高机器学习中的预测效果（Farber, Lapedes, & Sirotkin, 1992）。关于这一主题有很多相关文献（Cover & Thomas, 2006），以及大量互联网上的资源。成对互信息提供了两个随机变量之间信息量的度量。通常，这一度量以比特数表示。互信息是通过联合概率分布的熵来定义的，![B9780123884268000112/si1.gif is missing](img/si1.gif)，表示位置 *i* 上符号 *s* 和位置 *j* 上符号 *s′* 的发生。它可以通过对比独立性假设下成对事件期望发生率与实际发生率的对数似然比来表示。参见公式 11.1，“互信息的定义。”（11.1）![B9780123884268000112/si2.gif is missing](img/si2.gif)在医学图像分析中，互信息被用作多模态配准的相似性度量。CUDA 提供了 50 倍的加速，使得医学图像的实时配准成为可能，并在机器人学中得到应用（Ines & Hirschmüller, 2008）。互联网上有许多可免费下载的实现版本。CUDA-MI¹²就是其中之一，另一个是澳大利亚国立大学 Shams 的版本。¹³¹²[`sites.google.com/site/liuweiguohome/cuda-mi`](https://sites.google.com/site/liuweiguohome/cuda-mi)。¹³[`users.cecs.anu.edu.au/~ramtin/cuda.htm`](http://users.cecs.anu.edu.au/~ramtin/cuda.htm)。

# 力导向图

许多基于图的算法仅提供图中节点之间关系的信息。这类问题通常出现在人们互相发送消息、打电话和前往不同地点时。可视化大量此类信息可能具有挑战性。关于绘制图的优秀综述可以参考 Di Battista, Eades, Tamassia, 和 Tollis (1999)和 Brandes (2001)。在缺乏其他信息的情况下，基于弹簧的胡克定律的力导向布局算法已被用来创建令人愉悦且信息丰富的图布局，正如 Eades 的弹簧-质量方程所描述的那样（Eades, 1984），后来 Fruchterman 和 Reingold 将其改编为模拟退火算法，模拟粒子物理学（Fruchterman & Reingold, 1991）。图的放置和布局仍然是一个活跃的研究领域，Frishman 和 Ayellet（Frishman & Ayellet, 2008）利用 GPU 加速增量图布局，提供比 CPU 快 17 倍的结果。Godiyal 等人（Godiyal, Hoberock, Garland, & Hart, 2009）使用快速多极方法（FMM）的一种变体来估计力导向布局中的远程排斥力。（FMM 方法是为加速*N*体问题中的远程力计算而开发的。）多极计算通过基于 GPU 的 k-d 树（用于在 k 维空间中组织点的空间分区数据结构）得到高效支持。作者报告称，他们的技术在 CPU 和 GPU 的先前方法中取得了显著的加速，通过 CUDA 在几秒钟内绘制了数十万个顶点的图。

# 蒙特卡洛方法

蒙特卡洛方法依赖于反复的随机抽样来计算结果。它们常用于模拟物理和数学系统，特别是在模拟具有多个耦合自由度的系统（如流体）时，用于建模现象，以及处理输入中具有显著不确定性的系统，例如商业风险计算。Hubbard 指出，蒙特卡洛在预测失败、成本超支和进度超支方面，通常比人类直觉或其他“软”方法更为准确（Hubbard, 2009）。蒙特卡洛方法在数学中广泛用于评估具有复杂边界条件的多维定积分。例如，Metropolis 算法是一种蒙特卡洛方法，用于从概率分布中获取一系列随机样本，而这种分布直接抽样是困难的。该序列可以用来近似该分布或计算积分以得到期望值。在我在洛斯阿拉莫斯国家实验室理论部的职业生涯中，我有幸认识了 Nick Metropolis，这证明了并行计算的知识如何间接丰富你的生活。他是一个了不起的人。Metropolis 算法被认为是二十世纪对科学和工程发展与实践影响最大的十种算法之一（Andrieu, de Freitas, Doucet, & Jordan, 2003; Beichel & Sullivan, 2000）。对于某些应用，马尔科夫链蒙特卡洛（MCMC）模拟是已知的唯一能够在合理时间内提供解决方案的一般方法（Andrieu, de Freitas, Doucet, & Jordan, 2003; Dyer, Frieze, & Kannan, 1991; Jerrum & Sinclair, 1996）。大量实现蒙特卡洛方法的 CUDA 项目展示了 CUDA 的强大功能以及对这一技术的兴趣。在多 GPU 实现中，加速比范围从 100 倍到超过 1000 倍不等。一个好的入门参考是《Understanding GPU Programming for Statistical Computation: Studies in Massively Parallel Massive Mixtures》（Suchard, Wang, Chan, Frelinger, Cron, & West, 2010）。有一些蒙特卡洛包可以免费下载：  

# 分子建模

分子建模通过使用 CUDA 也实现了显著的性能提升（Eastman & Pande, 2010; Hampton, Agarwal, Alam, & Crozier, 2010; Roberts, Stone, Sepulveda, Hwu, & Luthey-Schulten, 2009; Rodrigues, Hardy, Stone, Schulten, & Hwu, 2008），包括以下软件包：■ NAMD/VMD 分子建模系统（Humphrey, Dalke, & Schulten, 1996; Laxmikant et al., 1999; Stone, Hardy, Ufimtsev, & Schulten, 2010）。■ HOOMD-Blue（Anderson, Lorenz, & Travesset, 2008）是专为 GPU 从头编写的。■ 用于分子动力学的 OpenMM 库。作者报告称，相比传统处理器，性能提升了 100 倍。这些软件包都可以从互联网上免费下载。论文《GPU 加速分子建模的成熟》（Stone, Hardy, Ufimtsev, & Schulten, 2010）是对分子建模感兴趣的读者必读的文献。CUDA 和 GPU 计算还刺激了新型电荷相互作用近似方法的发展，这些方法能提供高达三个数量级的加速（Anandakrishnan et al., 2010）。在过去的几年里，分子建模一直是 CUDA 研究中一个充满活力和不断发展的领域。

# 量子化学

量子化学应用量子力学来解释和预测化学过程的行为。理解物质的电子结构是材料设计以及创造更高效的电池、膜、太阳能电池板和多种常见材料中的一个重要问题。许多方法使用对薛定谔方程的近似解来确定分子的能级以及导电性、电荷分布和反应性等性质。其他量子化学结果包括分子几何、化学键的强度和其他特性、光谱及其他光谱、分子间力以及许多其他化学性质和化学行为特征。量子 ESPRESSO 是一个可免费下载的集成计算机代码套件，用于电子结构计算和纳米尺度的材料建模。它基于密度泛函理论、平面波和伪势（包括守恒范数和超软伪势）。一篇好的入门文章是“使用图形处理单元加速平面波电子结构计算” (Maintz, Eck, & Dronskowski, 2011)。ICHEC 与量子 ESPRESSO 项目合作，创建了该代码的基于 GPU 的版本。目前报告的加速比为单核处理器的八倍。预计随着 GPU 项目的成熟，这一性能将会提高。支持 GPU 的量子化学软件包如 TeraChem (Ufimtsev & Martinez, 2008, Ufimtsev & Martinez, 2009a 和 Ufimtsev & Martinez, 2009b)，现在称为 PetaChem，正在国家超级计算应用中心（NCSA）等主要超级计算中心部署。一些研究人员和组织报告了量子化学模拟的优秀加速效果 (Hwu, 2011)，包括 Gaussian 和 GAMESS (Ufimtsev & Martinez, 2008 和 Ufimtsev & Martinez, 2009)。伪谱方法在 GPU 和多核处理器上运行良好。一种实现是 BigDFT (BigDFT) (Genovese et al., 2009)。

# 交互式工作流程

GPGPU 为专用用途、可视化和交互式工作流程提供了额外的性能优势，因为它们被设计为能够插入到位于仪器旁边或个人桌面的计算机中。近期的科学文献展示了这项技术在多个仪器和项目中的应用。例如，像“Visual Molecular Dynamics (VMD)”这样的可视化软件包通过使用触觉反馈（Stone, Hardy, Ufimtsev, & Schulten, 2010），帮助使分子建模变得更加互动（Stone, Kohlmeyer, Vandivort, & Schulten, 2010）。研究人员 Balanchi 和 Di Leonardo 报告了一个 350 倍的加速，使他们能够将实时全息图生成纳入光学微操作工作流程中（Bianchi & Di Leonardo, 2010）。

# 众多项目

前面的示例仅代表了许多研究努力中的一小部分，这些研究报告了应用 GPGPU 技术所带来的显著益处。生物信息学 (Schmidt, 2010)、系统生物学 (Dematte & Prandi, 2010)、多细胞生物建模 (Christley, Lee, Dai, & Nie, 2010)、化学和蛋白质搜索 (Haque, Pande, & Walters, 2010; Stivala, Stuckey, & Wirth, 2010) 仅是其中几个额外的广泛领域。使用一个好的互联网搜索引擎可以帮助找到与你兴趣相关的研究项目。许多项目会免费提供其软件。如第八章所讨论的，几种通用库可以促进科学计算，如 NVIDIA 的 CUBLAS 和 CUFFT 库，以及 MAGMA（GPU 和多核架构上的矩阵代数）混合 CPU/GPU 库，这些都包含在 SDK 中或可供免费下载。

# 概述

基于 CUDA 的应用程序种类繁多，且正在不断开发中，这使得本章内容显得不完整。本文的目的是提供一些（但绝对不是全部！）重要概念和项目的链接。大多数参考的项目都有可以自由下载、构建和使用的软件。CUDA 的基础知识可以快速学习，然而技术的成熟需要更长的时间，这包括阅读论文、检查源代码以及与同行交流。本章的重点是可以从互联网自由下载的项目。市面上也有许多收费项目。例如，AMBER 是一个商业分子动力学应用程序，可以在 GPU 上运行。¹⁵ 商业药物发现软件也可以在 GPU 上运行，比如 OpenEye 科学软件。¹⁶ 除了学习 CUDA，这些产品还展示了商业 CUDA/GPU 开发的工作机会，以及创办自己科技公司的机会。¹⁵[`ambermd.org/gpus/`](http://ambermd.org/gpus)。¹⁶[`eyesopen.com`](http://eyesopen.com)。
